<?php
/*
 * Copyright notice
 * (c) 1998-2016 Limbas GmbH - Axel westhagen (support@limbas.org)
 * All rights reserved
 * This script is part of the LIMBAS project. The LIMBAS project is free software; you can redistribute it and/or modify it on 2 Ways:
 * Under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.
 * Or
 * In a Propritary Software Licence http://limbas.org
 * The GNU General Public License can be found at http://www.gnu.org/copyleft/gpl.html.
 * A copy is found in the textfile GPL.txt and important notices to the license from the author is found in LICENSE.txt distributed with these scripts.
 * This script is distributed WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 * This copyright notice MUST APPEAR in all copies of the script!
 * Version 3.0
 */

/*
 * ID:
 */


# --------------- Formularelemente --------------------------------------------
function formListElements($action,$gtabid,$ID,&$gresult,$gformid,$ellist=null,$force=null,$readonly=null){
	global $session;
	global $gtab;
	global $gfield;
	global $gform;
	global $gformlist;

	if(!is_array($ellist)){$ellist = $gform[$gformid]["mainellist"];}

	// check permission if not already done
	if($readonly === null){
    	# ----------- edit Permission -----------
    	if($gtab["editrule"][$gtabid]){
    		$readonly = check_GtabRules($ID,$gtabid,null,$gtab["editrule"][$gtabid],0,$gresult);
    	}
    	# --- specific user/grouprules  --------------------------------------
    	if($gtab["has_userrules"][$gtabid] AND !$readonly AND !$gtab["edit_userrules"][$gtabid]){
    		$readonly = !check_GtabUserRules($gtabid,$ID,$session["user_id"],"edit");
    	}
	}

	foreach($ellist as $value => $key){

		$respadd = 0;
		if(!$gform[$gformid]["tab_el_col"][$key] AND !$gform[$gformid]["tab_el_row"][$key]){
			$field_id = $gform[$gformid]["field_id"][$key];
			$tab_id = $gform[$gformid]["tab_id"][$key];
			$stylearray = explode(";",$gform[$gformid]["style"][$key]);
			$collapse = $stylearray[32];
			$stylevalue = set_style($stylearray);

			$width = $gform[$gformid]["width"][$key];
			$height = $gform[$gformid]["height"][$key];

			# ----- Mozilla ------
			if($session["browser"] == "ns"){
				# ----- padding-Verhalten bei Mozilla ------
				if($gform[$gformid]["typ"][$key] == "dbdat"){
					if(($gfield[$tab_id]["argument_typ"][$field_id] == 15 AND !$gfield[$tab_id]["argument_edit"][$field_id]) OR !$gfield[$tab_id]["perm_edit"][$field_id] OR $action == 'gtab_deterg' OR $gfield[$tab_id]["data_type"][$field_id] == 46 OR $gfield[$tab_id]["data_type"][$field_id] == 32 OR $gfield[$tab_id]["field_type"][$field_id] == 14 OR $gfield[$tab_id]["field_type"][$field_id] == 15){
						$respadd = 1;
					}
				}else{$respadd = 1;}

				if($respadd){
					$width = ($width - (2 * $stylearray[22]));
					$height = ($height - (2 * $stylearray[22]));
				}

				# ----- Rahmen-Verhalten bei Mozilla ------
				if($stylearray[19] == 'none'){$height ++;}
				if($stylearray[20] == 'none'){$height ++;}
			}


			# maxlength
			if($stylearray[36] AND $tab_id){
				$maxlength = $gfield[$tab_id]["size"][$field_id];
				$gfield[$tab_id]["size"][$field_id] = $stylearray[36];
			}

			#if(!$tab_id){$tab_id = $gformlist;} # ?????
			$style = "width:".$width."px;height:".$height."px;z-index:".$gform[$gformid]["z_index"][$key];
			if(!$gform[$gformid]["class"][$key]){
				$style = $style.';'.$stylevalue;
			}
			
            $typearray = array_flip(array('dbdat','tab','frame'));
            if ($readonly and isset($typearray[$gform[$gformid]["typ"][$key]])) {
                $stylearray[35] = 1;
            }

			$pos = "position:absolute;left:".$gform[$gformid]["posx"][$key].";top:".$gform[$gformid]["posy"][$key].";";
			$fname = "form_".$gform[$gformid]["typ"][$key];

			if($gform[$gformid]["class"][$key]){$class=$gform[$gformid]["class"][$key];}else{$class="gtabBodyDetailTR";}

			# check if tabmenu
			if($gform[$gformid]["typ"][$key] == "tabulator"){
				if($gform[$gformid]["subellist"]){

					# special styles
					$tbgcolor = $stylearray[21];
					if($tbgcolor){$tstyle="background-color:$tbgcolor;";}
					echo "<table style=\"left:".$gform[$gformid]["posx"][$key].";top:".$gform[$gformid]["posy"][$key].";height:".$height."px;width:".$width."px;margin:0px;border-collapse:collapse;position:absolute\" cellpadding=\"0\" cellspacing=\"0\"><tr><td valign=\"top\">";

					# menu is left
					if($stylearray[38] == 2){
						echo "<table style=\"border-collapse:collapse;height:100%\" cellpadding=\"0\" cellspacing=\"0\">";
						$stprfix = "Left";
						# menu is top
					}else{
						echo "<div>";
					}

					if($stylearray[39] == 2 OR $GLOBALS['old_action'] == 'gtab_change'){
						$gf = $GLOBALS["filter"]["tabulatorKey"][$gtabid][$key];
					}else{
						$GLOBALS["filter"]["tabulatorKey"][$gtabid][$key] = null;
					}
					if($gform[$gformid]["subellist"][$key]){
						foreach ($gform[$gformid]["subellist"][$key] as $sckey => $scval){
							if(!$sckey){continue;}
							if(!$gf){$gf = $sckey;}
							if($gf == $sckey){$class = "lmbGtabTabulator".$stprfix."Active";}else{$class="lmbGtabTabulator".$stprfix."Inactive";}

							if($stylearray[38] == 2){
								echo "<tr><td><div id=\"LmbTabulatorHeader_".$gtabid."_".$sckey."\" class=\"$class\" style=\"$tstyle;\" OnClick=\"lmbSwitchTabulator(this,'$key','$sckey','Left');\">".$gform[$gformid]["inhalt"][$sckey]."&nbsp;</div></td></tr>";
							}else{
								echo "<div id=\"LmbTabulatorHeader_".$gtabid."_".$sckey."\" class=\"$class\" style=\"$tstyle;\" OnClick=\"lmbSwitchTabulator(this,'$key','$sckey');\">".$gform[$gformid]["inhalt"][$sckey]."&nbsp;</div>";
							}
						}
					}

					if($stylearray[38] == 2){
						echo "<tr><td style=\"height:100%;\"><div class=\"lmbGtabTabulator".$stprfix."Space\">&nbsp;</div></td></tr>";
						echo "</table>";
						echo "</td><td valign=\"top\">";
					}else{
						echo "<div class=\"lmbGtabTabulatorSpace\">&nbsp;</div>";
						echo "</div>";
					}

					echo "<table style=\"margin:0px;border-collapse:collapse;width:".$width."px;height:".$height."px;\" cellpadding=\"0\" cellspacing=\"0\"><tr><td>";
					if($gform[$gformid]["subellist"][$key]){
						foreach ($gform[$gformid]["subellist"][$key] as $sckey => $scval){
							if(!$sckey){continue;}
							# grouping header with tabs
							if($gf != $sckey){$dst = "display:none;";}else{$dst = "";}
							echo "<div id=\"LmbTabulatorItem_".$gtabid."_".$sckey."\" class=\"lmbGtabTabulator".$stprfix."Frame\" style=\"$tstyle;$dst;position:relative;width:100%;height:100%;overflow:".$stylearray[24].";\">";
							formListElements($action,$gtabid,$ID,$gresult,$gformid,$gform[$gformid]["subellist"][$key][$sckey],$force,$readonly);
							echo "</div>";
						}
					}
					echo "</td></tr></table>";

					echo "</td></tr></table>";

				}
			# check if mainmenu
			}elseif($gform[$gformid]["typ"][$key] == "menue"){

				$mbgcolor = $stylearray[21];
				if($mbgcolor){$mstyle="background-color:$mbgcolor;";}
				# print menu top
				$gf = form_menue($key,$gformid,$pos,$style,"CLASS=\"".$gform[$gformid]["class"][$key]."\"",$ID,$gtabid,$action,$field_id,$tab_id,$gresult,1,$readonly);
				# list of subelements in menu
				if($gform[$gformid]["subellist"][$key]){
					echo "<div id=\"GtabTableBody\" style=\"height:".$height."px;overflow:".$stylearray[24]."\">";
					# group elements for categories
					foreach ($gfield[$gtabid]["sort"] as $sckey => $scval){
						if($gfield[$gtabid]["field_type"][$sckey] == 100){
							$hascategorie = 1;
							if(!$sckey){continue;}
							# grouping header with tabs
							if(!$gf){$gf = $sckey;}
							if($gf != $sckey){$dst = "display:none;";$force=0;}else{$dst = "";$force=1;}
							#echo "<div class=\"".$class."\" id=\"LmbHeaderPart_".$gtabid."_".$sckey."\" style=\"$dst;position:relative;width:".$width."px;height:".$height."px;overflow:".$stylearray[24].";$mstyle\">";
							echo "<div class=\"".$class."\" id=\"LmbHeaderPart_".$gtabid."_".$sckey."\" style=\"$dst;position:relative;width:".$width."px;height:100%;overflow:".$stylearray[24].";$mstyle\">";
							# tabulator elements
							if($gform[$gformid]["subellist"][$key][$sckey]){$subellist_a = $gform[$gformid]["subellist"][$key][$sckey];}else{$subellist_a = array();}
							# all elements
							if($gform[$gformid]["subellist"][$key][0]){$subellist_b = $gform[$gformid]["subellist"][$key][0];}else{$subellist_b = array();}
							$subellist = array_merge($subellist_b,$subellist_a);
							if(!$gfield[$gtabid]["ajaxpost"][$sckey] OR $force){
								formListElements($action,$gtabid,$ID,$gresult,$gformid,$subellist,$force,$readonly);
							}
							echo "</div>";
						}
					}

					if(!$hascategorie){
						$hascategorie = 1;
						echo "<div class=\"".$class."\" id=\"LmbHeaderPart_".$gtabid."_".$sckey."\" style=\"$dst;position:relative;width:".$width."px;height:100%;overflow:".$stylearray[24].";$mstyle\">";
						formListElements($action,$gtabid,$ID,$gresult,$gformid,$gform[$gformid]["subellist"][$key][0],1,$readonly);
						echo "</div>";
					}

					echo "</div>";
				}
				# print menu bottom
				form_menue($key,$gformid,null,null,null,$ID,$gtabid,$action,null,null,$null,2,$readonly);

				# single element
			}elseif($gform[$gformid]["typ"][$key] != "tabuItem"){
				if($gform[$gformid]["class"][$key]){$fclass = "CLASS=\"".$gform[$gformid]["class"][$key]."\"";}else{$fclass = "";}
				$fname($key,$gformid,$pos,$style,$fclass,$ID,$gtabid,$action,$field_id,$tab_id,$gresult,$gform[$gformid]["z_index"][$key],$collapse,$stylearray[35]);
				echo "\n";
			}

			# maxlength zurücksetzen
			if($maxlength){
				$gfield[$tab_id]["size"][$field_id] = $maxlength;
			}

		}
	}
}

# create single gresult for each relation
function form_gresult($ID,$gtabid,$form_id,&$gresult,$self=null,$verkn=null){
	global $gfield;
	global $gform;
	static $recursive;
	
	if(!$self){$recursive = null;}
	if($recursive[$gtabid]){return;}
	$recursive[$gtabid] = 1;
	
    // relation parameters values
	if($verkn['id'] AND $vgtabid_ = $gfield[ $verkn['tabid'] ]["verknparams"][$verkn['fieldid']]){
        if($parelts = $gform[$form_id]['paramrel'][ $verkn['md5tab'] ]){
            $onlyfield[$vgtabid_] = $parelts;
            $extension['where'][] = "ID = ".$verkn['tabid'];
            $extension['where'][] = "VERKN_ID = $ID";
            $gresult_ = get_gresult($vgtabid_,null,null,null,null,$onlyfield,null,$extension);
            $gresult[$vgtabid_] = $gresult_[$vgtabid_];
        }
	}

	// parent relation values
	if($gfield[$gtabid]["verknfields"]){
		# all relation fields
		foreach ($gfield[$gtabid]["verknfields"] as $fieldid => $value){
			
			$gtabid_ = $gfield[$gtabid]["verkntabid"][$fieldid];
			$parelts = $gform[$form_id]["parentrel"][$gfield[$gtabid]["md5tab"][$fieldid]];
			
			if($parelts){
				$onlyfield[$gtabid_] = $parelts;
				$verkn = set_verknpf($gtabid,$fieldid,$ID,0,0,1,0);
				$filter["getlongval"][$gtabid_] = 1;
				if($gresult_ = get_gresult($gtabid_,1,$filter,$GLOBALS["gsf"],$verkn,$onlyfield)){
					$ID_ = $gresult_[$gtabid_]["id"][0];
					$gresult[$gtabid_] = $gresult_[$gtabid_];
				}
			}
	
			# recursive call
			if($ID_){
				form_gresult($ID_,$gtabid_,$form_id,$gresult,1);
			}
		}
	}
}


#------------ Feld gelöscht! ---------------------
/*
function dftyp_warningDelete($key,$gformid,$pos,$style,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$z_index){

	global $gform;
	global $gfield;
	global $gtab;
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<DIV $style $event>";
	echo "field used in formular not in table or without rights!<br>";
	echo "table: ".$gtab['desc'][$tab_id]." (ID $tab_id) - field:<b>".$gfield[$tab_id]["spelling"][$field_id]." (ID $field_id)</b>";
	echo "</DIV>";

}
*/

#------------ dbdat ---------------------
function form_dbdat($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$z_index,$collapse,$readonly){
	global $gfield;
	global $gtab;
	global $gform;
	global $session;
	#global $gdublicate;

	$noedit = 1;

	# ----------- View Permission from Field-Rule -----------
	if($gfield[$tab_id]["viewrule"][$field_id]){
		$returnval = eval(trim($gfield[$tab_id]["viewrule"][$field_id]).";");
		if($returnval){return;}
	}

	# ----------- Edit Permission -----------
	if($gfield[$tab_id]["perm_edit"][$field_id] AND $readonly != 1){$noedit = 0;}

	# ----------- Edit Permission from Table-Rule -----------
	/*
	if(!$noedit AND $gtab["editrule"][$tab_id]){
		#$rownr = 0;
		
	    error_log('a '.$readonly);
	    
		$noedit = check_GtabRules($ID,$tab_id,$field_id,$gtab["editrule"][$tab_id],0,$gresult);
	}
	*/

	# ----------- Edit Permission from Field-Rule -----------
	if(!$noedit AND $gfield[$tab_id]["editrule"][$field_id]){
		$noedit = check_GtabRules($ID,$tab_id,$field_id,$gfield[$tab_id]["editrule"][$field_id],0,$gresult);
	}

	# ----------- Argument Typfunction -----------
	if($gfield[$tab_id]["argument"][$field_id] AND $gfield[$tab_id]["argument_typ"][$field_id] == 15){
		if(!$gfield[$tab_id]["argument_edit"][$field_id]){$noedit = 1;}
		if(($action == 'gtab_change' OR $action == 'gtab_neu') AND !$noedit){$edittyp = 1;}else{$edittyp = 2;}
		$gresult[$tab_id][$field_id][0] = dftyp_13($ID,$gresult,$field_id,$tab_id,'','','',$edittyp);
	}else{
		if(($action == 'gtab_change' OR $action == 'gtab_neu') AND !$noedit){$edittyp = 1;}else{$edittyp = 2;}
	}


	$typ = $gfield[$tab_id]["funcid"][$field_id];
	$pos = $pos."z-index:".$z_index.";";
	#------------------ Typfunction ---------------------
	/* ------------------ Default --------------------- */
	if(!$typ){return;}
	#if(!$typ){$typ = "warningDelete";}
	$fname = "dftyp_".$typ;
	/* ------------------ Extension --------------------- */
	if($gfield[$tab_id]["ext_type"][$field_id]){
		if(function_exists("lmbd_".$gfield[$tab_id]["ext_type"][$field_id])){
			$fname = "lmbd_".$gfield[$tab_id]["ext_type"][$field_id];
		}
	}
	#------------------ Typfunction ---------------------
	#if($edittyp == 1){
	#if($gdublicate[$tab_id][$field_id]){$edittyp = 2;}
	#$gdublicate[$tab_id][$field_id] = 1;
	#}
	if($class){$fclass = $class;}else{$fclass = "CLASS=\"fgtabchange\"";}
	
	# use new ID of fields from related Tables / important for update
	if($gtabid != $tab_id){
		$ID = $gresult[$tab_id]['id'][0];
	}
	
	$fname($ID,$gresult,$field_id,$tab_id,$fclass,$style,$pos,$edittyp,$z_index,$gform[$gformid]["event"][$key],$gformid,$key,$gform[$gformid]["pic_size"][$key]);
}

#------------ dbdesc ---------------------
function form_dbdesc($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$z_index){
	global $gform;
	global $gfield;
	global $gtab;

	# ----------- View Permission from Field-Rule -----------
	if($gfield[$tab_id]["viewrule"][$field_id]){
		$returnval = eval(trim($gfield[$tab_id]["viewrule"][$field_id]).";");
		if($returnval){return;}
	}

	if($event = dftyp_events($typ,$gform[$gformid]["event"][$key],null,null,null,null,null,$gresult,$gtabid,$field_id)){$style .= ";cursor:pointer;";}
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<DIV ID=\"d_".$gtabid."_".$field_id."\" $class $style $event title=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">";
	echo $gfield[$tab_id]["spelling"][$field_id]."<span class=\"gtabBodyDetailNeedTitle\">".lmb_substr($gfield[$tab_id]["need"][$field_id],0,1)."</span>";
	echo "</DIV>";
}

#------------ bild ---------------------
function form_bild($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	global $gtab;
	global $db;
	global $umgvar;

	if($event = dftyp_events($typ,$gform[$gformid][event][$key],null,null,null,null,null,$null,$gtabid,null)){$style .= ";cursor:pointer;";}
	$width = $gform[$gformid]["width"][$key];
	$height = $gform[$gformid]["height"][$key];
	#$size = ";width:".$width."; height:".$height;
	$path = "UPLOAD/form/".$gform[$gformid]["tab_size"][$key];
	$dest = "TEMP/thumpnails/".$gform[$gformid]["tab_size"][$key];
	$style = "STYLE=\"".$pos.$style."\"";

	$secname = $pathinfo[0] = $path;
	$mimeid = $pathinfo[1];

	$url = IMACK_ConvertThumbs($path,$width,$height,null,null,$dest);

	if($url){
		#$style = "style=\"position:absolute; left:".$gform[$gformid][posx][$key]."; top:".$gform[$gformid][posy][$key].";$size; z-index:".$gform[$gformid][z_index][$key]."; ".$stylevalue."\"";
		echo "<IMG SRC=\"".$url."\" ID=\"pic".$key."_".$gformid."\" $class $style $event title=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">";
	}
}

#------------ chart ---------------------
function form_chart($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult){
	global $gform;
	global $gtab;
	global $umgvar;
	
	require_once('extra/diagram/diagram.php');

	if($event = dftyp_events($typ,$gform[$gformid][event][$key],null,null,null,null,null,$null,$gtabid,null)){$style .= ";cursor:pointer;";}
	$width = $gform[$gformid]["width"][$key];
	$height = $gform[$gformid]["height"][$key];
	$diag_id = $gform[$gformid]["tab_id"][$key];
	$style_ = "STYLE=\"".$pos.$style."\"";
	$stylearray = explode(";",$gform[$gformid]["style"][$key]);
	if($gform[$gformid]["parameters"][$key]){eval($gform[$gformid]["parameters"][$key]);}
	
	$url = lmb_createDiagram($diag_id, $gsr, $filter, $verkn, $extension, $width, $height, $stylearray);

	if($url){
		echo "<IMG SRC=\"".$url."\" ID=\"pic".$key."_".$gformid."\" $class $style_ $event title=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">";
	}
}

#------------ uform ---------------------
function form_uform($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$z_index,$collapse,$readonly){
	global $gform;
	global $gformlist;
	global $gfield;
	global $gtab;
	global $db;

	$styleset = "style=\"".$pos.$style."\"";

	# IFRAME
	if($gform[$gformid]["uform_vtyp"][$key] == 1){
		# userdefined
		if($gform[$gformid]["uform_typ"][$key] == 1){
			$src = "src=\"".eval($gform[$gformid]['parameters'][$key].";")."\"";
			echo "<iframe id=\"element".$gform[$gformid]["fid"][$key]."\" title=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\" frameborder=\"0\" name=\"iframe_".$gform[$gformid]["fid"][$key]."\" $src $class $styleset></iframe>";
			# form
		}elseif($gform[$gformid]["uform_typ"][$key] == 2){
			$parameters = "&".eval($gform[$gformid]['parameters'][$key].";");
			echo "<iframe id=\"element".$gform[$gformid]["fid"][$key]."\" title=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\" frameborder=\"0\" name=\"iframe_".$gform[$gformid]["fid"][$key]."\" src=\"main.php?action=gtab_erg&gtabid=".$gform[$gformid]["tab_id"][$key]."&form_id=".$gform[$gformid]["tab_group"][$key].$parameters."\" $class $styleset></iframe>";
			# table
		}elseif($gform[$gformid]["uform_typ"][$key] == 3){
			$parameters = "&".eval($gform[$gformid]['parameters'][$key].";");
			echo "<iframe id=\"element".$gform[$gformid]["fid"][$key]."\" title=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\" frameborder=\"0\" name=\"iframe_".$gform[$gformid]["fid"][$key]."\" src=\"main.php?action=gtab_erg&gtabid=".$gform[$gformid]["tab_id"][$key].$parameters."\" $class $styleset></iframe>";
		}
	# DIV
	}elseif($gform[$gformid]["uform_vtyp"][$key] == 2){
		# userdefined
		if($gform[$gformid]["uform_typ"][$key] == 1){
			echo "<div id=\"element".$gform[$gformid]["fid"][$key]."\" title=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\" $class $styleset>";
			if($gform[$gformid]['parameters'][$key]){eval($gform[$gformid]['parameters'][$key].";");}
			echo "</div>";
		# subform
		}elseif($gform[$gformid]["uform_typ"][$key] == 2){
			$stylearray = explode(";",$gform[$gformid]["style"][$key]);
			if($stylearray[24]){$styleset = $pos.$style;}else{$styleset = $pos;}
			$filter["anzahl"][$gtabid] = "all";
			if($gform[$gformid]['parameters'][$key]){eval($gform[$gformid]['parameters'][$key].";");}
			echo "<div id=\"element".$gform[$gformid]["fid"][$key]."\" title=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\" style=\"$styleset\">";
			if($gformlist[$gform[$gformid]["tab_id"][$key]]["typ"][$gform[$gformid]["tab_group"][$key]] == 2){
				$ugresult = get_gresult($gform[$gformid]["tab_id"][$key],null,$filter,$gsr,$verkn,$onlyfield);
				require_once('gtab/html/gtab_erg.lib');
				form_ergview($gform[$gformid]["tab_id"][$key],$ugresult,$gform[$gformid]["tab_group"][$key]);
			}else{
				$ugresult = get_gresult($gform[$gformid]["tab_id"][$key],null,$filter,$gsr,$verkn,$onlyfield,$ID);
				form_gresult($ID,$gform[$gformid]["tab_id"][$key],$gform[$gformid]["tab_group"][$key],$ugresult); # need for fields of related tables
				#form_view($gform[$gformid]["tab_id"][$key],$ID,$ugresult,$gform[$gformid]["tab_group"][$key]);
				formListElements('gtab_change',$gform[$gformid]["tab_id"][$key],$ID,$ugresult,$gform[$gformid]["tab_group"][$key]);
			}
			echo "</div>";
		# table
		}elseif($gform[$gformid]["uform_typ"][$key] == 3){
			global $filter;

			$gtabid = $gform[$gformid]["tab_id"][$key];
			$fieldid = $key."_".$gformid;
			$vuniqueid = "g_0_".$fieldid;
			$linklevel["tabid"] = $gtabid;
			$gsr = $filter["ext_RelationFields"]["searchval"][$vuniqueid];
			$vfilter["anzahl"][$gtabid] = "all";
			$vfilter["order"][$gtabid] = $filter["ext_RelationFields"]["order"][$vuniqueid];
			
			# specific formular styles
			$st = explode(";",$gform[$gformid]["style"][$key]);
			if($st[24]){ #overflow
				if($st[24] == 'scroll'){$st[24] = 'auto';} # scroll soll als auto behandelt werden
				$bt = "height:".$gform[$gformid]["height"][$key]."px;overflow:".$st[24];
			}else{
				$bt = "";
			}
			$style_abs = str_replace(";height:",";height_:",$styleset); # workaround to disable height
			$style_abs = str_replace(":scroll;",":auto;",$style_abs); # workaround to disable overflow scroll

			# specific formular filter
			if($gform[$gformid]["parameters"][$key]){
			$filter_ = eval($gform[$gformid]["parameters"][$key]);
			if(is_array($filter_)){
				foreach ($filter_ as $fkey => $fval){
					if($fkey == 'showfields' AND !$filter["ext_RelationFields"][$vuniqueid]){
						$filter["ext_RelationFields"][$vuniqueid] = $fval;
					}elseif($fkey == 'order'){
						if(!$vfilter["order"][$gtabid]){
							$vfilter["order"][$gtabid] = $fval;
						}
					}else{
						$filter["ext_RelationFields"][$fkey][$vuniqueid] = $fval;
					}
				}
			}
			}

			if(!$filter["ext_RelationFields"][$vuniqueid]){$filter["ext_RelationFields"][$vuniqueid] = $gfield[$gtabid]["key"];}
			if(!$filter["ext_RelationFields"]['nogresult'][$vuniqueid]){$ugresult = get_gresult($gtabid,2,$vfilter,$gsr,$verkn,$onlyfield,$single,$extension);}
			if(($action == 'gtab_change' OR $action == 'gtab_neu') AND !$readonly){$edittyp = 1;}else{$edittyp = 2;}

			echo "<div $style_abs class=\"gtabFringeRelationBody\">\n";
			if(!$filter["ext_RelationFields"]["no_menu"][$vuniqueid]){
				dftyp_14_header($gtabid,$fieldid,$ID,$vuniqueid,$gformid,$key,$edittyp,$linklevel,$z_index,null,$filter);
			}
			echo "<div style=\"width:100%;$bt\" ID=\"extRelationFieldsTab_".$gtabid."_".$fieldid."\">";
			# table
			
			cftyp_14_d($ugresult,$rscount,1,$verkn,$gtabid,$gtabid,$fieldid,$ID,$VID,$linklevel,$vuniqueid,$gformid,$key,$filter);
			echo "</div>";
			echo "</div>";
		}
	}
}


#------------ tab ---------------------
function form_tab($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$z_index,$collapse,$readonly){
	global $gform;
	global $gfield;
	global $gtab;
	global $action;

	$typearray = array_flip(array('dbdat','tab','frame'));
	$tab_size = explode(";",$gform[$gformid]["tab_size"][$key]);
	$tdsize = explode(";",$gform[$gformid]["parameters"][$key]);

	$stylearray_tab = explode(";",$gform[$gformid]["style"][$key]);
	# zeigt gesammte Höhe an
	if($stylearray_tab[24]){$height = "height:".$gform[$gformid]["height"][$key]."";}
	$div_style = "style=\"".$pos.";width:".$gform[$gformid]["width"][$key].";$height;".set_style($stylearray_tab)."\"";
	$tab_style = "style=\"border-collapse:$collapse;\"";

	echo "
	<div $class $div_style>
	<table cellpadding=0 cellspacing=0 $tab_style id=\"element".$gform[$gformid]["fid"][$key]."\">";

	# rows
	for ($r=1; $r<=$tab_size[1];$r++){
		$colspan = "";
		echo "<tr>";
		# cells
		for ($c=1; $c<=$tab_size[0];$c++){
			if($colspan-- > 1){continue;}
			$cell_key = $gform[$gformid]["tab_cell"][$gform[$gformid]["tab"][$key]][$c][$r];
			if($cell_key){
				$stylearray = explode(";",$gform[$gformid]["style"][$cell_key]);
				$align = "align=\"".$stylearray[12]."\"";
				$valign = "valign=\"".$stylearray[23]."\"";
				unset($stylearray[23],$stylearray[12]);
				$stylevalue = set_style($stylearray);
				# style fom tab
				if($stylearray_tab[34]){$stylevalue = $style_tab.";".$stylevalue;}
				# colspan
				if($stylearray[37]){$colspan = $stylearray[37]; $CLSP = "colspan=\"".$stylearray[37]."\"";}else{$CLSP = "";}
				# width
				$tdwidth = "width:".$tdsize[$c-1];
				# event
				if($event = dftyp_events($typ,$gform[$gformid]['event'][$cell_key],null,null,null,null,null,$null,$gtabid,null)){$stylevalue .= ";cursor:pointer;";}

				$class = "class=\"".$gform[$gformid]["class"][$cell_key]."\"";
				echo "<td id=\"element".$gform[$gformid]["fid"][$cell_key]."\" $class style=\"$stylevalue;$tdwidth\" $align $valign $event $CLSP>";

				if($gform[$gformid]["tab_cellel"][$gform[$gformid]["tab"][$key]][$c][$r]){
					foreach ($gform[$gformid]["tab_cellel"][$gform[$gformid]["tab"][$key]][$c][$r] as $numkey => $cellElkey){
						$tab_id = $gform[$gformid]["tab_id"][$cellElkey];
						$field_id = $gform[$gformid]["field_id"][$cellElkey];
						$styleElarray = explode(";",$gform[$gformid]["style"][$cellElkey]);
						$styleElvalue = set_style($styleElarray).";position:relative;width:".$gform[$gformid]["width"][$cellElkey]."px;height:".$gform[$gformid]["height"][$cellElkey]."px;z-index:".$gform[$gformid]["z_index"][$cellElkey];
						// readonly from editrule
                        if ($readonly and isset($typearray[$gform[$gformid]["typ"][$cellElkey]])) {$styleElarray[35] = 1;}
                        
                        $fname = "form_".$gform[$gformid]["typ"][$cellElkey];
						$itemclass = "class=\"".$gform[$gformid]["class"][$cellElkey]."\"";
						$fname($cellElkey,$gformid,'',$styleElvalue,$itemclass,$ID,$gtabid,$action,$field_id,$tab_id,$gresult,$gform[$gformid]["z_index"][$cellElkey],$collapse,$styleElarray[35]);
					}}
			}
			echo "</td>";
		}
		echo "</tr>";
	}

	echo "</table></div>";
}


#------------ system tablist ---------------------
function form_stab($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,$gresult){
	global $gform;
	global $gfield;
	global $gtab;
	global $gsnap;
	global $filter;

	$pos = "top:".$gform[$gformid]["posy"][$key].";left:".$gform[$gformid]["posx"][$key].";";
	$snap_id = $gform[$gformid]["tab_id"][$key];
	$view = explode(";",$gform[$gformid]["tab_size"][$key]);

	if($snap_id AND $gsnap[$gtabid]["id"][$snap_id] AND (!$filter["snapisset"][$snap_id] OR $filter["snapid"][$gtabid] != $snap_id)){
		SNAP_get_filter($snap_id,$gtabid);
		# new gresult
		$gresult = get_gresult($gtabid,1,$filter,$GLOBALS["gsr"],null,$gform[$gformid]["used_fields"]);
	}

	echo "<div $class style=\"position:absolute;".$pos.$style."\">\n";
	lmbGlistOpen();
	if($view[0] == "true"){lmbGlistTabs($gtabid,null,$snap_id);}
	if($view[1] == "true"){lmbGlistMenu($gtabid);}
	if($view[2] == "true"){lmbGlistSearch($gtabid,null,null);}
	lmbGlistHeader($gtabid,$gresult,0);
	lmbGlistBody($gtabid,$gresult,1,null,null,$filter,0,0,0,0,1);
	if($view[3] == "true"){lmbGlistFooter($gtabid,$gresult,$filter);}
	lmbGlistClose();
	echo "</div>";

}




#------------ main-menu ---------------------
function form_menue($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$part=0,$readonly=0){
	global $lang;
	global $gfield;
	global $gform;

	$showel = explode("_",$gform[$gformid]["pic_size"][$key]);

	# Kopfelemente
	if($part == 1){
		$stylearray = explode(";",$gform[$gformid]["style"][$key]);

		echo "<table class=\"lmbfringeGtab\" id=\"gtabDetail\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"$pos;margin:0px;\">\n";

		# Verknüpfungsreiter
		if(in_array("0",$showel) AND $ID){
			echo "<tr><td>";
			print_linktags($gtabid,$GLOBALS["verkn_poolid"],$ID,$gresult);
			echo "</td></tr>";
			$hastop = 1;
			# Tabreiter
		}elseif(in_array("3",$showel)){
			echo "<tr><td>";
			print_linktags($gtabid,$GLOBALS["verkn_poolid"],$ID,$gresult,1);
			echo "</td></tr>";
			$hastop = 1;
		}

		# menu
		if(in_array("1",$showel)){
			if(!$hastop){echo "<tr class=\"gtabBodyDetailTopBorder\"><td></td></tr>";}
			echo "<tr><td>";
			print_menue($gtabid,$gresult,$GLOBALS["verkn_addfrom"],$readonly);
			echo "</td></tr>";
		}

		echo "<tr><td><table class=\"gtabBodyDetailFringe\" style=\"width:100%\">";

		# Submenu
		if($GLOBALS["filter"]["groupheader"][$gtabid]){
			echo "<tr class=\"gtabBodyDetailTopSpace\"><td></td></tr>\n";
			if(in_array(100,$gfield[$gtabid]["field_type"])){

				# first define all visible tabulators
				foreach ($gfield[$gtabid]["sort"] as $gkey => $gvalue){
					if($gfield[$gtabid]["field_type"][$gkey] == 100){
						# ----------- Viewrule -----------
						if($gfield[$gtabid]["viewrule"][$gkey]){
							$returnval = eval(trim($gfield[$gtabid]["viewrule"][$gkey]).";");
							if($returnval){continue;}
						}
						$tablist[$gkey] = 1;
					}
				}

				echo "<tr class=\"gtabBodyDetailSubheader\"><td>\n";
				if(($stylearray[39] == 2 OR $GLOBALS['old_action'] == 'gtab_change') AND $tablist[$GLOBALS["filter"]["groupheaderKey"][$gtabid]]){
					$gf = $GLOBALS["filter"]["groupheaderKey"][$gtabid];
				}
				echo "<table class=\"lmbGtabSubheaderTable\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\"><tr>\n";
				echo "<td class=\"tabpoolItemSpaceGtab\" style=\"width:20px;\">&nbsp;&nbsp;</td>\n";
				foreach ($tablist as $gkey => $gvalue){
					if(!$gf){$gf = $gkey; $GLOBALS["filter"]["groupheaderKey"][$gtabid] = $gkey;}
					if($gf == $gkey){$class = "lmbGtabSubheaderActive";}else{$class = "lmbGtabSubheaderInactive";}
					echo "<td id=\"LmbTabulatorMenu_".$gtabid."_".$gkey."\" nowrap class=\"$class\" OnClick=\"limbasSubheaderSelection(this,'$gtabid','$gkey','DIV','$gformid','$ID','$key','".$gfield[$gtabid]["ajaxpost"][$gkey]."');".$gfield[$gtabid]["relext"][$gkey]."\">".$gfield[$gtabid]["spelling"][$gkey]."</td>\n";
				}
				echo "<td class=\"tabpoolItemSpaceGtab\">&nbsp;</td>\n";
				echo "</tr></table>\n";
				echo "</td></tr>\n";
			}
		}

		echo "<tr class=\"gtabBodyDetailBody\"><td>\n";

	# Fußelemente
	}elseif($part == 2){
		echo "</td></tr></table></td></tr>\n";

		if(in_array("2",$showel)){
			echo "<tr><td>";
			if(in_array("0",$showel) OR in_array("1",$showel)){
				echo "<table width=\"100%\" cellpadding=0 cellspacing=0 class=\"gtabFooterTAB\"><TR class=\"gtabFooterTR\"><TD COLSPAN=\"2\" ALIGN=\"LEFT\"><TABLE><TR><TD WIDTH=\"200\">";
			}else{
				echo "<table width=\"100%\" cellpadding=0 cellspacing=0><TR><TD COLSPAN=\"2\" ALIGN=\"LEFT\"><TABLE><TR><TD WIDTH=\"200\">";
			}

			if($ID){print_scroll($ID);}
			echo "</td><td>";
			if($action == 'gtab_change' OR $action == 'gtab_neu'){
				echo "<input class=\"submit\" TYPE=\"button\" name=\"lmbSbm\" STYLE=\"cursor:pointer\" value=\"$lang[55]\" onclick=\"document.form1.action.value='gtab_change'; send_form('1');\">&nbsp;&nbsp;";
				echo "<input class=\"submit\" TYPE=\"button\" name=\"lmbSbmClose\" STYLE=\"cursor:pointer;display:none;\" value=\"$lang[2796]\" onclick=\"document.form1.action.value='gtab_change';send_form(1,0,0,1);\">";
			}
			echo "</td></tr></table></td></tr></table>";
			echo "</td></tr>";
		}

		echo "<tr><td class=\"lmbGtabBottom\"></td></tr>";

		echo "</table>";

	}

	return $gf;
}







#------------ tabulator ---------------------
function form_tabulator($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult){
	global $gform;
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style>";

	echo "</DIV>";
}

#------------ fmenu ---------------------
function form_fmenue($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult){
	global $gform;
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style>";
	print_linktags($gtabid,$GLOBAL["verkn_poolid"],$ID,$gresult[$gtabid][$key]);
	echo "</DIV>";
}




#------------ frame ---------------------
function form_frame($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$z_index,$collapse,$readonly){
	global $gform;
	if($gform[$gformid]["inhalt"][$key]){
		$style_ = preg_replace("/width:|height:|border-style:|padding:/","null",$style);
		echo "<div $class style=\"color:transparent;border:none;padding:0px;padding-left:6px;padding-right:6px;$style_;left:".($gform[$gformid]["posx"][$key] + 15).";top:".($gform[$gformid]["posy"][$key] - 1).";height:3px;overflow:hidden;z-index:".($gform[$gformid]["z_index"][$key] + 1).";position:absolute;\">".$gform[$gformid]["inhalt"][$key]."</div>";
		echo "<div $class style=\"opacity:0.3;filter:Alpha(opacity=30);padding-left:6px;padding-right:6px;$style_;left:".($gform[$gformid]["posx"][$key] + 15).";top:".($gform[$gformid]["posy"][$key] - 8).";z-index:".($gform[$gformid]["z_index"][$key] + 2).";position:absolute;border:none;\">".$gform[$gformid]["inhalt"][$key]."</div>";
	}

	echo "<div id=\"element".$gform[$gformid]["fid"][$key]."\" style=\"".$pos.$style."\" title=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\" $class>";
	if(is_array($gform[$gformid]["subellist"][$key][0])){
		formListElements($action,$gtabid,$ID,$gresult,$gformid,$gform[$gformid]["subellist"][$key][0],0,$readonly);
	}
	echo "</div>";
}

#------------ datum ---------------------
function form_datum($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	$event = dftyp_events(1,$gform[$gformid]['event'][$key],null,null,null,null,null,$null,$gtabid,null);
	if($gform[$gformid]['event'][$key]['click']){$style .= ";cursor:pointer;";}
	$style = "style=\"".$style."\"";
	echo "<DIV style=\"$pos;z-index:".$gform[$gformid]["z_index"][$key]."\">";
	echo "<INPUT ID=\"element".$gform[$gformid]["fid"][$key]."\" NAME=\"lfel[".$gform[$gformid][fid][$key]."]\" $class $style $event TYPE=\"TEXT\" $style $event TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\" TITLE=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">";
	echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" id=\"lfel_".$gform[$gformid]['fid'][$key]."\" BORDER=\"0\" TITLE=\"$lang[700]\" style=\"cursor:pointer;vertical-align:top;\" Onclick=\"lmb_datepicker(event,this,'','','".dateStringToDatepicker(setDateFormat(1,1))."')\"></i>\n";
	#echo local_date(0);
	echo "</DIV>";
}

#------------ scroll ---------------------
function form_scroll($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult){
	global $gform;
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style>";
	print_scroll($ID);
	echo "</DIV>";
}

#------------ usetime ---------------------
function form_usetime($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style>";
	print_usetime($gtab,$gtabid);
	echo "</DIV>";
}

#------------ submit/button ---------------------
function form_submt($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	$event = dftyp_events(1,$gform[$gformid]['event'][$key],null,null,null,null,null,$null,$gtabid,null);
	if(!$gform[$gformid]['event'][$key]['click']){$event = "OnClick=\"send_form('1');\";";}
	$style = "style=\"".$pos.$style.";cursor:pointer;\"";
	echo "<input id=\"element".$gform[$gformid]["fid"][$key]."\" type=\"button\" value=\"".$gform[$gformid]["inhalt"][$key]."\" $class $style $event tabindex=\"".$gform[$gformid]["z_index"][$key]."\">";
}

#------------ input button ---------------------
function form_button($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	$event = dftyp_events(1,$gform[$gformid]['event'][$key],null,null,null,null,null,$null,$gtabid,null);
	$style = "style=\"".$pos.$style.";cursor:pointer;\"";
	echo "<input id=\"element".$gform[$gformid]["fid"][$key]."\" type=\"button\" value=\"".$gform[$gformid]["inhalt"][$key]."\" $class $style $event tabindex=\"".$gform[$gformid]["z_index"][$key]."\">";
}


#------------ input text ---------------------
function form_inptext($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$z_index,$collapse,$readonly){
	global $gform;
	if($readonly == 1){$readonly = 'readonly';}
	$stylearray = explode(";",$gform[$gformid]["style"][$key]);
	$event = dftyp_events(1,$gform[$gformid]["event"][$key],null,null,null,null,null,$null,$gtabid,null);
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<INPUT ID=\"element".$gform[$gformid]["fid"][$key]."\" TYPE=\"TEXT\" NAME=\"lfel[".$gform[$gformid]["fid"][$key]."]\" $readonly $class $style $event VALUE=\"".htmlentities($gform[$gformid]["inhalt"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\" MAXLENGTH=\"".$stylearray[36]."\" TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\" TITLE=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">";
}

#------------ input hidden ---------------------
function form_inphidden($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	echo "<INPUT ID=\"element".$gform[$gformid]["fid"][$key]."\" TYPE=\"HIDDEN\" NAME=\"lfel[".$gform[$gformid][fid][$key]."]\" VALUE=\"".htmlentities($gform[$gformid]["inhalt"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">";
}

#------------ input textarea ---------------------
function form_inparea($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$z_index,$collapse,$readonly){
	global $gform;
	if($readonly == 1){$readonly = 'readonly';}
	$event = dftyp_events(1,$gform[$gformid][event][$key],null,null,null,null,null,$null,$gtabid,null);
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<TEXTAREA ID=\"element".$gform[$gformid]["fid"][$key]."\" NAME=\"lfel[".$gform[$gformid][fid][$key]."]\" $readonly $class $style $event TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\" TITLE=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">".htmlentities($gform[$gformid]["inhalt"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."</TEXTAREA>";
}

#------------ input select ---------------------
function form_inpselect($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$z_index,$collapse,$readonly){
	global $gform;
	global $db;
	global $session;
	global $umgvar;

	if($readonly == 1){$readonly = 'readonly';}
	$event = dftyp_events(1,$gform[$gformid][event][$key],null,null,null,null,null,$null,$gtabid,null);
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<SELECT ID=\"element".$gform[$gformid]["fid"][$key]."\" TYPE=\"TEXT\" NAME=\"lfel[".$gform[$gformid][fid][$key]."]\" $readonly $class $style $event TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\" TITLE=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">";

	if(is_numeric($gform[$gformid]['inhalt'][$key])){
		
		// multilang
		$field_name = 'WERT';
		if($umgvar['multi_language'] AND $session['language'] != $umgvar['default_language']){
		      $field_name = 'LANG'.$session['language'].'_WERT';
		}
		    
		$sqlquery = "SELECT ID,$field_name,HIDE,DEF FROM LMB_SELECT_W WHERE POOL = ".$gform[$gformid]['inhalt'][$key]." ORDER BY SORT";
		$rs = odbc_exec($db,$sqlquery) or errorhandle(odbc_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
		$bzm1 = 1;
		echo "<OPTION>";
		while(odbc_fetch_row($rs, $bzm1)) {
			if(odbc_result($rs, "HIDE")){continue;}
			if(odbc_result($rs, "DEF")){$selected = 'SELECTED';}
			$sval = htmlentities(odbc_result($rs, $field_name),ENT_QUOTES,$GLOBALS["umgvar"]["charset"]);
			echo "<OPTION $selected>$sval";
			$bzm1++;
		}
	}elseif($gform[$gformid]['inhalt'][$key]){
		$opt = explode(",",$gform[$gformid]['inhalt'][$key]);
		foreach ($opt as $key => $value){
			echo "<OPTION>$value\n";
		}
	}
	echo "</SELECT>";
}

#------------ input check ---------------------
function form_inpcheck($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$z_index,$collapse,$readonly){
	global $gform;
	if($readonly == 1){$readonly = 'readonly';}
	$event = dftyp_events(1,$gform[$gformid][event][$key],null,null,null,null,null,$null,$gtabid,null);
	$style = "STYLE=\"".$pos.$style."\"";
	if($gform[$gformid][inhalt][$key] == 1){$CHECKED = "checked";}
	echo "<INPUT ID=\"element".$gform[$gformid]["fid"][$key]."\" TYPE=\"CHECKBOX\" NAME=\"lfel[".$gform[$gformid][fid][$key]."]\" $readonly $class $style $event $CHECKED TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\" TITLE=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">";
}

#------------ input radio ---------------------
function form_inpradio($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	$event = dftyp_events(1,$gform[$gformid][event][$key],null,null,null,null,null,$null,$gtabid,null);
	$style = "STYLE=\"".$pos.$style."\"";
	if($gform[$gformid][inhalt][$key]){
		$opt = explode(" ",$gform[$gformid][inhalt][$key]);
	}
	if($opt[1] == 1){$CHECKED = "checked";}
	echo "<INPUT ID=\"element".$gform[$gformid]["fid"][$key]."\" TYPE=\"RADIO\" NAME=\"lfel[".$opt[0]."]\" VALUE=\"lfel[".$gform[$gformid][fid][$key]."]\" $class $style $event $CHECKED TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\" TITLE=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">";
}

#------------ line ---------------------
function form_line($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	if($event = dftyp_events(1,$gform[$gformid][event][$key],null,null,null,null,null,$null,$gtabid,null)){$style .= ";cursor:pointer;";}
	$style = "STYLE=\"".$pos.$style."\"";
	$st = explode(";",$gform[$gformid][style][$key]);
	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style $event>";
	echo "
	<script type=\"text/javascript\">
	var jg".$gform[$gformid]["fid"][$key]." = new jsGraphics(\"element".$gform[$gformid]["fid"][$key]."\");
	js_line('jg".$gform[$gformid]["fid"][$key]."','".$gform[$gformid]["width"][$key]."','".$gform[$gformid]["height"][$key]."','$st[25]','$st[9]','$st[3]');
	</script>
	";
	echo "</DIV>";
}

#------------ ellipse ---------------------
function form_ellipse($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	if($event = dftyp_events(1,$gform[$gformid][event][$key],null,null,null,null,null,$null,$gtabid,null)){$style .= ";cursor:pointer;";}
	$style = "STYLE=\"".$pos.$style."\"";
	$st = explode(";",$gform[$gformid][style][$key]);
	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style $event>";
	echo "
	<script type=\"text/javascript\">
	var jg".$gform[$gformid]["fid"][$key]." = new jsGraphics(\"element".$gform[$gformid]["fid"][$key]."\");
	js_ellipse('jg".$gform[$gformid]["fid"][$key]."','".$gform[$gformid]["width"][$key]."','".$gform[$gformid]["height"][$key]."','$st[9]','$st[3]');
	</script>
	";
	echo "</DIV>";
}

#------------ rect ---------------------
function form_rect($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	if($event = dftyp_events(1,$gform[$gformid][event][$key],null,null,null,null,null,$null,$gtabid,null)){$style .= ";cursor:pointer;";}
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style $event>";
	echo "&nbsp;";
	echo "</DIV>";
}

#------------ text ---------------------
function form_text($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	if($event = dftyp_events(1,$gform[$gformid][event][$key],null,null,null,null,null,$null,$gtabid,null)){$style .= ";cursor:pointer;";}
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style $event>";
	echo nl2br(htmlentities($gform[$gformid]["inhalt"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"]));
	echo "</DIV>";
}


#------------ workflow-history ---------------------
function form_wflhist($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	$style = "STYLE=\"".$pos.$style."\"";

	# get workflow id
	$wfl_id = $gform[$gformid]['uform_typ'][$key];

	# parse parameters
    if($gform[$gformid]["parameters"][$key]){eval($gform[$gformid]["parameters"][$key]);}

    # use global wfl instance
    if(!$wfl_inst){$wfl_inst = $GLOBALS['wfl_inst'];}


    if($wfl_id AND $wfl_inst){
        require_once('extra/workflow/lwf.lib');

    	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style>";
    	echo lmb_wfl_printHistory($wfl_id, $wfl_inst);
    	echo "</DIV>";
    }
}




#------------ J Script ---------------------
function form_js($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	echo "\n<SCRIPT language='JavaScript'>\n";
	echo $gform[$gformid]["inhalt"][$key];
	echo "\n</SCRIPT>\n";
}

#------------ PHP Script ---------------------
function form_php($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult){
	global $gform;
	global $lfel;	
	if($rtrn = eval($gform[$gformid]["inhalt"][$key])){
		if($rtrn === true){$rtrn = '';}
		if($event = dftyp_events(1,$gform[$gformid]["event"][$key],null,null,null,null,null,$null,$gtabid,null)){$style .= ";cursor:pointer;";}
		$style = "STYLE=\"".$pos.$style."\"";
		echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style $event>";
		echo $rtrn;
		echo "</DIV>";
	}
}

#------------ dbnew ---------------------
function form_dbnew($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	#table_newdata($field_id,$tab_id,$filter);
}

#------------ reminder ------------------
function form_reminder($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id) {
	global $gform;

    /* config syntax:
     *
     * datetime => string | e.g. '16.03.2016 22:44'
     * usergroups => string | e.g. '33_u;22_g;55_u' or '' for the current user
     * remark => string
     * mail => 0 or 1
     * category => int | id of category to use, 0 for default
     * hidecurrent => 1 to hide
    
    /*
    $config = array(
        'datetime' => '10.03.2017 22:55',
        'usergroups' => '1_u',
        'remark' => 'testtttt',
        'mail' => 0,
        'category' => 2,
        'hidecurrent' => 1
    );
     */

    $defaults = json_encode(eval($gform[$gformid]["parameters"][$key]));

    if($event = dftyp_events(1,$gform[$gformid][event][$key],null,null,null,null,null,$null,$gtabid,null)){$style .= ";cursor:pointer;";}
	$style = "STYLE=\"".$pos.$style."\"";
    echo "{$gform[$gformid]["inhalt"][$key]}<i class=\"lmb-icon lmb-bell\" ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style $event onclick=\"limbasDivShowReminder(event,this,null,null,null,null,'" . htmlentities($defaults) . "');\" onmousedown=\"this.style.border='1px solid black';\" onmouseup=\"this.style.border='';\"></i>";
}

# --------------------------- List -------------------------------



#------------ tab ---------------------
function formlist_tab($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$style){
	global $gform;
	global $gfield;
	global $gtab;
	global $lang;
	global $farbschema;
	$line = 0;

	$collapse = $style[32];
	$cellstyle = $style[34];
	$overflow = $style[24];
    if(!$style[21]){$cl = "class=\"lmbfringegtab\"";}
    if($style[24] AND $style[24] != 'visible' AND $gform[$gformid]["height"][$key]){$height = $gform[$gformid]["height"][$key];}
	$tab_size = explode(";",$gform[$gformid]['tab_size'][$key]);
	$pos = "top:".$gform[$gformid]["posy"][$key].";left:".$gform[$gformid]["posx"][$key].";";
	$tdsize = explode(";",$gform[$gformid]["parameters"][$key]);
	 
	$style = set_style($style);
	if($cellstyle == 1){$style_ = $style;}

	echo "<div id=\"element".$gform[$gformid]["fid"][$key]."\" style=\"position:absolute;$pos;width:".(array_sum($tdsize))."px;max-height:".$height."px;$style;overflow:visible;\">
	<table $cl id=\"elementTab".$gform[$gformid]["fid"][$key]."\" cellspacing=\"0\" cellpadding=\"0\" STYLE=\"display:inline-block;margin:0px;border-collapse:collapse;border-spacing:1px;\">\n";

	for ($r=1; $r<=$tab_size[1];$r++){
	    
	    // menu
	    if($gform[$gformid]["typ"][$gform[$gformid]["tab_el_key"][$gform[$gformid]["tab"][$key]][1][$r]] == "tabmenu"){
	        lmbGlistMenu($gtabid,1);
	    // scroll
	    }elseif($gform[$gformid]["typ"][$gform[$gformid]["tab_el_key"][$gform[$gformid]["tab"][$key]][1][$r]] == "scroll"){
	        echo "<tr><td>";
	        lmbGlistFooter($gtabid,$gresult,$GLOBALS['filter'],1);
	        echo "</td></tr>";
	    }else{

    		// ------- Datensatz in Zeile vorhanden --------
    		if($gform[$gformid]["tab_el_rowdat"][$gform[$gformid]["tab"][$key]][$r]){
    		    echo "<tr><td><div id=\"elementBody".$gform[$gformid]["fid"][$key]."\" style=\"overflow-y:".$overflow.";overflow-x: hidden;\"><table class=\"lmbfringeGtabBody\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" STYLE=\"overflow:hidden;border-collapse:$collapse;width:".array_sum($tdsize)."\">";
    			$bzm = 0;
    			while($bzm < $gresult[$gtabid]["res_viewcount"]) {
    				formlist_tabrow($key,$gformid,$gtabid,$field_id,$tab_id,$gresult,$tab_size,$r,$bzm,$style_);
    				$bzm++;
    			}
    			echo '</table></div></td></tr>';
    			
    			
    			// --- Keine Ergebnisse ---------------------------------------
    			#if(!$bzm){
    			#	echo "<TR><TD COLSPAN=\"10\" HEIGHT=\"40\" STYLE=\"color:red;\">&nbsp;&nbsp;".$lang[98]."</TD></TR>";
    			#}
    			
    		}else{
    		    echo "<tr><td><div><table class=\"lmbfringeGtabBody\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" STYLE=\"border-collapse:$collapse;width:100%\">";
    			formlist_tabrow($key,$gformid,$gtabid,$field_id,$tab_id,$gresult,$tab_size,$r,0,$style_);
    			echo '</table></div></td></tr>';
    		}

	    }

	}
	echo "</table></div>";
	if($height){
	echo "
	    <script type=\"text/javascript\">
	       var h = ".$height."  - ($('#elementTab".$gform[$gformid]["fid"][$key]."').height() - $('#elementBody".$gform[$gformid]["fid"][$key]."').height());
	       $('#elementBody".$gform[$gformid]["fid"][$key]."').height(h);
	    </script>
	    ";
	}
	
}


#------------ tabrow ---------------------
function formlist_tabrow($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$tab_size,$r,$line,$tabstyle){
	global $gform;
	global $gformlist;
	global $gfield;
	global $gtab;
	global $userdat;
	global $lang;
	global $farbschema;

	if($gresult[$gtabid]['color'][$line]){$BGCOLOR = "#".$gresult[$gtabid]['color'][$line];}
	if($session["data_display"] == 2 AND $verknpf != 1){$is_frame = "1";}else{$is_frame = "0";}

	
    if($gform[$gformid]["typ"][$gform[$gformid]["tab_el_key"][$gform[$gformid]["tab"][$key]][1][$r]] == "dbdat"){
		echo "<TR
		id=\"elrow_".$gresult[$gtabid]["id"][$line]."_".$gtabid."\"
		lmbbgcolor=\"$BGCOLOR\"
		onmouseover=\"lmb_tableRowColor(this,'".$farbschema["WEB7"]."',1)\"
		onmouseout=\"lmb_tableRowColor(this,'',1)\"
		onclick=\"lmbTableClickEvent(event,this,'$gtabid','".$gresult[$gtabid]["id"][$line]."')\"
		oncontextmenu=\"document.form2.form_id.value='".$gformlist[$gtabid]["redirect"][$gformid]."';return div1(event,this,'".$gresult[$gtabid]["id"][$line]."','$gtabid','".$gresult[$gtabid]["ERSTDATUM"][$line]."','".$gresult[$gtabid]["EDITDATUM"][$line]."','".$userdat["bezeichnung"][$gresult[$gtabid]["ERSTUSER"][$line]]."','".$userdat["bezeichnung"][$gresult[$gtabid]["EDITUSER"][$line]]."','','','','');\"
		ondblclick=\"document.form2.form_id.value='".$gformlist[$gtabid]["redirect"][$gformid]."';lmbTableDblClickEvent(event,this,'$gtabid','".$gresult[$gtabid]["id"][$line]."','','".$GLOBALS["verkn_poolid"]."','','','','','');return false; \">\n";
	}else{
		echo "<TR id=\"elrow_0_".$gtabid."\">\n";
	}

	$tdsize = explode(";",$gform[$gformid]["parameters"][$key]);
	# --- Zellen -----
	for ($c=1; $c<=$tab_size[0];$c++){
		#if(!$colspan){
			$cell_key = $gform[$gformid]["tab_el_key"][$gform[$gformid]["tab"][$key]][$c][$r];
			if($cell_key){
				$stylearray = explode(";",$gform[$gformid]["style"][$cell_key]);
				$stylevalue = set_style($stylearray);
				$style = "width:".$tdsize[$c-1]."px;".$stylevalue.";height:".$gform[$gformid]["height"][$cell_key].";";
				$field_id = $gform[$gformid]["field_id"][$cell_key];
				$tab_id = $gform[$gformid]["tab_id"][$cell_key];
				$bgcolor = null;
				if($stylearray[21]){$bgcolor = $stylearray[21];}
				if($gfield[$gtabid]["color"][$field_id]){$bgcolor = $gfield[$gtabid]["color"][$field_id];}

				# default Class
				if($gform[$gformid]["class"][$cell_key]){$class = "CLASS=\"".$gform[$gformid]["class"][$cell_key]."\"";
				}elseif($gform[$gformid]["typ"][$cell_key] == 'dbdesc'){$class = "CLASS=\"gtabHeaderTitleTD\"";}

				echo "<td $class STYLE=\"".$tabstyle.";".$style.";overflow:hidden;\" valign=\"top\" oncontextmenu=\"cell_id = 'td_".$gresult[$gtabid]["id"][$line]."_".$gfield[$gtabid]["field_id"][$field_id]."_".$gtabid."';\" ";
				    if($gform[$gformid]["typ"][$cell_key] == "dbdat"){echo "id=\"td_".$gresult[$gtabid]["id"][$line]."_".$gfield[$gtabid]["field_id"][$field_id]."_".$gtabid."\"";}
				    if($bgcolor AND $gform[$gformid]["typ"][$cell_key] == 'dbdat' AND !$gresult[$gtabid]["color"][$line]){echo "BGCOLOR=\"".$bgcolor."\"";}
				    #if($gform[$gformid]["typ"][$cell_key] == "scroll" OR $gform[$gformid]["typ"][$cell_key] == "tabmenu" OR $gform[$gformid]["typ"][$cell_key] == "menue" OR $gform[$gformid]["typ"][$cell_key] == "fmenue"){echo " COLSPAN=\"".$tab_size[0]."\"";$colspan = 1;}
				echo ">";
				
				#if($gform[$gformid]["typ"][$cell_key] == "menue" OR $gform[$gformid]["typ"][$cell_key] == "fmenue"){echo "<TABLE cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">";}
				$fname = "formlist_".$gform[$gformid]["typ"][$cell_key];
				$fname($cell_key,$gformid,$gtabid,$field_id,$tab_id,$gresult,$line,$stylevalue);
				#if($gform[$gformid]["typ"][$cell_key] == "menue" OR $gform[$gformid]["typ"][$cell_key] == "fmenue"){echo "</TABLE>";}
			}else{
				echo "<td>";
			}
			echo "</td>\n";
		#}
	}
	echo "</TR>";
}


#------------ dbdat ---------------------
function formlist_dbdat($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$line,$style=null){
	global $gfield;
	global $gtab;
	global $gform;
	global $session;
	global $action;
	global $filter;

	$st = explode(";",$gform[$gformid]["style"][$key]);

	if(($filter["alter"][$gtabid] OR $st[35] == 2) AND $gfield[$tab_id]["perm_edit"][$field_id]){$edittyp = 1;}else{$edittyp = 2;}

	if($gfield[$tab_id]["argument"][$field_id]){
		/* ------------------ Argument-Typfunction --------------------- */
		if($gfield[$tab_id]["argument_edit"][$field_id]){$edittyp = 1;}else{$edittyp = 2;}
		#$gresult[$tab_id][$field_id] = cftyp_13($gresult[$gtabid]["id"][$line],$gresult,$field_id,$tab_id,'','',$edittyp);
	}
	$typ = $gfield[$tab_id]["funcid"][$field_id];

	/* ------------------ Default --------------------- */
	$fname = "cftyp_".$typ;
	/* ------------------ Extension --------------------- */
	if($gfield[$tab_id]["ext_type"][$field_id]){
		if(function_exists("lmbc_".$gfield[$gtabid]["ext_type"][$field_id])){
			$fname = "lmbc_".$gfield[$tab_id]["ext_type"][$field_id];
		}
	}
	#------------------ Typfunction ---------------------
	$fname($line,$field_id,$gtabid,$edittyp,$gresult,$gform[$gformid]["event"][$key],$gform[$gformid]["pic_size"][$key]); # pic_size = dest_formid
	#------------------ Typfunction ---------------------
}

#------------ menue ---------------------
#function formlist_tabmenu($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	#table_menu($gtabid,$gresult);
	#echo '<table cellpadding=0 cellspacing=0 width="100%">';
	#lmbGlistMenu($gtabid);
	#echo '</table>';
#}

#------------ fmenu ---------------------
#function formlist_fmenue($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
#	table_tabs($gtabid,$verkn_poolid);
#}

#------------ dbsearch ---------------------
function formlist_dbsearch($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid,$style=null){
	lmbGlistSearchDetail($tab_id,$field_id,$style);
}

#------------ dbdesc ---------------------
function formlist_dbdesc($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid,$style=null){
	lmbGlistHeaderDetail($tab_id,$gresult,$field_id,$key,$gformid,0,$style);
}

#------------ dbnew ---------------------
function formlist_dbnew($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	table_newdata($field_id,$tab_id,$filter);
}

#------------ text ---------------------
function formlist_text($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	global $gform;
	echo str_replace(" ","&nbsp;",nl2br(htmlentities($gform[$gformid]["inhalt"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])));
}


#------------ datum ---------------------
function formlist_datum($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	echo local_date(0);
}

#------------ usetime ---------------------
function formlist_usetime($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	global $gtab;
	print_usetime($gtab,$gtabid);
}

#------------ submit ---------------------
function formlist_submt($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	global $gform;
	$event = cftyp_events($typ,$gform[$gformid][event][$key],null,$gresult,$gtabid,null,$datid);
	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" STYLE=\";cursor:pointer;\" $event OnClick=\"send_form('1');\">";
	echo $gform[$gformid][inhalt][$key];
	echo "<DIV>";
}

#------------ input text ---------------------
function formlist_inptext($key,$gformid,$gtabid,$field_id,$tab_id,$gresult,$datid,$style=null){
	global $gform;
	$event = cftyp_events($typ,$gform[$gformid]["event"][$key],null,$gresult,$gtabid,null,$datid);
	$style = "STYLE=\"width:100%;height:100%;".$style.";border:none\"";
	echo "<INPUT ID=\"element".$gform[$gformid]["fid"][$key]."\" TYPE=\"TEXT\" NAME=\"lfel[".$gform[$gformid][fid][$key]."]\" $style $event VALUE=\"".htmlentities($gform[$gformid]["inhalt"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\" TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\">";
}

#------------ input hidden ---------------------
function formlist_inphidden($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	global $gform;
	echo "<INPUT ID=\"element".$gform[$gformid]["fid"][$key]."\" TYPE=\"HIDDEN\" NAME=\"lfel[".$gform[$gformid][fid][$key]."]\" VALUE=\"".htmlentities($gform[$gformid]["inhalt"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">";
}

#------------ input textarea ---------------------
function formlist_inparea($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	global $gform;
	$event = cftyp_events($typ,$gform[$gformid][event][$key],null,$gresult,$gtabid,null,$datid);
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<TEXTAREA ID=\"element".$gform[$gformid]["fid"][$key]."\" TYPE=\"TEXT\" NAME=\"lfel[".$gform[$gformid][fid][$key]."]\" $style $event TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\">".htmlentities($gform[$gformid]["inhalt"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."</TEXTAREA>";
}

#------------ input select ---------------------
function formlist_inpselect($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid,$style=null){
	global $gform;
	$event = cftyp_events($typ,$gform[$gformid][event][$key],null,$gresult,$gtabid,null,$datid);
	$style = "STYLE=\"width:100%;height:100%;".$style.";border:none\"";
	echo "<SELECT ID=\"element".$gform[$gformid]["fid"][$key]."\" TYPE=\"TEXT\" NAME=\"lfel[".$gform[$gformid][fid][$key]."]\" $style $event TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\">";
	if($gform[$gformid]['inhalt'][$key]){
		$opt = explode("\n",$gform[$gformid]['inhalt'][$key]);
		foreach ($opt as $key => $value){
			echo "<OPTION>$value\n";
		}
	}
	echo "</SELECT>";
}

#------------ input check ---------------------
function formlist_inpcheck($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid,$style=null){
	global $gform;
	$event = cftyp_events($typ,$gform[$gformid][event][$key],null,$gresult,$gtabid,null,$datid);
	$style = "STYLE=\"width:100%;height:100%;".$style.";border:none\"";
	if($gform[$gformid][inhalt][$key] == 1){$CHECKED = "checked";}
	echo "<INPUT ID=\"element".$gform[$gformid]["fid"][$key]."\" TYPE=\"CHECKBOX\" NAME=\"lfel[".$gform[$gformid][fid][$key]."]\" $style $event $CHECKED TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\">";
}

#------------ input radio ---------------------
function formlist_inpradio($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid,$style=null){
	global $gform;
	$event = cftyp_events($typ,$gform[$gformid][event][$key],null,$gresult,$gtabid,null,$datid);
	$style = "STYLE=\"width:100%;height:100%;".$style.";border:none\"";
	if($gform[$gformid]["inhalt"][$key]){
		$opt = explode(" ",$gform[$gformid][inhalt][$key]);
	}
	if($opt[1] == 1){$CHECKED = "checked";}
	echo "<INPUT ID=\"element".$gform[$gformid]["fid"][$key]."\" TYPE=\"RADIO\" NAME=\"lfel[".$opt[0]."]\" VALUE=\"lfel[".$gform[$gformid][fid][$key]."]\" $style $event $CHECKED TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\">";
}

#------------ PHP Script ---------------------
function formlist_php($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	global $gform;
	global $lfel;
	eval($gform[$gformid]["inhalt"][$key]);
}

#------------ Script ---------------------
function formlist_js($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	global $gform;
	echo "\n<SCRIPT language='JavaScript'>\n";
	echo $gform[$gformid]["inhalt"][$key];
	echo "\n</SCRIPT>\n";
}

#------------ bild ---------------------
function formlist_bild($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid,$style=null){
	global $gform;
	global $gtab;
	global $db;
	global $umgvar;

	$path = "UPLOAD/form/".$gform[$gformid]["tab_size"][$key];
	$path1 = "TEMP/thumpnails/form/".lmb_substr($gform[$gformid][tab_size][$key],0,lmb_strrpos($gform[$gformid]["tab_size"][$key],"."));

	if(!file_exists($path1.".png")){
		$cmd = $umgvar["imagemagick"]."/convert ".$umgvar["imagemagicklimit"]." ".$path." ".$path1.".png";
		system($cmd,$out);
	}

	if(file_exists($path1.".png")){
		$event = cftyp_events($typ,$gform[$gformid]["event"][$key],null,$gresult,$gtabid,null,$datid);
		$style = "style=\".position:absolute; left:".$gform[$gformid]["posx"][$key]."; top:".$gform[$gformid]["posy"][$key].";$size; z-index:".$gform[$gformid]["z_index"][$key]."\"";
		echo "<IMG SRC=\"".$path1.".png\" ID=\"element".$gform[$gformid]["fid"][$key]."\" $style $link $event>";
	}
}
?>
