<?php
/**
 * @copyright Limbas GmbH <https://limbas.com>
 * @license https://opensource.org/licenses/GPL-2.0 GPL-2.0
 *
 * This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 */


use Limbas\extra\diagram\LmbChart;
use Limbas\extra\template\base\TemplateConfig;
use Limbas\extra\template\form\FormTemplateConfig;
use Limbas\layout\Layout;


# --------------- Formularelemente --------------------------------------------
function formListElements($action,$gtabid,$ID,&$gresult,$gformid,$ellist=null,$force=null,$readonly=null){
	global $session;
	global $gtab;
	global $gfield;
	global $gform;
	global $gformlist;
	global $umgvar;

	if(!is_array($ellist)){$ellist = $gform[$gformid]["mainellist"];}

	// userdefined css
	if($gformlist[$gtabid]["css"][$gformid]){
 		echo "<style type=\"text/css\">@import url(".$gformlist[$gtabid]["css"][$gformid]."?v={$umgvar['version']});</style>\n";
	}

	// check permission if not already done
	if($readonly === null){
	    $readonly = check_DataPermission($gtabid,$ID,$gresult);
	}

	foreach($ellist as $value => $key){

		$respadd = 0;
		if(!$gform[$gformid]["tab_el_col"][$key] AND !$gform[$gformid]["tab_el_row"][$key]){
			$field_id = $gform[$gformid]["field_id"][$key];
			$tab_id = $gform[$gformid]["tab_id"][$key];
			$stylearray = explode(";",$gform[$gformid]["style"][$key]);
			$collapse = $stylearray[32];

            // workaround for bootstrap style
            if($stylearray[26] == 'none'){$stylearray[26] = $stylearray[26].' !important';}

            // generate style string
			$stylevalue = set_style($stylearray);

			$width = $gform[$gformid]["width"][$key];
			$height = $gform[$gformid]["height"][$key];

            # ----- padding-Verhalten ------
            if($gform[$gformid]["typ"][$key] == "dbdat"){
                if(($gfield[$tab_id]["argument_typ"][$field_id] == 15 AND !$gfield[$tab_id]["argument_edit"][$field_id]) OR !$gfield[$tab_id]["perm_edit"][$field_id] OR $action == 'gtab_deterg' OR $gfield[$tab_id]["data_type"][$field_id] == 46 OR $gfield[$tab_id]["data_type"][$field_id] == 32 OR $gfield[$tab_id]["field_type"][$field_id] == 14 OR $gfield[$tab_id]["field_type"][$field_id] == 15){
                    $respadd = 1;
                }
            }else{$respadd = 1;}

            if($respadd AND is_numeric($stylearray[22])){
                $width = ($width - (2 * $stylearray[22]));
                $height = ($height - (2 * $stylearray[22]));
            }

            # ----- Rahmen-Verhalten bei Mozilla ------
            if($stylearray[19] == 'none'){$height ++;}
            if($stylearray[20] == 'none'){$height ++;}

			# maxlength
			if($stylearray[36] AND $tab_id){
				$maxlength = $gfield[$tab_id]["size"][$field_id];
				$gfield[$tab_id]["size"][$field_id] = $stylearray[36];
			}

			#if(!$tab_id){$tab_id = $gformlist;} # ?????
			$style = "width:".$width."px;height:".$height."px;z-index:".$gform[$gformid]["z_index"][$key];

			#if(!$gform[$gformid]["class"][$key]){ // not use of style
			#	$style = $style.';'.$stylevalue;
			#}
			$style = $style.';'.$stylevalue;
			
            $typearray = array_flip(array('dbdat','tab','frame'));
            if ($readonly and isset($typearray[$gform[$gformid]["typ"][$key]])) {
                $stylearray[35] = 1;
            }

			$pos = "position:absolute;left:".formlist_handlePx($gform[$gformid]["posx"][$key]).";top:".formlist_handlePx($gform[$gformid]["posy"][$key]).";";
			$fname = "form_".$gform[$gformid]["typ"][$key];

			if($gform[$gformid]["class"][$key]){$class=$gform[$gformid]["class"][$key];}else{$class="gtabBodyDetailTR";}

			# check if tabmenu
			if($gform[$gformid]["typ"][$key] == "tabulator"){
				if($gform[$gformid]["subellist"]){

					# special styles
					$tbgcolor = formlist_handleColor($stylearray[21]);
					if($tbgcolor){$tstyle="background-color:$tbgcolor;";}
					echo "<table style=\"left:".formlist_handlePx($gform[$gformid]["posx"][$key]).";top:".formlist_handlePx($gform[$gformid]["posy"][$key]).";height:".$height."px;width:".$width."px;margin:0px;border-collapse:collapse;position:absolute\" cellpadding=\"0\" cellspacing=\"0\"><tr><td valign=\"top\">";

					# menu is left
					if($stylearray[38] >= 2){
						echo "<table style=\"border-collapse:collapse;height:100%\" cellpadding=\"0\" cellspacing=\"0\">";
						$stprfix = "Left";
						# menu is top
					}else{
						echo "<div>";
					}

                    // formularsetting remember position
					if(($stylearray[39] == 1 OR $GLOBALS['old_action'] == 'gtab_change') AND $_REQUEST['action'] != 'gtab_neu'){
						$gf = $GLOBALS["filter"]["tabulatorKey"][$gtabid][$key];
					}else{
						$GLOBALS["filter"]["tabulatorKey"][$gtabid][$key] = null;
					}

					// print tabs
					if($gform[$gformid]["subellist"][$key]){

					    // tabs in mainmenu
					    if($stylearray[38] == 3){
					        require_once(Layout::getFilePath('nav_render.php'));                            
					        $dspl = 'display:none';

                            $bze = 2000;
                            $bzc = 0;
                            foreach ($gform[$gformid]["subellist"][$key] as $sckey => $scval){
                                if(!$sckey){continue;}
                                if(!$gf){$gf = $sckey;}

                                $child[$bzc]['id'] = $bzc;
                                $child[$bzc]['name'] = $gform[$gformid]["inhalt"][$sckey];
                                $child[$bzc]['desc'] = $gform[$gformid]["inhalt"][$sckey];
                                $child[$bzc]['link'] = "window.main.document.getElementById('LmbTabulatorHeader_{$gtabid}_{$sckey}').click();event.stopPropagation();";
                                $GLOBALS['menu_setting']['submenu'][$bze . "_" . $gindex] = 1;
                                $bzc++;
                                $gindex++;
                            }

                            $menu[0]['id'] = 15;
                            $menu[0]['name'] = $gform[$gformid]["parameters"][$key];
                            #$menu[$bze][0]['desc'] = 'test';
                            #$menu[$bze][0]['icon'] = 'test';
                            $menu[0]['child'] = $child;
                            $GLOBALS['menu_setting']['menu'][$bze . "_2100"] = 1;

                            echo "<div id=\"menu-side-container\" style=\"display:none\">";
                            recRender(2100, $menu[0], 1, array('depth0Key' => $bze));
                            echo "</div>";

                            ?>
                            <script>;
                            // get activ menu ID
                            $(function() {
                                var menuID = parent.$('ul.mainmenu:visible').attr('id');
                                var menuContent = $('#menu-side-container').html();
                                menuContent = menuContent.replace(/2000/g, menuID); // set new ID
                                menuContent = menuContent.replace(/clearfix open/g, 'clearfix open form_tabmenu'); // set new class to remove item
                                $('#menu-side-container').html(menuContent);

                                //if(parent.document.getElementById('menu-side-header-'+menuID)) {
                                    //parent.$('#menu-side-header-'+menuID).remove();
                                    //parent.$('.form_tabmenu').remove();
                                //}
                                $('#menu-side-container').children().clone().insertAfter(parent.$('.sidenav-quicksearch:visible'));
                            });

                            </script>
                            <?php
                        }
						foreach ($gform[$gformid]["subellist"][$key] as $sckey => $scval){
							if(!$sckey){continue;}
							if(!$gf){$gf = $sckey;}
							if($gf == $sckey){
                                $class = "lmbGtabTabulator".$stprfix."Active";
                                echo "<script>parent.$('#lmb-main-subtitle').text(' - ".$gform[$gformid]["inhalt"][$sckey]."');</script>";
                            }else{$class="lmbGtabTabulator".$stprfix."Inactive";}

							// tabs left or in mainmenu
							if($stylearray[38] >= 2){
								echo "<tr><td><div id=\"LmbTabulatorHeader_".$gtabid."_".$sckey."\" class=\"$class\" style=\"$tstyle;$dspl\" OnClick=\"lmbSwitchTabulator(this,'$key','$sckey','Left');\">".$gform[$gformid]["inhalt"][$sckey]."&nbsp;</div></td></tr>";
							// tabs top
							}else{
								echo "<div id=\"LmbTabulatorHeader_".$gtabid."_".$sckey."\" class=\"$class\" style=\"$tstyle;\" OnClick=\"lmbSwitchTabulator(this,'$key','$sckey');\">".$gform[$gformid]["inhalt"][$sckey]."&nbsp;</div>";
							}
						}
					}

					if($stylearray[38] >= 2){
						echo "<tr><td style=\"height:100%;\"><div class=\"lmbGtabTabulator".$stprfix."Space\">&nbsp;</div></td></tr>";
						echo "</table>";
						echo "</td><td valign=\"top\">";
					}else{
						echo "<div class=\"lmbGtabTabulatorSpace\">&nbsp;</div>";
						echo "</div>";
					}

					// print container
					echo "<table style=\"margin:0px;border-collapse:collapse;width:".$width."px;height:".$height."px;\" cellpadding=\"0\" cellspacing=\"0\"><tr><td style=\"height:100%\">";
					if($gform[$gformid]["subellist"][$key]){
						foreach ($gform[$gformid]["subellist"][$key] as $sckey => $scval){
							if(!$sckey){continue;}
							# grouping header with tabs
							if($gf != $sckey){$dst = "display:none;";}else{$dst = "";}
							echo "<div id=\"LmbTabulatorItem_".$gtabid."_".$sckey."\" class=\"lmbGtabTabulator".$stprfix."Frame\" style=\"$tstyle;$dst;position:relative;width:100%;height:100%;overflow:".$stylearray[24].";\">";
							formListElements($action,$gtabid,$ID,$gresult,$gformid,$gform[$gformid]["subellist"][$key][$sckey],$force,$readonly);
							echo "</div>";
						}
					}
					echo "</td></tr></table>";

					echo "</td></tr></table>";

				}
			# check if mainmenu
			}elseif($gform[$gformid]["typ"][$key] == "menue"){

				$mbgcolor = formlist_handleColor($stylearray[21]);
				if($mbgcolor){$mstyle="background-color:$mbgcolor;";}
				# print menu top
				$gf = form_menue($key,$gformid,$pos,$style,"CLASS=\"".$gform[$gformid]["class"][$key]."\"",$ID,$gtabid,$action,$field_id,$tab_id,$gresult,1,$readonly);
				# list of subelements in menu
				if($gform[$gformid]["subellist"][$key]){
					echo "<div id=\"GtabTableBody\" style=\"height:".$height."px;overflow:".$stylearray[24]."\">";
					# group elements for categories
					foreach ($gfield[$gtabid]["sort"] as $sckey => $scval){
						if($gfield[$gtabid]["field_type"][$sckey] == 100){
							$hascategorie = 1;
							if(!$sckey){continue;}
							# grouping header with tabs
							if(!$gf){$gf = $sckey;}
							if($gf != $sckey && $GLOBALS["filter"]["groupheader"][$gtabid]){$dst = "display:none;";$force=0;}else{$dst = "";$force=1;}
							#echo "<div class=\"".$class."\" id=\"LmbHeaderPart_".$gtabid."_".$sckey."\" style=\"$dst;position:relative;width:".$width."px;height:".$height."px;overflow:".$stylearray[24].";$mstyle\">";
							echo "<div class=\"".$class."\" id=\"LmbHeaderPart_".$gtabid."_".$sckey."\" style=\"$dst;position:relative;width:".$width."px;height:100%;overflow:".$stylearray[24].";$mstyle\">";
							# tabulator elements
							if($gform[$gformid]["subellist"][$key][$sckey]){$subellist_a = $gform[$gformid]["subellist"][$key][$sckey];}else{$subellist_a = array();}
							# all elements
							if($gform[$gformid]["subellist"][$key][0]){$subellist_b = $gform[$gformid]["subellist"][$key][0];}else{$subellist_b = array();}
							$subellist = array_merge($subellist_b,$subellist_a);
							if(!$gfield[$gtabid]["ajaxpost"][$sckey] OR $force){
								formListElements($action,$gtabid,$ID,$gresult,$gformid,$subellist,$force,$readonly);
							}
							echo "</div>";
						}
                        // disable category tabs - show only tab "all elements"
                        if(!$GLOBALS["filter"]["groupheader"][$gtabid]){break;}
					}

					if(!$hascategorie){
						$hascategorie = 1;
						echo "<div class=\"".$class."\" id=\"LmbHeaderPart_".$gtabid."_".$sckey."\" style=\"$dst;position:relative;width:".$width."px;height:100%;overflow:".$stylearray[24].";$mstyle\">";
						formListElements($action,$gtabid,$ID,$gresult,$gformid,$gform[$gformid]["subellist"][$key][0],1,$readonly);
						echo "</div>";
					}

					echo "</div>";
				}
				# print menu bottom
				form_menue($key,$gformid,null,null,null,$ID,$gtabid,$action,null,null,$null,2,$readonly);

				# single element
			}elseif($gform[$gformid]["typ"][$key] != "tabuItem"){
				if($gform[$gformid]["class"][$key]){
                    if($gform[$gformid]["typ"][$key]== 'dbdat' OR $gform[$gformid]["typ"][$key] == 'dbdesc'){
                        $fclass = $gform[$gformid]["class"][$key];
                    }else{
                        $fclass = "CLASS=\"".$gform[$gformid]["class"][$key]."\"";
                    }
                }else{
                    $fclass = "";
                }
				$fname($key,$gformid,$pos,$style,$fclass,$ID,$gtabid,$action,$field_id,$tab_id,$gresult,$gform[$gformid]["z_index"][$key],$collapse,$stylearray[35]);
				echo "\n";
			}

			# maxlength zurücksetzen
			if($maxlength){
				$gfield[$tab_id]["size"][$field_id] = $maxlength;
			}

		}
	}
}

# create single gresult for each relation
function form_gresult($ID,$gtabid,$form_id,&$gresult,$self=null,$verkn=null){
	global $gfield;
	global $gform;
	static $recursive;
	
	if(!$self){$recursive = null;}
	if($recursive[$gtabid]){return;}
	$recursive[$gtabid] = 1;

    // relation parameters values
	if($verkn['id'] AND $vgtabid_ = $gfield[ $verkn['tabid'] ]['verknparams'][$verkn['fieldid']]){
        if($parelts = $gform[$form_id]['paramrel'][ $verkn['md5tab'] ]){
            $onlyfield[$vgtabid_] = $parelts;
            $extension['where'][] = "ID = ".$verkn['id'];
            $extension['where'][] = "VERKN_ID = $ID";
            $filter['validity'][$vgtabid_] = 'all';
            $gresult_ = get_gresult($vgtabid_,null,$filter,null,null,$onlyfield,null,$extension);
            $gresult[$vgtabid_] = $gresult_[$vgtabid_];
        }
	}

	// parent relation values
	if($gfield[$gtabid]['verknfields']){
		# all relation fields
		foreach ($gfield[$gtabid]['verknfields'] as $fieldid => $value){

		    $onlyfield = null;
			$gtabid_ = $gfield[$gtabid]['verkntabid'][$fieldid];
			$parelts = $gform[$form_id]['parentrel'][$gfield[$gtabid]['md5tab'][$fieldid]];
            // backward 1:n direct relation - workaround for missing md5tab
            if($gfield[$gtabid]['data_type'][$fieldid] == 25 && $gfield[$gtabid]["verkntabletype"][$fieldid] == 2){
                $parelts = $gform[$form_id]['parentrel'][$gfield[$gtabid]['md5tabBD'][$fieldid].'_BD'];
            }

			$verkn = null;
			if($parelts){

				$onlyfield[$gtabid_] = $parelts;
				$verkn = set_verknpf($gtabid,$fieldid,$ID,0,0,1,0);
				$filter['getlongval'][$gtabid_] = 1;
				$filter['validity'][$gtabid_] = 'all';

                // extract parameters from relation fields
                $extension = null;
				if($gform[$form_id]['parameters']){
                    foreach($gform[$form_id]['tab_id'] as $pkey => $pval){
                        if($gform[$form_id]['parameters'][$pkey] AND $pval == $gtabid_ AND in_array($gform[$form_id]['field_id'][$pkey],$parelts)){
                            $parameters_ .= $gform[$form_id]['parameters'][$pkey];
                        }
                    }
                }
                if($parameters_) {
                    eval($parameters_.';');
                }

                if($gsr){
				    $gsr = array_merge($GLOBALS["gsf"],$gsr);
                }else{
				    $gsr = $GLOBALS["gsf"];
                }

				if($gresult_ = get_gresult($gtabid_,1,$filter,$gsr,$verkn,$onlyfield,null,$extension)){
					$ID_ = $gresult_[$gtabid_]["id"][0];
					$gresult[$gtabid_] = $gresult_[$gtabid_];
					// origin of relation fields in forms
					$gresult[$gtabid_]['parentage'] = $gtabid.'_'.$fieldid.'_'.$ID;
				}
			}
	
			/**
             * recursive call - zeige Inhalte von Unterferknüpfungen an
             * funtioniert nur wenn die ganze Verknüpungskette im Formular existiert!!
             * kann nur ein Feld sein das versteckt ist.
             */

			if($ID_){
				form_gresult($ID_,$gtabid_,$form_id,$gresult,1, $verkn);
			}
		}
	}
}


#------------ Feld gelöscht! ---------------------
/*
function dftyp_warningDelete($key,$gformid,$pos,$style,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$z_index){

	global $gform;
	global $gfield;
	global $gtab;
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<DIV $style $event>";
	echo "field used in formular not in table or without rights!<br>";
	echo "table: ".$gtab['desc'][$tab_id]." (ID $tab_id) - field:<b>".$gfield[$tab_id]["spelling"][$field_id]." (ID $field_id)</b>";
	echo "</DIV>";

}
*/

#------------ dbdat ---------------------
/**
 * @param int $key
 * @param int $gformid
 * @param string $pos css-style-string containing the top:... left:...
 * @param string $style another css-style-string
 * @param string $class css classes to add to the element
 * @param int $ID dataset id
 * @param int $gtabid table id of table hosting the report
 * @param string $action limbas action, e.g. gtab_change
 * @param int $field_id field id of dbdat
 * @param int $tab_id table id of dbdat
 * @param array $gresult from get_gresult()
 * @param int $z_index css z-index
 * @param null $collapse
 * @param bool $readonly whether to display the input as readonly field
 */
function form_dbdat($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$z_index=null,$collapse=null,$readonly=null){
	global $gfield;
	global $gtab;
	global $gform;
	global $session;
	#global $gdublicate;

	$noedit = 1;

	# ----------- View Permission from Field-Rule -----------
	if($gfield[$tab_id]["viewrule"][$field_id]){
		$returnval = eval(trim($gfield[$tab_id]["viewrule"][$field_id]).";");
		if($returnval){return;}
	}

	# ----------- Edit Permission -----------
	if($gfield[$tab_id]["perm_edit"][$field_id] AND $readonly != 1){$noedit = 0;}

	# ----------- Edit Permission from Table-Rule -----------
	/*
	if(!$noedit AND $gtab["editrule"][$tab_id]){
		#$rownr = 0;
		
	    error_log('a '.$readonly);
	    
		$noedit = check_GtabRules($ID,$tab_id,$field_id,$gtab["editrule"][$tab_id],0,$gresult);
	}
	*/

	# ----------- Edit Permission from Field-Rule -----------
	if(!$noedit AND $gfield[$tab_id]["editrule"][$field_id]){
		$noedit = check_GtabRules($ID,$tab_id,$field_id,$gfield[$tab_id]["editrule"][$field_id],0,$gresult);
	}

	# ----------- Argument Typfunction -----------
	if($gfield[$tab_id]["argument"][$field_id] AND $gfield[$tab_id]["argument_typ"][$field_id] == 15){
		if(!$gfield[$tab_id]["argument_edit"][$field_id]){$noedit = 1;}
		if(($action == 'gtab_change' OR $action == 'gtab_neu') AND !$noedit){$edittyp = 1;}else{$edittyp = 2;}
		$gresult[$tab_id][$field_id][0] = dftyp_13($ID,$gresult,$field_id,$tab_id,'','','',$edittyp);
	}else{
		if(($action == 'gtab_change' OR $action == 'gtab_neu') AND !$noedit AND $gfield[$tab_id]["argument_typ"][$field_id] != 47){$edittyp = 1;}else{$edittyp = 2;}
	}

	$typ = $gfield[$tab_id]["funcid"][$field_id];
	$pos = $pos."z-index:".$z_index.";";
	#------------------ Typfunction ---------------------
	/* ------------------ Default --------------------- */
	if(!$typ){return;}
	#if(!$typ){$typ = "warningDelete";}
	$fname = "dftyp_".$typ;
	/* ------------------ Extension --------------------- */
	if($gfield[$tab_id]["ext_type"][$field_id]){
		if(function_exists("lmbd_".$gfield[$tab_id]["ext_type"][$field_id])){
			$fname = "lmbd_".$gfield[$tab_id]["ext_type"][$field_id];
		}
	}
	#------------------ Typfunction ---------------------
	#if($edittyp == 1){
	#if($gdublicate[$tab_id][$field_id]){$edittyp = 2;}
	#$gdublicate[$tab_id][$field_id] = 1;
	#}
	if($class){$fclass = $class;}else{$fclass = "fgtabchange";}

	# use new ID of fields from related Tables / important for update
	if($gtabid != $tab_id){
		$ID = $gresult[$tab_id]['id'][0];
		if(!$ID) {
            if (!$gresult[$tab_id]['parentage']) {
                $ID = null;
                $edittyp = 2;
            }else{
                $ID = 0;
            }
        }
	}

	$fname($ID,$gresult,$field_id,$tab_id,$fclass,$style,$pos,$edittyp,$z_index,$gform[$gformid]["event"][$key],$gformid,$key,$gform[$gformid]["pic_size"][$key]); // pic_size == language
}

#------------ dbdesc ---------------------
function form_dbdesc($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult){
	global $gform;
	global $gfield;
	global $gtab;

	# ----------- View Permission from Field-Rule -----------
	if($gfield[$tab_id]["viewrule"][$field_id]){
		$returnval = eval(trim($gfield[$tab_id]["viewrule"][$field_id]).";");
		if($returnval){return;}
	}

	if($event = dftyp_events($typ,$gform[$gformid]["event"][$key],null,null,null,null,null,$gresult,$gtabid,$field_id)){$style .= ";cursor:pointer;";}
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<DIV ID=\"d_".$gtabid."_".$field_id."\" $class $style $event title=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">";
	echo $gfield[$tab_id]["spelling"][$field_id]."<span class=\"gtabBodyDetailNeedTitle\">".lmb_substr($gfield[$tab_id]["need"][$field_id],0,1)."</span>";
	echo "</DIV>";
}

#------------ dbsearch ---------------------
function form_dbsearch($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id){

    // field based search in table header
    if($field_id) {
        echo "<div style=\"$pos\">";
        lmbGlistSearchDetail($tab_id, $field_id, $style);
        echo "</div>";
    // full search - deprecated
    }else{
        $gresult = null;
        formlist_globsearch($key,$gformid,$gtabid,$field_id,$tab_id,$gresult,null);
    }
}

#------------ filter menue ---------------------
function form_filter($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult){
	global $gform;
    global $LINK;
    global $snap_id;

    # parse parameters
    /*
    if(substr($gform[$gformid]["parameters"][$key],0,6) == 'return'){
        $filtergroup = eval($gform[$gformid]["parameters"][$key].';');
    }elseif($gform[$gformid]["parameters"][$key]){
        $filtergroup = $gform[$gformid]["parameters"][$key];
    }
    */
    ?>
    <div class="input-group input-group-sm mb-3" style="<?=$pos.$style?>">
        <?php if ($LINK[225]){?>
            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#snapfilter-menu"><i class="lmb-icon lmb-filter"></i></button>
        <?php }else{?>
            <span class="input-group-text"><i class="lmb-icon lmb-filter"></i></span>
        <?php }?>

        <select id="globalFilter" class="form-select" onchange="document.form1.snap_id.value=this.value;document.form2.snap_id.value=this.value;send_form(1);"><option value='0'>
            <?php
            SNAP_print_select($gtabid,$snap_id);
            ?>
        </select>
    </div>

    <?php
    #echo "<div style=\"$pos\">";
    #lmbGlistSearchFilter($gtabid, $filtergroup, $style);
    #echo "</div>";

}

#------------ dbnew ---------------------
function form_dbnew($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id){
    $style = $style.';'.$pos;
    table_newdata($field_id,$tab_id,$filter,$style);
}

#------------ bild ---------------------
function form_bild($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	global $gtab;
	global $db;
	global $umgvar;

	if($event = dftyp_events($typ,$gform[$gformid]['event'][$key],null,null,null,null,null,$null,$gtabid,null)){$style .= ";cursor:pointer;";}
	$width = $gform[$gformid]["width"][$key];
	$height = $gform[$gformid]["height"][$key];
	#$size = ";width:".$width."; height:".$height;
	$path = UPLOADPATH . 'form/'.$gform[$gformid]["tab_size"][$key];
	$dest = TEMPPATH . 'thumpnails/' . $gform[$gformid]["tab_size"][$key];
	$style = "STYLE=\"".$pos.$style."\"";

	$secname = $pathinfo[0] = $path;
	$mimeid = $pathinfo[1];

	$url = lmb_getThumbnail($path,$width,$height,null,null,$dest);

	if($url){
		#$style = "style=\"position:absolute; left:".$gform[$gformid]['posx'][$key]."; top:".$gform[$gformid]['posy'][$key].";$size; z-index:".$gform[$gformid]['z_index'][$key]."; ".$stylevalue."\"";
		echo "<IMG SRC=\"".$url."\" ID=\"pic".$key."_".$gformid."\" $class $style $event title=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">";
	}
}

#------------ chart ---------------------
function form_chart($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult){
	global $gform;
	global $gtab;
	global $umgvar;
	global $gsr;
	global $filter;
	global $verkn;
	global $extension;

	if($event = dftyp_events($typ,$gform[$gformid]['event'][$key],null,null,null,null,null,$null,$gtabid,null)){$style .= ";cursor:pointer;";}
	$width = $gform[$gformid]["width"][$key];
	$height = $gform[$gformid]["height"][$key];
	$diag_id = $gform[$gformid]["tab_id"][$key];
	$style_ = "STYLE=\"".$pos.$style."\"";
	$stylearray = explode(";",$gform[$gformid]["style"][$key]);
	if($gform[$gformid]["parameters"][$key]){eval($gform[$gformid]["parameters"][$key]);}
	
	$path = LmbChart::makeChart($diag_id, $gsr, $filter, $verkn, $extension, $width, $height, $stylearray);

	if($path){
        $url = lmb_getDownloadHash($path,'','image/png');
		echo "<IMG SRC=\"".trim($url,'/')."\" ID=\"pic".$key."_".$gformid."\" $class $style_ $event title=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">";
	}
}


#------------ uform ---------------------
function form_uform($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$z_index,$collapse,$readonly){
	global $gform;
	global $gformlist;
	global $gfield;
	global $gtab;
	global $db;

    require_once(COREPATH . 'gtab/gtab_type_erg.lib');

	$styleset = "style=\"".$pos.$style."\"";

	# IFRAME
	if($gform[$gformid]["uform_vtyp"][$key] == 1){
		# userdefined
		if($gform[$gformid]["uform_typ"][$key] == 1){
			$src = "src=\"".eval($gform[$gformid]['parameters'][$key].";")."\"";
			echo "<iframe id=\"element".$gform[$gformid]["fid"][$key]."\" title=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\" name=\"iframe_".$gform[$gformid]["fid"][$key]."\" $src $class $styleset></iframe>";
			# form
		}elseif($gform[$gformid]["uform_typ"][$key] == 2){
			$parameters = "&".eval($gform[$gformid]['parameters'][$key].";");
			echo "<iframe id=\"element".$gform[$gformid]["fid"][$key]."\" title=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\" name=\"iframe_".$gform[$gformid]["fid"][$key]."\" src=\"main.php?action=gtab_erg&gtabid=".$gform[$gformid]["tab_id"][$key]."&form_id=".$gform[$gformid]["tab_group"][$key].$parameters."\" $class $styleset></iframe>";
			# table
		}elseif($gform[$gformid]["uform_typ"][$key] == 3){
			$parameters = "&".eval($gform[$gformid]['parameters'][$key].";");
			echo "<iframe id=\"element".$gform[$gformid]["fid"][$key]."\" title=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\" name=\"iframe_".$gform[$gformid]["fid"][$key]."\" src=\"main.php?action=gtab_erg&gtabid=".$gform[$gformid]["tab_id"][$key].$parameters."\" $class $styleset></iframe>";
		}
	# DIV
	}elseif($gform[$gformid]["uform_vtyp"][$key] == 2){
		# userdefined
		if($gform[$gformid]["uform_typ"][$key] == 1){
			echo "<div id=\"element".$gform[$gformid]["fid"][$key]."\" title=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\" $class $styleset>";
			if($gform[$gformid]['parameters'][$key]){eval($gform[$gformid]['parameters'][$key].";");}
			echo "</div>";
		# subform
		}elseif($gform[$gformid]["uform_typ"][$key] == 2){
			$stylearray = explode(";",$gform[$gformid]["style"][$key]);
			if($stylearray[24]){$styleset = $pos.$style;}else{$styleset = $pos;}
			$filter["anzahl"][$gtabid] = "all";
			if($gform[$gformid]['parameters'][$key]){eval($gform[$gformid]['parameters'][$key].";");}
			echo "<div id=\"element".$gform[$gformid]["fid"][$key]."\" title=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\" style=\"$styleset\">";
			if($gformlist[$gform[$gformid]["tab_id"][$key]]["typ"][$gform[$gformid]["tab_group"][$key]] == 2){
				$ugresult = get_gresult($gform[$gformid]["tab_id"][$key],null,$filter,$gsr,$verkn,$onlyfield);
				require_once(COREPATH . 'gtab/gtab_erg.lib');
				form_ergview($gform[$gformid]["tab_id"][$key],$ugresult,$gform[$gformid]["tab_group"][$key]);
			}else{
				$ugresult = get_gresult($gform[$gformid]["tab_id"][$key],null,$filter,$gsr,$verkn,$onlyfield,$ID);
				form_gresult($ID,$gform[$gformid]["tab_id"][$key],$gform[$gformid]["tab_group"][$key],$ugresult); # need for fields of related tables
				#form_view($gform[$gformid]["tab_id"][$key],$ID,$ugresult,$gform[$gformid]["tab_group"][$key]);
				formListElements('gtab_change',$gform[$gformid]["tab_id"][$key],$ID,$ugresult,$gform[$gformid]["tab_group"][$key]);
			}
			echo "</div>";
		# table
		}elseif($gform[$gformid]["uform_typ"][$key] == 3){
			global $filter;

			$gtabid = $gform[$gformid]["tab_id"][$key];
			$fieldid = $key."_".$gformid;
			$vuniqueid = "g_0_".$fieldid;
			$linklevel["tabid"] = $gtabid;
			$gsr = $filter["ext_RelationFields"]["searchval"][$vuniqueid];
			$vfilter["order"][$gtabid] = $filter["ext_RelationFields"]["order"][$vuniqueid];

            // check for permission
            if(!$gtab['table'][$gtabid]){return;}

			# specific formular styles
			$st = explode(";",$gform[$gformid]["style"][$key]);
			if($st[24]){ #overflow
				if($st[24] == 'scroll'){$st[24] = 'auto';} # scroll soll als auto behandelt werden
				$bt = "height:".$gform[$gformid]["height"][$key]."px;overflow:".$st[24];
			}else{
				$bt = "";
			}
			$style_abs = str_replace(";height:",";height_:",$styleset); # workaround to disable height
			$style_abs = str_replace(":scroll;",":auto;",$style_abs); # workaround to disable overflow scroll

			# specific formular filter
			if($gform[$gformid]["parameters"][$key]){
			$filter_ = eval($gform[$gformid]["parameters"][$key]);
			if(is_array($filter_)){
				foreach ($filter_ as $fkey => $fval){
					if($fkey == 'showfields' AND !$filter["ext_RelationFields"][$vuniqueid]){
						$filter["ext_RelationFields"][$vuniqueid] = $fval;
					}elseif($fkey == 'order'){
						if(!$vfilter["order"][$gtabid]){
							$vfilter["order"][$gtabid] = $fval;
						}
					}else{
						$filter["ext_RelationFields"][$fkey][$vuniqueid] = $fval;
					}
				}
			}
			}

			// use relation view for manual relation in ext_RelationFields setting
			if($filter["ext_RelationFields"]["relation"][$vuniqueid]){
			    echo "<div $style_abs class=\"gtabFringeRelationBody form-legacy\">\n";
                dftyp_14($filter["ext_RelationFields"]["relation"][$vuniqueid]['ID'],$gresult,$filter["ext_RelationFields"]["relation"][$vuniqueid]['field_id'],$filter["ext_RelationFields"]["relation"][$vuniqueid]['tab_id'],null,null,null,1,null,null,$gformid,$formid);
                echo "</div>";
                return;
            }

			if(!$filter["ext_RelationFields"][$vuniqueid]){$filter["ext_RelationFields"][$vuniqueid] = $gfield[$gtabid]["key"];}
			#$vfilter["anzahl"][$gtabid] = $filter["ext_RelationFields"]["count"][$vuniqueid];
			#$vfilter["page"][$gtabid] = $filter["ext_RelationFields"]["page"][$vuniqueid];

			get_countFilter($gtabid,$vuniqueid,$params,$vfilter);

			if(!$filter["ext_RelationFields"]['nogresult'][$vuniqueid]){
			    $onlyfield[$gtabid] = $filter["ext_RelationFields"][$vuniqueid];
			    $ugresult = get_gresult($gtabid,2,$vfilter,$gsr,$verkn,$onlyfield,null,$extension);
			}

			if(($action == 'gtab_change' OR $action == 'gtab_neu') AND !$readonly){$edittyp = 1;}else{$edittyp = 2;}

			echo "<div $style_abs class=\"gtabFringeRelationBody form-legacy\">\n";
			if(!$filter["ext_RelationFields"]["no_menu"][$vuniqueid]){
				dftyp_14_header($gtabid,$fieldid,$ID,$vuniqueid,$gformid,$key,$edittyp,$linklevel,$z_index,null,$filter);
			}
			# table
			echo "<div style=\"width:100%;$bt\" lmbHeight=\"$bt\" ID=\"extRelationFieldsTab_".$gtabid."_".$fieldid."\">";
			cftyp_14_d($ugresult,$rscount,1,$verkn,$gtabid,$gtabid,$fieldid,$ID,$VID,$linklevel,$vuniqueid,$gformid,$key,$filter);
			echo "</div>";

            // pagination placeholder
            if($filter["ext_RelationFields"]["pagination"][$vuniqueid]) {
                echo "<div id=\"extRelationFooter_".$gtabid."_".$fieldid."\"></div>";
            }

			echo "</div>";
		}
	}
}


#------------ tab ---------------------
function form_tab($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$z_index,$collapse,$readonly){
	global $gform;
	global $gfield;
	global $gtab;
	global $action;

	$typearray = array_flip(array('dbdat','tab','frame'));
	$tab_size = explode(";",$gform[$gformid]["tab_size"][$key]);
	$tdsize = explode(";",$gform[$gformid]["parameters"][$key]);

	$stylearray_tab = explode(";",$gform[$gformid]["style"][$key]);
	$style_div = set_style($stylearray_tab);
	# zeigt gesammte Höhe an
	if($stylearray_tab[24]){$height = "height:".$gform[$gformid]["height"][$key]."";}
	$tab_style = "style=\"border-collapse:$collapse;\"";
    if(!$stylearray_tab[34]){$style_div_ = $style_div;}

	echo "
	<div $class style=\"".$pos.";width:".$gform[$gformid]["width"][$key].";$height;$style_div_\">
	<table cellpadding=0 cellspacing=0 $tab_style id=\"element".$gform[$gformid]["fid"][$key]."\">";

	# rows
	for ($r=1; $r<=$tab_size[1];$r++){
		$colspan = "";
		echo "<tr>";
		# cells
		for ($c=1; $c<=$tab_size[0];$c++){
			if($colspan-- > 1){continue;}
			$cell_key = $gform[$gformid]["tab_cell"][$gform[$gformid]["tab"][$key]][$c][$r];
			if($cell_key){
				$stylearray = explode(";",$gform[$gformid]["style"][$cell_key]);
				$align = "align=\"".$stylearray[12]."\"";
				$valign = "valign=\"".$stylearray[23]."\"";
				unset($stylearray[23],$stylearray[12]);
				$stylevalue = set_style($stylearray);
				$class = $gform[$gformid]["class"][$cell_key];
				# inherit style from table
				if($stylearray_tab[34]){
				    $stylevalue = $style_div.";".$stylevalue;
				    $class = $gform[$gformid]["class"][$key]." ".$gform[$gformid]["class"][$cell_key];
				}

				# colspan
				if($stylearray[37]){$colspan = $stylearray[37]; $CLSP = "colspan=\"".$stylearray[37]."\"";}else{$CLSP = "";}
				# width
				$tdwidth = "width:".$tdsize[$c-1];
				# event
				if($event = dftyp_events($typ,$gform[$gformid]['event'][$cell_key],null,null,null,null,null,$null,$gtabid,null)){$stylevalue .= ";cursor:pointer;";}


				echo "<td id=\"element".$gform[$gformid]["fid"][$cell_key]."\" class=\"$class\" style=\"$stylevalue;$tdwidth\" $align $valign $event $CLSP>";

				if($gform[$gformid]["tab_cellel"][$gform[$gformid]["tab"][$key]][$c][$r]){
					foreach ($gform[$gformid]["tab_cellel"][$gform[$gformid]["tab"][$key]][$c][$r] as $numkey => $cellElkey){
                        $height_ = '';
                        if($gform[$gformid]["height"][$cellElkey]){$height_ = 'height:'.$gform[$gformid]["height"][$cellElkey].'px';}
						$tab_id = $gform[$gformid]["tab_id"][$cellElkey];
						$field_id = $gform[$gformid]["field_id"][$cellElkey];
						$styleElarray = explode(";",$gform[$gformid]["style"][$cellElkey]);
						$styleElvalue = set_style($styleElarray).";position:relative;width:".$gform[$gformid]["width"][$cellElkey]."px;$height_;z-index:".$gform[$gformid]["z_index"][$cellElkey];
						// readonly from editrule
                        if ($readonly and isset($typearray[$gform[$gformid]["typ"][$cellElkey]])) {$styleElarray[35] = 1;}
                        
                        $fname = "form_".$gform[$gformid]["typ"][$cellElkey];

                        if($gform[$gformid]["typ"][$cellElkey] == 'dbdat' OR $gform[$gformid]["typ"][$cellElkey] == 'dbdesc'){
                            $itemclass = $gform[$gformid]["class"][$cellElkey];
                        }else{
                            $itemclass = 'class="'.$gform[$gformid]["class"][$cellElkey].'"';
                        }
						$fname($cellElkey,$gformid,'',$styleElvalue,$itemclass,$ID,$gtabid,$action,$field_id,$tab_id,$gresult,$gform[$gformid]["z_index"][$cellElkey],$collapse,$styleElarray[35]);
					}}
			}
			echo "</td>";
		}
		echo "</tr>";
	}

	echo "</table></div>";
}


#------------ system tablist ---------------------
function form_stab($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,$gresult){
	global $gform;
	global $gfield;
	global $gtab;
	global $gsnap;
	global $filter;

	$pos = "top:".formlist_handlePx($gform[$gformid]["posy"][$key]).";left:".formlist_handlePx($gform[$gformid]["posx"][$key]).";";
	$snap_id = $gform[$gformid]["tab_id"][$key];
	$view = explode(";",$gform[$gformid]["tab_size"][$key]);

	if($snap_id AND $gsnap[$gtabid]["id"][$snap_id] AND (!$filter["snapisset"][$snap_id] OR $filter["snapid"][$gtabid] != $snap_id)){
		SNAP_get_filter($snap_id,$gtabid);
		# new gresult
		$gresult = get_gresult($gtabid,1,$filter,$GLOBALS["gsr"],null,$gform[$gformid]["used_fields"]);
	}

	echo "<div $class style=\"position:absolute;".$pos.$style."\">\n";
	lmbGlistOpen();
	if($view[0] == "true"){lmbGlistTabs($gtabid,null,$snap_id);}
	if($view[1] == "true"){lmbGlistMenu($gtabid);}
	if($view[2] == "true"){lmbGlistSearch($gtabid,null,null);}
	lmbGlistHeader($gtabid,$gresult,0);
	lmbGlistBody($gtabid,$gresult,1,null,null,$filter,0,0,0,0,1);
	if($view[3] == "true"){lmbGlistFooter($gtabid,$gresult,$filter);}
	lmbGlistClose();
	echo "</div>";

}




#------------ main-menu ---------------------
function form_menue($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$part=0,$readonly=0){
	global $lang;
	global $gfield;
	global $gform;
	global $gtab;

	$showel = explode("_",$gform[$gformid]["pic_size"][$key]);

	# Kopfelemente
	if($part == 1){
		$stylearray = explode(";",$gform[$gformid]["style"][$key]);

		echo "<table class=\"lmbfringeGtab\" id=\"gtabDetail\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"$pos;margin:0px;\">\n";

		# Verknüpfungsreiter
		if(in_array("0",$showel) AND $ID){
			echo "<tr><td>";
			print_linktags($gtabid,$GLOBALS["verkn_poolid"],$ID,$gresult);
			echo "</td></tr>";
			$hastop = 1;
        # Tabreiter
		}elseif(in_array("3",$showel)){
			echo "<tr><td>";
			print_linktags($gtabid,$GLOBALS["verkn_poolid"],$ID,$gresult,1);
			echo "</td></tr>";
			$hastop = 1;
		}

		# menu
		if(in_array('1',$showel)){
			if(!$hastop){echo "<tr class=\"gtabBodyDetailTopBorder\"><td></td></tr>";}
			echo "<tr><td>";
			print_menue($gtabid,$gresult,$GLOBALS["verkn_addfrom"],$readonly,$showel);
			echo "</td></tr>";
		}

        echo "<tr><td>";
        print_notice($gtabid,$ID,$gresult);
        echo "</td></tr>";

		echo "<tr><td><table class=\"gtabBodyDetailFringe\" style=\"width:100%\">";

		# Submenu
		if($GLOBALS["filter"]["groupheader"][$gtabid]){
			echo "<tr class=\"gtabBodyDetailTopSpace\"><td></td></tr>\n";
			if(in_array(100,$gfield[$gtabid]["field_type"])){

				# first define all visible tabulators
				foreach ($gfield[$gtabid]["sort"] as $gkey => $gvalue){
					if($gfield[$gtabid]["field_type"][$gkey] == 100){
						# ----------- Viewrule -----------
						if($gfield[$gtabid]["viewrule"][$gkey]){
							$returnval = eval(trim($gfield[$gtabid]["viewrule"][$gkey]).";");
							if($returnval){continue;}
						}
						$tablist[$gkey] = 1;
					}
				}

				echo "<tr class=\"gtabBodyDetailSubheader\"><td>\n";
				if(($stylearray[39] == 1 OR $GLOBALS['old_action'] == 'gtab_change') AND $tablist[$GLOBALS["filter"]["groupheaderKey"][$gtabid]]){
					$gf = $GLOBALS["filter"]["groupheaderKey"][$gtabid];
				}
				echo "<table class=\"lmbGtabSubheaderTable\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\"><tr>\n";
				echo "<td class=\"tabpoolItemSpaceGtab\" style=\"width:20px;\">&nbsp;&nbsp;</td>\n";
				foreach ($tablist as $gkey => $gvalue){
					if(!$gf){$gf = $gkey; $GLOBALS["filter"]["groupheaderKey"][$gtabid] = $gkey;}
					if($gf == $gkey){$class = "lmbGtabSubheaderActive";}else{$class = "lmbGtabSubheaderInactive";}
					echo "<td id=\"LmbTabulatorMenu_".$gtabid."_".$gkey."\" nowrap class=\"$class\" OnClick=\"limbasSubheaderSelection(this,'$gtabid','$gkey','DIV','$gformid','$ID','$key','".$gfield[$gtabid]["ajaxpost"][$gkey]."');".$gfield[$gtabid]["relext"][$gkey]."\">".$gfield[$gtabid]["spelling"][$gkey]."</td>\n";
				}
				echo "<td class=\"tabpoolItemSpaceGtab\">&nbsp;</td>\n";
				echo "</tr></table>\n";
				echo "</td></tr>\n";
			}
		}

		echo "<tr class=\"gtabBodyDetailBody\"><td>\n";

	# Fußelemente
	}elseif($part == 2){
		echo "</td></tr></table></td></tr>\n";

        
        // TODO: showel
        
		if(in_array("2",$showel)){
			echo "<tr><td>";
            
            
			if(in_array("0",$showel) OR in_array("1",$showel)){
				echo "<table width=\"100%\" cellpadding=0 cellspacing=0 class=\"gtabFooterTAB\"><TR class=\"gtabFooterTR\"><TD COLSPAN=\"2\" class=\"pt-3\">";
			}else{
				echo "<table width=\"100%\" cellpadding=0 cellspacing=0><TR><TD COLSPAN=\"2\" class=\"pt-3\">";
			}

            require(COREPATH . 'gtab/html/forms/parts/footer.php');
            
			echo "</td></tr></table>";
			echo "</td></tr>";
            
            
		}

		echo "<tr><td class=\"lmbGtabBottom\"></td></tr>";

		echo "</table>";

	}

	return $gf;
}







#------------ tabulator ---------------------
function form_tabulator($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult){
	global $gform;
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style>";

	echo "</DIV>";
}

#------------ fmenu ---------------------
function form_fmenue($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult){
	global $gform;
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style>";
	print_linktags($gtabid,$GLOBAL["verkn_poolid"],$ID,$gresult[$gtabid][$key]);
	echo "</DIV>";
}




#------------ frame ---------------------
function form_frame($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$z_index,$collapse,$readonly){
	global $gform;

	echo "<div style=\"".$pos."\">";
	if($gform[$gformid]["inhalt"][$key]){
        echo "<div style=\"$style_;position:relative;padding:4px;z-index:".($gform[$gformid]["z_index"][$key] + 2).";border:none;\">".$gform[$gformid]["inhalt"][$key]."</div>";
	}
	echo "<div id=\"element".$gform[$gformid]["fid"][$key]."\" style=\"position:relative;".$style."\" title=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\" $class>";
	if(is_array($gform[$gformid]["subellist"][$key][0])){
		formListElements($action,$gtabid,$ID,$gresult,$gformid,$gform[$gformid]["subellist"][$key][0],0,$readonly);
	}
	echo "</div></div>";
}

#------------ datum ---------------------
function form_datum($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	$event = dftyp_events(1,$gform[$gformid]['event'][$key],null,null,null,null,null,$null,$gtabid,null);
	if($gform[$gformid]['event'][$key]['click']){$style .= ";cursor:pointer;";}
	$style = "style=\"".$style."\"";
	echo "<DIV style=\"$pos;z-index:".$gform[$gformid]["z_index"][$key]."\">";
	echo "<INPUT ID=\"element".$gform[$gformid]["fid"][$key]."\" NAME=\"lfel[".$gform[$gformid]['fid'][$key]."]\" $class $style $event TYPE=\"TEXT\" $style $event TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\" TITLE=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">";
	echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" id=\"lfel_".$gform[$gformid]['fid'][$key]."\" BORDER=\"0\" TITLE=\"$lang[700]\" style=\"cursor:pointer;vertical-align:top;\" Onclick=\"lmb_datepicker(event,this,'','','".dateStringToDatepicker(setDateFormat(1,1))."')\"></i>\n";
	#echo local_date(0);
	echo "</DIV>";
}

#------------ Verknüpfungsreiter ---------------------
function form_relpath($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;

	if(!$GLOBALS["verkn_addfrom"]){return;}

	echo "<DIV style=\"$pos;z-index:".$gform[$gformid]["z_index"][$key]."\">";
    print_verknaddfrom($GLOBALS["verkn_addfrom"],$gtabid,$style);
	echo "</DIV>";
}

#------------ scroll ---------------------
function form_scroll($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult){
	global $gform;
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style>";
	print_scroll($ID);
	echo "</DIV>";
}

#------------ usetime ---------------------
function form_usetime($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style>";
	print_usetime($gtab,$gtabid);
	echo "</DIV>";
}

#------------ submit/button ---------------------
function form_submt($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;

	if($class){
	    $class = substr($class,7,-1);
	    $class = "submit $class";
	}else{
	    $class = 'submit';
	}

	$event = dftyp_events(1,$gform[$gformid]['event'][$key],null,null,null,null,null,$null,$gtabid,null);
	if(!$gform[$gformid]['event'][$key]['click']){$event = "OnClick=\"send_form('1');\";";}

    // prevent submitting parent form1 in subforms
	if($GLOBALS['actid'] == 'openSubForm' AND $_REQUEST['subformlayername']){
	    #$event = "OnClick=\"newwin7('',$gtabid,'".$_REQUEST['verkn_tabid']."','".$_REQUEST['verkn_fieldid']."','".$_REQUEST['verkn_ID']."',$ID,$gformid,null,null,'".$_REQUEST['subformlayername']."','".$_REQUEST['verkn_addfrom']."')\"";
        $event = "OnClick=\"lmbOpenForm(event,'{$gtabid}','$ID',{formid:'$gformid', v_tabid:'{$_REQUEST['verkn_tabid']}',v_fieldid:'{$_REQUEST['verkn_fieldid']}',v_id:'{$_REQUEST['verkn_ID']}',formopenas:'{$_REQUEST['subformlayername']}',show_relationpath:'{$_REQUEST['verkn_addfrom']}'});\"";
    }

	$style = "style=\"".$pos.$style.";cursor:pointer;\"";
	echo "<input id=\"element".$gform[$gformid]["fid"][$key]."\" type=\"button\" value=\"".$gform[$gformid]["inhalt"][$key]."\" $class $style $event tabindex=\"".$gform[$gformid]["z_index"][$key]."\">";
}

#------------ input button ---------------------
function form_button($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	$event = dftyp_events(1,$gform[$gformid]['event'][$key],null,null,null,null,null,$null,$gtabid,null);
	$style = "style=\"".$pos.$style.";cursor:pointer;\"";
	echo "<input id=\"element".$gform[$gformid]["fid"][$key]."\" type=\"button\" value=\"".$gform[$gformid]["inhalt"][$key]."\" $class $style $event tabindex=\"".$gform[$gformid]["z_index"][$key]."\">";
}

#------------ input text ---------------------
function form_inptext($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$z_index,$collapse,$readonly){
	global $gform;
	if($readonly == 1){$readonly = 'readonly';}
	$stylearray = explode(";",$gform[$gformid]["style"][$key]);
	$event = dftyp_events(1,$gform[$gformid]["event"][$key],null,null,null,null,null,$null,$gtabid,null);
	$style = "STYLE=\"".$pos.$style."\"";
	$value = $gform[$gformid]["inhalt"][$key];
	if($_REQUEST['lfel'][$gform[$gformid]['fid'][$key]]){
	    $value = $_REQUEST['lfel'][$gform[$gformid]['fid'][$key]];
    }
	echo "<INPUT ID=\"element".$gform[$gformid]["fid"][$key]."\" TYPE=\"TEXT\" NAME=\"lfel[".$gform[$gformid]["fid"][$key]."]\" $readonly $class $style $event VALUE=\"".htmlentities($value,ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\" MAXLENGTH=\"".$stylearray[36]."\" TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\" TITLE=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">";
}

#------------ input hidden ---------------------
function form_inphidden($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	$value = $gform[$gformid]["inhalt"][$key];
	if($_REQUEST['lfel'][$gform[$gformid]['fid'][$key]]){
	    $value = $_REQUEST['lfel'][$gform[$gformid]['fid'][$key]];
    }
	echo "<INPUT ID=\"element".$gform[$gformid]["fid"][$key]."\" TYPE=\"HIDDEN\" NAME=\"lfel[".$gform[$gformid]['fid'][$key]."]\" VALUE=\"".htmlentities($value,ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">";
}

#------------ input textarea ---------------------
function form_inparea($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$z_index,$collapse,$readonly){
	global $gform;
	if($readonly == 1){$readonly = 'readonly';}
	$event = dftyp_events(1,$gform[$gformid]['event'][$key],null,null,null,null,null,$null,$gtabid,null);
	$style = "STYLE=\"".$pos.$style."\"";
	$value = $gform[$gformid]["inhalt"][$key];
	if($_REQUEST['lfel'][$gform[$gformid]['fid'][$key]]){
	    $value = $_REQUEST['lfel'][$gform[$gformid]['fid'][$key]];
    }
	echo "<TEXTAREA ID=\"element".$gform[$gformid]["fid"][$key]."\" NAME=\"lfel[".$gform[$gformid]['fid'][$key]."]\" $readonly $class $style $event TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\" TITLE=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">".htmlentities($value,ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."</TEXTAREA>";
}

#------------ input select ---------------------
function form_inpselect($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$z_index,$collapse,$readonly){
	global $gform;
	global $db;
	global $session;
	global $umgvar;

	if($readonly == 1){$readonly = 'readonly';}
	$event = dftyp_events(1,$gform[$gformid]['event'][$key],null,null,null,null,null,$null,$gtabid,null);
	$style = "STYLE=\"".$pos.$style."\"";
	if($_REQUEST['lfel'][$gform[$gformid]['fid'][$key]]){
	    $value = $_REQUEST['lfel'][$gform[$gformid]['fid'][$key]];
    }

	echo "<SELECT ID=\"element".$gform[$gformid]["fid"][$key]."\" TYPE=\"TEXT\" NAME=\"lfel[".$gform[$gformid]['fid'][$key]."]\" $readonly $class $style $event TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\" TITLE=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">";

	// use Select-Pool
	if(is_numeric($gform[$gformid]['inhalt'][$key])){
        echo "<OPTION>";

        // multilang
		$field_name = 'WERT';
		if($umgvar['multi_language'] AND $session['dlanguage'] != $umgvar['default_language']){
		      $field_name = 'LANG'.$session['dlanguage'].'_WERT';
		}
		    
		$sqlquery = "SELECT ID,$field_name,HIDE,DEF FROM LMB_SELECT_W WHERE POOL = ".$gform[$gformid]['inhalt'][$key]." ORDER BY SORT";
		$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
		while(lmbdb_fetch_row($rs)) {
		    $selected = '';
			if(lmbdb_result($rs, "HIDE")){continue;}
			if(!$value AND lmbdb_result($rs, "DEF")){$selected = 'SELECTED';}
			if($value == $sval){$selected = 'SELECTED';}
			$sval = htmlentities(lmbdb_result($rs, $field_name),ENT_QUOTES,$GLOBALS["umgvar"]["charset"]);
			echo "<OPTION value=\"$sval\" $selected>$sval";
		}
	// use Text with linebreak
	}elseif($gform[$gformid]['inhalt'][$key]){
		$opt = explode("\n",$gform[$gformid]['inhalt'][$key]);
		$html = '';
		$emptyOption = '<option></option>';
        foreach ($opt as $key => $sval){
		    $selected = '';
		    $sval = trim($sval,"\r");
            if (lmb_substr($sval, -1) === '*') {
                $emptyOption = '';
                $sval = lmb_substr($sval, 0, -1);
                if (!$value) {
                    $value = $sval;
                }
            }
		    if($value == $sval){$selected = 'SELECTED';}
            $html .= "<OPTION $selected value=\"$sval\">$sval</OPTION>";
		}
		echo $emptyOption, $html;
	}
	echo "</SELECT>";
}

#------------ input check ---------------------
function form_inpcheck($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult,$z_index,$collapse,$readonly){
	global $gform;
	if($readonly == 1){$readonly = 'readonly';}
	$event = dftyp_events(1,$gform[$gformid]['event'][$key],null,null,null,null,null,$null,$gtabid,null);
	$style = "STYLE=\"".$pos.$style."\"";
	$value = $gform[$gformid]["inhalt"][$key];
	if($_REQUEST['lfel'][$gform[$gformid]['fid'][$key]]){
	    $value = 1;
    }
	if($value){$CHECKED = "checked";}
	echo "<INPUT ID=\"element".$gform[$gformid]["fid"][$key]."\" TYPE=\"CHECKBOX\" NAME=\"lfel[".$gform[$gformid]['fid'][$key]."]\" $readonly $class $style $event $CHECKED TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\" TITLE=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">";
}

#------------ input radio ---------------------
function form_inpradio($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	$event = dftyp_events(1,$gform[$gformid]['event'][$key],null,null,null,null,null,$null,$gtabid,null);
	$style = "STYLE=\"".$pos.$style."\"";
	if($gform[$gformid]['inhalt'][$key]){
		$name = $gform[$gformid]['inhalt'][$key];
	}else{
	    $name = $gform[$gformid]['fid'][$key];
    }
    $name = explode(' ',$name);
	if($_REQUEST['lfel'][$name[0]] == $gform[$gformid]['fid'][$key]){
	    $value = 1;
    }
    if($value){$CHECKED = "checked";}

	echo "<INPUT ID=\"element".$gform[$gformid]["fid"][$key]."\" TYPE=\"RADIO\" NAME=\"lfel[".$name[0]."]\" VALUE=\"".$gform[$gformid]['fid'][$key]."\" $class $style $event $CHECKED TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\" TITLE=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">";
}

#------------ line ---------------------
function form_line($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	if($event = dftyp_events(1,$gform[$gformid]['event'][$key],null,null,null,null,null,$null,$gtabid,null)){$style .= ";cursor:pointer;";}
	$style = "STYLE=\"".$pos.$style."\"";
	$st = explode(";",$gform[$gformid]['style'][$key]);
	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style $event>";
	echo "
	<script type=\"text/javascript\">
	var jg".$gform[$gformid]["fid"][$key]." = new jsGraphics(\"element".$gform[$gformid]["fid"][$key]."\");
	js_line('jg".$gform[$gformid]["fid"][$key]."','".$gform[$gformid]["width"][$key]."','".$gform[$gformid]["height"][$key]."','$st[25]','$st[9]','$st[3]');
	</script>
	";
	echo "</DIV>";
}

#------------ ellipse ---------------------
function form_ellipse($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	if($event = dftyp_events(1,$gform[$gformid]['event'][$key],null,null,null,null,null,$null,$gtabid,null)){$style .= ";cursor:pointer;";}
	$style = "STYLE=\"".$pos.$style."\"";
	$st = explode(";",$gform[$gformid]['style'][$key]);
	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style $event>";
	echo "
	<script type=\"text/javascript\">
	var jg".$gform[$gformid]["fid"][$key]." = new jsGraphics(\"element".$gform[$gformid]["fid"][$key]."\");
	js_ellipse('jg".$gform[$gformid]["fid"][$key]."','".$gform[$gformid]["width"][$key]."','".$gform[$gformid]["height"][$key]."','$st[9]','$st[3]');
	</script>
	";
	echo "</DIV>";
}

#------------ rect ---------------------
function form_rect($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	if($event = dftyp_events(1,$gform[$gformid]['event'][$key],null,null,null,null,null,$null,$gtabid,null)){$style .= ";cursor:pointer;";}
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style $event>";
	echo "&nbsp;";
	echo "</DIV>";
}

#------------ text ---------------------
function form_text($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	if($event = dftyp_events(1,$gform[$gformid]['event'][$key],null,null,null,null,null,$null,$gtabid,null)){$style .= ";cursor:pointer;";}
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style $event>";
	echo nl2br(htmlentities($gform[$gformid]["inhalt"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"]));
	echo "</DIV>";
}

#------------ notice bar ---------------------
function form_notice($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult){
	global $gform;
    global $filter;

	$style = "STYLE=\"".$pos.$style."\"";

	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style>";
    if($ID AND function_exists('print_notice')) {
        print_notice($gtabid, $ID, $gresult);
    }else{
        lmbGlistNotice($gtabid,$filter);
    }
	echo "</DIV>";
}

#------------ workflow-history ---------------------
function form_wflhist($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	$style = "STYLE=\"".$pos.$style."\"";

	# get workflow id
	$wfl_id = $gform[$gformid]['uform_typ'][$key];

	# parse parameters
    if($gform[$gformid]["parameters"][$key]){eval($gform[$gformid]["parameters"][$key]);}

    # use global wfl instance
    if(!$wfl_inst){$wfl_inst = $GLOBALS['wfl_inst'];}


    if($wfl_id AND $wfl_inst){
        require_once(COREPATH . 'extra/workflow/lwf.lib');

    	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style>";
    	echo lmb_wfl_printHistory($wfl_id, $wfl_inst);
    	echo "</DIV>";
    }
}




#------------ J Script ---------------------
function form_js($key,$gformid,$pos,$style,$class,$ID,$gtabid){
	global $gform;
	echo "\n<SCRIPT language='JavaScript'>\n";
	echo $gform[$gformid]["inhalt"][$key];
	echo "\n</SCRIPT>\n";
}

#------------ PHP Script ---------------------
function form_php($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult){
	global $gform;
	global $lfel;	
	if($rtrn = eval($gform[$gformid]["inhalt"][$key])){
		if($rtrn === true){$rtrn = '';}
		if($event = dftyp_events(1,$gform[$gformid]["event"][$key],null,null,null,null,null,$null,$gtabid,null)){$style .= ";cursor:pointer;";}
		$style = "STYLE=\"".$pos.$style."\"";
		echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style $event>";
		echo $rtrn;
		echo "</DIV>";
	}
}

#------------ reminder ------------------
function form_reminder($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id) {
	global $gform;

    /* default values - config syntax:
     *
     * datetime => string | e.g. '16.03.2016 22:44'
     * usergroups => string | e.g. '33_u;22_g;55_u' or '' for the current user
     * remark => string
     * mail => 0 or 1
     * category => int | id of category to use, 0 for default
     * hidecurrent => 1 to hide
     * gtabid
     * ID
    /*
    $config = array(
        'datetime' => '10.03.2017 22:55',
        'usergroups' => '1_u',
        'remark' => 'testtttt',
        'mail' => 0,
        'category' => 2,
        'hidecurrent' => 1
    );
    $gtabid = 1;
    ID = 23;
     */

    $defaults = json_encode(eval($gform[$gformid]["parameters"][$key]));

    if($event = dftyp_events(1,$gform[$gformid]['event'][$key],null,null,null,null,null,$null,$gtabid,null)){$style .= ";cursor:pointer;";}
	$style = "STYLE=\"".$pos.$style."\"";
    echo "{$gform[$gformid]["inhalt"][$key]}<i class=\"lmb-icon lmb-bell\" ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style $event onclick=\"limbasDivShowReminder(event,this,null,null,null,null,'" . htmlentities($defaults) . "','$gtabid','$ID');\" onmousedown=\"this.style.border='1px solid black';\" onmouseup=\"this.style.border='';\"></i>";
}

#-------- html template -----------
function form_templ($key,$gformid,$pos,$style,$class,$ID,$gtabid,$action,$field_id,$tab_id,&$gresult) {
    global $gform;

    if(!$ID){return;}

    $content = $gform[$gformid]['inhalt'][$key];
    $templGtabid = $gform[$gformid]['pic_typ'][$key];
    TemplateConfig::$instance = new FormTemplateConfig(intval($gtabid), false, $ID, $action !== 'gtab_change' && $action !== 'gtab_neu');

    $baseElement = TemplateConfig::$instance->getTemplateElementInstance($templGtabid, 'lmbBaseElement', $content);
    $baseElement->resolve($ID);

    # TODO event
    echo "<DIV ID=\"element{$gform[$gformid]["fid"][$key]}\" $class STYLE=\"$pos $style\">";
    foreach ($baseElement->getAsHtmlArr() as &$html) {
        echo $html;
    }
    echo "</DIV>";
}


# --------------------------- Listmode -------------------------------



#------------ tab ---------------------
function formlist_tab($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid,$style=null){
	global $gform;
	global $gfield;
	global $gtab;
	global $lang;
	global $farbschema;
	$line = 0;

	$collapse = $style[32];
	$cellstyle = $style[34];
	$overflow = $style[24];
    if(!$style[21]){$cl = "class=\"lmbfringegtab\"";}
    if($style[24] AND $style[24] != 'visible' AND $gform[$gformid]["height"][$key]){$height = $gform[$gformid]["height"][$key];}
	$tab_size = explode(";",$gform[$gformid]['tab_size'][$key]);
    $tdsize = explode(";",$gform[$gformid]["parameters"][$key]);
	$pos = "top:".formlist_handlePx($gform[$gformid]["posy"][$key]).";left:".formlist_handlePx($gform[$gformid]["posx"][$key]).";";

	$style = set_style($style);
	if($cellstyle == 1){$style_ = $style;}
	if($datid !== null){$elname = '_'.$datid;}

	echo "<div id=\"element".$gform[$gformid]["fid"][$key].$elname."\" style=\"position:absolute;$pos;max-height:".$height."px;$style;overflow:visible;\">
	<table $cl id=\"elementTab".$gform[$gformid]["fid"][$key].$elname."\" cellspacing=\"0\" cellpadding=\"0\" STYLE=\"margin:0px;border-collapse:collapse;border-spacing:1px;width:".array_sum($tdsize)."px\">\n";

	for ($r=1; $r<=$tab_size[1];$r++){

	    // menu
	    if($gform[$gformid]["typ"][$gform[$gformid]["tab_el_key"][$gform[$gformid]["tab"][$key]][1][$r]] == "tabmenu"){
	        echo "<tr><td colspan=\"".lmb_count($tdsize)."\"><table cellpadding=0 cellspacing=0>";
	        lmbGlistMenu($gtabid,1);
	        echo "</table></td></tr>";
	    // scroll
	    }elseif($gform[$gformid]["typ"][$gform[$gformid]["tab_el_key"][$gform[$gformid]["tab"][$key]][1][$r]] == "scroll"){
	        echo "<tr><td colspan=\"".lmb_count($tdsize)."\">";
	        lmbGlistFooter($gtabid,$gresult,$GLOBALS['filter'],1);
	        echo "</td></tr>";
	    }else{
    		// ------- Datensatz in Zeile vorhanden --------
    		if($gform[$gformid]["tab_el_rowdat"][$gform[$gformid]["tab"][$key]][$r]){
    		    #echo "<tr><td><div id=\"elementBody".$gform[$gformid]["fid"][$key]."\" style=\"overflow-y:".$overflow.";overflow-x: hidden;\"><table class=\"lmbfringeGtabBody\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" STYLE=\"overflow:hidden;border-collapse:$collapse;width:".array_sum($tdsize)."\">";
    			$bzm = 0;
    			while($bzm < $gresult[$gtabid]["res_viewcount"]) {
    			    # show only one dataset if datid is present - for tile subforms
    			    if($datid !== null){$bzm = $datid;}
    				formlist_tabrow($key,$gformid,$gtabid,$field_id,$tab_id,$gresult,$tab_size,$r,$bzm,$style_);
    			    if($datid !== null){break;}
    				$bzm++;
    			}
    			#echo '</table></div></td></tr>';
    		}else{
    		    #echo "<tr><td><div><table class=\"lmbfringeGtabBody\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" STYLE=\"border-collapse:$collapse;width:100%\">";
    			formlist_tabrow($key,$gformid,$gtabid,$field_id,$tab_id,$gresult,$tab_size,$r,0,$style_);
    			#echo '</table></div></td></tr>';
    		}
	    }
	}
	echo "</table></div>";
	if($height){
	echo "
	    <script type=\"text/javascript\">
	       var h = ".$height."  - ($('#elementTab".$gform[$gformid]["fid"][$key]."').height() - $('#elementBody".$gform[$gformid]["fid"][$key]."').height());
	       $('#elementBody".$gform[$gformid]["fid"][$key]."').height(h);
	    </script>
	    ";
	}
	
}


#------------ tabrow ---------------------
function formlist_tabrow($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$tab_size,$r,$line,$tabstyle){
	global $gform;
	global $gformlist;
	global $gfield;
	global $gtab;
	global $userdat;
	global $lang;
	global $farbschema;

	if($gresult[$gtabid]['color'][$line]){$BGCOLOR = "#".$gresult[$gtabid]['color'][$line];}
	if($session["data_display"] == 2 AND $verknpf != 1){$is_frame = "1";}else{$is_frame = "0";}

	
    if($gform[$gformid]["typ"][$gform[$gformid]["tab_el_key"][$gform[$gformid]["tab"][$key]][1][$r]] == "dbdat"){
		echo "<TR
		id=\"elrow_".$gresult[$gtabid]["id"][$line]."_".$gtabid."\"
		lmbbgcolor=\"$BGCOLOR\"
		onclick=\"lmbTableClickEvent(event,this,'$gtabid','".$gresult[$gtabid]["id"][$line]."')\"
		oncontextmenu=\"document.form2.form_id.value='".$gformlist[$gtabid]["redirect"][$gformid]."';return div1(event,this,'".$gresult[$gtabid]["id"][$line]."','$gtabid','".$gresult[$gtabid]["ERSTDATUM"][$line]."','".$gresult[$gtabid]["EDITDATUM"][$line]."','".$userdat["bezeichnung"][$gresult[$gtabid]["ERSTUSER"][$line]]."','".$userdat["bezeichnung"][$gresult[$gtabid]["EDITUSER"][$line]]."','','','','');\"
		ondblclick=\"document.form2.form_id.value='".$gformlist[$gtabid]["redirect"][$gformid]."';lmbTableDblClickEvent(event,this,'$gtabid','".$gresult[$gtabid]["id"][$line]."','','','','','');return false; \">\n";
	}else{
		echo "<TR id=\"elrow_0_".$gtabid."\">\n";
	}

	$tdsize = explode(";",$gform[$gformid]["parameters"][$key]);
	# --- Zellen -----
	for ($c=1; $c<=$tab_size[0];$c++){
		#if(!$colspan){
			$cell_key = $gform[$gformid]["tab_el_key"][$gform[$gformid]["tab"][$key]][$c][$r];
			if($cell_key){
				$stylearray = explode(";",$gform[$gformid]["style"][$cell_key]);
				$stylevalue = set_style($stylearray);
				#$style = "width:".$tdsize[$c-1]."px;".$stylevalue.";min-height:".$gform[$gformid]["height"][$cell_key]."px;";
				$style = "width:".$tdsize[$c-1]."px;".$stylevalue;
				$field_id = $gform[$gformid]["field_id"][$cell_key];
				$tab_id = $gform[$gformid]["tab_id"][$cell_key];
				$bgcolor = null;
				if($stylearray[21]){$bgcolor = $stylearray[21];}
				if($gfield[$gtabid]["color"][$field_id]){$bgcolor = $gfield[$gtabid]["color"][$field_id];}

				# default Class
				if($gform[$gformid]["class"][$cell_key]){$class = "CLASS=\"".$gform[$gformid]["class"][$cell_key]."\"";
				}elseif($gform[$gformid]["typ"][$cell_key] == 'dbdesc'){$class = "CLASS=\"gtabHeaderTitleTD\"";}

				echo "<td $class STYLE=\"".$tabstyle.";".$style.";overflow:hidden;\" valign=\"top\" oncontextmenu=\"cell_id = 'td_".$gresult[$gtabid]["id"][$line]."_".$gfield[$gtabid]["field_id"][$field_id]."_".$gtabid."';\" ";
				    if($gform[$gformid]["typ"][$cell_key] == "dbdat"){echo "id=\"td_".$gresult[$gtabid]["id"][$line]."_".$gfield[$gtabid]["field_id"][$field_id]."_".$gtabid."\"";}
				    if($bgcolor AND $gform[$gformid]["typ"][$cell_key] == 'dbdat' AND !$gresult[$gtabid]["color"][$line]){echo "BGCOLOR=\"".$bgcolor."\"";}
				    #if($gform[$gformid]["typ"][$cell_key] == "scroll" OR $gform[$gformid]["typ"][$cell_key] == "tabmenu" OR $gform[$gformid]["typ"][$cell_key] == "menue" OR $gform[$gformid]["typ"][$cell_key] == "fmenue"){echo " COLSPAN=\"".$tab_size[0]."\"";$colspan = 1;}
				echo ">";
				
				#if($gform[$gformid]["typ"][$cell_key] == "menue" OR $gform[$gformid]["typ"][$cell_key] == "fmenue"){echo "<TABLE cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">";}
				$fname = "formlist_".$gform[$gformid]["typ"][$cell_key];
				$fname($cell_key,$gformid,$gtabid,$field_id,$tab_id,$gresult,$line,$stylevalue);
				#if($gform[$gformid]["typ"][$cell_key] == "menue" OR $gform[$gformid]["typ"][$cell_key] == "fmenue"){echo "</TABLE>";}
			}else{
				echo "<td>";
			}
			echo "</td>\n";
		#}
	}
	echo "</TR>";
}

#------------ dbdat ---------------------
function formlist_dbdat($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$line){
	global $gfield;
	global $gtab;
	global $gform;
	global $session;
	global $action;
	global $filter;

	$st = explode(";",$gform[$gformid]["style"][$key]);

	if(($filter["alter"][$gtabid] OR $st[35] == 2) AND $gfield[$tab_id]["perm_edit"][$field_id]){$edittyp = 1;}else{$edittyp = 2;}

	if($gfield[$tab_id]["argument"][$field_id]){
		/* ------------------ Argument-Typfunction --------------------- */
		if($gfield[$tab_id]["argument_edit"][$field_id]){$edittyp = 1;}else{$edittyp = 2;}
		#$gresult[$tab_id][$field_id] = cftyp_13($gresult[$gtabid]["id"][$line],$gresult,$field_id,$tab_id,'','',$edittyp);
	}
	$typ = $gfield[$tab_id]["funcid"][$field_id];

	/* ------------------ Default --------------------- */
	$fname = "cftyp_".$typ;
	/* ------------------ Extension --------------------- */
	if($gfield[$tab_id]["ext_type"][$field_id]){
		if(function_exists("lmbc_".$gfield[$gtabid]["ext_type"][$field_id])){
			$fname = "lmbc_".$gfield[$tab_id]["ext_type"][$field_id];
		}
	}
	#------------------ Typfunktion ---------------------
	$fname($line,$field_id,$tab_id,$edittyp,$gresult,$gform[$gformid]["event"][$key],$gformid,$key);
	#------------------ Typfunktion ---------------------
}

#------------ menue ---------------------
#function formlist_tabmenu($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	#table_menu($gtabid,$gresult);
	#echo '<table cellpadding=0 cellspacing=0 width="100%">';
	#lmbGlistMenu($gtabid);
	#echo '</table>';
#}

#------------ fmenu ---------------------
#function formlist_fmenue($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
#	table_tabs($gtabid,$verkn_poolid);
#}

#------------ dbsearch single field in tableheader ---------------------
function formlist_dbsearch($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	lmbGlistSearchDetail($tab_id,$field_id,$style);
}

#------------ dbdesc ---------------------
function formlist_dbdesc($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid,$tile=null){
    if($tile) {
        form_dbdesc($key, $gformid, null, null, null, null, $gtabid, null, $field_id, $tab_id, $gresult);
    }else {
        lmbGlistHeaderDetail($tab_id,$gresult,$field_id,$key,$gformid);
    }
}

#------------ dbnew ---------------------
function formlist_dbnew($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	table_newdata($field_id,$tab_id);
}

#------------ scroll ---------------------
function formlist_scroll($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
    global $gform;

    $stylearray = explode(";",$gform[$gformid]["style"][$key]);
    $stylevalue = set_style($stylearray);
    $style = "STYLE=\"position:relative;width:".formlist_handlePx($gform[$gformid]["width"][$key]).";height:".formlist_handlePx($gform[$gformid]["height"][$key]).";left:".formlist_handlePx($gform[$gformid]["posx"][$key]).";top:".formlist_handlePx($gform[$gformid]["posy"][$key]).";".$stylevalue."\"";
    echo "<div $style>";
    lmbGlistFooter($gtabid,$gresult,$GLOBALS['filter'],1);
    echo "</div>";
}

#------------ global search ---------------------
function formlist_globsearch($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
    global $gform;
    global $gsr;

    $stylearray = explode(";",$gform[$gformid]["style"][$key]);
    $style = set_style($stylearray);
    $size = 'width:'.formlist_handlePx($gform[$gformid]["width"][$key]).';height:'.formlist_handlePx($gform[$gformid]["height"][$key]).';';
    $pos = "position:absolute;left:".formlist_handlePx($gform[$gformid]["posx"][$key]).";top:".formlist_handlePx($gform[$gformid]["posy"][$key]).';';

    ?>
    <div class="input-group input-group-sm" style="<?=$size.$pos?>">
        <button class="btn btn-outline-secondary" type="button" onclick="<?=$GLOBALS['LINK']["link_url"][14]?>">
            <i class="lmb-icon lmb-page-find"></i>
            <i class="lmb-icon lmb-exclamation alert-warning" id="fullsearchInfo" style=display:<?=($gsr[$gtabid] ? '' : 'none')?>></i>
        </button>
        <input type="text" style="<?=$style?>" id="globalSearch" onclick="event.stopPropagation();" class="form-control" name="gs[<?=$gtabid?>][0][0]" value="<?=$gsr[$gtabid][0][0]?>" onchange="checktyp(13,'gs[<?=$gtabid?>][0][0]','FulltextSearch','0','<?=$gtabid?>',this.value,'');">
    </div>

    <?php
}

#------------ notice bar ---------------------
function formlist_notice($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
    global $gform;
    global $filter;

    $stylearray = explode(";",$gform[$gformid]["style"][$key]);
    $stylevalue = set_style($stylearray);
    $style = "style=\"position:absolute;width:".formlist_handlePx($gform[$gformid]["width"][$key]).";height:".formlist_handlePx($gform[$gformid]["height"][$key]).";left:".formlist_handlePx($gform[$gformid]["posx"][$key]).";top:".formlist_handlePx($gform[$gformid]["posy"][$key]).";".$stylevalue."\"";
    echo "<div $style id=\"GtabTableFull\" style=\"overflow-x:auto;overflow-y:hidden;\">";
    lmbGlistNotice($gtabid,$filter);
    echo "</div>";
}

#------------ text ---------------------
function formlist_text($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	global $gform;
	echo nl2br(htmlentities($gform[$gformid]["inhalt"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"]));
}

#------------ datum ---------------------
function formlist_datum($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	echo local_date(0);
}

#------------ usetime ---------------------
function formlist_usetime($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	global $gtab;
	print_usetime($gtab,$gtabid);
}

#------------ submit ---------------------
function formlist_submt($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	global $gform;
	$event = cftyp_events($typ,$gform[$gformid]['event'][$key],null,$gresult,$gtabid,null,$datid);
	echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."_".$gresult[$gtabid]['id'][$datid]."\" CLASS=\"submit\" data-id=\"".$gresult[$gtabid]['id'][$datid]."\" STYLE=\";cursor:pointer;\" $event OnClick=\"send_form('1');\">";
	echo $gform[$gformid]['inhalt'][$key];
	echo "</DIV>";
}

#------------ input button ---------------------
function formlist_button($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
    global $gform;
    $event = cftyp_events($typ,$gform[$gformid]["event"][$key],null,$gresult,$gtabid,null,$datid);
    $style = "STYLE=\"width:100%;height:100%;".$style.";border:none\"";
    echo "<input id=\"element".$gform[$gformid]["fid"][$key]."_".$gresult[$gtabid]['id'][$datid]."\" data-id=\"".$gresult[$gtabid]['id'][$datid]."\" type=\"button\" value=\"".$gform[$gformid]["inhalt"][$key]."\" $event tabindex=\"".$gform[$gformid]["z_index"][$key]."\">";
}

#------------ input text ---------------------
function formlist_inptext($key,$gformid,$gtabid,$field_id,$tab_id,$gresult,$datid,$style=null){
	global $gform;
	$event = cftyp_events($typ,$gform[$gformid]["event"][$key],null,$gresult,$gtabid,null,$datid);
	$style = "STYLE=\"width:100%;height:100%;".$style.";border:none\"";
	$value = $gform[$gformid]["inhalt"][$key];
	if($_REQUEST['lfel'][$gform[$gformid]['fid'][$key]][$datid]){
	    $value = $_REQUEST['lfel'][$gform[$gformid]['fid'][$key]][$datid];
    }

	echo "<INPUT ID=\"element".$gform[$gformid]["fid"][$key]."_".$gresult[$gtabid]['id'][$datid]."\" data-id=\"".$gresult[$gtabid]['id'][$datid]."\" TYPE=\"TEXT\" NAME=\"lfel[".$gform[$gformid]['fid'][$key]."][$datid]\" $style $event VALUE=\"".htmlentities($value,ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\" TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\">";
}

#------------ input hidden ---------------------
function formlist_inphidden($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	global $gform;
	echo "<INPUT ID=\"element".$gform[$gformid]["fid"][$key]."_".$gresult[$gtabid]['id'][$datid]."\" data-id=\"".$gresult[$gtabid]['id'][$datid]."\" TYPE=\"HIDDEN\" NAME=\"lfel[".$gform[$gformid]['fid'][$key]."]\" VALUE=\"".htmlentities($gform[$gformid]["inhalt"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\">";
}

#------------ input textarea ---------------------
function formlist_inparea($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	global $gform;
	$event = cftyp_events($typ,$gform[$gformid]['event'][$key],null,$gresult,$gtabid,null,$datid);
	$style = "STYLE=\"".$pos.$style."\"";
	echo "<TEXTAREA ID=\"element".$gform[$gformid]["fid"][$key]."_".$gresult[$gtabid]['id'][$datid]."\" data-id=\"".$gresult[$gtabid]['id'][$datid]."\" TYPE=\"TEXT\" NAME=\"lfel[".$gform[$gformid]['fid'][$key]."]\" $style $event TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\">".htmlentities($gform[$gformid]["inhalt"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."</TEXTAREA>";
}

#------------ input select ---------------------
function formlist_inpselect($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid,$style=null){

	global $gform;
	$event = cftyp_events($typ,$gform[$gformid]['event'][$key],null,$gresult,$gtabid,null,$datid);
	$style = "STYLE=\"width:100%;height:100%;".$style.";border:none\"";
	if($_REQUEST['lfel'][$gform[$gformid]['fid'][$key]][$datid]){
	    $value = $_REQUEST['lfel'][$gform[$gformid]['fid'][$key]][$datid];
    }
	echo "<SELECT ID=\"element".$gform[$gformid]["fid"][$key]."_".$gresult[$gtabid]['id'][$datid]."\" data-id=\"".$gresult[$gtabid]['id'][$datid]."\" TYPE=\"TEXT\" NAME=\"lfel[".$gform[$gformid]['fid'][$key]."][$datid]\" $style $event TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\">";

	if(is_numeric($gform[$gformid]['inhalt'][$key])){
	    echo '<option></option>';

		// multilang
		$field_name = 'WERT';
		if($umgvar['multi_language'] AND $session['dlanguage'] != $umgvar['default_language']){
		      $field_name = 'LANG'.$session['dlanguage'].'_WERT';
		}

		$sqlquery = "SELECT ID,$field_name,HIDE,DEF FROM LMB_SELECT_W WHERE POOL = ".$gform[$gformid]['inhalt'][$key]." ORDER BY SORT";
		$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
		while(lmbdb_fetch_row($rs)) {
		    $selected = '';
			if(lmbdb_result($rs, "HIDE")){continue;}
			if(!$value AND lmbdb_result($rs, "DEF")){$selected = 'SELECTED';}
			if($value == $sval){$selected = 'SELECTED';}
			$sval = htmlentities(lmbdb_result($rs, $field_name),ENT_QUOTES,$GLOBALS["umgvar"]["charset"]);
			echo "<OPTION value=\"$sval\" $selected>$sval";
		}
	// use Text with linebreak
	}elseif($gform[$gformid]['inhalt'][$key]){
		$opt = explode("\n",$gform[$gformid]['inhalt'][$key]);
		$html = '';
		$emptyOption = '<option></option>';
        foreach ($opt as $key => $sval){
		    $selected = '';
		    $sval = trim($sval,"\r");
		    if (lmb_substr($sval, -1) === '*') {
                $emptyOption = '';
		        $sval = lmb_substr($sval, 0, -1);
		        if (!$value) {
		            $value = $sval;
                }
            }
		    if($value == $sval){$selected = 'SELECTED';}
			$html .= "<OPTION $selected value=\"$sval\">$sval</OPTION>";
		}
		echo $emptyOption, $html;
	}

	echo "</SELECT>";
}

#------------ input check ---------------------
function formlist_inpcheck($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid,$style=null){
	global $gform;
	$event = cftyp_events($typ,$gform[$gformid]['event'][$key],null,$gresult,$gtabid,null,$datid);
	$style = "STYLE=\"width:100%;height:100%;".$style.";border:none\"";
	$value = $gform[$gformid]["inhalt"][$key];
	if($_REQUEST['lfel'][$gform[$gformid]['fid'][$key]][$datid]){
	    $value = 1;
    }
	if($value){$CHECKED = "checked";}
	echo "<INPUT ID=\"element".$gform[$gformid]["fid"][$key]."_".$gresult[$gtabid]['id'][$datid]."\" data-id=\"".$gresult[$gtabid]['id'][$datid]."\" TYPE=\"CHECKBOX\" NAME=\"lfel[".$gform[$gformid]['fid'][$key]."][$datid]\" $style $event $CHECKED TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\">";
}

#------------ input radio ---------------------
function formlist_inpradio($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid,$style=null){
	global $gform;
	$event = cftyp_events($typ,$gform[$gformid]['event'][$key],null,$gresult,$gtabid,null,$datid);
	$style = "STYLE=\"width:100%;height:100%;".$style.";border:none\"";
	if($gform[$gformid]['inhalt'][$key]){
		$name = $gform[$gformid]['inhalt'][$key];
	}else{
	    $name = $gform[$gformid]['fid'][$key];
    }
    $name = explode(' ',$name);
	if($_REQUEST['lfel'][$name[0]][$datid] == $gform[$gformid]['fid'][$key].'_'.$datid){
	    $value = 1;
    }
    if($value){$CHECKED = "checked";}

	echo "<INPUT ID=\"element".$gform[$gformid]["fid"][$key]."_".$gresult[$gtabid]['id'][$datid]."\" data-id=\"".$gresult[$gtabid]['id'][$datid]."\" TYPE=\"RADIO\" NAME=\"lfel[".$name[0]."][$datid]\" VALUE=\"".$gform[$gformid]['fid'][$key]."_".$datid."\" $style $event $CHECKED TABINDEX=\"".$gform[$gformid]["z_index"][$key]."\">";
}

#------------ PHP Script ---------------------
function formlist_php($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	global $gform;
	global $lfel;

    if($rtrn = eval($gform[$gformid]["inhalt"][$key])){
        if($rtrn === true){$rtrn = '';}
        if($event = dftyp_events(1,$gform[$gformid]["event"][$key],null,null,null,null,null,$null,$gtabid,null)){$style .= ";cursor:pointer;";}
        $style = "STYLE=\"".$pos.$style."\"";
        echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" data-id=\"".$gresult[$gtabid]['id'][$datid]."\" $class $style $event>";
        echo $rtrn;
        echo "</DIV>";
    }
}

#------------ Script ---------------------
function formlist_js($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	global $gform;
	echo "\n<SCRIPT language='JavaScript'>\n";
	echo $gform[$gformid]["inhalt"][$key];
	echo "\n</SCRIPT>\n";
}

#------------ bild ---------------------
function formlist_bild($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
	global $gform;
	global $gtab;
	global $db;
	global $umgvar;

	$ID = $gresult[$gtabid]['id'][$datid];
	$style = set_style(explode(";", $gform[$gformid]["style"][$key]));
	$class='class="'.$gform[$gformid]["class"][$key].'"';
	form_bild($key,$gformid,null,$style,$class,$ID,$gtabid);
}

#------------ frame ---------------------
function formlist_frame($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
    global $gform;

    if($gform[$gformid]["inhalt"][$key]){
        $style_ = preg_replace("/width:|height:|border-style:|padding:/","null",$style);
        echo "<div $class style=\"color:transparent;border:none;padding:0px;padding-left:6px;padding-right:6px;$style_;left:".formlist_handlePx($gform[$gformid]["posx"][$key] + 15).";top:".formlist_handlePx($gform[$gformid]["posy"][$key] - 1).";height:3px;overflow:hidden;z-index:".($gform[$gformid]["z_index"][$key] + 1).";position:absolute;\">".$gform[$gformid]["inhalt"][$key]."</div>";
        echo "<div $class style=\"opacity:0.3;filter:Alpha(opacity=30);padding-left:6px;padding-right:6px;$style_;left:".formlist_handlePx($gform[$gformid]["posx"][$key] + 15).";top:".formlist_handlePx($gform[$gformid]["posy"][$key] - 8).";z-index:".($gform[$gformid]["z_index"][$key] + 2).";position:absolute;border:none;\">".$gform[$gformid]["inhalt"][$key]."</div>";
    }

    echo "<div id=\"element".$gform[$gformid]["fid"][$key]."\" style=\"".$pos.$style."\" title=\"".htmlentities($gform[$gformid]["title"][$key],ENT_QUOTES,$GLOBALS["umgvar"]["charset"])."\" $class>";
    if(is_array($gform[$gformid]["subellist"][$key][0])){
        formlist_Elements($datid,$gformid,$gtabid,$gresult,$gform[$gformid]["subellist"][$key][0]);
    }
    echo "</div>";
}

#------------ tabulator ---------------------
function formlist_tabulator($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
    global $gform;

    #echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."\" $class $style>";

    $stylearray = explode(";",$gform[$gformid]["style"][$key]);

    $width = $gform[$gformid]["width"][$key];
    $height = $gform[$gformid]["height"][$key];

    # special styles
    $tbgcolor = formlist_handleColor($stylearray[21]);
    if($tbgcolor){$tstyle="background-color:$tbgcolor;";}
    echo "<table style=\"height:100%;width:100%;margin:0px;border-collapse:collapse;\" cellpadding=\"0\" cellspacing=\"0\"><tr><td valign=\"top\">";

    # menu is left
    if($stylearray[38] == 2){
        echo "<table style=\"border-collapse:collapse;height:100%\" cellpadding=\"0\" cellspacing=\"0\">";
        $stprfix = "Left";
    # menu is top
    }else{
        echo "<div>";
    }

    if($stylearray[39] == 1 OR $GLOBALS['old_action'] == 'gtab_change'){
        $gf = $GLOBALS["filter"]["tabulatorKey"][$gtabid][$key];
    }else{
        $GLOBALS["filter"]["tabulatorKey"][$gtabid][$key] = null;
    }
    if($gform[$gformid]["subellist"][$key]){
        foreach ($gform[$gformid]["subellist"][$key] as $sckey => $scval){
            if(!$sckey){continue;}
            if(!$gf){$gf = $sckey;}
            if($gf == $sckey){
                $class = "lmbGtabTabulator".$stprfix."Active";
                echo "<script>parent.$('#lmb-main-subtitle').text(' - ".$gform[$gformid]["inhalt"][$sckey]."');</script>";
            }else{$class="lmbGtabTabulator".$stprfix."Inactive";}

            if($stylearray[38] == 2){
                echo "<tr><td><div id=\"LmbTabulatorHeader_".$gtabid."_".$sckey."\" class=\"$class\" style=\"$tstyle;\" OnClick=\"lmbSwitchTabulator(this,'$key','$sckey','Left');\">".$gform[$gformid]["inhalt"][$sckey]."&nbsp;</div></td></tr>";
            }else{
                echo "<div id=\"LmbTabulatorHeader_".$gtabid."_".$sckey."\" class=\"$class\" style=\"$tstyle;\" OnClick=\"lmbSwitchTabulator(this,'$key','$sckey');\">".$gform[$gformid]["inhalt"][$sckey]."&nbsp;</div>";
            }
        }
    }

    if($stylearray[38] == 2){
        echo "<tr><td style=\"height:100%;\"><div class=\"lmbGtabTabulator".$stprfix."Space\">&nbsp;</div></td></tr>";
        echo "</table>";
        echo "</td><td valign=\"top\">";
    }else{
        echo "<div class=\"lmbGtabTabulatorSpace\">&nbsp;</div>";
        echo "</div>";
    }

    echo "<table style=\"margin:0px;border-collapse:collapse;width:$width;height:$height;\" cellpadding=\"0\" cellspacing=\"0\"><tr><td style=\"height:100%\">";
    if($gform[$gformid]["subellist"][$key]){
        foreach ($gform[$gformid]["subellist"][$key] as $sckey => $scval){
            if(!$sckey){continue;}
            # grouping header with tabs
            if($gf != $sckey){$dst = "display:none;";}else{$dst = "";}
            echo "<div id=\"LmbTabulatorItem_".$gtabid."_".$sckey."_$datid\" class=\"lmbGtabTabulator".$stprfix."Frame\" style=\"$tstyle;$dst;position:relative;width:100%;height:100%;overflow:".$stylearray[24].";\">";
            formlist_Elements($datid,$gformid,$gtabid,$gresult,$gform[$gformid]["subellist"][$key][$sckey]);
            echo "</div>";
        }
    }
    echo "</td></tr></table>";

    echo "</td></tr></table>";

    #echo "</DIV>";
}

// Unterformular
function formlist_uform($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid){
    $ID = $gresult[$gtabid]['id'][$datid];
    form_uform($key,$gformid,null,null,null,$ID,$gtabid,$action,$field_id,$tab_id,$gresult,null,null,null);
}

// Listenformular
function formlist_tile($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult){
    global $gform;
    global $gfield;
    global $gtab;
    global $gformlist;
    global $umgvar;

    $stylearray = explode(";",$gform[$gformid]["style"][$key]);
    $style = "width:".formlist_handlePx($gform[$gformid]["width"][$key]).";height:".formlist_handlePx($gform[$gformid]["height"][$key]).";".set_style($stylearray);
    $style = str_replace('padding:','margin:',$style);
    $sub_gformid = $gform[$gformid]["tab_group"][$key];

    if($stylearray[26] == 'tile'){$style .= ';float:left';}else{$style .= 'margin-right:100%';}

    // userdefined css
	if($gformlist[$gtabid]["css"][$gformid]) {
        echo "<style type=\"text/css\">@import url(" . $gformlist[$gtabid]["css"][$gformid] . "?v={$umgvar['version']});</style>\n";
    }
    if($gformlist[$gtabid]["css"][$sub_gformid]){
 		echo "<style type=\"text/css\">@import url(".$gformlist[$gtabid]["css"][$sub_gformid]."?v={$umgvar['version']});</style>\n";
	}

    echo "<div id=\"GtabTableBody\" style=\"overflow-x: hidden;overflow-y:auto;position:absolute;left:".formlist_handlePx($gform[$gformid]["posx"][$key]).";top:".formlist_handlePx($gform[$gformid]["posy"][$key]).";padding-right:1.5rem\">";

    $line = 0;
    while ($line < $gresult[$gtabid]["res_viewcount"]) {
        $ID = $gresult[$gtabid]['id'][$line];

        // relation parameters fields | parent relation fields
        if($gform[$sub_gformid]["parentrel"] OR $gform[$sub_gformid]["paramrel"]){
            form_gresult($ID,$gtabid,$sub_gformid,$gresult);
        }

        echo "<div id=\"subelement".$key."_".$ID."\" style=\"position:relative;$style;\" class=\"tabTileSubform ".$gform[$gformid]["class"][$key]."\" data-ID=\"$ID\">";

        formlist_Elements($line,$sub_gformid,$gtabid,$gresult);

        echo "
        <i class=\"lmb-icon lmb-resizer tabTileResize\" id=\"tabTileResize".$key."_".$ID."\" onclick=\"toggleHeight('subelement".$key."_".$ID."','".$gform[$gformid]["height"][$key]."','".$gform[$gformid]["width"][$key]."')\"></i>
        </div>";

        $line++;
    }

    echo "</div>";


}

#-------- html template -----------
function formlist_templ($key,$gformid,$gtabid,$field_id,$tab_id,&$gresult,$datid,$tile=null) {
    global $gform;

    if(!$gresult[$gtabid]['id'][$datid]){return;}

    $ID = $gresult[$gtabid]['id'][$datid];
    $content = $gform[$gformid]['inhalt'][$key];
    $templGtabid = $gform[$gformid]['pic_typ'][$key];

    TemplateConfig::$instance = new FormTemplateConfig(intval($gtabid), true, $ID);

    $baseElement = TemplateConfig::$instance->getTemplateElementInstance($templGtabid, 'lmbBaseElement', $content);
    $baseElement->resolve($ID,$gresult);

    #$event = cftyp_events($typ,$gform[$gformid]['event'][$key],null,$gresult,$gtabid,null,$datid);
    echo "<DIV ID=\"element".$gform[$gformid]["fid"][$key]."_".$ID."\">";
    foreach ($baseElement->getAsHtmlArr() as &$html) {
        echo $html;
    }
    echo "</div>";
}


/**
 * Kachel Elemente Inhalt
 *
 * @param $line
 * @param $key
 * @param $gformid
 * @param $gtabid
 * @param $gresult
 * @param null $ellist
 */
function formlist_Elements($line,$gformid,$gtabid,&$gresult,$ellist=null){
    global $session;
    global $gtab;
    global $gfield;
    global $gform;

    if (!is_array($ellist)) {
        $ellist = $gform[$gformid]["mainellist"];
    }

    foreach ($ellist as $skey => $value) {

        if($gform[$gformid]["tab_el_row"][$skey] OR $gform[$gformid]["tab_el_col"][$skey] OR $gform[$gformid]["typ"][$skey] == "tabuItem" OR $gform[$gformid]["subelement"][$skey] == "tabuItem"){continue;}


        $sub_field_id = $gform[$gformid]["field_id"][$skey];
        $sub_tab_id = $gform[$gformid]["tab_id"][$skey];
        $div_style = '';

        $stylearray = explode(";", $gform[$gformid]["style"][$skey]);
        $div_style = "width:".$gform[$gformid]["width"][$skey]."px;height:".$gform[$gformid]["height"][$skey]."px;z-index:".$gform[$gformid]["z_index"][$skey].";";
        $div_pos = "position:absolute;left:".formlist_handlePx($gform[$gformid]["posx"][$skey]).";top:".formlist_handlePx($gform[$gformid]["posy"][$skey]).";";
        $div_class = "CLASS=\"".$gform[$gformid]["class"][$skey]."\"";
        $ID = $gresult[$gtabid]['id'][$line];

        // relations
        if($gfield[$sub_tab_id]['field_type'][$sub_field_id] == 11 AND $gresult[$gtabid][$sub_field_id][$line]) {
            $div_style = set_style($stylearray);
        // no image or upload
        }elseif($gform[$gformid]["typ"][$skey] != "bild" AND $gfield[$sub_tab_id]['field_type'][$sub_field_id] != 6) {
            $div_style .= set_style($stylearray);
        }

        // if subresult from relation -> use line 0
        $line_ = $line;
        if($sub_tab_id AND $gtabid != $sub_tab_id){$line_ = 0;}

        $fname = "formlist_".$gform[$gformid]["typ"][$skey];
        if($gform[$gformid]["typ"][$skey] == 'tab') {
            $fname($skey,$gformid,$gtabid,$sub_field_id,$sub_tab_id,$gresult,$line_,$stylearray);
        }else{
            echo "<div id=\"element" . $skey . "_" . $line_ . "\" style=\"$div_style;$div_pos\" $div_class>";
            $fname($skey,$gformid,$gtabid,$sub_field_id,$sub_tab_id,$gresult,$line_,1);
            echo "</div>";
        }

    }

}

function formlist_handlePx($value) {
    $valueWithoutPx = str_replace('px','',$value);
    if(is_numeric($valueWithoutPx)) {
        return $valueWithoutPx . 'px';
    }
    return $value;
}

function formlist_handleColor($value) {
    if(ctype_xdigit($value) && !str_contains($value,'#')) {
        return '#' . $value;
    }
    return $value;
}
