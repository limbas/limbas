<?php
/**
 * @copyright Limbas GmbH <https://limbas.com>
 * @license https://opensource.org/licenses/GPL-2.0 GPL-2.0
 *
 * This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 */

use Limbas\lib\general\Log\Log;

# include extensions
global $gLmbExt;
if($gLmbExt["ext_type.inc"]){
	foreach ($gLmbExt["ext_type.inc"] as $key => $value){
		require_once($value);
	}
}


function dftyp_groupStyle($style){
    if(!$style){return '';}
    $style = str_replace('STYLE="', '', rtrim($style, '"'));
    $style = 'style="' . $style . 'width:25px;padding:0px;padding-left:6px;"';
    return $style;
}

/**
 * display formatted field
 *
 * @param array $gresult from get_gresult()
 * @param int $gtabid table id
 * @param int $fieldid field id
 * @param int $ID dataset id
 * @param bool $edit show fields as editable
 * @param string $class css classes to add to the field
 * @param string $style custom css
 * @param string $pos more css
 * @param int $z_index used for tabindex
 * @param array $event passed to dftyp_events() to create onclick/onchange/... actions
 */
function display_dftyp(&$gresult,$gtabid,$fieldid,$ID,$edit=true,$class=null,$style=null,$pos=null,$z_index=1,&$event=null,$options=null){
	global $gfield;
	global $gtab;

	// multilang
	if($gfield[$gtabid]['multilang'][$fieldid]){$mlcl = 'gmultilang';}
	// default
	if(!$class){$class = "gtabchange $mlcl";}
	// userdefined
	else{$class = "$class $mlcl";}

	# ----------- Field Edit -----------
	$noedit = 1;
	if($gtab["edit"][$gtabid]){
		if ($gfield[$gtabid]["perm_edit"][$fieldid]) {
		    $noedit = 0;
		}

		# ----------- Editrule -----------
		if (!$noedit and $gfield[$gtabid]["editrule"][$fieldid]){
			$noedit = check_GtabRules($ID, $gtabid, $fieldid, $gfield[$gtabid]["editrule"][$fieldid], 0, $gresult);
		}
	}

    if($edit AND !$noedit AND $gfield[$gtabid]["argument_typ"][$fieldid] != 47){$edittyp = 1;}else{$edittyp = 2;}

	// ------------------ Default ---------------------
	$fname = "dftyp_".$gfield[$gtabid]["funcid"][$fieldid];
	// ------------------ Field-Extension ---------------------
    if($gfield[$gtabid]["ext_type"][$fieldid]){
		if(function_exists("lmbd_".$gfield[$gtabid]["ext_type"][$fieldid])){
			$fname = "lmbd_".$gfield[$gtabid]["ext_type"][$fieldid];
		}
	}

    // calculate php argument
    #if($gfield[$gtabid]["argument_typ"][$fieldid] == 15 && $gfield[$gtabid]["argument_modus"][$fieldid] == 1){
    #    lmbGetArgumentValue($gtabid, $fieldid, $ID, $gresult);
    #}

    $null = null;
	$fname($ID,$gresult,$fieldid,$gtabid,$class,$style,$pos,$edittyp,$z_index,$event,$null,$null,$null,$options);
}

/* -------------------------- Events --------------------------------- */
function dftyp_events($typ,$event,$click,$dblclick,$over,$out,$change,&$gresult,$gtabid,$fieldid){

    if(!is_array($event)) {
        $event = [];
    }
    
	if($event["click"] OR $click){$events = "OnClick=\"".eval("return \"".$event["click"]."\";")."; $click\" ";}
	if($event["dblclick"] OR $dblclick){$events .= "OnDblClick=\"".eval("return \"".$event["dblclick"]."\";")."; $dblclick\" ";}
	if($event["over"] OR $over){$events .= "OnMouseOver=\"".eval("return \"".$event["over"]."\";")."; $over\" ";}
	if($event["out"] OR $out){$events .= "OnMouseOut=\"".eval("return \"".$event["out"]."\";")."; $out\" ";}
	if(($event["change"] OR $change) AND $typ == 1){$events .= "OnChange=\"".$change.";".eval("return \"".$event["change"]."\";")."; \" ";}

	return $events;
}


# -------------------------- Gruppierung Reihe ---------------------------------
function dftyp_34($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ) {
	global $gtab;
	global $gfield;
	global $action;

	if($gfield[$gtabid]["argument"][$bzm]){
		if($parts = explode(";",$gfield[$gtabid]["argument"][$bzm])){

			echo "<DIV CLASS=\"lmbGtabTabBody\">";

			$elst = (round(100/lmb_count($parts))-5);
			
			echo "<table cellpadding=2 cellspacing=0 class=\"gtabBodyDetailValTD\" style=\"width:100%;padding-top:5px;padding-bottom:5px;\"><tr>";
			foreach ($parts as $key => $fieldid){
				if(!$gfield[$gtabid]["sort"][$fieldid]){continue;}

				echo "<TD VALIGN=\"TOP\" ALIGN=\"LEFT\" style=\"width:$elst%\">".$gfield[$gtabid]["spelling"][$fieldid]."<br>\n";
				
				if(!$gfield[$gtabid]["sort"][$fieldid]){continue;}

				$noedit = 1;
				# ----------- Edit Permission -----------
				if($gfield[$gtabid]["perm_edit"][$fieldid]){$noedit = 0;}
				# ----------- Editrule -----------
				if($gfield[$gtabid]["editrule"][$fieldid]){
					$noedit = check_GtabRules($ID,$gtabid,$fieldid,$gfield[$gtabid]["editrule"][$fieldid],0,$gresult);
				}

                if(($action == 'gtab_change' OR $action == 'gtab_neu') AND !$noedit AND $gfield[$gtabid]["argument_typ"][$fieldid] != 47){$edittyp = 1;}else{$edittyp = 2;}

                // ------------------ Default ---------------------
                $fname = "dftyp_".$gfield[$gtabid]["funcid"][$fieldid];

				/* ------------------ Extension --------------------- */
				if($gfield[$gtabid]["ext_type"][$fieldid]){
                    if(function_exists("lmbd_".$gfield[$gtabid]["ext_type"][$fieldid])){
                        $fname = "lmbd_".$gfield[$gtabid]["ext_type"][$fieldid];
                    }
				}

				if($gfield[$gtabid]["funcid"][$fieldid]) {
                    $fname($ID, $gresult, $fieldid, $gtabid, "class=\"gtabchange\"", 'width:90%', '', $edittyp, $bzm, $event, 0, 0);
                }else{
                    Log::limbasError('parse_error - field '.$gtabid.'->'.$fieldid.' does not exists', null, $gtabid, $fieldid, $ID);
                }

				
				echo "</TD>";

			}
			echo "</tr></table>";
			echo "</DIV>";
		}
	}
}


# -------------------------- Gruppierung Tabs ---------------------------------
function dftyp_33($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ) {
	global $gtab;
	global $gfield;
	global $action;
	
	if($gfield[$gtabid]["argument"][$bzm]){
		if($parts = explode(";",$gfield[$gtabid]["argument"][$bzm])){
			
			echo '<table class="lmbGtabTab"><tr>';
            $selected = true;
			foreach ($parts as $key => $value){
				if(!$gfield[$gtabid]["sort"][$value]){continue;}
                if ($selected) {
                    echo "<TD class=\"lmbGtabTabActive\" style=\"cursor: auto\" NOWRAP OnClick=\"limbasGroupingFieldSelection(this,'$bzm','$value')\"><button type=\"button\" class=\"btn btn-outline-secondary btn-sm active\">{$gfield[$gtabid]["spelling"][$value]}</button></TD>";
                } else {
                    echo "<TD class=\"lmbGtabTabInactive\" style=\"cursor: pointer\" NOWRAP OnClick=\"limbasGroupingFieldSelection(this,'$bzm','$value')\"><button type=\"button\" class=\"btn btn-outline-secondary btn-sm\">{$gfield[$gtabid]["spelling"][$value]}</button></TD>";
                }
                $selected = false;
			}
			$ftypelayer = "ftypelayer_{$bzm}_{$gtabid}";
			echo "<TD class=\"lmbGtabTabSpace\">&nbsp;</TD>";
			echo "</tr></table>";
			
			echo "<DIV CLASS=\"lmbGtabTabBody\" STYLE=\"max-height:120px;overflow:auto;\" ID=\"$ftypelayer\">";
				foreach ($parts as $key => $fieldid){
					if(!$gfield[$gtabid]["sort"][$fieldid]){continue;}
					
					$functyp = $gfield[$gtabid]["funcid"][$fieldid];
					
					$noedit = 1;
					# ----------- Edit Permission -----------
					if($gfield[$gtabid]["perm_edit"][$fieldid]){$noedit = 0;}
					# ----------- Editrule -----------
					if($gfield[$gtabid]["editrule"][$fieldid]){
						$noedit = check_GtabRules($ID,$gtabid,$fieldid,$gfield[$verkn["tabid"]]["editrule"][$verkn["fieldid"]],0,$gresult);
					}

                    if(($action == 'gtab_change' OR $action == 'gtab_neu') AND !$noedit AND $gfield[$gtabid]["argument_typ"][$fieldid] != 47){$edittyp = 1;}else{$edittyp = 2;}

					/* ------------------ Extension --------------------- */
					if($gfield[$gtabid]["ext_type"][$fieldid]){
						if(function_exists("lmbd_".$gfield[$gtabid]["ext_type"][$fieldid])){
                            $functyp = $gfield[$gtabid]["ext_type"][$fieldid];
						}
					}

                    if($functyp) {
                        $fname = "dftyp_".$functyp;
                        if(!$displ){$displ = " ";}else{$displ = "none";}
                        echo "<SPAN style=\"display:$displ;\" ID=\"LmbGroupingPart_".$bzm."_".$fieldid."\">";
                        if($gfield[$gtabid]["field_type"][$fieldid] == 3){$style = "width:100%;height:100%;";}else{$style = "width:99.5%;";}
                        $fname($ID,$gresult,$fieldid,$gtabid,"class=\"gtabchange\"",$style,null,$edittyp,$bzm,$event);
                        echo "</SPAN>";
                    }else{
                        Log::limbasError('parse_error - field '.$gtabid.'->'.$fieldid.' does not exists', null, $gtabid, $fieldid, $ID);
                    }

				}
			echo "</DIV>";
		}
	}
}


/* -------------------------- PHP Argument --------------------------------- */
function dftyp_13($ID,&$gresult,$field_id,$gtabid,$class,$style,$pos,$typ){
    global $gfield;

    // calculate always
    #if($gfield[$gtabid]['argument_modus'] == 1){
    #    lmbGetArgumentValue($gtabid, $field_id, $ID, $gresult);
    #}

    $cftyp_function = 'cftyp_'.$gfield[$gtabid]['funcid'][$field_id];
    $cftyp_function($ID,$gresult,$bzm,$gtabid,$class,$style,$pos,$typ);

}


# Vererbung
function dftyp_inherit($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null){
	global $gtab;
	global $gfield;
	
	# view as select
	if($gfield[$gtabid]["artleiste"][$bzm]){
		$sourceGtabid = $gfield[$gtabid]["inherit_tab"][$bzm];
		$sourceGfieldid = $gfield[$gtabid]["inherit_field"][$bzm];
		$sourcefilter = $gfield[$gtabid]["inherit_filter"][$bzm];
		if($sourcefilter){eval($sourcefilter.";");}

		$event_change = "limbasInheritFrom(event, $sourceGtabid,this.value, $gtabid, $bzm, $ID, '".$gresult[$gtabid]['parentage']."');";
		$events = dftyp_events($typ,$event,null,null,null,null,$event_change,$gresult,$gtabid,$bzm);

		echo "<select id=\"".$gfield[$gtabid]["form_name"][$bzm]."_di\" name=\"".$gfield[$gtabid]["form_name"][$bzm]."_di\" class=\"form-select " . $class . "\" $style data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" title=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" tabindex=\"$z_index\" $events><option></option>";
		$filter["anzahl"][$sourceGtabid] = "all";
		$onlyfield[$sourceGtabid] = array($sourceGfieldid);
		$inhresult = get_gresult($sourceGtabid,1,$filter,$gsr,$verkn,$onlyfield,$sourceId,$extension);

		if($inhresult[$sourceGtabid][$sourceGfieldid]){
			foreach ($inhresult[$sourceGtabid][$sourceGfieldid] as $key => $value){
				if($value){
					if($value == $gresult[$gtabid][$bzm][0]){$SELECTED = "selected";}else{$SELECTED = "";}
					echo "<option value=\"".$inhresult[$sourceGtabid]["id"][$key]."\" $SELECTED>".$value."</option>";
				}
			}}
			echo "</select>";
			echo "<input TYPE=\"hidden\" id=\"".$gfield[$gtabid]["form_name"][$bzm]."\" name=\"".$gfield[$gtabid]["form_name"][$bzm]."\">";
	# view as ajax based input
	}else{
		$inheritEvent = " OnKeyUp=\"limbasSearchInherit($gtabid,$bzm," . $gfield[$gtabid]["inherit_tab"][$bzm] . "," . $gfield[$gtabid]["inherit_field"][$bzm] . ",this,'$ID')\"";
		$event_dblclick = "this.value='*';limbasSearchInherit($gtabid,$bzm," . $gfield[$gtabid]["inherit_tab"][$bzm] . "," . $gfield[$gtabid]["inherit_field"][$bzm] . ",this,'$ID')";
		if($gfield[$gtabid]["argument_edit"][$bzm]){
		  $event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm]."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value,'".$ID."','".$gfield[$gtabid]["ajaxpost"][$bzm]."','".$gfield[$gtabid]["size"][$bzm]."',this,'".$gresult[$gtabid]['parentage']."')";
		}
		$events = dftyp_events($typ,$event,null,$event_dblclick,null,null,$event_change,$gresult,$gtabid,$bzm);
		echo "<INPUT ID=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"form-control " . $class . "\" $style TYPE=\"TEXT\" data-regex=\"".htmlentities($gfield[$gtabid]["regex"][$bzm],ENT_QUOTES)."\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" VALUE=\"".htmlentities($gresult[$gtabid][$bzm][0],ENT_QUOTES)."\" MAXLENGTH=\"".$gfield[$gtabid]["size"][$bzm]."\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $inheritEvent $events>";
	}

}








/* -------------------------- Zahl --------------------------------- */
function dftyp_1($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null) {
	global $gtab;
	global $gfield;

	if($style){$style = "STYLE=\"".$pos.$style."\"";}
    if(!$gformid){$roclass='form-control readonly';}

	$result = preg_replace("/^[\.]/","0.",$gresult[$gtabid][$bzm][0]);
	if($result AND $gfield[$gtabid]["data_type"][$bzm] == 21){
		$proz = " %";
	}

	if($typ == 1){
		# inherit
		if($gfield[$gtabid]["inherit_tab"][$bzm] AND $gfield[$gtabid]["inherit_search"][$bzm]){
			dftyp_inherit($ID,$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null);
		# text
		}else{
			$event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm]."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value,'$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."','".$gfield[$gtabid]["size"][$bzm]."',this,'".$gresult[$gtabid]['parentage']."')";
		    if($gfield[$gtabid]["inherit_tab"][$bzm] AND !$gfield[$gtabid]["argument_edit"][$bzm]){$event_change = null; $readonly='readonly';}
			$events = dftyp_events($typ,$event,null,null,null,null,$event_change,$gresult,$gtabid,$bzm);
			# Potenz-Darstellung
            if($result == ''){

            }elseif($gfield[$gtabid]["potency"][$bzm]){
				$result = convert_FloatToScientific($result,$gfield[$gtabid]["potency"][$bzm], $gfield[$gtabid]["nformat"][$bzm]);
			} else {
                $result = convert_NumberFormat($result, $gfield[$gtabid]["nformat"][$bzm]);
            }

			echo "<INPUT ID=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"form-control " . $class . "\" $style TYPE=\"TEXT\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" VALUE=\"".$result.$proz."\" data-regex=\"".htmlentities($gfield[$gtabid]["regex"][$bzm],ENT_QUOTES)."\" MAXLENGTH=\"".($gfield[$gtabid]["size"][$bzm]+6)."\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $readonly $events>";
        }
	}elseif($typ == 2){
		$events = dftyp_events($typ,$event,$event_click,null,null,null,null,$gresult,$gtabid,$bzm);
		# Potenz-Darstellung
		if($gfield[$gtabid]["potency"][$bzm]){
			$value = convert_FloatToScientific($result,$gfield[$gtabid]["potency"][$bzm]);
			if(lmb_strpos($value,"E")){
				$value = explode("E",$value);
				$result = ($value[0]*10)."<sup>".$value[1]."</sup>";
			}
		# Format-Darstellung
		}elseif($gfield[$gtabid]["nformat"][$bzm]){
			$result = convert_NumberFormat($gresult[$gtabid][$bzm][0],$gfield[$gtabid]["nformat"][$bzm]);
		}

		echo "<div id=\"".$gfield[$gtabid]["form_name"][$bzm]."\" name=\"".$gfield[$gtabid]["form_name"][$bzm]."\"  class=\"$roclass readonly " . $class . "\" $style $events> ".$result.$proz."</div>";
	}
}

/* -------------------------- WÃ¤hrung --------------------------------- */
function dftyp_7($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null) {
	global $gtab;
	global $gfield;
	global $umgvar;
	global $lmcurrency;

	if($pos){$pos = "STYLE=\"".$pos."\"";}
    if(!$gformid){$roclass='form-control readonly';}

	echo "<div $pos>";
	if($typ == 1){
		if($result = preg_replace("/^[\.]/","0.",$gresult[$gtabid][$bzm][0]['V'])){
			$result = $result." ".$gresult[$gtabid][$bzm][0]['C'];
		}
		$event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm]."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',document.getElementsByName('".$gfield[$gtabid]["form_name"][$bzm]."')[0].value,'$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."','".$gfield[$gtabid]["size"][$bzm]."',this,'".$gresult[$gtabid]['parentage']."')";
	    if($gfield[$gtabid]["inherit_tab"][$bzm] AND !$gfield[$gtabid]["argument_edit"][$bzm]){$event_change = null; $readonly='readonly';}
		$events = dftyp_events($typ,$event,null,null,null,null,$event_change,$gresult,$gtabid,$bzm);
		echo "<INPUT ID=\"".$gfield[$gtabid]["form_name"][$bzm]."\" TYPE=\"TEXT\" STYLE=\"".$style."\" class=\"form-control " . $class . "\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" VALUE=\"".$result."\" data-regex=\"".htmlentities($gfield[$gtabid]["regex"][$bzm],ENT_QUOTES)."\" MAXLENGTH=\"".($gfield[$gtabid]["size"][$bzm]+6)."\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $readonly $events>";

		if($gresult[$gtabid][$bzm][0]['V'] AND $gfield[$gtabid]["option"][$bzm]){
			if(preg_match('/display:none/',$style)){$sdpl="display:none;";}
			echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" ID=\"".$gfield[$gtabid]["form_name"][$bzm]."_dse\" TITLE=\"\" style=\"cursor:pointer;vertical-align:baseline;$sdpl\" OnClick=\"limbasChangeCurrency(this,'".$gfield[$gtabid]["form_name"][$bzm]."','$bzm')\"></i>";
		}
		#echo "&nbsp;<span style=\"position:absolute;\" Onclick=\"limbasChangeCurrency(this,'".$gresult[$gtabid][$bzm][0]['V']."','".$gresult[$gtabid][$bzm][0]['C']."','".$gfield[$gtabid]["form_name"][$bzm]."','$bzm')\"><IMG SRC=\"assets/images/legacy/edit4.gif\" BORDER=\"0\" TITLE=\"\" style=\"cursor:pointer;vertical-align:baseline;\"></span>";
	}else{
	    $val = $gresult[$gtabid][$bzm][0]['V'];
		$val = preg_replace("/^[\.]/","0.",$val);
		$events = dftyp_events($typ,$event,$event_click,null,null,null,null,$gresult,$gtabid,$bzm);
		if($gfield[$gtabid]["nformat"][$bzm]){
			$val = convert_NumberFormat($val,$gfield[$gtabid]["nformat"][$bzm]);
		}
        $result = $val . " " . $lmcurrency["symbol"][$gresult[$gtabid][$bzm][0]['C']];
        echo "<div id=\"".$gfield[$gtabid]["form_name"][$bzm]."\" name=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"$roclass " . $class . "\" STYLE=\"".$style."\" $events> ".$result."</div>";
	}
	echo "</div>";
}

/* -------------------------- Phone --------------------------------- */
function dftyp_28($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null) {
	global $gtab;
	global $gfield;
	global $session;

	if($pos){$pos = "STYLE=\"".$pos."\"";}
	if($style){$style = "STYLE=\"".$style."\"";}
    if(!$gformid){$roclass='form-control readonly';}

	echo "<DIV $pos>";
	if($typ == 1){
		$event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm]."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value,'$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."',null,this,'".$gresult[$gtabid]['parentage']."')";
	    if($gfield[$gtabid]["inherit_tab"][$bzm] AND !$gfield[$gtabid]["argument_edit"][$bzm]){$event_change = null; $readonly='readonly';}
		$events = dftyp_events($typ,$event,null,null,null,null,$event_change,$gresult,$gtabid,$bzm);
		echo "<INPUT ID=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"form-control " . $class . "\" $style TYPE=\"TEXT\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" VALUE=\"".$gresult[$gtabid][$bzm][0]."\" data-regex=\"".htmlentities($gfield[$gtabid]["regex"][$bzm],ENT_QUOTES)."\" MAXLENGTH=\"".$gfield[$gtabid]["size"][$bzm]."\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $readonly $events>";
		if(preg_match('/display:none/',$style)){$sdpl="display:none;";}
		if($gfield[$gtabid]["option"][$bzm]){echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" id=\"sel_$bzm\" ALIGN=\"middle\" BORDER=\"0\" TITLE=\"$lang[700]\" style=\"cursor:pointer;vertical-align:baseline;$sdpl\" Onclick=\"openPhone_".$session["t_setting"][0]."('".str_replace(" ","",$gresult[$gtabid][$bzm][0])."')\"></i>\n";}
    }elseif($typ == 2){
		$events = dftyp_events($typ,$event,$event_click,null,null,null,null,$gresult,$gtabid,$bzm);
		echo "<div id=\"".$gfield[$gtabid]["form_name"][$bzm]."\" name=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"$roclass " . $class . "\" $style $events><a href=\"#\" OnClick=\"openPhone_".$session["t_setting"][0]."('".str_replace(" ","",$gresult[$gtabid][$bzm][0])."')\">".htmlentities($gresult[$gtabid][$bzm][0],ENT_QUOTES)."</a></div>";
	}
	echo "</DIV>";
}



/* -------------------------- Text --------------------------------- */
function dftyp_2($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null,$formid=null,$language=null) {
	global $gtab;
	global $gfield;

	#if($style){$style = "STYLE=\"".$pos.$style."\"";}
    if($pos){$pos = "STYLE=\"".$pos."\"";}
    if(!$gformid){$roclass='form-control readonly';}

    echo "<div $pos>";

	if($typ == 1){
		# inherit
		if($gfield[$gtabid]["inherit_tab"][$bzm] AND $gfield[$gtabid]["inherit_search"][$bzm]){
			dftyp_inherit($ID,$gresult,$bzm,$gtabid,$class,"STYLE=\"$style\"",$pos,$typ,$z_index,$event=null);
		# text
		}else{
            $formname = $gfield[$gtabid]["form_name"][$bzm];
            $ajaxpost = $gfield[$gtabid]["ajaxpost"][$bzm];

            // inline multilang - render for dyns_gmultilang() - overwrite default language from formularsetting
            if($language AND $gfield[$gtabid]["multilang"][$bzm]){
                $formname = 'LANG'.$language.'_'.$formname;
                $ajaxpost = 1;
            }

            $event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$formname."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value,'".$ID."','".$ajaxpost."','".$gfield[$gtabid]["size"][$bzm]."',this,'".$gresult[$gtabid]['parentage']."','$language')";
		    if($gfield[$gtabid]["inherit_tab"][$bzm] AND !$gfield[$gtabid]["argument_edit"][$bzm]){$event_change = null; $readonly='readonly';}
            $events = dftyp_events($typ,$event,null,$event_dblclick,null,null,$event_change,$gresult,$gtabid,$bzm);
			echo "<INPUT ID=\"".$formname."\" class=\"form-control " . $class . "\" STYLE=\"".$style."\" TYPE=\"TEXT\" NAME=\"".$formname."\" data-regex=\"".htmlentities($gfield[$gtabid]["regex"][$bzm],ENT_QUOTES)."\" VALUE=\"".htmlentities($gresult[$gtabid][$bzm][0],ENT_QUOTES)."\" MAXLENGTH=\"".$gfield[$gtabid]["size"][$bzm]."\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $readonly $inheritEvent $events>";
            if ($gfield[$gtabid]["speechrec"][$bzm]) {
                echo '<script type="text/javascript">
                    $(document).ready(function() {
                    lmb_addSpeechRecButton(\'' . $formname . '\');
                });
                </script>';
            }
		}

		// multilang details
	    if($gfield[$gtabid]["multilang"][$bzm] AND $gfield[$gtabid]["option"][$bzm] AND !$language){
	        if(preg_match('/display:none/',$style)){$sdpl="display:none;";}
	        echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" id=\"sel_$bzm\"  TITLE=\"$lang[700]\" style=\"cursor:pointer;vertical-align:baseline;$sdpl\" Onclick=\"lmbAjax_multilang(this,$gtabid,$bzm,$ID)\"></i>\n";
	    }

	}elseif($typ == 2){
		$events = dftyp_events($typ,$event,$event_click,null,null,null,null,$gresult,$gtabid,$bzm);
		echo "<div id=\"".$formname."\" name=\"".$formname."\" class=\"$roclass " . $class . "\" STYLE=\"".$style."\" $events>".htmlentities($gresult[$gtabid][$bzm][0],ENT_QUOTES)."</div>";
	}

	echo "</div>";
}



/* -------------------------- Textblock --------------------------------- */
function dftyp_3($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null,$formid=null,$language=null) {
	global $gtab;
	global $gfield;
	global $gsr;

	#if($style){$style = "STYLE=\"".$pos.$style."\"";}
    if($pos){$pos = "STYLE=\"".$pos."\"";}
    if(!$gformid){$roclass='form-control readonly';}

    echo "<div $pos>";

	if($typ == 1){
		if(lmb_strpos($style,"overflow:auto") OR !$style){
			$onkeyup = "limbasResizeTextArea(this,5);";
			if($style){
				if($strp = lmb_strpos($style,"height:")){
					$sta = lmb_substr($style,$strp+7,5);
					settype($sta,"integer");
				}
			}
			if($sta){
				$onblur = "onblur=\"this.style.height='".$sta."'\"";
			}else{
				$onblur = "onblur=\"this.rows=5\"";
			}
		}

        $formname = $gfield[$gtabid]["form_name"][$bzm];
        $ajaxpost = $gfield[$gtabid]["ajaxpost"][$bzm];

        // inline multilang - render for dyns_gmultilang() - overwrite default language from formularsetting
        if($language AND $gfield[$gtabid]["multilang"][$bzm]){
            $formname = 'LANG'.$language.'_'.$formname;
            $ajaxpost = 1;
        }

		$onkeyup .= "memokeypress(event,this,'".htmljs($gsr[$gtabid][$bzm][0])."');";
		$onkeyup = "onkeydown=\"$onkeyup\"";
		$event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$formname."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value,'$ID','".$ajaxpost."','".$gfield[$gtabid]["size"][$bzm]."',this,'".$gresult[$gtabid]['parentage']."','$language')";
		if($gfield[$gtabid]["inherit_tab"][$bzm] AND !$gfield[$gtabid]["argument_edit"][$bzm]){$event_change = null; $readonly='readonly';}
		$onmouseover = "OnMouseover=\"setSelectedText(this,'".htmljs($gsr[$gtabid][$bzm][0])."')\"";
		$events = dftyp_events($typ,$event,null,null,null,null,$event_change,$gresult,$gtabid,$bzm);

		echo "<TEXTAREA ID=\"".$formname."\" class=\"form-control " . $class . "\" STYLE=\"".$style."\" ROWS=\"5\" WRAP=\"off\" NAME=\"".$formname."\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" data-regex=\"".htmlentities($gfield[$gtabid]["regex"][$bzm],ENT_QUOTES)."\" TABINDEX=\"$z_index\" $readonly $onkeyup $onblur $onmouseover $events>".htmlentities($gresult[$gtabid][$bzm][0],ENT_QUOTES)."</TEXTAREA>";

		// multilang
		if($gfield[$gtabid]["multilang"][$bzm] AND $gfield[$gtabid]["option"][$bzm] AND !$language){
	       if(preg_match('/display:none/',$style)){$sdpl="display:none;";}
	       echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" id=\"sel_$bzm\" style=\"cursor:pointer;vertical-align:top;$sdpl\" title=\"$lang[700]\" Onclick=\"lmbAjax_multilang(this,$gtabid,$bzm,$ID)\"></i>\n";
	    }

	}elseif($typ == 2){
		$events = dftyp_events($typ,$event,null,null,null,null,null,$gresult,$gtabid,$bzm);
		$result = nl2br(htmlentities($gresult[$gtabid][$bzm][0],ENT_QUOTES));
		$cl = array('FCFD87','FDCF87','D2FD87','87FDF9','DBBCFC');
		$czm = 0;
		if($gsr[$gtabid][$bzm]){
			foreach($gsr[$gtabid][$bzm] as $key => $value){
				if($value AND !is_array($value)){
					$value = htmlentities($value,ENT_QUOTES);
					$result = str_replace($value,"<SPAN STYLE=\"background-color:".$cl[$czm]."\">$value</SPAN>",$result);
					$czm++;
				}
			}
		}
		echo "<div id=\"".$formname."\" name=\"".$formname."\" class=\"$roclass " . $class . "\" STYLE=\"".$style."\" $events>".$result."</div>";
	}

	echo "</div>";

}

/* -------------------------- Long --------------------------------- */
function dftyp_22($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null,$formid=null,$language=null) {
	global $gtab;
	global $gfield;
	global $gsr;
	global $gform;

	if($pos){$pos = "STYLE=\"".$pos."z-Index:$z_index;\"";}
    if(!$gformid){$roclass='form-control readonly';}

	echo "<div $pos>";
	if($typ == 1){
		$width = 'width:95%';
		if($style){
			$style_ = "STYLE=\"".$style."\"";
			$stylearray=explode(";",$style);
			$width=$stylearray[0];
		}
		if(/*lmb_strpos($style,"overflow:auto") OR*/ !$style){
			$onkeyup = "limbasResizeTextArea(this,5);";
			if($style){
				if($strp = lmb_strpos($style,"height:")){
					$sta = lmb_substr($style,$strp+7,5);
					settype($sta,"integer");
				}
			}
			if($sta){
				$onblur = "onblur=\"this.style.height='".$sta."'\"";
			}else{
				$onblur = "onblur=\"this.style.height=''\"";
			}
		}

        $formname = $gfield[$gtabid]["form_name"][$bzm];
        $ajaxpost = 2;

        // inline multilang - render for dyns_gmultilang() - overwrite default language from formularsetting
        if($language AND $gfield[$gtabid]["multilang"][$bzm]){
            $formname = 'LANG'.$language.'_'.$formname;
            $ajaxpost = 1;
        }

		$onkeyup .= "memokeypress(event,this,'".htmljs($gsr[$gtabid][$bzm][0])."');";
		$onkeyup = "onkeyup=\"$onkeyup\"";
		$event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$formname."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value,'$ID',$ajaxpost,null,null,'".$gresult[$gtabid]['parentage']."','$language')";
	    if($gfield[$gtabid]["inherit_tab"][$bzm] AND !$gfield[$gtabid]["argument_edit"][$bzm]){$event_change = null; $readonly='readonly';}
		$events = dftyp_events($typ,$event,null,null,null,null,$event_change,$gresult,$gtabid,$bzm);

		if($gfield[$gtabid]["wysiwyg"][$bzm]){
			$formstyle=explode(";",$gform[$gformid]["style"][$formid]);
			echo "<table cellpadding=0 cellspacing=0 style=\"width:100%;\"><tr>";
			if($formstyle[35] == 3){
				echo "<td class=\"" . $class . "\" style=\"$width\"><div name=\"".$formname."\" style=\"$style\" $events>".$gresult[$gtabid][$bzm][0]."</div>";
			}else{
				echo "<td style=\"$width\"><TEXTAREA ID=\"".$formname."\" class=\"form-control " . $class . "\" $style_ ROWS=\"5\" WRAP=\"virtual\" NAME=\"".$formname."\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $events>".htmlentities($gresult[$gtabid][$bzm][0],ENT_QUOTES)."</TEXTAREA>";
				echo lmbInitTinyMce($formname, tabId: intval($gtabid), changeEvent: $event_change, tinyMceConfigId: intval($gfield[$gtabid]['wysiwyg_config'][$bzm]));
			}
			echo "</td>";
			if(preg_match('/display:none/',$style)){$sdpl="display:none;";}
			if($gfield[$gtabid]["option"][$bzm]){echo "<td valign=\"top\">&nbsp;<i class=\"lmb-icon lmb-edit-caret\" id=\"sel_$bzm\" style=\"cursor:pointer;vertical-align:top;$sdpl\" title=\"$lang[700]\" Onclick=\"newwin9('$bzm','$gtabid','$ID','$gformid','$formid')\"></i></td>";}
			echo "</tr></table>";
		}else{
			echo "<textarea id=\"".$formname."\" class=\"form-control " . $class . "\" $style_ $onkeyup $onblur ROWS=\"5\" WRAP=\"off\" NAME=\"".$formname."\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $readonly $events>".htmlentities($gresult[$gtabid][$bzm][0],ENT_QUOTES)."</TEXTAREA>";
			// multilang
    	    if($gfield[$gtabid]["multilang"][$bzm] AND $gfield[$gtabid]["option"][$bzm] AND !$language){
    	       if(preg_match('/display:none/',$style)){$sdpl="display:none;";}
    	       echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" id=\"sel_$bzm\" style=\"cursor:pointer;vertical-align:top;$sdpl\" title=\"$lang[700]\" Onclick=\"lmbAjax_multilang(this,$gtabid,$bzm,$ID)\"></i>\n";
    	    }
		}

	}elseif($typ == 2){
		$events = dftyp_events($typ,$event,null,null,null,null,null,$gresult,$gtabid,$bzm);
		if($gfield[$gtabid]["wysiwyg"][$bzm]){$result = $gresult[$gtabid][$bzm][0];}else{$result = nl2br(htmlentities($gresult[$gtabid][$bzm][0],ENT_QUOTES));}
		# Suche hervorheben
		$cl = array('FCFD87','FDCF87','D2FD87','87FDF9','DBBCFC');
		$czm = 0;
		if($gsr[$gtabid][$bzm]){
			foreach($gsr[$gtabid][$bzm] as $key => $value){
				if($value AND !is_array($value)){
					$value = htmlentities($value,ENT_QUOTES);
					$result = str_replace($value,"<DIV STYLE=\"background-color:".$cl[$czm]."\">$value</DIV>",$result);
					$czm++;
				}
			}
		}
		# is in grouping menu
		if($style == "width:100%;height:100%;;"){
			$st = "style=\"".$style."\"";
			$class = "gtabdetail";
		}
		echo "<div id=\"".$formname."\" name=\"".$formname."\" class=\"$roclass " . $class . "\" style=\"$style\" $events>".$result."</div>";
	}
	echo "</div>\n";
}

/* -------------------------- Datum --------------------------------- */
function dftyp_4($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null,$formid=null) {
	global $gtab;
	global $gfield;
	global $lang;
	global $gform;

	$dp = 'text';
	if($pos){$pos = "STYLE=\"".$pos."\"";}
	if($style){$style = "STYLE=\"".$style."\"";}
    if(!$gformid){$roclass='form-control readonly';}
	$dateformat = $gfield[$gtabid]["datetime"][$bzm]; // 1 = date or 0 = date+time+sec or 4 = data+time
    if($gfield[$gtabid]["data_type"][$bzm] == 40){$dateformat = 1;} // DATE

	echo "<div $pos>";

    // browser datepicker needs US format
    if($gfield[$gtabid]["select_pool"][$bzm] == 2){

        $gfield[$gtabid]["regex"][$bzm] = 1;
        if($dateformat == 1) {
            $dp = 'date';
            $value = get_date($gresult[$gtabid][$bzm][0],$dateformat,2);
        }else{
            $dp = 'datetime-local';
            $value = get_date($gresult[$gtabid][$bzm][0],4,2);
            $value = str_replace(' ','T',$value);
        }

    }else{
        $value = get_date($gresult[$gtabid][$bzm][0],$dateformat);
    }

	if($typ == 1){
        $countryformat = setDateFormat($dateformat,1);
		$event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm]."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value,'$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."',null,this,'".$gresult[$gtabid]['parentage']."')";
	    if($gfield[$gtabid]["inherit_tab"][$bzm] AND !$gfield[$gtabid]["argument_edit"][$bzm]){$event_change = null; $readonly='readonly';}
		$event_dblclick = "this.value=limbasGetDate('".$countryformat."');$event_change";
		$events = dftyp_events($typ,$event,null,$event_dblclick,null,null,$event_change,$gresult,$gtabid,$bzm);
		echo "<INPUT ID=\"".$gfield[$gtabid]["form_name"][$bzm]."\" $style class=\"form-control " . $class . "\" TYPE=\"$dp\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" VALUE=\"".$value."\" data-regex=\"".htmlentities($gfield[$gtabid]["regex"][$bzm],ENT_QUOTES)."\" MAXLENGTH=\"".$gfield[$gtabid]["size"][$bzm]."\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $readonly $events>";
		if(preg_match('/display:none/',$style)){$sdpl="display:none;";}
        $options = htmlspecialchars($gform[$gformid]["parameters"][$formid], ENT_COMPAT /* escape double quotes */);
		if (!$options) {
		    $options = '{}';
        }
		if($gfield[$gtabid]["option"][$bzm] AND $gfield[$gtabid]["select_pool"][$bzm] != 2){echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" id=\"sel_$bzm\" ALIGN=\"middle\" BORDER=\"0\" TITLE=\"$lang[700]\" style=\"cursor:pointer;vertical-align:baseline;$sdpl\" Onclick=\"lmb_datepicker(event,this,'','$value','".dateStringToDatepicker($countryformat)."',null,null,$options)\"></i>\n";}
	}elseif($typ == 2){

        $bzm_ = $bzm;

        // Systemfields use fieldname
        if($gfield[$gtabid]["field_type"][$bzm] == 15){
            $bzm_ = $gfield[$gtabid]["field_name"][$bzm];
        }

	    // use numberformat to format date
        if($gfield[$gtabid]["nformat"][$bzm]){
            $value = get_format_date($gresult[$gtabid][$bzm_][0],$gfield[$gtabid]["nformat"][$bzm]);
        }else{
            $value = get_date($gresult[$gtabid][$bzm_][0],$dateformat);
        }

		$events = dftyp_events($typ,$event,$event_click,null,null,null,null,$gresult,$gtabid,$bzm);
		echo "<div id=\"".$gfield[$gtabid]["form_name"][$bzm]."\" name=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"$gformid $roclass " . $class . "\" $style $events> ".$value."</div>";
	}
	echo "</div>\n";
}

/* -------------------------- Zeit --------------------------------- */
function dftyp_25($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null) {
	global $gfield;

	if($style){$style = "STYLE=\"".$pos.$style."\"";}
    if(!$gformid){$roclass='form-control readonly';}
	$value = $gresult[$gtabid][$bzm][0];

	# extract time out of date string
	if(!LMB_DBFUNC_TIMEHANDLE){
		$value = lmb_substr($value,11,8);
	}

	# time format
    if($gfield[$gtabid]['nformat'][$bzm]) {
	    $value = get_format_date($value, $gfield[$gtabid]['nformat'][$bzm]);
    }

	if($typ == 1){
		$event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm]."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value,'$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."',null,this,'".$gresult[$gtabid]['parentage']."')";
	    if($gfield[$gtabid]["inherit_tab"][$bzm] AND !$gfield[$gtabid]["argument_edit"][$bzm]){$event_change = null; $readonly='readonly';}
		$event_dblclick = "this.value=limbasGetDate(5);$event_change";
		$events = dftyp_events($typ,$event,null,$event_dblclick,null,null,$event_change,$gresult,$gtabid,$bzm);
		echo "<INPUT ID=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"form-control " . $class . "\" $style TYPE=\"TEXT\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" VALUE=\"".htmlentities($value,ENT_QUOTES)."\" data-regex=\"".htmlentities($gfield[$gtabid]["regex"][$bzm],ENT_QUOTES)."\" MAXLENGTH=\"".$gfield[$gtabid]["size"][$bzm]."\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $readonly $events>";
	}elseif($typ == 2){
		$events = dftyp_events($typ,$event,$event_click,null,null,null,null,$gresult,$gtabid,$bzm);
		echo "<div name=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"$roclass " . $class . "\" $style $events> ".htmlentities($value,ENT_QUOTES)."</div>";
	}
}

/* -------------------------- Boolean --------------------------------- */
function dftyp_5($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null,$formid=null,$language=null,$params=null) {
	global $gtab;
    global $gform;
	global $gfield;
	global $farbschema;
	global $lang;

	if($style){
		$style = "STYLE=\"".$pos.$style.";height:auto;\"";
	}
    if(!$gformid){$roclass='form-control';}

	if($typ == 2){$readonly = 'readonly disabled';}

	#if($typ == 1) {

        // parameters
        if($gform[$gformid]["parameters"][$formid]) {
            eval($gform[$gformid]["parameters"][$formid].';');
        }

        if (!$gfield[$gtabid]["listing_viewmode"][$bzm]) {
            $value = "this.checked";
        } elseif ($gfield[$gtabid]["listing_viewmode"][$bzm] >= 1){
            $value = "this.value";
        }

        // radio needed "el" parameter for checktyp() - radios to not work in "all elements" in formulars
        $radioel = 'null';
        if ($gfield[$gtabid]["listing_viewmode"][$bzm] == 1 OR $gfield[$gtabid]["listing_viewmode"][$bzm] == 3) {
            $radioel = 'this';
        }

        $event_click = "checktyp('" . $gfield[$gtabid]["data_type"][$bzm] . "','" . $gfield[$gtabid]["form_name"][$bzm] . "','" . $gfield[$gtabid]["spelling"][$bzm] . "','" . $bzm . "','" . $gtabid . "',$value,'$ID','" . $gfield[$gtabid]["ajaxpost"][$bzm] . "',null,$radioel,'" . $gresult[$gtabid]['parentage'] . "')";
        if ($gfield[$gtabid]["inherit_tab"][$bzm] AND !$gfield[$gtabid]["argument_edit"][$bzm]) {
            $event_click = '';
        }
        $events = dftyp_events($typ, $event, $event_click, null, null, null, null, $gresult, $gtabid, $bzm);
        if ($gresult[$gtabid][$bzm][0] == 1) {
            $checked = "CHECKED";
            $selected = "SELECTED";
        } else {
            unset($checked);
            $checked0 = "CHECKED";
            $selected0 = "SELECTED";
        }

        // checkbox
        if (!$gfield[$gtabid]["listing_viewmode"][$bzm]) {
            if($formid){
                echo "<INPUT $style class=\"" . $class . "\" $readonly ID=\"" . $gfield[$gtabid]["form_name"][$bzm] . "\" TYPE=\"CHECKBOX\" NAME=\"" . $gfield[$gtabid]["form_name"][$bzm] . "\" VALUE=\"true\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"" . $gfield[$gtabid]["need"][$bzm] . $gfield[$gtabid]["beschreibung"][$bzm] . "\" TABINDEX=\"$z_index\" $events $checked>";
            }else {
                echo "<div $style class=\"$roclass " . $class . "\"><INPUT $readonly ID=\"" . $gfield[$gtabid]["form_name"][$bzm] . "\" TYPE=\"CHECKBOX\" NAME=\"" . $gfield[$gtabid]["form_name"][$bzm] . "\" VALUE=\"true\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"" . $gfield[$gtabid]["need"][$bzm] . $gfield[$gtabid]["beschreibung"][$bzm] . "\" TABINDEX=\"$z_index\" $events $checked></div>";
            }
        // radio
        } elseif ($gfield[$gtabid]["listing_viewmode"][$bzm] == 1){
            echo "<div $style class=\"$roclass " . $class . "\">";
            if($params['position'] != 'left') {
                echo $lang[1506]."&nbsp;<INPUT $readonly ID=\"".$gfield[$gtabid]["form_name"][$bzm]."_1\"  TYPE=\"RADIO\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" VALUE=\"1\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $events $checked>&nbsp;".
                $lang[1507]."&nbsp;<INPUT $readonly ID=\"".$gfield[$gtabid]["form_name"][$bzm]."_0\"  TYPE=\"RADIO\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" VALUE=\"0\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $events $checked0>";
            }else{
                echo "<INPUT $readonly ID=\"" . $gfield[$gtabid]["form_name"][$bzm] . "_0\"  TYPE=\"RADIO\" NAME=\"" . $gfield[$gtabid]["form_name"][$bzm] . "\" VALUE=\"1\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"" . $gfield[$gtabid]["need"][$bzm] . $gfield[$gtabid]["beschreibung"][$bzm] . "\" TABINDEX=\"$z_index\" $events $checked>&nbsp;" . $lang[1506] . "
                &nbsp;<INPUT $readonly ID=\"" . $gfield[$gtabid]["form_name"][$bzm] . "_1\"  TYPE=\"RADIO\" NAME=\"" . $gfield[$gtabid]["form_name"][$bzm] . "\" VALUE=\"0\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"" . $gfield[$gtabid]["need"][$bzm] . $gfield[$gtabid]["beschreibung"][$bzm] . "\" TABINDEX=\"$z_index\" $events $checked0>&nbsp;" . $lang[1507];
            }
            echo "</div>";
        // radio reversed
        } elseif ($gfield[$gtabid]["listing_viewmode"][$bzm] == 3){
            echo "<div $style class=\"$roclass " . $class . "\">";
            if($params['position'] != 'left') {
                echo $lang[1507]."&nbsp;<INPUT $readonly ID=\"".$gfield[$gtabid]["form_name"][$bzm]."_0\"  TYPE=\"RADIO\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" VALUE=\"0\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $events $checked0>&nbsp;".
                $lang[1506]."&nbsp;<INPUT $readonly ID=\"".$gfield[$gtabid]["form_name"][$bzm]."_1\"  TYPE=\"RADIO\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" VALUE=\"1\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $events $checked>";
            }else{
                echo "<INPUT $readonly ID=\"" . $gfield[$gtabid]["form_name"][$bzm] . "_0\"  TYPE=\"RADIO\" NAME=\"" . $gfield[$gtabid]["form_name"][$bzm] . "\" VALUE=\"0\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"" . $gfield[$gtabid]["need"][$bzm] . $gfield[$gtabid]["beschreibung"][$bzm] . "\" TABINDEX=\"$z_index\" $events $checked0>&nbsp;" . $lang[1507] . "
                &nbsp;<INPUT $readonly ID=\"" . $gfield[$gtabid]["form_name"][$bzm] . "_1\"  TYPE=\"RADIO\" NAME=\"" . $gfield[$gtabid]["form_name"][$bzm] . "\" VALUE=\"1\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"" . $gfield[$gtabid]["need"][$bzm] . $gfield[$gtabid]["beschreibung"][$bzm] . "\" TABINDEX=\"$z_index\" $events $checked>&nbsp;" . $lang[1506];
            }
            echo "</div>";
        // select
        } elseif ($gfield[$gtabid]["listing_viewmode"][$bzm] == 2){
            echo "
            <SELECT $readonly ID=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"form-select " . $class . "\" $style TYPE=\"RADIO\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $events>
            <OPTION VALUE=\"1\" $selected>".$lang[1506]."
            <OPTION VALUE=\"0\" $selected0>".$lang[1507]."
            </SELECT>";
        }

        /*
	}elseif($typ == 2){
		if($gresult[$gtabid][$bzm][0] == 1){
			$events = dftyp_events($typ,$event,null,null,null,null,null,$gresult,$gtabid,$bzm);
			echo "<div id=\"".$gfield[$gtabid]["form_name"][$bzm]."\" name=\"".$gfield[$gtabid]["form_name"][$bzm]."\" $class $style $events><i class=\"lmb-icon lmb-check\" BORDER=\"0\"></i></div>";
		}else{
		    echo "<div id=\"".$gfield[$gtabid]["form_name"][$bzm]."\" name=\"".$gfield[$gtabid]["form_name"][$bzm]."\" $class $style_ $events>&nbsp;</div>";
		}
	}
        */
}

/* -------------------------- DB-ID --------------------------------- */
function dftyp_6($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null) {
	global $gtab;
	global $gfield;
	global $lang;

	$events = dftyp_events(2,$event,null,null,null,null,null,$gresult,$gtabid,$bzm);
	if($style){$style = "STYLE=\"".$pos.$style."\"";}
    if(!$gformid){$roclass='form-control readonly';}

	echo "<DIV class=\"$roclass " . $class . "\" $style $events>";
	echo $gresult[$gtabid]["id"][0];
	echo "<input type=\"hidden\" name=\"".$gfield[$gtabid]["form_name"][$bzm]."\" value=\"".$gresult[$gtabid]["id"][0]."\">";
	echo "</DIV>";
}

/* -------------------------- SYSTEM_USER --------------------------------- */
function dftyp_19($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null) {
	global $gtab;
	global $gfield;
	global $userdat;
	global $lang;

    if(!$gformid){$roclass='form-control readonly';}

	#$event_click = "new_message=open('main.php?action=message_new&to=".urlencode($userdat["bezeichnung"][$gresult[$gtabid][$gfield[$gtabid]["field_name"][$bzm]][0]])." <u@local.".$userdat["userid"][$gresult[$gtabid][$gfield[$gtabid]["field_name"][$bzm]][0]].">,' ,'Kalender','toolbar=0,location=0,status=0,menubar=0,scrollbars=1,resizable=1,width=650,height=600')";
	$events = dftyp_events(2,$event,$event_click,null,null,null,null,$gresult,$gtabid,$bzm);
	if($style){$style = "STYLE=\"".$pos.$style."cursor:pointer;\"";}else{$style = "STYLE=\"cursor:pointer;\"";}

	echo "<DIV class=\"$roclass " . $class . "\" $style $events>".$userdat["bezeichnung"][$gresult[$gtabid][$gfield[$gtabid]["field_name"][$bzm]][0]]."</DIV>";
	echo "<input type=\"hidden\" id=\"".$gfield[$gtabid]["form_name"][$bzm]."\" name=\"".$gfield[$gtabid]["form_name"][$bzm]."\">";
}

/* -------------------------- SYSTEM_DATE --------------------------------- */
function dftyp_20($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null) {
    dftyp_4($ID,$gresult,$bzm,$gtabid,$class,$style,$pos,2,$z_index,$event, $gformid);
}

/* -------------------------- User/Gruppen-Auswahl --------------------------------- */
function dftyp_21($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null) {
	global $gtab;
	global $gfield;
	global $userdat;
	global $groupdat;
	global $lang;
	global $farbschema;
	global $db;

    if(!$ID){return;}

	if($pos){$pos = "style=\"".$pos."\"";}
	if($style){$style = "style=\"".$style."\"";}
	$events = dftyp_events($typ,$event,null,null,null,null,null,$gresult,$gtabid,$bzm);

	if($typ == 1){
        $evtUser = "lmbAjax_showUserGroupsSearch(event,this,this.value,'".$ID."','".$gtabid."','$bzm','lmb_UGtype','".$gfield[$gtabid]["form_name"][$bzm]."','user','');";
        $evtGroup = "lmbAjax_showUserGroupsSearch(event,this,this.value,'".$ID."','".$gtabid."','$bzm','lmb_UGtype','".$gfield[$gtabid]["form_name"][$bzm]."','group','')";
		echo "
		    <table class=\"" . $class . "\" $pos><tr><td>
			<table cellpadding=0 cellspacing=0 style=\"width:100%\"><tr>
			<td nowrap style=\"width:50%;\">
			<i class=\"lmb-icon lmb-user-alt\" style=\"cursor:pointer\" onclick=\"activ_menu=1;lmbAjax_showUserGroupsSearch(event,this,'*','".$ID."','".$gtabid."','$bzm','lmb_UGtype','".$gfield[$gtabid]["form_name"][$bzm]."','user')\"></i>&nbsp;<input type=\"text\" style=\"width:80%;\" ondblclick=\"this.value='*';$evtUser\"' OnKeyup=\"$evtUser\">
			<div id=\"".$gfield[$gtabid]["form_name"][$bzm]."lmb_UGtypeuser\" class=\"lmbContextMenu\" style=\"position:absolute;display:none;\"></div>
			</td><td nowrap style=\"width:50%;\">
			<i class=\"lmb-icon lmb-group\" style=\"cursor:pointer\" OnClick=\"activ_menu=1;lmbAjax_showUserGroupsSearch(event,this,'*','".$ID."','".$gtabid."','$bzm','lmb_UGtype','".$gfield[$gtabid]["form_name"][$bzm]."','group','')\"></i>&nbsp;<input type=\"text\" style=\"width:80%;\" ondblclick=\"this.value='*';$evtGroup\" OnKeyup=\"$evtGroup\">
			<div id=\"".$gfield[$gtabid]["form_name"][$bzm]."lmb_UGtypegroup\" class=\"lmbContextMenu\" style=\"position:absolute;display:none;\"></div>
			</td></tr></table>
		";

		echo "<div id=\"".$gfield[$gtabid]["form_name"][$bzm]."_dsl\" style=\"margin-left:20px;\">";
	}

	$sqlquery = "SELECT UGID,TYP FROM LMB_UGLST WHERE TABID = $gtabid AND FIELDID = $bzm AND DATID = ".$ID;
	$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
	while(lmbdb_fetch_row($rs)){
		$gutyp = lmbdb_result($rs, "TYP");
		$guid = lmbdb_result($rs, "UGID");
		$ers = "";
		if($typ != 2){$ers = "<i class=\"lmb-icon lmb-erase\" OnClick=\"lmb_UGtype('".$guid."_".$gutyp."','','$gtabid','$bzm','$ID','');\" style=\"cursor:pointer\"></i>&nbsp;";}
		if($gutyp == 'u'){
			$gres[] = "<span>".$ers."<i class=\"lmb-icon lmb-icon-8 lmb-user\"></i> ".$userdat["bezeichnung"][$guid].$br."</span>";
		}elseif($gutyp == 'g'){
			$gres[] = "<span>".$ers."<i class=\"lmb-icon lmb-icon-8 lmb-group\"></i> ".$groupdat["name"][$guid].$br."</span>";
		}
	}

	if($gres){
		if($typ != 2){echo "<hr>";}
		if(!$gfield[$gtabid]["select_cut"][$bzm]) {
		    $cut = '<br>';
        } elseif (lmb_strtoupper($gfield[$gtabid]["select_cut"][$bzm]) == "<OL>" OR lmb_strtoupper($gfield[$gtabid]["select_cut"][$bzm]) == "<UL>" OR lmb_strtoupper($gfield[$gtabid]["select_cut"][$bzm]) == "<LI>") {
		    echo "<LI>";$cut = "<LI>";
		} else {
		    $cut = $gfield[$gtabid]["select_cut"][$bzm];
		}
		echo implode($cut,$gres);
	}
    if($typ == 1) {
        echo '</div></td></tr></table>';
    }

}

/* -------------------------- Filesize --------------------------------- */
function dftyp_29($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null) {
	global $gtab;
	global $gfield;
	global $lang;

	if($pos){$pos = "STYLE=\"".$pos."\"";}
	if($style){$style = "STYLE=\"".$style."\"";}
    if(!$gformid){$roclass='form-control readonly';}

	echo "<DIV $pos>";
	if($typ == 1){
		$event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm]."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value,'$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."',null,null,'".$gresult[$gtabid]['parentage']."')";
		$events = dftyp_events($typ,$event,null,null,null,null,$event_change,$gresult,$gtabid,$bzm);
		echo "<INPUT ID=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"form-control " . $class . "\" $style TYPE=\"TEXT\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" VALUE=\"".file_size($gresult[$gtabid][$bzm][0])."\" MAXLENGTH=\"".$gfield[$gtabid]["size"][$bzm]."\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $events>";
	}elseif($typ == 2){
		$events = dftyp_events($typ,$event,$event_click,null,null,null,null,$gresult,$gtabid,$bzm);
		echo "<div id=\"".$gfield[$gtabid]["form_name"][$bzm]."\" name=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"$roclass " . $class . "\" $style $events style=\"cursor:pointer;\">".file_size($gresult[$gtabid][$bzm][0])."</div>";
	}
	echo "</DIV>";
}

/* -------------------------- Mimetype --------------------------------- */
function dftyp_30($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null) {
	global $gtab;
	global $gfield;
	global $lang;
	global $gmimetypes;

	if($pos){$pos = "STYLE=\"".$pos."\"";}
	if($style){$style = "STYLE=\"".$style."\"";}
    if(!$gformid){$roclass='form-control readonly';}

	echo "<DIV $pos>";
	if($typ == 1){
		$event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm]."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value,'$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."',null,null,'".$gresult[$gtabid]['parentage']."')";
		$events = dftyp_events($typ,$event,null,null,null,null,$event_change,$gresult,$gtabid,$bzm);
		echo "<SELECT ID=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"form-select " . $class . "\" $style NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $events>\n";
		foreach ($gmimetypes["mimetype"] as $key => $value){
			if($key == $gresult[$gtabid][$bzm][0]){$SELECTED = "SELECTED";}else{$SELECTED = "";}
			echo "<OPTION VALUE=\"$key\" $SELECTED>".$value."\n";
		}
		echo "</SELECT>\n";
	}elseif($typ == 2){
		$events = dftyp_events($typ,$event,$event_click,null,null,null,null,$gresult,$gtabid,$bzm);
		echo "<div id=\"".$gfield[$gtabid]["form_name"][$bzm]."\" name=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"$roclass " . $class . "\" $style $events style=\"cursor:pointer;\">".$gmimetypes["mimetype"][$gresult[$gtabid][$bzm][0]]."</div>";
	}
	echo "</DIV>";
}

/* -------------------------- Email --------------------------------- */
function dftyp_17($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null) {
	global $gtab;
	global $gfield;
	global $lang;

	if($pos){$pos = "STYLE=\"".$pos."\"";}
	if($style){$style = "STYLE=\"".$style."\"";}
    if(!$gformid){$roclass='form-control readonly';}

	echo "<DIV $pos>";
    $event_click = "lmbShowTemplateModal($gtabid, $ID, 'mail', true, {receiver: '{$gresult[$gtabid][$bzm][0]}'});";
	if($typ == 1){
		$event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm]."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value,'$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."',null,this,'".$gresult[$gtabid]['parentage']."')";
	    if($gfield[$gtabid]["inherit_tab"][$bzm] AND !$gfield[$gtabid]["argument_edit"][$bzm]){$event_change = null; $readonly='readonly';}
		$events = dftyp_events($typ,$event,null,null,null,null,$event_change,$gresult,$gtabid,$bzm);
		echo "<INPUT ID=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"form-control " . $class . "\" $style TYPE=\"TEXT\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" VALUE=\"".htmlentities($gresult[$gtabid][$bzm][0],ENT_QUOTES)."\" data-regex=\"".htmlentities($gfield[$gtabid]["regex"][$bzm],ENT_QUOTES)."\" MAXLENGTH=\"".$gfield[$gtabid]["size"][$bzm]."\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $readonly $events>";
		if($gresult[$gtabid][$bzm][0]){
			if(preg_match('/display:none/',$style)){$sdpl="display:none;";}
			if($gfield[$gtabid]["option"][$bzm]){echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" BORDER=\"0\" TITLE=\"$lang[869]\" style=\"cursor:pointer;vertical-align:baseline;$sdpl\" Onclick=\"$event_click\"></i>";}
		}
	}elseif($typ == 2){
		$events = dftyp_events($typ,$event,$event_click,null,null,null,null,$gresult,$gtabid,$bzm);
		echo "<div class=\"$roclass " . $class . "\" $style $events style=\"cursor:pointer;\"><A href=\"#\"  id=\"".$gfield[$gtabid]["form_name"][$bzm]."\" name=\"".$gfield[$gtabid]["form_name"][$bzm]."\">".htmlentities($gresult[$gtabid][$bzm][0],ENT_QUOTES)."</A></div>";
	}

	echo "</DIV>";
}

/* -------------------------- URL --------------------------------- */
function dftyp_18($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null) {
	global $gtab;
	global $gfield;
	global $lang;

	if($pos){$pos = "STYLE=\"".$pos."\"";}
	if($style){$style = "STYLE=\"".$style."\"";}
    if(!$gformid){$roclass='form-control readonly';}

	echo "<DIV $pos>";
	if($typ == 1){
		$event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm]."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value,'$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."',null,this,'".$gresult[$gtabid]['parentage']."')";
	    if($gfield[$gtabid]["inherit_tab"][$bzm] AND !$gfield[$gtabid]["argument_edit"][$bzm]){$event_change = null; $readonly='readonly';}
		$events = dftyp_events($typ,$event,null,null,null,null,$event_change,$gresult,$gtabid,$bzm);
		echo "<INPUT ID=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"form-control " . $class . "\" $style TYPE=\"TEXT\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" VALUE=\"".htmlentities($gresult[$gtabid][$bzm][0],ENT_QUOTES)."\" data-regex=\"".htmlentities($gfield[$gtabid]["regex"][$bzm],ENT_QUOTES)."\" MAXLENGTH=\"".$gfield[$gtabid]["size"][$bzm]."\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $readonly $events>";
		if($gresult[$gtabid][$bzm][0]){
			if(preg_match('/display:none/',$style)){$sdpl="display:none;";}
			if($gfield[$gtabid]["option"][$bzm]){echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" BORDER=\"0\" TITLE=\"$lang[870]\" style=\"cursor:pointer;vertical-align:baseline;$sdpl\" Onclick=\"website=open('".$gresult[$gtabid][$bzm][0]."' ,'Website','toolbar=1,location=1,status=1,menubar=1,scrollbars=1,resizable=1,width=850,height=600');\"></i>";}
		}
	}elseif($typ == 2){
		$events = dftyp_events($typ,$event,$event_click,null,null,null,null,$gresult,$gtabid,$bzm);
		echo "<div class=\"$roclass" . $class . "\" $style $events style=\"cursor:pointer;\"><A HREF=\"".$gresult[$gtabid][$bzm][0]."\" TARGET=\"new\" id=\"".$gfield[$gtabid]["form_name"][$bzm]."\" name=\"".$gfield[$gtabid]["form_name"][$bzm]."\">".htmlentities($gresult[$gtabid][$bzm][0],ENT_QUOTES)."</A></div>";
	}


	echo "</DIV>";
}


/* -------------------------- Picture --------------------------------- */
function dftyp_24($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null) {
	global $gtab;
	global $gfield;

	if($pos){$pos = "STYLE=\"".$pos."\"";}
	if($style){$style = "STYLE=\"".$style.";\"";}elseif($typ == 2){$style = "STYLE=\"width:auto\"";}

	echo "<DIV $pos>";
	if($typ == 1){
		$event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm]."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value,'$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."',null,null,'".$gresult[$gtabid]['parentage']."')";
		$events = dftyp_events($typ,$event,null,null,null,null,$event_change,$gresult,$gtabid,$bzm);
		echo "<INPUT ID=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"form-control " . $class . "\" $style TYPE=\"TEXT\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" VALUE=\"".htmlentities($gresult[$gtabid][$bzm][0],ENT_QUOTES)."\" MAXLENGTH=\"".$gfield[$gtabid]["size"][$bzm]."\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $events>";
	}elseif($typ == 2){
		$events = dftyp_events($typ,$event,$event_click,null,null,null,null,$gresult,$gtabid,$bzm);
		echo "<img class=\"" . $class . "\" $style $events src=\"".htmlentities($gresult[$gtabid][$bzm][0],ENT_QUOTES)."\" id=\"".$gfield[$gtabid]["form_name"][$bzm]."\" name=\"".$gfield[$gtabid]["form_name"][$bzm]."\">";
	}

	echo "</DIV>";
}

/* -------------------------- Farbauswahl --------------------------------- */
function dftyp_16($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null) {
	global $gtab;
	global $gfield;

	if($pos){$pos = "STYLE=\"".$pos."\"";}
	$style = "STYLE=\"background-color:".$gresult[$gtabid][$bzm][0].";color:".lmbSuggestColor($gresult[$gtabid][$bzm][0]).";$style\"";
	if(!$gformid){$roclass='form-control readonly';}

	echo "<DIV $pos>";
	if($typ == 1){
		$event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm]."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value,'$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."',null,null,'".$gresult[$gtabid]['parentage']."')";
	    if($gfield[$gtabid]["inherit_tab"][$bzm] AND !$gfield[$gtabid]["argument_edit"][$bzm]){$event_change = null; $readonly='readonly';}
		$events = dftyp_events($typ,$event,null,$event_dblclick,null,null,$event_change,$gresult,$gtabid,$bzm);
		echo "<INPUT ID=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"form-control " . $class . "\" $style TYPE=\"TEXT\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" VALUE=\"".htmlentities($gresult[$gtabid][$bzm][0],ENT_QUOTES)."\" MAXLENGTH=\"".$gfield[$gtabid]["size"][$bzm]."\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $readonly $events>";
		if(preg_match('/display:none/',$style)){$sdpl="display:none;";}
		if($gfield[$gtabid]["option"][$bzm]){echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" BORDER=\"0\" TITLE=\"$lang[870]\" style=\"cursor:pointer;vertical-align:baseline;$sdpl\" Onclick=\"limbasAjxColorSelect(event,'".$gfield[$gtabid]["form_name"][$bzm]."','$gtabid','$bzm','$ID')\"></i>";}
	}elseif($typ == 2){
		$events = dftyp_events($typ,$event,$event_click,null,null,null,null,$gresult,$gtabid,$bzm);
		echo "<div id=\"".$gfield[$gtabid]["form_name"][$bzm]."\" name=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"$roclass " . $class . "\" $style $events style=\"cursor:pointer;\"> ".htmlentities($gresult[$gtabid][$bzm][0],ENT_QUOTES)."</div>";
	}
	echo "</DIV>";
}


/* -------------------------- Sync-Slave --------------------------------- */
function dftyp_35($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null) {
	global $db;
    global $gtab;
	global $gfield;
	global $lmb_sync_clients;

	if(!$lmb_sync_clients){
	$sqlquery = "SELECT ID,NAME,SLAVE_URL FROM LMB_SYNC_CLIENTS ORDER BY NAME";
	$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
	while(lmbdb_fetch_row($rs)){
        $lmb_sync_clients[lmbdb_result($rs, 'ID')] = lmbdb_result($rs, 'NAME');
	}
	}

	if($pos){$pos = "STYLE=\"".$pos."\"";}
	if($style){$style = "STYLE=\"".$style."\"";}
    if(!$gformid){$roclass='form-control readonly';}

	echo "<DIV $pos>";
	if($typ == 1){
		$event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm]."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value,'".$ID."','".$gfield[$gtabid]["ajaxpost"][$bzm]."',null,null,'".$gresult[$gtabid]['parentage']."')";
	    if($gfield[$gtabid]["inherit_tab"][$bzm] AND !$gfield[$gtabid]["argument_edit"][$bzm]){$event_change = null; $readonly='readonly';}
		$events = dftyp_events($typ,$event,null,$event_dblclick,null,null,$event_change,$gresult,$gtabid,$bzm);

		echo "<SELECT ID=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"form-select " . $class . "\" $style NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $events><OPTION></OPTION>";
        foreach ($lmb_sync_clients as $key => $value){
            echo "<OPTION value=\"$key\" ";
            if($key == $gresult[$gtabid][$bzm][0]){echo "selected";}
            echo ">$value</OPTION>";
        }
        echo "</SELECT>";

	}elseif($typ == 2){
		$events = dftyp_events($typ,$event,$event_click,null,null,null,null,$gresult,$gtabid,$bzm);
		echo "<div id=\"".$gfield[$gtabid]["form_name"][$bzm]."\" name=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"$roclass " . $class . "\" $style $events style=\"cursor:pointer;\"> ".htmlentities($lmb_sync_clients[$gresult[$gtabid][$bzm][0]],ENT_QUOTES)."</div>";
	}
	echo "</DIV>";
}


/* -------------------------- multitenants --------------------------------- */
function dftyp_36($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null) {
	global $db;
    global $gtab;
    global $gfield;
    global $session;
    global $lmmultitenants;

	if($pos){$pos = "STYLE=\"".$pos."\"";}
	if($style){$style = "STYLE=\"".$style."\"";}
    if(!$gformid){$roclass='form-control readonly';}

	echo "<DIV $pos>";
	if($typ == 1){
		$event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm]."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value,'".$ID."','".$gfield[$gtabid]["ajaxpost"][$bzm]."',null,null,'".$gresult[$gtabid]['parentage']."')";
		$events = dftyp_events($typ,$event,null,$event_dblclick,null,null,$event_change,$gresult,$gtabid,$bzm);

		echo "<SELECT ID=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"form-select " . $class . "\" $style NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $events><OPTION></OPTION>";
        foreach ($lmmultitenants['mid'] as $mid => $value){
            echo "<OPTION value=\"$value\" ";
            if($value == $gresult[$gtabid]['MID'][0]){echo "selected";}
            echo ">".$lmmultitenants['name'][$mid]." ($value)</OPTION>";
        }
        echo "</SELECT>";

	}elseif($typ == 2){
		$events = dftyp_events($typ,$event,$event_click,null,null,null,null,$gresult,$gtabid,$bzm);
		echo "<div id=\"".$gfield[$gtabid]["form_name"][$bzm]."\" name=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"$roclass " . $class . "\" $style $events style=\"cursor:pointer;\" title=\"".$gresult[$gtabid]['MID'][0]."\"> ".htmlentities($lmmultitenants['name'][$lmmultitenants['translate'][$gresult[$gtabid]['MID'][0]]],ENT_QUOTES)."</div>";
	}
	echo "</DIV>";
}

/* -------------------------- Validity --------------------------------- */
function dftyp_37($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null,$formid=null) {
	global $gtab;
	global $gfield;
	global $lang;
	global $gform;

    if($pos || $style) {
        $style = "style=\"$style$pos\"";
    }

	$dateformat = 1;

    // write
    $value1 = get_date($gresult[$gtabid]['LMB_VALIDFROM'][0], 1, 2);
    $value2 = get_date($gresult[$gtabid]['LMB_VALIDTO'][0], 1, 2);

    // read/disabled
    if($typ == 2){
        // use numerformat to format date
        if($gfield[$gtabid]["nformat"][$bzm]){
            $value1 = get_format_date($gresult[$gtabid]['LMB_VALIDFROM'][0], $gfield[$gtabid]["nformat"][$bzm]);
            $value2 = get_format_date($gresult[$gtabid]['LMB_VALIDTO'][0], $gfield[$gtabid]["nformat"][$bzm]);
        }else{
            $value1 = get_date($gresult[$gtabid]['LMB_VALIDFROM'][0], $dateformat);
            $value2 = get_date($gresult[$gtabid]['LMB_VALIDTO'][0], $dateformat);
        }

        $value1 = $value1 ?: '&nbsp;';
        $value2 = $value2 ?: '&nbsp;';
    }

    $countryformat = setDateFormat($dateformat, 1);

    $event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm]."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value,'$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."',null,this,'".$gresult[$gtabid]['parentage']."')";
    if($gfield[$gtabid]["inherit_tab"][$bzm] AND !$gfield[$gtabid]["argument_edit"][$bzm]){$event_change = null; $readonly='readonly';}
    $event_dblclick = "this.value=limbasGetDate('".$countryformat."');$event_change";
    $events = dftyp_events($typ,$event,null,$event_dblclick,null,null,$event_change,$gresult,$gtabid,$bzm);

    $form_name = $gfield[$gtabid]["form_name"][$bzm];
    $regex = e($gfield[$gtabid]["regex"][$bzm]);

    echo <<<HTML
        <div class="{$class} d-flex flex-wrap" $style>
            <div class="d-flex flex-row align-items-center">
                <label for="{$form_name}_from" class="form-label m-0 mx-1">{$lang[1445]}</label>
    HTML;

    if ($typ == 2) {
        echo <<<HTML
                <div id="{$form_name}" 
                     name="{$form_name}" 
                     data-regex="{$regex}"
                     style="min-width:133px;"
                     class="form-control mx-1" $events>
                     $value1
                </div>
        HTML;
    } else {
        echo <<<HTML
                <input class="form-control w-100 mx-1" style="width:80%"
                       type="date" id="{$form_name}" 
                       name="{$form_name}[0]" 
                       value="{$value1}" maxlength="{$gfield[$gtabid]["size"][$bzm]}" 
                       data-required="{$gfield[$gtabid]["need"][$bzm]}" 
                       title="{$gfield[$gtabid]["need"][$bzm]}{$gfield[$gtabid]["beschreibung"][$bzm]}" 
                       tabindex="$z_index" $readonly $events>
        HTML;
    }

    echo <<<HTML
            </div>
            <div class="d-flex flex-row align-items-center">
                <label for="{$form_name}_to" class="form-label m-0 mx-1">{$lang[1446]}</label>
    HTML;

    if ($typ == 2) {
        echo <<<HTML
                <div id="{$form_name}"
                     name="{$form_name}" 
                     data-regex="{$regex}"
                     style="min-width:133px;"
                     class="form-control mx-1" $events>
                     $value2
                </div>
        HTML;
    } else {
        // todo description states 'GÃ¼ltigkeit von' even though it should be 'GÃ¼ltigkeit bis'
        echo <<<HTML
                <input class="form-control w-100 mx-1"
                       style="width:80%" type="date" id="{$form_name}" 
                       name="{$form_name}[1]" 
                       value="{$value2}" maxlength="{$gfield[$gtabid]["size"][$bzm]}" 
                       data-required="{$gfield[$gtabid]["need"][$bzm]}" 
                       title="{$gfield[$gtabid]["need"][$bzm]}{$gfield[$gtabid]["beschreibung"][$bzm]}" 
                       tabindex="$z_index" $readonly $events>
        HTML;
    }

    echo <<<HTML
            </div>
        </div>
    HTML;

}

/* -------------------------- Encryption --------------------------------- */
function dftyp_38($ID,&$gresult,$fieldid,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$forceDecrypt=false) {
    global $gfield;
    global $umgvar;

    $encryptionMode = $gfield[$gtabid]['encryption_mode'][$fieldid];

    $fname = 'dftyp_'.$gfield[$gtabid]['argument'][$fieldid];

    $value = $gresult[$gtabid][$fieldid][0];

    if ($encryptionMode == 1 && !$forceDecrypt && !empty($value)) {
        $params = htmlentities(implode('|',[$class,$style,$pos,$typ,$z_index,$event]),ENT_QUOTES);
        echo '<div '. $pos .' data-decrypt="' . $ID . '" data-gtabid="' . $gtabid . '" data-fieldid="' . $fieldid . '" data-dparams="' . $params . '" data-mode="detail">';
        echo '<a>Decrypt</a>';
        echo "</div>";
    } else {
        $fname($ID,$gresult,$fieldid,$gtabid,$class,$style,$pos,$typ,$z_index,$event);
    }

}


/* -------------------------- Select-Feld 1 --------------------------------- */
function dftyp_9($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null) {
	global $gtab;
	global $gfield;
	global $db;
	global $lang;
	global $session;

	if($pos){$pos = "STYLE=\"".$pos."\"";}
	if($style){$style = "STYLE=\"".$style."\"";}
    if(!$gformid){$roclass='form-control readonly';}

	# form name / detail & list
	$form_name = $gfield[$gtabid]["form_name"][$bzm];
	if($z_index == 'listmode'){
		$form_name .= "_".$ID;
	}
	if(!$ID AND $gfield[$gtabid]["dynsearch"][$bzm]) {$typ = 2;}

	echo "<DIV $pos>";
	if($typ == 1){
		# --- Dynamic Search ----
		if($gfield[$gtabid]["dynsearch"][$bzm]){
			echo "<INPUT NAME=\"".$form_name."_ds\" ID=\"".$form_name."_ds\" class=\"form-control " . $class . "\" TYPE=\"TEXT\" TABINDEX=\"$z_index\" VALUE=\"".htmlentities($gresult[$gtabid][$bzm][0],ENT_QUOTES)."\"";
			if($gfield[$gtabid]["inherit_tab"][$bzm] AND !$gfield[$gtabid]["argument_edit"][$bzm]){
			     echo " readonly ";
			}else{
			     echo " OnKeyup=\"lmbAjax_dynsearch(event,this,'11_a','".$form_name."',0,0,'$gtabid','$bzm','$ID','$typ','','','".$gfield[$gtabid]["data_type"][$bzm]."')\" OnClick=\"lmbAjax_dynsearch('*',this,'11_a','".$form_name."',0,0,'$gtabid','$bzm','$ID','$typ','','','".$gfield[$gtabid]["data_type"][$bzm]."')\" ";
			}
			echo "$style $events>";
			if($gfield[$gtabid]["select_pool"][$bzm] AND $GLOBALS["LINK"][8]){
				if(preg_match('/display:none/',$style)){$sdpl="display:none;";}
				if($gfield[$gtabid]["option"][$bzm]){echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" TITLE=\"$lang[715]\" STYLE=\"cursor:pointer;$sdpl\" Onclick=\"lmbAjax_multibleSelect(this,'$gtabid','$bzm','$ID')\"></i>";}
			}
			echo "<DIV></DIV>";
			echo "<DIV ID=\"".$form_name."_dsl\" class=\"ajax_container\" STYLE=\"position:absolute;z-index:9999;display:none;\"></DIV><INPUT data-test='B' TYPE=\"HIDDEN\" ID=\"".$form_name."\" NAME=\"".$form_name."\">";
		}else{
			$event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$form_name."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this[this.selectedIndex].text,'$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."',null,null,'".$gresult[$gtabid]['parentage']."')";
		    if($gfield[$gtabid]["inherit_tab"][$bzm] AND !$gfield[$gtabid]["argument_edit"][$bzm]){$event_change = null;}
			$events = dftyp_events($typ,$event,null,null,null,null,$event_change,$gresult,$gtabid,$bzm);
			echo "<SELECT class=\"form-select " . $class . "\" $style NAME=\"".$form_name."\" ID=\"".$form_name."\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $events>";

			# extension
			if($gfield[$gtabid]["relext"][$bzm]){
				$extension = eval($gfield[$gtabid]["relext"][$bzm]);
				if($extension['where']){$where = 'AND ('.$extension['where'].')';}
			}

			// multilang
			$field_name = 'WERT';
			if($gfield[$gtabid]['multilang'][$bzm] == 2){
		        $field_name = 'LANG'.$session['dlanguage'].'_WERT';
		    }

			$sqlquery = "SELECT ID,$field_name,HIDE,DEF FROM LMB_SELECT_W WHERE POOL = ".$gfield[$gtabid]["select_pool"][$bzm]." ".$where;
            if ($gfield[$gtabid]["select_sort"][$bzm]) {$sqlquery .= " ORDER BY LMB_SELECT_W." . $gfield[$gtabid]["select_sort"][$bzm];} else {$sqlquery .= " ORDER BY LMB_SELECT_W.SORT";}
			$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);


            #$def_desc = $gfield[$gtabid]["beschreibung"][$bzm];
            #if($def_desc AND !$gresult[$gtabid][$bzm][0]) {
            #    echo "<OPTION disabled selected hidden> $def_desc";
            #}else{
                echo '<OPTION>';
            #}

			while(lmbdb_fetch_row($rs)) {
				$wert = lmbdb_result($rs, $field_name);
                $default = lmbdb_result($rs, 'DEF');
				$sval = htmlentities($wert,ENT_QUOTES);
				if(!lmbdb_result($rs, "HIDE") OR $wert == $gresult[$gtabid][$bzm][0]){
					echo "<OPTION VALUE=\"$sval\" ";
					if($wert == $gresult[$gtabid][$bzm][0] OR (!$gresult[$gtabid][$bzm][0] AND $default)){echo "SELECTED";}
					echo ">";
					echo $sval;
				}
			}
			echo "</SELECT>";
			if($gfield[$gtabid]["select_pool"][$bzm] AND $GLOBALS["LINK"][8]){
				if(preg_match('/display:none/',$style)){$sdpl="display:none;";}
				if($gfield[$gtabid]["option"][$bzm]){echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" BORDER=\"0\" TITLE=\"$lang[715]\" style=\"cursor:pointer;vertical-align:baseline;$sdpl\" Onclick=\"lmbAjax_multibleSelect(this,'$gtabid','$bzm','$ID');\"></i>";}
			}
		}
	}elseif($typ == 2){
		$events = dftyp_events($typ,$event,$event_click,null,null,null,null,$gresult,$gtabid,$bzm);
		echo "<div id=\"".$gfield[$gtabid]["form_name"][$bzm]."\" name=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"$roclass readonly " . $class . "\" $style $events style=\"cursor:pointer;\"> ".htmlentities($gresult[$gtabid][$bzm][0],ENT_QUOTES)."</div>";
	}
	echo "</DIV>";
}

/* -------------------------- Select-Feld 2 / Radio --------------------------------- */
function dftyp_15($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null,$formid=null,$language=null,$params=null) {
	global $gtab;
	global $gfield;
	global $db;
	global $lang;
	global $session;
    global $gform;

	if($style){$style = "STYLE=\"width:100%;".$pos.$style.";\"";}else{$style="style=\"width:auto\"";}
    if(!$gformid){$roclass='form-control readonly';}

	if($typ == 1 OR $params['use_specific']){
		$event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm]."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value,'$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."',null,this,'".$gresult[$gtabid]['parentage']."')";
	    if($gfield[$gtabid]["inherit_tab"][$bzm] AND !$gfield[$gtabid]["argument_edit"][$bzm]){$event_change = null;}
		$events = dftyp_events($typ,$event,null,null,null,null,$event_change,$gresult,$gtabid,$bzm);

        // parameters
        if($gform[$gformid]["parameters"][$formid]) {
            eval($gform[$gformid]["parameters"][$formid].';');
        }

        // extension
		if($gfield[$gtabid]["relext"][$bzm]){
			$extension = eval($gfield[$gtabid]["relext"][$bzm]);
			if($extension['where']){$where = 'AND ('.$extension['where'].')';}
		}

		// multilang
		$field_name = 'WERT';
		if($gfield[$gtabid]['multilang'][$bzm] == 2){
		     $field_name = 'LANG'.$session['dlanguage'].'_WERT';
		}

        // extended formating
        if($typ == 2){
            $readonly = 'readonly';
        }
        if($params['width']) {
            $width = $params['width'];
        }elseif($gform[$gformid]['width'][$formid]){
            $width = ($gform[$gformid]['width'][$formid]-30);
        }elseif(!$params['notitle']){
            $width = '50';
        }
        $align='left';

        if($params['use_specific']){$where .= ' AND ID = '.parse_db_int($params['use_specific']);}
		$sqlquery = "SELECT $field_name,HIDE,ID FROM LMB_SELECT_W WHERE POOL = ".$gfield[$gtabid]["select_pool"][$bzm].' '.$where;
		if ($gfield[$gtabid]["select_sort"][$bzm]) {$sqlquery .= " ORDER BY LMB_SELECT_W." . $gfield[$gtabid]["select_sort"][$bzm];} else {$sqlquery .= " ORDER BY LMB_SELECT_W.SORT";}
		echo "<TABLE BORDER=\"0\" CELLPADDING=\"2\" CELLSPACING=\"0\" class=\"" . $class . "\" $style>";
		$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
		if($params['linebreak'] == 'line'){
            echo "<TR>";$space = '&nbsp;&nbsp;';
            if($params['position'] != 'left'){
                $style_r = "style=\"min-width:{$width}px;\"";}
            else{
                $style_l = "style=\"min-width:{$width}px;\"";
            }
        }else{
            if($params['position'] != 'left'){
                $style_l = "style=\"min-width:{$width}px;\"";}
            else{
                $style_r = "style=\"min-width:{$width}px;\"";
            }
        }

        while(lmbdb_fetch_row($rs)) {
			$wert = lmbdb_result($rs, $field_name);
			$i++;
			if(!lmbdb_result($rs, "HIDE") OR $wert == $gresult[$gtabid][$bzm][0]){
				if(!$params['linebreak']){echo "<TR>";}
				if($params['position'] != 'left' AND !$params['notitle']){
                    echo "<TD $style_l>".htmlentities($wert,ENT_QUOTES).$space."</TD>";if(!$params['linebreak']){$align='right';}
                }
				echo "<TD align=\"$align\" $style_r><INPUT class=\"" . $class . "\" $readonly ID=\"".$gfield[$gtabid]["form_name"][$bzm]."_$i\" data-index=\"$i\" TYPE=\"RADIO\" VALUE=\"".htmlentities($wert,ENT_QUOTES)."\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" STYLE=\"border:none;background-color:transparent;\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $events";
				if($wert == $gresult[$gtabid][$bzm][0]){echo "CHECKED";}
				echo "></TD>";
                if($params['position'] == 'left' AND !$params['notitle']){echo "<TD $style_l>".$space.htmlentities($wert,ENT_QUOTES)."</TD>";}
				if(!$params['linebreak']){echo "</TR>";}
			}
		}
        if($params['linebreak'] == 'line'){echo "</TR>";}
		echo "</TABLE>";
	}elseif($typ == 2){
		$events = dftyp_events($typ,$event,$event_click,null,null,null,null,$gresult,$gtabid,$bzm);
		echo "<div id=\"".$gfield[$gtabid]["form_name"][$bzm]."\" name=\"".$gfield[$gtabid]["form_name"][$bzm]."\" class=\"$roclass readonly " . $class . "\" $style $events style=\"cursor:pointer;\">".htmlentities($gresult[$gtabid][$bzm][0],ENT_QUOTES)."</div>";
	}
}

/* -------------------------- Select-Feld-Multiple --------------------------------- */
function dftyp_10($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null,$formid=null) {
	global $gtab;
	global $gfield;
	global $lang;
	global $db;
	global $session;

	if($pos){$pos = "STYLE=\"".$pos."\"";}
	if($style){$style = "STYLE=\"".$style."\"";}
    if(!$gformid){$roclass='form-control readonly';}

	if(!$ID) {$typ = 2;}

	# form name / detail & list
	$form_name = $gfield[$gtabid]["form_name"][$bzm];
	if($z_index == 'listmode'){
		$form_name .= "_".$ID;
	}

	// multilang
	$field_name = 'WERT';
	if($gfield[$gtabid]['multilang'][$bzm] == 2){
	    $field_name = 'LANG'.$session['dlanguage'].'_WERT';
	}

	echo "<DIV $pos>";
	if($typ == 1){

		# extension
		if($gfield[$gtabid]["relext"][$bzm]){
			$extension = eval($gfield[$gtabid]["relext"][$bzm]);
			if($extension['where']){$where = 'AND ('.$extension['where'].')';}
		}

		/*------ Pool --------*/
		$sqlquery = "SELECT LMB_SELECT_W.ID,LMB_SELECT_W.$field_name,LMB_SELECT_D.ID AS DID FROM LMB_SELECT_W
		LEFT OUTER JOIN LMB_SELECT_D ON (LMB_SELECT_D.W_ID = LMB_SELECT_W.ID AND LMB_SELECT_D.TAB_ID = ".$gtabid." AND LMB_SELECT_D.FIELD_ID = ".$bzm." AND LMB_SELECT_D.DAT_ID = $ID)
		WHERE LMB_SELECT_W.POOL = ".$gfield[$gtabid]['select_pool'][$bzm]." AND LMB_SELECT_W.HIDE = FALSE $where";
		if ($gfield[$gtabid]["select_sort"][$bzm]) {$sqlquery .= " ORDER BY LMB_SELECT_W." . $gfield[$gtabid]["select_sort"][$bzm].", LMB_SELECT_D.ID";} else {$sqlquery .= " ORDER BY LMB_SELECT_D.ID";}
		$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
		while(lmbdb_fetch_row($rs)) {
			$sid = lmbdb_result($rs, "ID");
			$mselct['value'][$sid] = lmbdb_result($rs, $field_name);
			$mselct['d_id'][$sid] = lmbdb_result($rs, "DID");
		}

		# if unique
		if(!$gfield[$gtabid]["unique"][$bzm]){$MULTIPLE = "MULTIPLE SIZE=\"".(lmb_count($mselct['value'])+1)."\"";}
		$event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$form_name."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this[this.selectedIndex].text,'$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."',null,null,'".$gresult[$gtabid]['parentage']."')";
	    if($gfield[$gtabid]["inherit_tab"][$bzm] AND !$gfield[$gtabid]["argument_edit"][$bzm]){$event_change = null;}
		$events = dftyp_events($typ,$event,null,null,null,null,$event_change,$gresult,$gtabid,$bzm);
		echo "<INPUT TYPE=\"HIDDEN\" NAME=\"".$form_name."\" data-test='C'>";
		echo "<SELECT ID=\"".$form_name."\" $style class=\"form-select " . $class . "\" $MULTIPLE  NAME=\"".$form_name."[]\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $events><OPTION>";

		/*------ Vorhandene Werte --------*/
		if($mselct['value']){
		foreach ($mselct['value'] as $wid => $value){
			echo "<OPTION ";
			if($mselct['d_id'][$wid]){echo "SELECTED";}
			echo " VALUE=\"$wid\">";
			echo htmlentities($value,ENT_QUOTES);
		}}
		echo "</SELECT>";

		if($gfield[$gtabid]["select_pool"][$bzm] AND $GLOBALS["LINK"][8]){
			if(preg_match('/display:none/',$style)){$sdpl="display:none;";}
			if($gfield[$gtabid]["option"][$bzm]){echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" BORDER=\"0\" TITLE=\"$lang[715]\" style=\"cursor:pointer;vertical-align:baseline;$sdpl\" Onclick=\"lmbAjax_multibleSelect(this,'$gtabid','$bzm','$ID')\"></i>";}
		}

		# update fieldvalue with count of relation
		if(parse_db_int($scount) != parse_db_int($gresult[$gtabid][$bzm][0])){updateMultiselectCount($gtabid,$bzm,$ID);}

	}elseif($typ == 2){
		$events = dftyp_events($typ,$event,null,null,null,null,null,$gresult,$gtabid,$bzm);
		echo "<div id=\"".$form_name."\" $style class=\"$roclass " . $class . "\" $events>";
		$sqlquery1 = "SELECT LMB_SELECT_W.$field_name FROM LMB_SELECT_W,LMB_SELECT_D WHERE LMB_SELECT_D.W_ID = LMB_SELECT_W.ID AND LMB_SELECT_D.TAB_ID = $gtabid AND LMB_SELECT_D.FIELD_ID = $bzm AND LMB_SELECT_D.DAT_ID = $ID AND LMB_SELECT_W.HIDE = FALSE ";
		if ($gfield[$gtabid]["select_sort"][$bzm]) {$sqlquery .= " ORDER BY LMB_SELECT_W." . $gfield[$gtabid]["select_sort"][$bzm].", LMB_SELECT_D.ID";} else {$sqlquery .= " ORDER BY LMB_SELECT_D.ID";}
		$rs1 = lmbdb_exec($db,$sqlquery1) or errorhandle(lmbdb_errormsg($db),$sqlquery1,$action,__FILE__,__LINE__);
		while(lmbdb_fetch_row($rs1)) {
			if(!$gfield[$gtabid]["unique"][$bzm]){echo "<li class=\"gtabBodyDetailValLI\">";}
			echo htmlentities(lmbdb_result($rs1, $field_name),ENT_QUOTES);
			if(!$gfield[$gtabid]["unique"][$bzm]){echo "</li>";}
		}
		echo "</div>";
	}
	echo "</DIV>";
}


/* -------------------------- multiselect / attribute - Ajax  --------------------------------- */
function dftyp_11($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null,$formid=null) {
	global $gtab;
	global $gfield;
	global $lang;
	global $db;
	global $session;
	global $farbschema;
	global $gform;

	#if(!$ID){return;}
    $showframe = true;
	if(!$ID) {$typ = 2;}
    if($style == -1){$showframe=false;}
    if(!$gformid){$roclass='form-control readonly';}

	$ellid = array();

	// multilang
	$field_name = 'WERT';
	if($gfield[$gtabid]['multilang'][$bzm] == 2){
	    $field_name = 'LANG'.$session['dlanguage'].'_WERT';
	}

	// SELECT / ATTRIBUTE
	if($gfield[$gtabid]["field_type"][$bzm] == 19){$tabtyp = "LMB_ATTRIBUTE";}else{$tabtyp = "LMB_SELECT";}

	// Poolsettings
    $pool_tagmode = $GLOBALS['gselectpool'][$tabtyp]['tagmode'][$gfield[$gtabid]["select_pool"][$bzm]];
    $pool_multimode = $GLOBALS['gselectpool'][$tabtyp]['multimode'][$gfield[$gtabid]["select_pool"][$bzm]];
    #$sqlquery = "SELECT LMB_{$tabtyp}_P.TAGMODE,LMB_{$tabtyp}_P.MULTIMODE FROM LMB_{$tabtyp}_P WHERE ID = ".$gfield[$gtabid]["select_pool"][$bzm];
    #$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
    #$pool_tagmode = lmbdb_result($rs, 'TAGMODE');
    #$pool_multimode = lmbdb_result($rs, "MULTIMODE");

	if($typ == 1){

		# form style
		if($style){
			$stylearray = explode(";",$gform[$gformid]["style"][$formid]);
			$style_body = 'overflow:'.$stylearray[24].';padding:'.$stylearray[22].';height:'.($gform[$gformid]["height"][$formid]-26);
			$style = str_replace('overflow:','overflowx',$style);
			$style = str_replace('height:','heightx',$style);
            if ($pool_tagmode) {
                $class = 'tagattr';
            }
		# default style
		}else{
			$class1 = $class;
			$class = 'fgtabchange';
			$style_body = 'padding:2px;';
		}

		# get select values
		if($gfield[$gtabid]["field_type"][$bzm] != 19){
			$sqlquery1 = "SELECT LMB_SELECT_W.ID,LMB_SELECT_D.ID AS DID,LMB_SELECT_W.$field_name,LMB_SELECT_W.KEYWORDS FROM LMB_SELECT_W,LMB_SELECT_D WHERE LMB_SELECT_D.W_ID = LMB_SELECT_W.ID AND LMB_SELECT_D.TAB_ID = ".$gtabid." AND LMB_SELECT_D.FIELD_ID = ".$bzm." AND LMB_SELECT_D.DAT_ID = $ID";
			if ($gfield[$gtabid]["select_sort"][$bzm]) {$sqlquery1 .= " ORDER BY LMB_SELECT_W." . $gfield[$gtabid]["select_sort"][$bzm].", LMB_SELECT_D.ID";} else {$sqlquery1 .= "ORDER BY LMB_SELECT_D.ID";}
		    $rs1 = lmbdb_exec($db,$sqlquery1) or errorhandle(lmbdb_errormsg($db),$sqlquery1,$action,__FILE__,__LINE__);
			# get single value if is unique
			if($gfield[$gtabid]["unique"][$bzm]){
				$singlevalue = lmbdb_result($rs1, $field_name);
				$svalue = lmbdb_result($rs1, "ID");
			}
		}

		# form name / detail & list
		$form_name = $gfield[$gtabid]["form_name"][$bzm];
		if($z_index == 'listmode'){
			$form_name .= "_".$ID;
		}

		if($showframe) {
            echo "<div style=\"" . $pos . "\">";
            echo "<table cellpadding=0 cellspacing=0 style=\"width:100%\"><tr><td class=\"" . $class1 . "\"><div class=\"" . $class . "\" style=\"" . $style . "\">";

            # --- Dynamic Search or Attribute ----
            echo "<INPUT NAME=\"" . $form_name . "_ds\" ID=\"" . $form_name . "_ds\" style=\"width:100%\" TYPE=\"TEXT\" TABINDEX=\"$z_index\" OnKeyup=\"lmbAjax_dynsearch(event,this,'11_a','" . $form_name . "',0,0,'$gtabid','$bzm','$ID','$typ','','','" . $gfield[$gtabid]["data_type"][$bzm] . "')\" OnClick=\"lmbAjax_dynsearch('*',this,'11_a','" . $form_name . "',0,0,'$gtabid','$bzm','$ID','$typ','','','" . $gfield[$gtabid]["data_type"][$bzm] . "')\" $events value=\"" . htmlentities($singlevalue, ENT_QUOTES) . "\" title=\"" . $gfield[$gtabid]["beschreibung"][$bzm] . " - use [CTRL] for multiple joice\">";
            echo "<DIV ID=\"" . $form_name . "_dsl\" class=\"ajax_container\" STYLE=\"position:absolute;z-index:9999;display:none\" OnClick=\"activ_menu=1;\"></DIV>";
        }

		# attributes
		if($gfield[$gtabid]["field_type"][$bzm] == 19){

            if($showframe) {
                echo "<DIV ID=\"" . $form_name . "_dse\" STYLE=\"$style_body\">";
            }

            ################
            $ellid = dftyp_tags($gtabid,$bzm,$ID,$form_name,$field_name,$pool_multimode,$typ,$gresult);
            ################

            if($showframe) {
                echo "</DIV>";
            }

		# multiselect - only if not unique
        } elseif (!$gfield[$gtabid]["unique"][$bzm]) {
            if($showframe) {
                echo "<DIV ID=\"" . $form_name . "_dse\" STYLE=\"$style_body;padding-left:5px;\">";
            }
            if ($pool_tagmode) {
                echo '<div class="tagmulti">';
            }

            $scount = 0;
            while (lmbdb_fetch_row($rs1)) {
                $ellist[] = "
                <SPAN style=\"cursor:pointer;vertical-align:middle;\" TITLE=\"" . htmlentities(lmbdb_result($rs1, "KEYWORDS"), ENT_QUOTES) . "\">
                <i class=\"lmb-icon lmb-erase\" is_active=\"1\" style=\"cursor:pointer;font-size:10\" 
                OnClick=\"dyns_11_a(event,this,'" . lmbdb_result($rs1, "DID") . "','" . $form_name . "','$bzm','$gtabid','$ID','','','g');\"></i>
                <SPAN>" . htmlentities(lmbdb_result($rs1, $field_name), ENT_QUOTES) ."</SPAN></SPAN>";
                $ellid[] = lmbdb_result($rs1, "ID");
                $bzm1++;
            }
            if (!$gfield[$gtabid]["select_cut"][$bzm] OR lmb_strtoupper($gfield[$gtabid]["select_cut"][$bzm]) == "<OL>" OR lmb_strtoupper($gfield[$gtabid]["select_cut"][$bzm]) == "<UL>" OR lmb_strtoupper($gfield[$gtabid]["select_cut"][$bzm]) == "<LI>") {
                echo "<LI>";
                $cut = "<LI>";
            } else {
                $cut = $gfield[$gtabid]["select_cut"][$bzm];
            }
            if(is_array($ellist)) {
                echo implode($cut, $ellist);
            }

            if ($pool_tagmode) {
                echo '</div>';
            }
            if($showframe) {
                echo "</DIV>";
            }
        }

		if(is_array($ellid)){$svalue = implode(";",$ellid);}

		if($showframe) {

            if(is_array($gresult) && array_key_exists('g_15_1',$gresult)) {
                //$svalue .= $gresult['g_15_1'];
            }

            echo "<INPUT TYPE=\"HIDDEN\" ID=\"" . $form_name . "\" NAME=\"" . $form_name . "\" VALUE=\"" . $svalue . "\" data-test='D'></div></td><td valign=\"top\">";
            if ($gfield[$gtabid]["select_pool"][$bzm] AND $GLOBALS["LINK"][8]) {
                if (preg_match('/display:none/', $style)) {
                    $sdpl = "display:none;";
                }
                if ($gfield[$gtabid]["option"][$bzm]) {
                    echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" TITLE=\"$lang[715]\" style=\"cursor:pointer;vertical-align:baseline;$sdpl\" Onclick=\"lmbAjax_multibleSelect(this,'$gtabid','$bzm','$ID')\"></i>";
                }
            }
            echo '</td></tr></table>';
            if ($pool_tagmode) {
                echo '<script>tagAttr_init();</script>';
            }
            echo '</div>';
        }

		# update fieldvalue with count of relation
		if(parse_db_int($scount) != parse_db_int($gresult[$gtabid][$bzm][0])){updateMultiselectCount($gtabid,$bzm,$ID);}

	}elseif($typ == 2){
		echo "<DIV class=\"$roclass " . $class . "\" STYLE=\"".$pos.$style."\">";
		# Attribute
		if($gfield[$gtabid]["field_type"][$bzm] == 19){
			global $lmfieldtype;

			// tagmode
            if ($pool_tagmode) {
                $class = 'tagattr';
            }

            echo "<div class=\"$class listform\">";
            ################
            $ellid = dftyp_tags($gtabid,$bzm,$ID,$form_name,$field_name,$pool_multimode,$typ,$gresult);
            ################
            echo "</div>";

		# Select
		}else{
			$sqlquery1 = "SELECT LMB_SELECT_W.$field_name FROM LMB_SELECT_W,LMB_SELECT_D WHERE LMB_SELECT_D.W_ID = LMB_SELECT_W.ID AND LMB_SELECT_D.TAB_ID = ".$gtabid." AND LMB_SELECT_D.FIELD_ID = ".$bzm." AND LMB_SELECT_D.DAT_ID = $ID";
			if ($gfield[$gtabid]["select_sort"][$bzm]) {$sqlquery1 .= " ORDER BY LMB_SELECT_W." . $gfield[$gtabid]["select_sort"][$bzm].", LMB_SELECT_D.ID";} else {$sqlquery1 .= " ORDER BY LMB_SELECT_D.ID";}
			$rs1 = lmbdb_exec($db,$sqlquery1) or errorhandle(lmbdb_errormsg($db),$sqlquery1,$action,__FILE__,__LINE__);
			while(lmbdb_fetch_row($rs1)) {
				$ellist[] = htmlentities(lmbdb_result($rs1, $field_name),ENT_QUOTES);
			}
			if(lmb_strtoupper($gfield[$gtabid]["select_cut"][$bzm]) == "<OL>" OR lmb_strtoupper($gfield[$gtabid]["select_cut"][$bzm]) == "<UL>" OR lmb_strtoupper($gfield[$gtabid]["select_cut"][$bzm]) == "<LI>"){echo "<LI>";$cut = "<LI>";}else{$cut = $gfield[$gtabid]["select_cut"][$bzm];}
			if($ellist){echo implode($cut,$ellist);}

		}
		echo "</DIV>";
	}
}


function dftyp_tags($gtabid,$bzm,$ID,$form_name,$field_name,$pool_multimode,$typ,$values=[]){
    global $db;
	global $gtab;
	global $gfield;
	global $lang;
	global $session;
	global $farbschema;
	global $gform;
	global $lmfieldtype;

    echo "<TABLE>";

    $sqlquery1 = "SELECT LMB_ATTRIBUTE_D.W_ID,LMB_ATTRIBUTE_W.TYPE,LMB_ATTRIBUTE_W.$field_name,LMB_ATTRIBUTE_W.KEYWORDS,LMB_ATTRIBUTE_W.TYPE,LMB_ATTRIBUTE_W.MANDATORY,LMB_ATTRIBUTE_W.COLOR,LMB_ATTRIBUTE_W.ATTRPOOL,LMB_ATTRIBUTE_W.HIDETAG,LMB_ATTRIBUTE_D.ID AS DID,LMB_ATTRIBUTE_D.VALUE_STRING,LMB_ATTRIBUTE_D.VALUE_NUM,VALUE_DATE FROM LMB_ATTRIBUTE_W,LMB_ATTRIBUTE_D WHERE LMB_ATTRIBUTE_D.W_ID = LMB_ATTRIBUTE_W.ID AND LMB_ATTRIBUTE_D.TAB_ID = " . $gtabid . " AND LMB_ATTRIBUTE_D.FIELD_ID = " . $bzm . " AND LMB_ATTRIBUTE_D.DAT_ID = $ID";
    if ($gfield[$gtabid]["select_sort"][$bzm]) {$sqlquery1 .= " ORDER BY LMB_ATTRIBUTE_W." . $gfield[$gtabid]["select_sort"][$bzm].", LMB_ATTRIBUTE_D.ID";} else {$sqlquery1 .= " ORDER BY LMB_ATTRIBUTE_D.ID";}
    $rs1 = lmbdb_exec($db, $sqlquery1) or errorhandle(lmbdb_errormsg($db), $sqlquery1, $action, __FILE__, __LINE__);

    while (lmbdb_fetch_row($rs1)) {

        $wert = lmbdb_result($rs1, $field_name);
        $wid = lmbdb_result($rs1, "W_ID");
        $type = lmbdb_result($rs1, 'TYPE');
        $keywords = lmbdb_result($rs1, 'KEYWORDS');
        $color = lmbdb_result($rs1, 'COLOR');
        $pool = lmbdb_result($rs1, 'ATTRPOOL');
        $hidetag = lmbdb_result($rs1, 'HIDETAG');
        $keyword = lmbdb_result($rs1, 'KEYWORDS');
        if($pool_multimode){$did = lmbdb_result($rs1, "DID");}

        $fieldName = $gfield[$gtabid]['form_name'][$bzm].'_'.$ID.'_att';
        $form_tagname = $fieldName . '[' . $wid . '][' . $did . ']';

        $need = '';
        $checkbox = '';
        $option = '';
        $attvalue = '';

        if(lmbdb_result($rs1, "MANDATORY")){$need = '*';}

        # date
        if ($lmfieldtype['parse_type'][$type] == 4) {
            $formtype = "<INPUT TYPE=\"text\"";
            $attvalue = get_date(lmbdb_result($rs1, 'VALUE_DATE'));
        # boollmb_deleteView
        } else if ($lmfieldtype['parse_type'][$type] == 3) {
            $formtype = '<input id="attrckb'.$form_tagname.'" type="checkbox" onchange="$(this).siblings(\'input\').val(this.checked?1:0).change();" ' . (lmbdb_result($rs1, 'VALUE_NUM') ? 'checked' : '') . '><label for="attrckb'.$form_tagname.'"></label><INPUT TYPE="hidden"';
            $attvalue = lmbdb_result($rs1, 'VALUE_NUM');
        # pool
        }else if($type == 12){
            $formtype = "<select ";
            $attvalue = lmbdb_result($rs1, 'VALUE_STRING');

            # extension
            if($gfield[$gtabid]["relext"][$bzm]){
                $extension = eval($gfield[$gtabid]["relext"][$bzm]);
                if($extension['where']){$where = 'AND ('.$extension['where'].')';}
            }

            // multilang
            $field_name = 'WERT';
            if($gfield[$gtabid]['multilang'][$bzm] == 2){
                $field_name = 'LANG'.$session['dlanguage'].'_WERT';
            }

            $sqlquery2 = "SELECT ID,$field_name,HIDE FROM LMB_SELECT_W WHERE POOL = $pool ".$where;  # todo - order by
            $rs2 = lmbdb_exec($db,$sqlquery2) or errorhandle(lmbdb_errormsg($db),$sqlquery2,$action,__FILE__,__LINE__);
            $option = "<OPTION>";
            while(lmbdb_fetch_row($rs2)) {
                $subval = lmbdb_result($rs2, $field_name);
                $sval = htmlentities($subval,ENT_QUOTES);
                if(!lmbdb_result($rs, "HIDE") OR $subval == $gresult[$gtabid][$bzm][0]){
                    $option .= "<OPTION VALUE=\"$sval\" ";
                    if($subval == $attvalue){$option .= "SELECTED";}
                    $option .= ">".$sval.'</OPTION>';
                }
            }

        # text / number
        } else if($type){
            $formtype = "<INPUT TYPE=\"text\"";

            if (lmbdb_result($rs1, 'VALUE_NUM')) {
                $value_num = convert_FloatRound(lmbdb_result($rs1, 'VALUE_NUM'));
            } else {
                $value_num = '';
            }
            $attvalue = htmlentities(trim($value_num . ' ' . lmbdb_result($rs1, 'VALUE_STRING')), ENT_QUOTES);
        }

        //override value if different in values use that value
        if(is_array($values) && array_key_exists($fieldName,$values) && is_array($values[$fieldName]) && array_key_exists($wid,$values[$fieldName]) && is_array($values[$fieldName][$wid]) && array_key_exists($did,$values[$fieldName][$wid])) {
            $attvalue = $values[$fieldName][$wid][$did];
        }

        // readonly
        if($typ == 2) {
            echo "<TR title=\"" . htmlentities($keyword, ENT_QUOTES) . "\" style=\"background-color:$color;color:" . lmbSuggestColor($color) . "\">
            <TD>&nbsp;</TD>
            <TD width=\"30%\" data-hidetag=\"" . $hidetag . "\">" . $wert . "</TD>
            <TD width=\"68%\">" . $attvalue . "&nbsp;</TD></TR>";
        // editmode
        }else {
            echo "<TR TITLE=\"" . htmlentities($keyword, ENT_QUOTES) . "\" style=\"background-color:$color;color:" . lmbSuggestColor($color) . "\">
            <TD><i class=\"lmb-icon lmb-erase\" is_active=\"1\" style=\"cursor:pointer\" 
            OnClick=\"dyns_11_a(event,this,'" . lmbdb_result($rs1, "DID") . "','" . $form_name . "','$bzm','$gtabid','$ID','','','g');\">
            </TD>
            <TD width=\"30%\" data-hidetag=\"$hidetag\">$wert <i style=\"color:red\">" . $need . "</i></TD>
            <TD width=\"68%\">";

            if ($type) {
                echo "
                $formtype 
                style=\"background-color:$color;color:" . lmbSuggestColor($color) . "\"
                NAME = \"" . $form_tagname . "\" 
                ID=\"" . $form_tagname . "\" 
                VALUE=\"" . $attvalue . "\" STYLE=\"overflow:initial;width:100%;\" class=\"" . $class . "\" 
                TABINDEX=\"$z_index\"
                OnChange=\"checktyp('" . lmbdb_result($rs1, "TYPE") . "','" . $form_tagname . "','" . $wert . "','" . $bzm . "','" . $gtabid . "',this.value,'$ID','" . $gfield[$gtabid]["ajaxpost"][$bzm] . "',null,null,'" . $gresult[$gtabid]['parentage'] . "');
                dyns_11_a(event,this,'" . lmbdb_result($rs1, "W_ID") . "','" . $form_name . "','$bzm','$gtabid','$ID','',1,'v');\">
                $option
                ";
            }
            echo "</TD></TR>";
        }
        $ellid[] = lmbdb_result($rs1, "W_ID");
    }

    echo "</TABLE>";

    return $ellid;

}


/* -------------------------- Select-Feld-Multiple3 --------------------------------- */
function dftyp_23($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null,$formid=null,$null,$params=null) {
	global $gtab;
	global $gfield;
    global $gform;
	global $lang;
	global $db;
	global $session;

	if(!$ID){return;}
	if($style){
		$style = "STYLE=\"width:100%;".$pos.str_replace('height:','height_:',$style).";\"";
	}else{
		$style="style=\"width:auto\"";
	}
    if(!$gformid){$roclass='form-control readonly';}

	// multilang
	$field_name = 'WERT';
	if($gfield[$gtabid]['multilang'][$bzm] == 2){
	    $field_name = 'LANG'.$session['dlanguage'].'_WERT';
	}

	if($typ == 1 OR $params['use_specific']){
		$event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm]."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.checked,'$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."','',this)";
		$events = dftyp_events($typ,$event,null,null,null,null,$event_change,$gresult,$gtabid,$bzm);

		/*------ Vorhandene Werte --------*/
		$sqlquery = "SELECT W_ID FROM LMB_SELECT_D WHERE TAB_ID = $gtabid AND FIELD_ID = $bzm AND DAT_ID = $ID";
		$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
		$tmp_result = array();
		$bzm1 = 1;
		while(lmbdb_fetch_row($rs)) {
			$tmp_result[] = lmbdb_result($rs, "W_ID");
			$bzm1++;
		}
		$scount = ($bzm1-1);

        // parameters
        if($gform[$gformid]["parameters"][$formid]) {
            eval($gform[$gformid]["parameters"][$formid].';');
        }

		# extension
		if($gfield[$gtabid]["relext"][$bzm]){
			$extension = eval($gfield[$gtabid]["relext"][$bzm]);
			if($extension['where']){$where = 'AND ('.$extension['where'].')';}
		}

        // extended formating
        if($typ == 2){
            $readonly = 'readonly';
        }
        if($params['width']) {
            $width = $params['width'];
        }elseif($gform[$gformid]['width'][$formid]){
            $width = ($gform[$gformid]['width'][$formid]-30);
        }elseif(!$params['notitle']){
            $width = '50';
        }
        $align='left';

		/*------ Auswahlliste --------*/
        if($params['use_specific']){$where .= ' AND ID = '.parse_db_int($params['use_specific']);}
		$sqlquery = "SELECT ID,$field_name,HIDE FROM LMB_SELECT_W WHERE POOL = ".$gfield[$gtabid]["select_pool"][$bzm].' '.$where;
		$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);

		echo "<TABLE class=\"" . $class . "\" $style BORDER=\"0\" CELLPADDING=\"2\" CELLSPACING=\"0\">";
		echo "<INPUT TYPE=\"HIDDEN\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."\" data-test='A'>";

		if($params['linebreak'] == 'line'){
            echo "<TR>";$space = '&nbsp;&nbsp;';
            if($params['position'] != 'left'){
                $style_r = "style=\"min-width:{$width}px;\"";}
            else{
                $style_l = "style=\"min-width:{$width}px;\"";
            }
        }else{
            if($params['position'] != 'left'){
                $style_l = "style=\"min-width:{$width}px;\"";}
            else{
                $style_r = "style=\"min-width:{$width}px;\"";
            }
        }

		$bzm1 = 1;
		while(lmbdb_fetch_row($rs)) {
            $wert = lmbdb_result($rs, $field_name);
			if(!lmbdb_result($rs, "HIDE") OR in_array(lmbdb_result($rs, "ID") ,$tmp_result)){
				if(!$params['linebreak']){echo "<TR>";}
                if($params['position'] != 'left' AND !$params['notitle']){
                    echo "<TD $style_l>".htmlentities($wert,ENT_QUOTES).$space."</TD>";if(!$params['linebreak']){$align='right';}
                }
                echo "<TD align=\"$align\" $style_r><INPUT TYPE=\"CHECKBOX\" ID=\"".$gfield[$gtabid]["form_name"][$bzm]."[".($bzm1-1)."]\" VALUE=\"".lmbdb_result($rs, "ID")."\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."[".($bzm1-1)."]\" class=\"" . $class . "\" STYLE=\"border:none;background-color:transparent;\" TABINDEX=\"$z_index\" $events data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" ";
				if(in_array(lmbdb_result($rs, "ID") ,$tmp_result)){echo "CHECKED";}
				echo "></TD>";
                if($params['position'] == 'left' AND !$params['notitle']){echo "<TD $style_l>".$space.htmlentities($wert,ENT_QUOTES)."</TD>";}
				if(!$params['linebreak']){echo "</TR>";}
			}
			$bzm1++;
		}
		unset($tmp_result);
        if($params['linebreak'] == 'line'){echo "</TR>";}
		echo "</TABLE>";
        # update fieldvalue with count of relation
		if(parse_db_int($scount) != parse_db_int($gresult[$gtabid][$bzm][0])){updateMultiselectCount($gtabid,$bzm,$ID);}

	}elseif($typ == 2){
		$events = dftyp_events(2,$event,null,null,null,null,null,$gresult,$gtabid,$bzm);
		$sqlquery1 = "SELECT LMB_SELECT_W.$field_name FROM LMB_SELECT_W,LMB_SELECT_D WHERE LMB_SELECT_D.W_ID = LMB_SELECT_W.ID AND LMB_SELECT_D.TAB_ID = ".$gtabid." AND LMB_SELECT_D.FIELD_ID = ".$bzm." AND LMB_SELECT_D.DAT_ID = $ID";
		$rs1 = lmbdb_exec($db,$sqlquery1) or errorhandle(lmbdb_errormsg($db),$sqlquery1,$action,__FILE__,__LINE__);
		echo "<div class=\"$roclass " . $class . "\" $style $events>";
		while(lmbdb_fetch_row($rs1)) {
			echo "<li>".htmlentities(lmbdb_result($rs1, $field_name),ENT_QUOTES)."</li>";
		}
		echo "</div>";
	}
	
}

/* -------------------------- Upload - deprecated --------------------------------- */
function dftyp_12($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null,$formid=null) {
	global $gtab;
	global $gfield;
	global $session;
	global $umgvar;
	global $farbschema;
	global $uploads;
	global $lang;
	global $LINK;
	global $db;
	global $userdat;
	global $gmimetypes;

	require_once(COREPATH . 'extra/explorer/filestructure.lib');
	
	if(!$ID){return;}
	if($gformid AND $formid){global $gform; $style_array = explode(";",$gform[$gformid]["style"][$formid]);}
	if($style){$style = "STYLE=\"".$pos.$style."\"";}
	if($pos){$pos = "STYLE=\"".$pos."\"";}

	# if multitenant
	$filequery = set_mttfilter();

	# --- Abfrage Datei-Liste --------------------------
	$sqlquery1 = "SELECT DISTINCT LDMS_FILES.ID,LDMS_FILES.LEVEL,LDMS_FILES.SORT,LDMS_FILES.CHECKED,LDMS_FILES.CHECKUSER,LDMS_FILES.PERM,LDMS_FILES.PERMUSER,LDMS_FILES.LMLOCK,LDMS_FILES.LOCKUSER,LDMS_FILES.SECNAME,LDMS_FILES.NAME,LDMS_FILES.THUMB_OK,LDMS_FILES.SIZE,LDMS_FILES.ERSTUSER,LDMS_FILES.ERSTDATUM,LDMS_FILES.INDD,LDMS_FILES.INDT,LDMS_FILES.IND,LDMS_FILES.MIMETYPE ".$filequery['select']."
	FROM LDMS_FILES
	WHERE LDMS_FILES.TABID = $gtabid AND LDMS_FILES.FIELDID = $bzm AND LDMS_FILES.DATID = $ID AND TYP = 3 AND VID = 1 ".$filequery['where']." ORDER BY LDMS_FILES.SORT,LDMS_FILES.ERSTDATUM";
	$rs1 = lmbdb_exec($db,$sqlquery1) or errorhandle(lmbdb_errormsg($db),$sqlquery1,$action,__FILE__,__LINE__);
	if(!$rs1) {$commit = 1;}

	# ----------- Formular Ansicht ---------------------------------------------------------------
	if($formid){

		#---- thumbs-Liste -----
        $bzm1 = 0;
		$img_sn = array();
		$width = $gform[$gformid]["width"][$formid];
		$height = $gform[$gformid]["height"][$formid];
		while(lmbdb_fetch_row($rs1)) {
		    $LID = lmbdb_result($rs1, "LEVEL");
			if($img2 = lmb_getThumbnail(array(lmbdb_result($rs1, "ID"),lmbdb_result($rs1, "SECNAME"),lmbdb_result($rs1, "MIMETYPE"),lmbdb_result($rs1, "THUMB_OK"),lmbdb_result($rs1, "LEVEL"),lmbdb_result($rs1, "LMB_MID")),($width-2),$height,1)){
				$img_sn[$bzm1] = $img2;
				$img_id[$bzm1] = lmbdb_result($rs1, "ID");
                $bzm1++;
			}
		}

		$fp = $gtabid."_".$bzm."_".$ID;
		
		#---- Scriptliste aller Bilder -----
		echo "<Script language=\"JavaScript\">\n";
		echo "var formpicsn_".$fp." = new Array();\n";
		$bzm1 = 0;
		$min = $bzm1;
		foreach($img_sn as $key => $value){
			echo "formpicsn_".$fp."[".$bzm1."] = \"".$img_sn[$key]."#$img_id[$key]\";\n";
			$bzm1++;
		}
        $max = $bzm1;

		echo "</SCRIPT>\n";
		
		$event_click = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm]."[1]','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value+'file','$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."')";
		$events = dftyp_events($typ,$event,$event_click,null,null,null,null,$gresult,$gtabid,$bzm);
		
		if(!$bzm1){
			echo "<DIV $style><TABLE class=\"" . $class . "\" STYLE=\"border-collapse:collapse;width:100%;height:100%;\"><TR class=\"tabHeader\"><TD class=\"tabHeaderItem\">
			<INPUT ID=\"f_".$LID."_1\" type=\"file\" style=\"width:100%\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."[1]\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $events>
			</TD></TR></TABLE></DIV>";
		}else{
			
			$event_click = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm]."[1]','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value+'file','$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."')";
			$events = dftyp_events($typ,$event,$event_click,null,null,null,null,$gresult,$gtabid,$bzm);

			echo "<DIV $style>";

			if($style_array[35] != 1){
                echo "<TABLE class=\"" . $class . "\" cellpadding=0 cellspacing=0 STYLE=\"border-collapse:collapse;width:100%;height:100%\" onclick=\"$(this.firstChild.firstChild).show( 'slow' )\"><TR class=\"tabHeader\" style=\"display:none\"><TD class=\"tabHeaderItem\" style=\"height:50px;\">
                <TABLE><TR>
                <TD><i title=\"$lang[2318]\" class=\"lmb-icon lmb-page-delete-alt\" STYLE=\"cursor:pointer;\" OnClick=\"checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','','','".$bzm."','".$gtabid."','delete_file','$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."');lmb_formpicdelete('".$gfield[$gtabid]["form_name"][$bzm]."','$fp');\"></i></TD>
                ";
                if(!$gfield[$gtabid]["unique"][$bzm] OR !$LID){
                    echo "<TD width=\"100%\">&nbsp;</TD>
                    <TD><i title=\"$lang[857]\" class=\"lmb-icon lmb-first\" STYLE=\"cursor:pointer;\" OnClick=\"lmb_formpicdmove('".$fp."','3','$max');\"></i></TD>
                    <TD><i title=\"$lang[860]\" class=\"lmb-icon lmb-previous\" STYLE=\"cursor:pointer;font-size:1.5em;\" OnClick=\"lmb_formpicdmove('".$fp."','2','$max');\"></i></TD>
                    <TD><INPUT TYPE=\"TEXT\" ID=\"formpicid_".$fp."\" READONLY STYLE=\"width:60px;padding:1px;\" VALUE=\"$min\"></TD>
                    <TD><i title=\"$lang[859]\" class=\"lmb-icon lmb-next\" STYLE=\"cursor:pointer;font-size:1.5em;\" OnClick=\"lmb_formpicdmove('".$fp."','1','$max');\"></i></TD>
                    <TD><i title=\"$lang[858]\" class=\"lmb-icon lmb-last\" STYLE=\"cursor:pointer;\" OnClick=\"lmb_formpicdmove('".$fp."','4','$max');\"></i></TD>
                    ";
                }else{
                     echo "<INPUT TYPE=\"hidden\" ID=\"formpicid_".$fp."\" VALUE=\"$min\">";
                }

                echo "</TR>";

                if(!$gfield[$gtabid]["unique"][$bzm] OR !$LID){
                     echo "<TR><TD colspan=\"9\"><INPUT ID=\"f_".$LID."_1\" type=\"file\" style=\"width:100%\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."[1]\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $events></TD></TR>";
                }

                echo "</TABLE></TD></TR>";
                echo "<TR><TD align=\"center\"><div style=\"height:".$height.";width:$width\"><div id=\"formpicname_".$fp."\"><IMG NAME=\"formpicname_".$fp."\" SRC=\"".$img_sn[$min]."\"></div></div></TD></TR>
                </TABLE>
                <INPUT TYPE=\"hidden\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."_delete\" VALUE=\"\">";
			}else{
			    echo "<TABLE class='$class' cellpadding=0 cellspacing=0 STYLE=\"border-collapse:collapse;width:100%;height:100%\">
                <TR><TD align=\"center\"><div style=\"height:".$height.";width:$width\"><div id=\"formpicname_".$fp."\"><IMG NAME=\"formpicname_".$fp."\" SRC=\"".$img_sn[$min]."\"></div></div></TD></TR>
			    </TABLE>";
            }

			echo "</DIV>";
		}


	# ----------- Default Ansicht -----------------------------------------------------------------
	}else{
		if($typ == 1){
			$event_click = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm]."[1]','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this.value+'file','$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."')";
			$events = dftyp_events($typ,$event,$event_click,null,null,null,null,$gresult,$gtabid,$bzm);
			echo "<DIV class=\"" . $class . "\" $pos>
			<INPUT TYPE=\"hidden\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."_delete\" VALUE=\"\">
			<TABLE class=\"gtabchange\" style=\"width:100%\">";
			
			if(!$gfield[$gtabid]["unique"][$bzm] OR !$LID){
			     echo "<TR><TD nowrap>
			         <INPUT ID=\"f_".$LID."_1\" type=\"file\" $calss NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."[1]\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" TABINDEX=\"$z_index\" $events></TD>";
			     # ---------  Uploadanzahl ---------
			     echo "<TD nowrap align=\"right\">&nbsp;&nbsp;<SELECT STYLE=\"width:40px;\" NAME=\"uploads[$gtabid][$bzm]\" OnChange=\"multiupload(this.value,'$LID');\">";
			     for ($i=1;$i<=10;$i++){
				        echo "<OPTION VALUE=\"$i\">$i";
			     }
			     echo "</SELECT></TD></TR>";
			}
			
			$events = dftyp_events($typ,$event,null,null,null,null,null,$gresult,$gtabid,$bzm);
			# ---------  Uploadfelder ---------
			for ($i=2;$i<=10;$i++){
				echo "<TR ID=\"f_".$LID."_".$i."\" STYLE=\"display:none;\"><TD><input type=\"file\" class=\"" . $class . "\" ID=\"".$gfield[$gtabid]["form_name"][$bzm]."[$i]\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."[$i]\" $events></TD>";
				#echo "<TD>&nbsp;$lang[1560]:&nbsp;<INPUT TYPE=\"CHECKBOX\" STYLE=\"border:none;background-color:transparent;\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm]."_archiv[$i]\"></TD><TD></TD></TR>";
			}

			echo "
			    </TABLE>
			    <TABLE style=\"width:100%\" cellspacing=\"1\" cellpadding=\"0\" border=\"0\" class=\"gtabchange\">";
		}else{
			echo "<DIV class=\"" . $class . "\" $pos>";
			echo "<TABLE style=\"width:100%\" cellspacing=\"1\" cellpadding=\"0\" border=\"0\" class=\"gtabchange\">";
		}
		# Datei Liste

        # ---- Datei-Liste -----
        while (lmbdb_fetch_row($rs1)) {
            $fid = lmbdb_result($rs1, "ID");
            $LID = lmbdb_result($rs1, "LEVEL");

            unset($img);
            $event_click = "checktyp('" . $gfield[$gtabid]["data_type"][$bzm] . "','','','" . $bzm . "','" . $gtabid . "','delete_file','$ID','" . $gfield[$gtabid]["ajaxpost"][$bzm] . "')";

            echo "
				<TR>
				<TD NOWRAP VALIGN=\"TOP\" WIDTH=\"20\" OnClick=\"this.parentNode.style.backgroundColor='red';\"><i class=\"lmb-icon-cus lmb-page-delete-fancy\" height=\"12\" width=\"12\" style=\"cursor:pointer;\" TITLE=\"" . $lang[160] . "\" OnClick=\"document.form1." . $gfield[$gtabid]["form_name"][$bzm] . "_delete.value+='$fid;';$event_click;\"></i></TD>";
            if (file_exists(ASSETSPATH . 'images/legacy/fileicons/' . $gmimetypes['pic'][lmbdb_result($rs1, "MIMETYPE")])) {
                echo "<TD NOWRAP VALIGN=\"TOP\" WIDTH=\"20\"><IMG SRC=\"assets/images/legacy/fileicons/" . $gmimetypes["pic"][lmbdb_result($rs1, "MIMETYPE")] . "\" height=\"12\" width=\"12\" BORDER=\"0\"></TD>";
            }
            echo "<TD NOWRAP VALIGN=\"TOP\"><A HREF=\"main.php?action=download&ID=$fid\" TARGET=\"new\" TYPE=\"" . lmbdb_result($rs1, "MIMETYPE") . "\">" . htmlentities(lmbdb_result($rs1, "NAME"), ENT_QUOTES) . "</A></TD>
				<TD NOWRAP VALIGN=\"TOP\"><FONT COLOR=\"black\" TITLE=\"$lang[1544]\">" . get_date(lmbdb_result($rs1, "ERSTDATUM"), 1) . " (" . file_size(lmbdb_result($rs1, "SIZE")) . ")";
            if (lmbdb_result($rs1, "IND")) {
                echo "(<B STYLE=\"color:green\">i</B>)&nbsp;";
            }
            if (preg_match('/display:none/', $style)) {
                $sdpl = "display:none;";
            }
            echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" BORDER=\"0\" TITLE=\"$lang[1545]\" STYLE=\"cursor:pointer;$sdpl\" OnClick=\"newwin4('$fid','$LID')\"></i></FONT>";
            echo "</TD>";

            #---- thumbs -----
            $size = explode("x", $umgvar["thumbsize1"]);
            $img = lmb_getThumbnail(array(lmbdb_result($rs1, "ID"), lmbdb_result($rs1, "SECNAME"), lmbdb_result($rs1, "MIMETYPE"), lmbdb_result($rs1, "THUMB_OK"),lmbdb_result($rs1, "LEVEL"),lmbdb_result($rs1, "LMB_MID")), $size[0], $size[1], 1);
            if ($img) {
                echo "<TD ALIGN=\"RIGHT\" VALIGN=\"TOP\">&nbsp;<img src=\"$img\" BORDER=\"1\">&nbsp;</TD>";
            }
            echo "</TR>";
        }
        echo "<input type=\"hidden\" name=\"uploaded_" . $gfield[$gtabid]["form_name"][$bzm] . "_1\" value=\"1\">";


		echo "</TABLE>";
		echo "</DIV>";
	}
}

/* -------------------------- FILE Content --------------------------------- */
function dftyp_32($ID,&$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event=null,$gformid=null,$formid=null) {

	global $gfield;
	global $gmimetypes;
	global $umgvar;
	global $filestruct;


    require_once(COREPATH . 'extra/explorer/filestructure.lib');
    get_filestructure();


	$secname_id = $gfield[$gtabid]["argresult_name"]["SECNAME"];
	$mimetype_id = $gfield[$gtabid]["argresult_name"]["MIMETYPE"];
	$filename_id = $gfield[$gtabid]["argresult_name"]["NAME"];
    $level_id = $gfield[$gtabid]["argresult_name"]["LEVEL"];

	$secname = $gresult[$gtabid][$secname_id][0];
	$mimetype = $gresult[$gtabid][$mimetype_id][0];
	$filename = $gresult[$gtabid][$filename_id][0];
	$level = $gresult[$gtabid][$level_id][0];
    $filepath = lmb_getFilePath($ID,$level,$secname,$gmimetypes["ext"][$mimetype]);

	if(file_exists($filepath)){
		echo "<A HREF=\"main.php?action=download&ID=$ID\" TARGET=\"new\">".$filename."</A>";
	}else{
		echo "no referenz found, file does not exist!";
	}
	
}

function dftyp_14_header($gtabid,$fieldid,$ID,$vuniqueid,$gformid,$formid,$edittyp,$linklevel,$z_index,$verkn,&$filter)
{
    global $gtab;
    global $gfield;
    global $lang;
    global $gformlist;
    global $gform;
    global $LINK;

    // relation table
    if (is_numeric($fieldid)) {
        $add = $gtab["add"][$gfield[$gtabid]["verkntabid"][$fieldid]];
        $delete = $gtab["delete"][$gfield[$gtabid]["verkntabid"][$fieldid]];
        $trash = $gtab["trash"][$gfield[$gtabid]["verkntabid"][$fieldid]];
        $archive = $gtab["hide"][$gfield[$gtabid]["verkntabid"][$fieldid]];
        $vgtabid = $verkn["vtabid"];
    // subform only - table without relation
    }else{
	    $add = $gtab["add"][$gtabid];
	    $delete = $gtab["delete"][$gtabid];
        $trash = $gtab["trash"][$gtabid];
        $archive = $gtab["hide"][$gtabid];
	    $vgtabid = $gtabid;
    }


    // form params
    $formparams = cftyp_OpenFormParams($vgtabid,$gformid,$formid,$vuniqueid,$filter);

	echo "<table border=\"0\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" class=\"gtabHeaderRelationTAB\" id=\"extRelationTab_".$gtabid."_".$fieldid."menu\">\n";
	echo "<tr class=\"gtabHeaderSymbolTR\">";

	if($edittyp == 1 && $gtab["typ"][$gtabid] != 5){
        // add
		if(!$filter["ext_RelationFields"]["no_add"][$vuniqueid] AND $LINK[1] AND $add){echo "<TD STYLE=\"width:20px;\" ALIGN=\"CENTER\" NOWRAP><i class=\"lmb-icon lmb-page-new\" BORDER=\"0\" title=\"".$lang[$LINK["desc"][1]]."\" STYLE=\"cursor:pointer\" OnClick=\"create_new_verkn(event,'".$verkn["vtabid"]."','$fieldid','$gtabid','$ID','".$gtab["desc"][$verkn["vtabid"]]."','".$formparams['dimension']."','".$formparams['formid']."','$gformid','".$formparams['openas']."','".$filter["ext_RelationFields"]["layername"][$vuniqueid]."');\"></i></TD>";}

        // unlink / delete
        if(!$filter["ext_RelationFields"]["no_delete"][$vuniqueid]){
            echo "<td style=\"width:5px;\" align=\"center\">|</td>";
			echo "<td style=\"width:20px;\" align=\"center\" nowrap>";
			if($gfield[$gtabid]["data_type"][$fieldid] == 24 AND $LINK[158]){
                // unlink relation
                echo "<i class=\"lmb-icon-cus lmb-rel-del\" align=\"center\" style=\"cursor:pointer;\" onclick=\"LmExt_RelationFields(this,'$gtabid','$fieldid','','$edittyp','$ID','','','unlink','".$gfield[$gtabid]["verkntabid"][$fieldid]."','$gformid','$formid');\" title=\"".$lang[$LINK["desc"][158]]."\"></i>";
			}elseif($LINK[11] && $delete){
                // delete dataset
                echo "<i class=\"lmb-icon-cus lmb-page-delete-fancy\" align=\"center\" style=\"cursor:pointer;\" onclick=\"LmExt_RelationFields(this,'$gtabid','$fieldid','','$edittyp','$ID','','','delete','".$gfield[$gtabid]["verkntabid"][$fieldid]."','$gformid','$formid');\" title=\"".$lang[$LINK["desc"][11]]."\"></i>";
            }
            echo "</td>";

            // trash
            if($LINK[313] && $trash && !$filter["ext_RelationFields"]["no_trash"][$vuniqueid]) {
                echo "
                <td style=\"width:5px;\" align=\"center\">|</td>
                <td style=\"width:20px;\" align=\"center\" nowrap>
                <i class=\"lmb-icon lmb-trash\" align=\"center\" style=\"cursor:pointer;\" onclick=\"LmExt_RelationFields(this,'$gtabid','$fieldid','','$edittyp','$ID','','','trash','" . $gfield[$gtabid]["verkntabid"][$fieldid] . "','$gformid','$formid');\" title=\"" . $lang[$LINK["desc"][313]] . "\"></i>
                </td>";
            }

            // archive
            if($LINK[164] && $archive && !$filter["ext_RelationFields"]["no_archive"][$vuniqueid]) {
                echo "
                <td style=\"width:5px;\" align=\"center\">|</td>
                <td style=\"width:20px;\" align=\"center\" nowrap>
                <i class=\"lmb-icon lmb-page-key\" align=\"center\" style=\"cursor:pointer;\" onclick=\"LmExt_RelationFields(this,'$gtabid','$fieldid','','$edittyp','$ID','','','archive','" . $gfield[$gtabid]["verkntabid"][$fieldid] . "','$gformid','$formid');\" title=\"" . $lang[$LINK["desc"][164]] . "\"></i>
                </td>";
            }
		}

		if($gfield[$gtabid]["data_type"][$fieldid] != 24 OR $gfield[$gtabid]["verknparams"][$fieldid]){
		    if(!$filter["ext_RelationFields"]["no_copy"][$vuniqueid] AND $LINK[201] AND $gtab["edit"][$gfield[$gtabid]["verkntabid"][$fieldid]]){
                echo "<td style=\"width:5px;\" align=\"center\">|</td>";
                echo "<TD title=\"".$lang[$LINK["desc"][201]]."\" STYLE=\"width:20px;\" ALIGN=\"CENTER\" NOWRAP><i class=\"lmb-icon lmb-page-copy\" STYLE=\"cursor:pointer;\" OnClick=\"LmExt_RelationFields(this,'$gtabid','$fieldid','','$edittyp','$ID','','','copy','".$gfield[$gtabid]["verkntabid"][$fieldid]."','$gformid','$formid');\"></i></TD>";
            }
			// serach
			if(!$filter["ext_RelationFields"]["no_edit"][$vuniqueid] AND $LINK[3] AND ($gtab["edit"][$gfield[$gtabid]["verkntabid"][$fieldid]] OR $gfield[$gtabid]["verknparams"][$fieldid])){
			    if($filter["ext_RelationFields"]["edit"][$vuniqueid]){$st = "opacity:0.3;filter:Alpha(opacity=30);";}
                echo "<td style=\"width:5px;\" align=\"center\">|</td>";
			    echo "<TD title=\"".$lang[$LINK["desc"][3]]."\" STYLE=\"width:20px;\" ALIGN=\"CENTER\" NOWRAP><i class=\"lmb-icon lmb-page-edit\" STYLE=\"cursor:pointer;$st\" OnClick=\"LmExt_RelationFields(this,'$gtabid','$fieldid','','$edittyp','$ID','','','edit','','$gformid','$formid');limbasSetOpacity(this)\"></i></TD>";
			    $st = '';
			}
		    if(!$filter["ext_RelationFields"]["no_colledit"][$vuniqueid] AND $LINK[3] AND $LINK[287] AND $gfield[$gfield[$gtabid]["verkntabid"][$fieldid]]["collreplace"] AND $gtab["edit"][$gfield[$gtabid]["verkntabid"][$fieldid]]){
                echo "<td style=\"width:5px;\" align=\"center\">|</td>";
                echo "<TD title=\"".$lang[$LINK["desc"][287]]."\" STYLE=\"width:20px;\" ALIGN=\"CENTER\" NOWRAP><i class=\"lmb-icon-cus lmb-col-edit\" STYLE=\"cursor:pointer;\" OnClick=\"LmExt_RelationFields(this,'$gtabid','$fieldid','','$edittyp','$ID','','','replace',".$gfield[$gtabid]["verkntabid"][$fieldid].",'$gformid','$formid');\"></i></TD>";
            }
		}
	}
	// search
	if(!$filter["ext_RelationFields"]["no_search"][$vuniqueid] AND $LINK[14]){
	    if($filter["ext_RelationFields"]["search"][$vuniqueid]){$st = "opacity:0.3;filter:Alpha(opacity=30);";}
        echo "<td style=\"width:5px;\" align=\"center\">|</td>";
	    echo "<td style=\"width:20px;\" align=\"center\" nowrap><i class=\"lmb-icon lmb-page-find\" style=\"cursor:pointer;$st\" title=\"".$lang[$LINK["desc"][14]]."\" onclick=\"LmExt_RelationFields(this,'$gtabid','$fieldid','','$edittyp','$ID','','','search','','$gformid','$formid');limbasSetOpacity(this)\"></i></td>";
	    $st = '';
	}

    /* ------------------ open Table ----------------------*/
	if(!$filter["ext_RelationFields"]["no_openlist"][$vuniqueid] AND $LINK[10]){
        echo "<td style=\"width:5px;\" align=\"center\">|</td>";
        echo "<td style=\"width:20px;\" align=\"center\" nowrap><i class=\"lmb-icon lmb-list-ul-alt\" style=\"cursor:pointer;\" title=\"".$lang[$LINK["desc"][10]]."\" alt=\"$lang[573]\" border=\"0\" onclick=\"lmbOpenForm(event,'{$verkn["vtabid"]}','',{action:'gtab_erg', v_tabid:'$gtabid',v_fieldid:'$fieldid',v_id:'$ID',v_formid:'$gformid',readonly:'$edittyp'});\"></i></td>";
    }

	/* ------------------ Fieldlist ----------------------*/
	if(!$filter["ext_RelationFields"]["no_fieldselect"][$vuniqueid] AND $LINK[286]){
        echo "<td style=\"width:5px;\" align=\"center\">|</td>";
	    echo "<td style=\"width:20px;\" align=\"center\" nowrap><i class=\"lmb-icon-cus lmb-select-list\" style=\"cursor:pointer;\" title=\"".$lang[$LINK["desc"][286]]."\" onclick=\"lmb_relShowField(event,this,'extRelationFieldsDIV_".$gtabid."_".$fieldid."');\"></i></td>";
        /* --- Fieldlist for regular relation table ------*/
        echo "<div ID=\"extRelationFieldsDIV_".$gtabid."_".$fieldid."\" class=\"lmbContextMenu\" style=\"position:absolute;display:none;z-index:9999\" OnClick=\"activ_menu = 1\">\n";
        pop_top('extRelationFieldsDIV_".$gtabid."_".$fieldid."');
        foreach ($gfield[$linklevel["tabid"]]["sort"] as $key => $value){

            if($gfield[$linklevel["tabid"]]["col_hide"][$key]){continue;}

            if($gfield[$linklevel["tabid"]]["field_type"][$key] >= 100){
                pop_header(null, $gfield[$linklevel["tabid"]]['spelling'][$key]);
                continue;
            }

            pop_left();
            if(in_array($key,$filter["ext_RelationFields"][$vuniqueid])){
                $color = "green";$class = "Icon";$icdis = "";
            }else{
                $color = "";$class = "";$icdis = "none";
            }

            $columnTitle = lmbGetColumnTitle($filter, $linklevel["tabid"], $key, $vuniqueid);
            
            echo "<i id=\"extRelationFieldsPIC_".$gtabid."_".$fieldid."_".$key."\" class=\"lmb-icon lmb-check\" class=\"lmbContextLeft\" border=\"0\" style=display:$icdis></i>";
            echo "<span class=\"lmbContextItem$class\" style=\"color:$color;cursor:pointer\" OnClick=\"LmExt_RelationFields(this,'$gtabid','$fieldid','$key','$edittyp','$ID','','','','','$gformid','$formid');\">".$columnTitle."</span>";
            pop_right();
        }

        /* --- Fieldlist for extended relation params ------*/
        if($gfield[$gtabid]["verknparams"][$fieldid]){
            $vgtabid_ = $gfield[$gtabid]["verknparams"][$fieldid];
            pop_header(null, $gtab['desc'][$gfield[$gtabid]["verknparams"][$fieldid]]);

            if($gfield[$vgtabid_]["sort"]){
            foreach ($gfield[$vgtabid_]["sort"] as $key => $value){
                if($gfield[$vgtabid_]["field_type"][$key] >= 100){continue;}
                pop_left();
                if(in_array($key,$filter["ext_RelationFields"][$vuniqueid])){
                    $color = "green";$class = "Icon";$icdis = "";
                }else{
                    $color = "";$class = "";$icdis = "none";
                }

                $columnTitle = lmbGetColumnTitle($filter, $vgtabid_, $key, $vuniqueid);
                
                echo "<i id=\"extRelationFieldsPIC_".$gtabid."_".$fieldid."_".$key."\" class=\"lmb-icon lmb-check\" class=\"lmbContextLeft\" border=\"0\" style=display:$icdis></i>";
                echo "<span class=\"lmbContextItem$class\" style=\"color:$color;cursor:pointer\" OnClick=\"LmExt_RelationFields(this,'$gtabid','$fieldid','$key','$edittyp','$ID','','','','','$gformid','$formid');\">".$columnTitle."</span>";
                pop_right();
            }
            }
        }

        pop_bottom();
        echo "</div>";
	}

	// validity
	if($gtab['validity'][$vgtabid] AND !$filter['ext_RelationFields']['no_validity'][$vuniqueid] AND $LINK[312]) {
        echo "<td style=\"width:5px;\" align=\"center\">|</td>";
        echo "<td style=\"width:20px;\" align=\"center\" nowrap>
        <i class=\"lmb-icon lmb-calendar-times-o
            ".($filter['ext_RelationFields']['validity'][$vuniqueid] == 'all' ? 'text-success' : 'text-warning')."
            \" style=\"cursor:pointer;\" title=\"" . $lang[$LINK['desc'][312]] . "\" alt=\"$lang[3044]\" border=\"0\" onclick=\"lmb_relShowField(event,this,'extRelationFieldsValidity_" . $gtabid . "_" . $fieldid . "');\" ></i>
        </td>";
        /* --- validity joice ------*/
        ${'extrv_'.$filter['ext_RelationFields']['validity'][$vuniqueid]} = 1;

        echo "<div ID=\"extRelationFieldsValidity_" . $gtabid . "_" . $fieldid . "\" class=\"lmbContextMenu\" style=\"position:absolute;display:none;z-index:9999\" OnClick=\"activ_menu = 1\">\n";
        pop_top('extRelationFieldsValidity_".$gtabid."_".$fieldid."');
        pop_menu(0, "LmExt_RelationFields(this,'$gtabid','$fieldid','','$edittyp','$ID','','','validity','valid','$gformid','$formid'); lmbSetContextActive(this,'extRelationFieldsValidity_" . $gtabid . "_" . $fieldid . "'); $(this).parent().hide();", $lang[3053], $extrv_, 0);
        pop_menu(0, "LmExt_RelationFields(this,'$gtabid','$fieldid','','$edittyp','$ID','','','validity','all','$gformid','$formid'); lmbSetContextActive(this,'extRelationFieldsValidity_" . $gtabid . "_" . $fieldid . "'); $(this).parent().hide();", $lang[3052], $extrv_all, 0);
        pop_menu(0, "LmExt_RelationFields(this,'$gtabid','$fieldid','','$edittyp','$ID','','','validity','allto','$gformid','$formid'); lmbSetContextActive(this,'extRelationFieldsValidity_" . $gtabid . "_" . $fieldid . "'); $(this).parent().hide();", $lang[3055], $extrv_allto, 0);
        pop_menu(0, "LmExt_RelationFields(this,'$gtabid','$fieldid','','$edittyp','$ID','','','validity','allfrom','$gformid','$formid'); lmbSetContextActive(this,'extRelationFieldsValidity_" . $gtabid . "_" . $fieldid . "'); $(this).parent().hide();", $lang[3054], $extrv_allfrom, 0);
        pop_bottom();
        echo "</div>";
    }

    # fullsearch
    if ($gfield[$gfield[$gtabid]["verkntabid"][$fieldid]]['fullsearch']) {
        echo "<td style=\"width:5px;\" align=\"center\">&nbsp;</td>";
        echo "<td><input class=\"gtabHeaderInputINP\" type=\"text\" placeholder=\"$lang[30]\" value=\"{$filter["ext_RelationFields"]["searchval"][$vuniqueid][$gfield[$gtabid]["verkntabid"][$fieldid]][0][0]}\" onchange=\"LmExt_RelationFields(this,'$gtabid','$fieldid','','$edittyp','$ID','','0','searchval',this.value,'$gformid','$formid');\"></td>";
    }

	if($filter["ext_RelationFields"]["showall"][$vuniqueid]){$cr = 'n';}else{$cr = 's';}
	echo "<td style=\"width:99%;cursor:$cr-resize\" onclick=\"if(this.style.cursor=='n-resize'){this.style.cursor='s-resize';}else{this.style.cursor='n-resize';};LmExt_RelationFields(this,'$gtabid','$fieldid','','$edittyp','$ID','','extRelationFieldsTab_".$gtabid."_".$fieldid."','showall','','$gformid','$formid');\">
          <div id=\"extRelationFieldsReload_".$gtabid."_".$fieldid."\" onclick=\"LmExt_RelationFields(this,'$gtabid','$fieldid','','$edittyp','$ID','','extRelationFieldsTab_".$gtabid."_".$fieldid."','','','$gformid','$formid');\"></div>
          </td>";
        /*
	if($gformid){
		echo "<td style=\"width:99%;\"></td>";
	}else{
		echo "<td style=\"width:99%;cursor:s-resize\" onclick=\"LmExt_RelationFields(this,'$gtabid','$fieldid','','$edittyp','$ID','','extRelationFieldsTab_".$gtabid."_".$fieldid."','showall','','$gformid','$formid');\">
		<div id=\"extRelationFieldsReload_".$gtabid."_".$fieldid."\" onclick=\"LmExt_RelationFields(this,'$gtabid','$fieldid','','$edittyp','$ID','','extRelationFieldsTab_".$gtabid."_".$fieldid."','','','$gformid','$formid');\"></div>
		</td>";
	}
        */
	# --- Ajax Search ----
	if($gfield[$gtabid]["dynsearch"][$fieldid] AND $edittyp == 1 AND !$filter["ext_RelationFields"]["no_link"][$vuniqueid]){
		echo "<td nowrap>
					<input type=\"text\" name=\"".$gfield[$gtabid]["form_name"][$fieldid]."_ds\" placeholder=\"$lang[2582]\" onkeyup=\"lmbAjax_dynsearch(event,this,'14_b','".$gfield[$gtabid]["form_name"][$fieldid]."','".$verkn["vtabid"]."','".$verkn["vfieldid"]."','$gtabid','$fieldid','$ID','$edittyp','$gformid','$formid','".$gfield[$gtabid]["data_type"][$bzm]."')\" onclick=\"lmbAjax_dynsearch('*',this,'14_b','".$gfield[$gtabid]["form_name"][$fieldid]."','".$verkn["vtabid"]."','".$verkn["vfieldid"]."','$gtabid','$fieldid','$ID','$edittyp','$gformid','$formid')\" tabindex=\"$z_index\" aria-haspopup=\"listbox\" aria-expanded=\"false\" aria-controls=\"lmbAjaxContainer\">
					<div></div><div id=\"".$gfield[$gtabid]["form_name"][$fieldid]."_dsl\" class=\"ajax_container\" style=\"position:fixed;z-index:9999;display:none;\" onclick=\"activ_menu=1;\"></div>
					<input type=\"hidden\" name=\"".$gfield[$gtabid]["form_name"][$fieldid]."\"></td>
					<td>&nbsp;</td>
					";
	}else{
		echo "<input type=\"hidden\" id=\"".$gfield[$gtabid]["form_name"][$bzm]."\" name=\"".$gfield[$gtabid]["form_name"][$fieldid]."\">";
	}

	echo "</tr></table>\n";
}

# ------------ scroll-menu -----------
function dftyp_14_footer(&$gresult,$gtabid,$fieldid,$ID,$gformid,$formid,$vuniqueid){
	global $lang;
	global $gtab;
	global $gfield;
	global $filter;
    global $session;


	if($filter["ext_RelationFields"]['count'][$vuniqueid] == "all"){$filter["ext_RelationFields"]['count'][$vuniqueid] = $gresult["res_count"];}
	if(!$filter["ext_RelationFields"]['count'][$vuniqueid]){$filter["ext_RelationFields"]['count'][$vuniqueid] = $session['maxresult'];}
	if(!$filter["ext_RelationFields"]['page'][$vuniqueid]){$filter["ext_RelationFields"]['page'][$vuniqueid] = 1;}

	echo "<table id=\"lmbGlistFooterTab\" class=\"gtabFooterTAB\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\"><tr class=\"gtabFooterTR\"><td>\n";
	echo "<table cellspacing=\"0\" cellpadding=\"0\" border=\"0\"><tr>\n";
	echo "<td class=\"gtabFooterTD\" nowrap>&nbsp;<span>".$gresult["res_count"]."</span>&nbsp;$lang[93]&nbsp;</td>\n";
	echo "<td class=\"gtabFooterTD\">|&nbsp;$lang[89]&nbsp;</td>\n";
	$maxpage = ceil($gresult["max_count"]/$filter["ext_RelationFields"]['count'][$vuniqueid]);
	if($filter["ext_RelationFields"]['page'][$vuniqueid] == 1){
		echo "<td class=\"gtabFooterTD\" nowrap style=\"width:10px;\"><i class=\"lmb-icon lmb-first\" style=\"opacity:0.4;filter:Alpha(opacity=40);\" border=\"0\" title=\"$lang[1294]\"></i></td>\n";
		echo "<td class=\"gtabFooterTD\" nowrap style=\"width:10px;\"><i class=\"lmb-icon lmb-previous\" style=\"opacity:0.4;filter:Alpha(opacity=40);font-size:1.5em;\" border=\"0\" title=\"$lang[1296]\"></i></td>\n";
	}else{
		echo "<td class=\"gtabFooterTD\" nowrap style=\"width:10px;\"><i class=\"lmb-icon lmb-first\" style=\"cursor:pointer;\" border=\"0\" title=\"$lang[1294]\" onclick=\"LmExt_RelationFields(this,'$gtabid','$fieldid','','1','$ID','','','page','1','$gformid','$formid')\"></i></td>\n";
		echo "<td class=\"gtabFooterTD\" nowrap style=\"width:10px;\"><i class=\"lmb-icon lmb-previous\" style=\"cursor:pointer;font-size:1.5em;\" border=\"0\" title=\"$lang[1296]\" onclick=\"LmExt_RelationFields(this,'$gtabid','$fieldid','','1','$ID','','','page','".($filter["ext_RelationFields"]['page'][$vuniqueid] - 1)."','$gformid','$formid')\"></i></td>\n";
	}
	echo "<td class=\"gtabFooterTD\" nowrap style=\"width:20px;\"><input type=\"text\" style=\"width:60px;padding:0;text-align:center;\" value=\"".$filter["ext_RelationFields"]['page'][$vuniqueid]."/".$maxpage."\"></td>\n";
	if($filter["ext_RelationFields"]['page'][$vuniqueid] == $maxpage){
		echo "<td class=\"gtabFooterTD\" nowrap style=\"width:10px;\"><i class=\"lmb-icon lmb-next\" style=\"opacity:0.4;filter:Alpha(opacity=40);font-size:1.5em;\" border=\"0\" title=\"$lang[1297]\"></i></td>\n";
		echo "<td class=\"gtabFooterTD\" nowrap style=\"width:10px;\"><i class=\"lmb-icon lmb-last\" style=\"opacity:0.4;filter:Alpha(opacity=40);\" border=\"0\" title=\"$lang[1295]\"></i></td>\n";
	}else{
		echo "<td class=\"gtabFooterTD\" nowrap style=\"width:10px;\"><i class=\"lmb-icon lmb-next\" style=\"cursor:pointer;font-size:1.5em;\" border=\"0\" title=\"$lang[1297]\" onclick=\"LmExt_RelationFields(this,'$gtabid','$fieldid','','1','$ID','','','page','".($filter["ext_RelationFields"]['page'][$vuniqueid] + 1)."','$gformid','$formid')\"></i></td>\n";
		echo "<td class=\"gtabFooterTD\" nowrap style=\"width:10px;\"><i class=\"lmb-icon lmb-last\" style=\"cursor:pointer;\" border=\"0\" title=\"$lang[1295]\" onclick=\"LmExt_RelationFields(this,'$gtabid','$fieldid','','1','$ID','','','page','".$maxpage."','$gformid','$formid');\"></i></td>\n";
	}
	echo "<td class=\"gtabFooterTD\" nowrap style=\"width:15px;\">&nbsp;|&nbsp;$lang[96]&nbsp;</td>\n";
	echo "<td class=\"gtabFooterTD\" style=\"width:30px;\"><input type=\"text\" style=\"width:30px;padding:0;text-align:center;\" value=\"".$filter["ext_RelationFields"]['count'][$vuniqueid]."\" maxlength=\"3\" onchange=\"LmExt_RelationFields(this,'$gtabid','$fieldid','','1','$ID','','','count',this.value,'$gformid','$formid');\"></td>\n";
	echo "<td class=\"gtabFooterTD\" style=\"width:30px;\">&nbsp;$lang[88]</td>\n\n";
	echo "<td class=\"gtabFooterTD\" style=\"width:100px;color:#707070;\" nowrap>&nbsp;&nbsp;&nbsp;(".$gresult["need_time"]." sec.)</td>\n";
	echo "<td class=\"gtabFooterTD\" style=\"width:15px;\" nowrap>&nbsp;&nbsp;</TD>\n";
	echo "<td class=\"gtabFooterTD\" nowrap></TD>\n";
	echo "</tr>\n";
	echo "</table>\n";
	echo "</td></tr>";
	echo "</table>";



}

# -------------------------- VerknÃ¼pfungen ---------------------------------
function dftyp_14($ID,&$gresult,$bzm,$gtabid,$class=null,$style=null,$pos=null,$typ=1,$z_index=null,$event=null,$gformid=null,$formid=null) {
	global $db;
	global $gtab;
	global $gfield;
	global $farbschema;
	global $lang;
	global $userdat;
	global $view_all_verkn;
	global $LINK;
	global $action;
	global $session;
	global $filter;
	global $umgvar;
	global $gformlist;
	$extension = null;
	$gsr = null;

    require_once COREPATH . 'gtab/gtab_type_erg.lib';

	$vgtabid = $gfield[$gtabid]["verkntabid"][$bzm];
	$vuniqueid = $gfield[$gtabid]["form_name"][$bzm]."_".$gformid;
	$verkntabletype = $gfield[$gtabid]["verkntabletype"][$bzm];
	$linklevel["tabid"] = $gfield[$gtabid]["verkntabid"][$bzm];
	$linklevel["fieldid"] = $gfield[$gtabid]["verknfieldid"][$bzm];
    $viewmode = $gtab["detailform_viewmode"][$vgtabid];
	if($verkntabletype == 3){$typ = 2;}
    if(!$action){$action = 'gtab_change';}

    // init_relation
	$verkn = set_verknpf($gtabid,$bzm,$ID,0,0,1,1);

    // get specific search params
    $gsr = $filter["ext_RelationFields"]["searchval"][$vuniqueid];

	// specific relation params & filter
    cftyp_ext_RelationFields($ID,$gtabid,$bzm,$vuniqueid,$formid,$gformid,$verkn,$gresult,$filter,$gsr,$extension);

    // destination form parameter
    $formparams = cftyp_OpenFormParams($vgtabid,$gformid,$formid,$vuniqueid,$filter);

    // specific formular viewmode - edit = 0 / view = 1
    if($filter["ext_RelationFields"]["view_mode"][$vuniqueid] == 1){
        $viewmode = 1;
    }elseif($filter["ext_RelationFields"]["view_mode"][$vuniqueid] == 2) {
        $viewmode = 0;
    }

    ?>
    <script>
        jsvar["detailform_viewmode_<?=$vgtabid?>"] = "<?=$viewmode?>";
    </script>
    <?php

    // render modus
    // 1:n / n:m relation view in simplified mode
    if(($gfield[$gtabid]["artleiste"][$bzm] OR $filter["ext_RelationFields"]['viewmode'][$vuniqueid]) AND $filter["ext_RelationFields"]['viewmode'][$vuniqueid] != 'default' AND $filter["ext_RelationFields"]["viewmode"][$vuniqueid] != 'minimized') {
        // drop-down html
        if($filter["ext_RelationFields"]["viewmode"][$vuniqueid] == 'dropdown') {
            $rendermode = 2;
        // single ajax selector
        }elseif(($gfield[$gtabid]["dynsearch"][$bzm] AND $gfield[$gtabid]["unique"][$bzm]) OR $filter["ext_RelationFields"]["viewmode"][$vuniqueid] == 'single_ajax') {
            $rendermode = 3;
        // multiple ajax selector
		}elseif($gfield[$gtabid]["dynsearch"][$bzm] OR $filter["ext_RelationFields"]["viewmode"][$vuniqueid] == 'multi_ajax'){
            $rendermode = 4;
        // drop-down html
		}else {
            $rendermode = 2;
        }
    // 1:n / n:m relation view in detailed mode
    }else{
        $rendermode = 1;
    }

    // exclude relation from reserve ID read only - except pop-down html // todo - reserve ID
    if(!$ID && $gtab['reserveid'][$gtabid] && $rendermode != 2 && $rendermode != 3 && $rendermode != 1){
        echo "<div style=\"".$pos.$style."\" class=\"alert alert-light\" role=\"alert\">".$lang[3184]."</div>";
        return;
    }

	// 1:n / n:m relation view in simplified mode
	if($rendermode > 1){
		if($style){$style_abs = "STYLE=\"".$pos.$style."\"";}
		$linklevel["norecursiv"] = 1; # do not resolve recursiv relations

		echo "<div style=\"$pos\">";

		# --- zeige definierte Felder ----
		if($gfield[$gtabid]["verknview"][$bzm]){
			$showfields = $gfield[$gtabid]["verknview"][$bzm];
			$afieldlist[$linklevel["tabid"]] = $gfield[$gtabid]["verknview"][$bzm];
		}else{
			$showfields = array($linklevel["fieldid"]);
			$afieldlist[$linklevel["tabid"]] = array($linklevel["fieldid"]);
		}

		# editmode for tablelist extend formname
		if($formid == -1){$fextend = '_'.$ID;}

		if($typ == 1){

			// single ajax selector
			if($rendermode == 3){

				# get result
				$vgresult = sql_14_c($vgtabid,$verkn,$linklevel,$gformid,null,$gsr,$afieldlist,$extension);
				$vid = $vgresult[$vgtabid]["id"][0];

				if($vid){
					$retrn = array();
					foreach ($showfields as $fkey => $ffieldid){
                        if(!$gfield[$vgtabid]["funcid"][$ffieldid]){continue;}
                        $fname = 'cftyp_'.$gfield[$vgtabid]["funcid"][$ffieldid];
                        // ------------------ cftyp_ Extension ---------------------
                        if($gfield[$vgtabid]["ext_type"][$ffieldid]){
                            if(function_exists("lmbc_".$gfield[$vgtabid]["ext_type"][$ffieldid])){
                                $fname = "lmbc_".$gfield[$vgtabid]["ext_type"][$ffieldid];
                            }
                        }
						$retrn[] = $fname(0,$ffieldid,$vgtabid,3,$vgresult,0);
					}
					if(!$retrn){$retrn[] = $vid;}

					$retrn = implode($gfield[$gtabid]["verknviewcut"][$bzm],$retrn);
				}

				$events = dftyp_events($typ,$event,null,null,null,null,null,$gresult,$gtabid,$bzm);
				echo "<input id=\"".$gfield[$gtabid]["form_name"][$bzm].$fextend."_ds\" name=\"".$gfield[$gtabid]["form_name"][$bzm].$fextend."_ds\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" title=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" type=\"text\" value=\"".$retrn."\" onclick=\"lmbAjax_dynsearch('*',this,'14_b','".$gfield[$gtabid]["form_name"][$bzm].$fextend."','".$linklevel["tabid"]."','".$linklevel["fieldid"]."','$gtabid','$bzm','$ID','$typ','$gformid','$formid')\" onkeyup=\"lmbAjax_dynsearch(event,this,'14_b','".$gfield[$gtabid]["form_name"][$bzm]."','".$linklevel["tabid"]."','".$linklevel["fieldid"]."','$gtabid','$bzm','$ID','$typ','$gformid','$formid')\" class=\"form-control " . $class . "\" style=\"$style\" tabindex=\"$z_index\" $events>";
				if(preg_match('/display:none/',$style)){$sdpl="display:none;";}
				if($gfield[$gtabid]["option"][$bzm]){
				if($vgresult[$linklevel["tabid"]]["id"][0]){
					// open relation detail
                    echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" border=\"0\" title=\"$lang[1298]\" style=\"cursor:pointer;$sdpl\" onclick=\"lmbOpenForm(event,'{$linklevel["tabid"]}','$vid',{action:'$action',formid:'{$formparams['formid']}',formopenas:'{$formparams['openas']}',formdimension:'{$formparams['dimension']}',v_tabid:'$gtabid',v_fieldid:'$bzm',v_id:'$ID',v_formid:'$gformid'});\"></i><div></div>";
				}else{
                    // open relation list
                    echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" border=\"0\" title=\"$lang[1298]\" style=\"cursor:pointer;$sdpl\" onclick=\"lmbOpenForm(event,'{$linklevel["tabid"]}','',{action:'gtab_erg', formopenas:'{$formparams['openas']}', v_tabid:'$gtabid',v_fieldid:'$bzm',v_id:'$ID',v_formid:'$gformid'});\"></i>";
				}}
				# ------ Detail der VerknÃ¼pfung -----
				echo "<div id=\"".$gfield[$gtabid]["form_name"][$bzm]."_dsl\" class=\"ajax_container\" style=\"position:absolute;z-index:9999;display:none\"></div>
				<input type=\"hidden\" id=\"".$gfield[$gtabid]["form_name"][$bzm].$fextend."\" name=\"".$gfield[$gtabid]["form_name"][$bzm].$fextend."\" value=\"$vid\">";

			// multiple ajax selector
			}elseif($rendermode == 4){

                # get result
				$vgresult = sql_14_c($vgtabid,$verkn,$linklevel,$gformid,null,$gsr,$afieldlist,$extension);

				$bzm1 = 0;
				if($vgresult[$vgtabid]['id']){
				foreach ($vgresult[$vgtabid]['id'] as $vkey => $vid){
					$retrn = array();
					foreach ($showfields as $fkey => $ffieldid){
						if(!$gfield[$vgtabid]["funcid"][$ffieldid]){continue;}
						$fname = 'cftyp_'.$gfield[$vgtabid]["funcid"][$ffieldid];
                        // ------------------ cftyp_ Extension ---------------------
                        if($gfield[$vgtabid]["ext_type"][$ffieldid]){
                            if(function_exists("lmbc_".$gfield[$vgtabid]["ext_type"][$ffieldid])){
                                $fname = "lmbc_".$gfield[$vgtabid]["ext_type"][$ffieldid];
                            }
                        }
						$retrn[] = $fname($bzm1,$ffieldid,$vgtabid,3,$vgresult,0);
					}
					if(!$retrn){$retrn[] = $vid;}
					$vval[$vid] = implode($gfield[$gtabid]["verknviewcut"][$bzm],$retrn);
					$bzm1++;
				}}

				$events = dftyp_events($typ,$event,null,null,null,null,null,$gresult,$gtabid,$bzm);
				echo "
				<div class=\"" . $class . "\" style=\"float: left;\">

				<input id=\"".$gfield[$gtabid]["form_name"][$bzm].$fextend."_ds\" name=\"".$gfield[$gtabid]["form_name"][$bzm].$fextend."_ds\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" title=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" type=\"text\" onclick=\"lmbAjax_dynsearch('*',this,'14_b','".$gfield[$gtabid]["form_name"][$bzm].$fextend."','".$linklevel["tabid"]."','".$linklevel["fieldid"]."','$gtabid','$bzm','$ID','$typ','$gformid','$formid')\" onkeyup=\"lmbAjax_dynsearch(event,this,'14_b','".$gfield[$gtabid]["form_name"][$bzm]."','".$linklevel["tabid"]."','".$linklevel["fieldid"]."','$gtabid','$bzm','$ID','$typ','$gformid','$formid')\" class=\"form-control " . $class . "\"  tabindex=\"$z_index\" style=\"width:100%;\"  $events>
				<div style=\"$style\" id=\"extRelationFieldsTab_".$gtabid."_".$bzm."\">";

				# show multi ajax list
				cftyp_14_c($gtabid,$bzm,$ID,$typ,$gformid,$formid,$vgtabid,$vfieldid,$showfields,$vgresult,$vval);

				echo "</div></div>";

				if(preg_match('/display:none/',$style)){$sdpl="display:none;";}
				if($gfield[$gtabid]["option"][$bzm]){
				if(lmb_count($vgresult[$vgtabid]['id']) == 1){
                    // open relation detail
                    echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" border=\"0\" title=\"$lang[1298]\" style=\"cursor:pointer;margin-top:3px;$sdpl\" onclick=\"lmbOpenForm(event,'{$linklevel["tabid"]}','$vid',{action:'$action',formid:'{$formparams['formid']}',formopenas:'{$formparams['openas']}',formdimension:'{$formparams['dimension']}',v_tabid:'$gtabid',v_fieldid:'$bzm',v_id:'$ID',v_formid:'$gformid'});\"></i><div></div>";
                }else{
                    // open relation list
                    echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" border=\"0\" title=\"$lang[1298]\" style=\"cursor:pointer;margin-top:3px;$sdpl\" onclick=\"lmbOpenForm(event,'{$linklevel["tabid"]}','',{action:'gtab_erg', formopenas:'{$formparams['openas']}', v_tabid:'$gtabid',v_fieldid:'$bzm',v_id:'$ID',v_formid:'$gformid');\"></i>";
                }}

				# ------ Detail der VerknÃ¼pfung -----
				echo "<div id=\"".$gfield[$gtabid]["form_name"][$bzm]."_dsl\" class=\"ajax_container\" style=\"position:absolute;z-index:9999;display:none\"></div>
				<input type=\"hidden\" id=\"".$gfield[$gtabid]["form_name"][$bzm].$fextend."\" name=\"".$gfield[$gtabid]["form_name"][$bzm].$fextend."\" value=\"$vid\">";

			// drop-down html
			}elseif($rendermode == 2){

			    // specific relation params & filter force eval
                cftyp_ext_RelationFields($ID,$gtabid,$bzm,$vuniqueid,$formid,$gformid,$verkn,$gresult,$filter,$gsr,$extension,1);

				# get result
				$vgresult = sql_14_c($vgtabid,$verkn,$linklevel,$gformid,null,$gsr,null,$extension);
				$rscount = $vgresult[$vgtabid]["res_count"];

				$event_change = "checktyp('".$gfield[$gtabid]["data_type"][$bzm]."','".$gfield[$gtabid]["form_name"][$bzm].$fextend."','".$gfield[$gtabid]["spelling"][$bzm]."','".$bzm."','".$gtabid."',this[this.selectedIndex].value,'$ID','".$gfield[$gtabid]["ajaxpost"][$bzm]."')";
				$events = dftyp_events($typ,$event,null,null,null,null,$event_change,$gresult,$gtabid,$bzm);

				$averkn = set_verknpf($gtabid,$bzm,$ID,null,null,null,1);
				$afilter["anzahl"][$linklevel["tabid"]] = "all";
				$agresult = array();
                $agresult = get_gresult($linklevel["tabid"],1,$afilter,$gsr,$averkn,$afieldlist,null,$extension);

				# NOT unique relation
				if(!$gfield[$gtabid]["unique"][$bzm]){
					if($rscount < 4){$scount = 4;}else{$scount = $rscount;}
					$multiple = "MULTIPLE SIZE=\"$scount\"";
				# add selected value to select value list if 1:n relation
				}elseif($gfield[$gtabid]["data_type"][$bzm] == 27 AND $vgresult[$linklevel["tabid"]]['id']){
					foreach ($agresult[$linklevel["tabid"]] as $vkey => $vvalue){
						if(is_array($vvalue) && is_array($vgresult[$linklevel["tabid"]][$vkey])){
							$agresult[$linklevel["tabid"]][$vkey] = array_merge($agresult[$linklevel["tabid"]][$vkey],$vgresult[$linklevel["tabid"]][$vkey]);
						}
					}
				}

				echo "<SELECT $multiple class=\"form-select " . $class . "\" STYLE=\"$style\" data-required=\"".$gfield[$gtabid]["need"][$bzm]."\" TITLE=\"".$gfield[$gtabid]["need"][$bzm].$gfield[$gtabid]["beschreibung"][$bzm]."\" ID=\"".$gfield[$gtabid]["form_name"][$bzm].$fextend."\" NAME=\"".$gfield[$gtabid]["form_name"][$bzm].$fextend."[]\" TABINDEX=\"$z_index\" $events>"; // todo  name mit [] am Ende ??
				echo "<OPTION VALUE=\"#L#delete\">";

				if(!$vgresultlist = $vgresult[$linklevel["tabid"]]["id"]){$vgresultlist = array();}
				if($agresult[$linklevel["tabid"]]["id"]){
					foreach($agresult[$linklevel["tabid"]]["id"] as $key => $value){
						$retrn = array();
						foreach ($showfields as $fkey => $ffieldid){
							if(!$gfield[$linklevel["tabid"]]["funcid"][$ffieldid]){continue;}
							$fname = "cftyp_".$gfield[$linklevel["tabid"]]["funcid"][$ffieldid];
                            // ------------------ cftyp_ Extension ---------------------
                            if($gfield[$linklevel["tabid"]]["ext_type"][$ffieldid]){
                                if(function_exists("lmbc_".$gfield[$linklevel["tabid"]]["ext_type"][$ffieldid])){
                                    $fname = "lmbc_".$gfield[$linklevel["tabid"]]["ext_type"][$ffieldid];
                                }
                            }
							$retrn[] = $fname($key,$ffieldid,$linklevel["tabid"],3,$agresult,0);
						}
						if(!$retrn){$retrn[] = $value;}
						$retrn = implode($gfield[$gtabid]["verknviewcut"][$bzm],$retrn);
						if(in_array($value,$vgresultlist)){$SELECTED = "SELECTED";}else{$SELECTED = "";}
						echo "<OPTION VALUE=\"".$value."\" $SELECTED>".$retrn;
					}
				}
				echo "</SELECT>";

				if(preg_match('/display:none/',$style)){$sdpl="display:none;";}
				if($gfield[$gtabid]["option"][$bzm]){
				if($rscount == 1){
                    // open relation detail
				    echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" BORDER=\"0\" TITLE=\"$lang[1298]\" STYLE=\"cursor:pointer;$sdpl\" onclick=\"lmbOpenForm(event,'{$linklevel["tabid"]}','{$vgresult[$linklevel["tabid"]]["id"][0]}',{action:'$action',formid:'{$formparams['formid']}',formopenas:'{$formparams['openas']}',formdimension:'{$formparams['dimension']}',v_tabid:'$gtabid',v_fieldid:'$bzm',v_id:'$ID',v_formid:'$gformid'});\"></i>";
                }else{
                    // open relation list
				    echo "&nbsp;<i class=\"lmb-icon lmb-edit-caret\" BORDER=\"0\" TITLE=\"$lang[1298]\" STYLE=\"cursor:pointer;$sdpl\" onclick=\"lmbOpenForm(event,'{$linklevel["tabid"]}','',{action:'gtab_erg', formopenas:'{$formparams['openas']}', v_tabid:'$gtabid',v_fieldid:'$bzm',v_id:'$ID',v_formid:'$gformid'});\"></i>";
                }}
			}
		}else{
			# Readonly View
			$vgresult = sql_14_c($vgtabid,$verkn,$linklevel,$gformid,null,$gsr,null,$extension);
			if($vgresult[$linklevel["tabid"]][$linklevel["fieldid"]]){
				$retrn = array();
				foreach ($showfields as $fkey => $ffieldid){
					if(!$gfield[$vgtabid]["funcid"][$ffieldid]){continue;}
					$fname = "cftyp_".$gfield[$vgtabid]["funcid"][$ffieldid];
                    // ------------------ cftyp_ Extension ---------------------
                    if($gfield[$vgtabid]["ext_type"][$ffieldid]){
                        if(function_exists("lmbc_".$gfield[$vgtabid]["ext_type"][$ffieldid])){
                            $fname = "lmbc_".$gfield[$vgtabid]["ext_type"][$ffieldid];
                        }
                    }
					$retrn[] = $fname(0,$ffieldid,$vgtabid,3,$vgresult,0);
				}
				if(!$retrn){$retrn[] = $vgresult[$linklevel["tabid"]]["id"][0];}
				$retrn = implode($gfield[$gtabid]["verknviewcut"][$bzm],$retrn);
                echo "<div onclick=\"lmbOpenForm(event,'{$linklevel["tabid"]}','{$vgresult[$linklevel["tabid"]]["id"][0]}',{action:'$action', formid:'{$formparams['formid']}',formopenas:'{$formparams['openas']}',formdimension:'{$formparams['dimension']}',v_tabid:'$gtabid',v_fieldid:'$bzm',v_id:'$ID',v_formid:'$gformid'});\">".$retrn."</div>";
            }else{
				echo "<div class=\"" . $class . "\" STYLE=\"$style\"></div>";
			}
		}
		echo "</div>";

	// 1:n / n:m relation view in detailed mode
	}else{

        // Extended DMS FileManager
        if ($gtab["typ"][$gfield[$gtabid]["verkntabid"][$bzm]] == 3) {
            dftyp_14_FileManager($ID,$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event,$gformid,$formid);
            return;
        }
        // Extended Celandar - todo
        /**
        if ($gtab["typ"][$gfield[$gtabid]["verkntabid"][$bzm]] == 2) {
            dftyp_14_Celandar($ID,$gresult,$bzm,$gtabid,$class,$style,$pos,$typ,$z_index,$event,$gformid,$formid);
            return;
        }
         **/

        # --- minimized View ----
        if($filter["ext_RelationFields"]["viewmode"][$vuniqueid] == 'minimized') {
            $events = "onclick=\"limbasOpenRelationMinimized('".$gtabid."_".$bzm."','".$gfield[$gtabid]['spelling'][$bzm]."','".$filter['ext_RelationFields']['formsize'][$vuniqueid]."')\"";
            echo "<div id=\"g_".$gtabid."_".$bzm."_m\" class=\"" . $class . "\" STYLE=\"".$pos.$style.";cursor:pointer\" $events>" . $gfield[$gtabid]['spelling'][$bzm] . "</div>";
            $minimized = 'display:none';
        }

		# get result
		#$vgresult = sql_14_c($vgtabid,$verkn,$linklevel,$gformid,$params["orderfield"],$gsr,$afieldlist);
        #$params['formid'] = $formid;   //TODO
        #$params['id'] = $ID;           //TODO
        $vgresult = sql_14_c($vgtabid,$verkn,$linklevel,$gformid,null,$gsr,null,$extension,$params);
		$rscount = $vgresult[$vgtabid]["res_count"];

		if($linklevel["is_subrelation"]) {$typ = 2;}

		if($style){$style_abs = "STYLE=\"".$pos.$style.";overflow-x:hidden;$minimized\"";}else{$style_abs = "STYLE=\"margin-top:5px;margin-bottom:5px;$minimized\"";}

		# default height
		if(!$filter["ext_RelationFields"]["showall"][$vuniqueid]){
			if($vgresult[$vgtabid]["res_viewcount"] > 6){$bt = "height:110px;overflow:auto;";$bh=110;}
		}

		# specific formular styles
		if($gformid AND $formid){
			$st = explode(";",$GLOBALS["gform"][$gformid]["style"][$formid]);
			if($st[24]){ #overflow
				if($st[24] == 'scroll'){$st[24] = 'auto';} # scroll soll als auto behandelt werden
				$bh = $GLOBALS["gform"][$gformid]["height"][$formid];
				$bt = "height:".$bh."px;overflow:".$st[24];
			}else{
				$bt = "";
				$bh = '';
			}
			$style_abs = str_replace(";height:",";height_:",$style_abs); # workaround to disable height
		}

		# Header
		echo "<div $style_abs class=\"gtabFringeRelationBody form-legacy\" id=\"g_".$gtabid."_".$bzm."\">\n";
		if(!$filter["ext_RelationFields"]["no_menu"][$vuniqueid]){
			dftyp_14_header($gtabid,$bzm,$ID,$vuniqueid,$gformid,$formid,$typ,$linklevel,$z_index,$verkn,$filter);
		}

		# table
		echo "<div style=\"width:100%;$bt\" lmbHeight=\"$bh\" ID=\"extRelationFieldsTab_".$gtabid."_".$bzm."\" data-gformid=\"$gformid\">";
		cftyp_14_d($vgresult,$rscount,$typ,$verkn,$gtabid,$vgtabid,$bzm,$ID,$VID,$linklevel,$vuniqueid,$gformid,$formid,$filter);
		echo "</div>";

        // pagination placeholder
        if($filter["ext_RelationFields"]["pagination"][$vuniqueid]) {
            echo "<div id=\"extRelationFooter_".$gtabid."_".$bzm."\"></div>";
        }

		echo "</div>";
	}
}


function cftyp_14_c($gtabid,$field_id,$ID,$typ,$gformid,$formid,$vgtabid,$vfieldid,&$showfields,&$vgresult,$vval=null){
	global $gfield;
	global $LINK;
	
	if(!$vval){
	$bzm1 = 0;
	if($vgresult[$vgtabid]['id']){
	foreach ($vgresult[$vgtabid]['id'] as $vkey => $vid){
		$retrn = array();
		foreach ($showfields as $fkey => $ffieldid){
			if(!$gfield[$vgtabid]["funcid"][$ffieldid]){continue;}
			$fname = 'cftyp_'.$gfield[$vgtabid]["funcid"][$ffieldid];
            // ------------------ cftyp_ Extension ---------------------
            if($gfield[$vgtabid]["ext_type"][$ffieldid]){
                if(function_exists("lmbc_".$gfield[$vgtabid]["ext_type"][$ffieldid])){
                    $fname = "lmbc_".$gfield[$vgtabid]["ext_type"][$ffieldid];
                }
            }
			$retrn[] = $fname($bzm1,$ffieldid,$vgtabid,3,$vgresult,0);
		}
		if(!$retrn){$retrn[] = $vid;}
		$vval[$vid] = implode($gfield[$gtabid]["verknviewcut"][$field_id],$retrn);
		$bzm1++;
	}}}
				
	echo "<table style=\"width:100%\" cellpadding=2 cellspacing=1>";

	if($gfield[$gtabid]["data_type"][$field_id] == 24 AND $LINK[158]){$ac = 'unlink';}
	if($gfield[$gtabid]["data_type"][$field_id] == 27 AND $LINK[11]){$ac = 'delete';}

	if($vval){
	foreach ($vval as $vkey => $v){
		echo "<tr class=\"gtabBodyTR\">
					<td clas==\"gtabBodyTD\">$v</td>";
		if($ac){echo "<td align=\"center\" style=\"width:30px;cursor:pointer\" onclick=\"LmExt_RelationFields(null,'$gtabid','$field_id','','$typ','$ID','','$vkey','$ac','','$gformid','$formid',0,event);\"><i class=\"lmb-icon lmb-erase\"></i></td>";}
		echo "</tr>";
	}}

	echo "</table>";

}

function cftyp_14_d(&$vgresult,$rscount,$typ,$verkn,$gtabid,$vgtabid,$bzm,$ID,$VID,$linklevel,$vuniqueid,$gformid,$formid,&$filter){
	global $gfield;
	global $gtab;
	global $farbschema;
	global $lang;
	global $umgvar;
	global $gformlist;

	# use style for header resizing in limbasSubheaderSelection()
	if($gformid AND $formid){
		$st = explode(";",$GLOBALS["gform"][$gformid]["style"][$formid]);
		if($st[24] == 'auto'){
			$resizable = 'resizable';
		}
	}

	echo "<table id=\"extRelationTab_".$gtabid."_".$bzm."\" data-el=\"".$gtabid."_".$bzm."\" datid=\"$ID\" class=\"legacy-table lmbfringeGtabBody $resizable\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\" style=\"border:none;width:100%;table-layout:fixed\">
	<thead>";

	# extended relation table
	if($gfield[$gtabid]["verkntabid"][$bzm]){
		$isrelation = 1;
	# independent table
	}else{
		$isrelation = 0;
	}

	# default list of shown fields
	if(!$filter["ext_RelationFields"][$vuniqueid]){
		if($gfield[$gtabid]["verknview"][$bzm]){
			$filter["ext_RelationFields"][$vuniqueid] = $gfield[$gtabid]["verknview"][$bzm];
		}else{
			$filter["ext_RelationFields"][$vuniqueid] = array($linklevel["fieldid"]);
		}
	}

	# field order
	if($filter["ext_RelationOrder"][$vuniqueid]){
		$params["orderfield"] = $filter["ext_RelationOrder"][$vuniqueid];
	}

	// show indicator always in default formular
    // for custom formulars use $filter["ext_RelationFields"]["indicator"][$vuniqueid] = 1; # $vuniqueid = 'g_[gtabid]_[fieldid]_[formid]'
    if(!$gformid){
        $filter["ext_RelationFields"]["indicator"][$vuniqueid] = 1;
    }
    if(!$vgresult[$vgtabid]["indicator"]["width"]){
        $vgresult[$vgtabid]["indicator"]["width"] = 50;
    }
    if(is_numeric($filter["ext_RelationFields"]["show_inframe"][$vuniqueid])){
        $filter["ext_RelationFields"]["show_inframe"][$vuniqueid] = 'element'.$filter["ext_RelationFields"]["show_inframe"][$vuniqueid];
    }

	#----------------------- Field search -----------------------
	if($filter["ext_RelationFields"]["search"][$vuniqueid] AND !$filter["ext_RelationFields"]["no_search"][$vuniqueid]){
		echo "<TR>";
		if(!$filter["ext_RelationFields"]["no_sort"][$vuniqueid] AND $typ == 1 AND $gfield[$gtabid]["data_type"][$bzm]){echo "<th class=\"gtabHeaderInputTD\" style=\"width:50px;\">&nbsp;</th>";}

        // add indicator object before
        if($filter["ext_RelationFields"]["indicator"][$vuniqueid] AND $vgresult[$vgtabid]["indicator"]["object"]){
            echo "<th nowrap class=\"gtabHeaderInputTD\" style=\"cursor:pointer;width:".$vgresult[$vgtabid]["indicator"]["width"].";\"></th>";
        }

		foreach ($filter["ext_RelationFields"][$vuniqueid] as $key1 => $value1){

            if($gfield[$vgtabid_]["col_hide"][$value1]){continue;}

			####################
			$vgtabid_ = $linklevel["tabid"];
			if($gfield[$gtabid]["verknparams"][$bzm] AND $value1 > 1000){
				$vgtabid_ = $gfield[$gtabid]["verknparams"][$bzm];
			}
			#####################

			if($gfield[$vgtabid_]["field_type"][$value1] == 5){$align = "right";}else{$align = "left";}
			# width
			if($filter["ext_RelationFields"]["width"][$vuniqueid] AND !$resizable){
				if($filter["ext_RelationFields"]["width"][$vuniqueid][$value1]){
					$width = $filter["ext_RelationFields"]["width"][$vuniqueid][$value1];
				}else{
					$width = $gfield[$vgtabid_]["rowsize"][$value1];
				}
			}

			echo "<th class=\"gtabHeaderInputTD\" $align style=\"width:".$width."px\">";
			echo "<INPUT class=\"gtabHeaderInputINP\" TYPE=\"TEXT\" VALUE=\"".$filter["ext_RelationFields"]["searchval"][$vuniqueid][$vgtabid_][$value1][0]."\" STYLE=\"width:100%;\" OnChange=\"LmExt_RelationFields(this,'$gtabid','$bzm','','$typ','$ID','','$value1','searchval',this.value,'$gformid','$formid');\">";
			echo "</th>";
		}
		echo "</TR>";
	}

	#----------------------- Field description ------------------------
	echo "<TR class=\"gtabHeaderTitleTR\">";
	// default order
	$bzmrk = 0;
	if(!$filter["ext_RelationFields"]["no_sort"][$vuniqueid] AND $typ == 1 AND $gfield[$gtabid]["data_type"][$bzm]){
		echo "<th nowrap class=\"gtabHeaderTitleTD\" style=\"cursor:pointer;width:50px;\" align=\"center\" OnClick=\"LmExt_RelationFields(this,'$gtabid','$bzm','','$typ','$ID','reset','','','','$gformid','$formid');\">
			<i class=\"lmb-icon lmb-caret-down-alt2\" valign=\"top\"></i>
			</th>";
		$bzmrk = 1;
	}

    // add indicator object before
    if($filter["ext_RelationFields"]["indicator"][$vuniqueid] AND $vgresult[$vgtabid]["indicator"]["object"]){
        echo "<th nowrap class=\"gtabHeaderTitleTD\" style=\"cursor:pointer;width:".$vgresult[$vgtabid]["indicator"]["width"].";\" align=\"center\">".$vgresult[$vgtabid]["indicator"]["header"]."</th>";
    }

	foreach ($filter["ext_RelationFields"][$vuniqueid] as $key1 => $value1){

	    if($gfield[$vgtabid_]['field_type'][$value1] >= 100){continue;}
        if($gfield[$vgtabid_]["col_hide"][$value1]){continue;}

		/* noch nicht fÃ¼r Liste
		# no view permission
		if($gfield[$vgtabid]["viewrule"][$value1]){
		if(check_GtabRules($ID,$vgtabid,$value1,$gfield[$vgtabid]["viewrule"][$value1])){
		continue;
		}
		}
		*/

		####################
		$vgtabid_ = $linklevel["tabid"];
		if($gfield[$gtabid]["verknparams"][$bzm] AND $value1 > 1000){
			$vgtabid_ = $gfield[$gtabid]["verknparams"][$bzm];
		}
		#####################

		# no field permission
		if(!$gfield[$vgtabid_]["sort"][$value1]){
			unset($filter["ext_RelationFields"][$vuniqueid][$key1]);
			save_viewSettings($vuniqueid);
			continue;
		}

		if($gfield[$vgtabid_]["field_type"][$value1] == 5){
            $align = "text-align:right;padding-right:30px";
        }else{
            $align = "text-align:left";
        }

		# width
		if($filter["ext_RelationFields"]["width"][$vuniqueid] AND !$resizable){
			if($filter["ext_RelationFields"]["width"][$vuniqueid][$value1]){
				$width = $filter["ext_RelationFields"]["width"][$vuniqueid][$value1];
			}else{
				$width = $gfield[$vgtabid_]["rowsize"][$value1];
			}
		}

		if(!$filter["ext_RelationFields"]["no_sort"][$vuniqueid] AND $gfield[$vgtabid_]["field_type"][$value1] != 3 AND $gfield[$vgtabid_]["data_type"][$value1] != 31 AND $gfield[$vgtabid_]["data_type"][$value1] != 32 AND $gfield[$vgtabid_]["field_type"][$value1] != 6 AND $gfield[$vgtabid_]["field_type"][$value1] != 11){
			$onclick = "OnClick=\"LmExt_RelationFields(this,'$gtabid','$bzm','','$typ','$ID',$value1,'','','','$gformid','$formid');\"";
		}

        $sorticon = 'lmb-caret-down';
		if($filter["ext_RelationFields"]["order"][$vuniqueid][0][1] == $value1 && "ASC" == $filter["ext_RelationFields"]["order"][$vuniqueid][0][2]){
            $sorticon = 'lmb-textsort-down';
		}else if($filter["ext_RelationFields"]["order"][$vuniqueid][0][1] == $value1 && "DESC" == $filter["ext_RelationFields"]["order"][$vuniqueid][0][2]){
            $sorticon = 'lmb-textsort-up';
		}

        $columnTitle = lmbGetColumnTitle($filter, $vgtabid_, $value1, $vuniqueid);

		echo "
			<th nowrap align=\"$align\" class=\"gtabHeaderTitleTD\" valign=\"top\" style=\"cursor:auto;width:".$width."px\">
			<div style=\"position:relative;\">
			<div class=\"gtabHeaderTitleTDItem\" style=\"width:100%;$align;$cursor\">".$columnTitle."</div>
            <span style=\"position:absolute; padding:0px; margin:0px; right:0px; top:0px; border-left: 1px solid {$farbschema['WEB1']};\">
                <i class=\"lmb-icon $sorticon\" STYLE=\"cursor:pointer;\" onclick=\"lmbSetColSetting(this,'$gtabid','$bzm','$ID','$value1','$gformid','$formid')\"></i>
            </span>
			</div>
			
			</th>";
		$bzmrk++;
	}
	echo "</TR>";

	echo "</thead><tbody>";

    if($filter["ext_RelationFields"]["edit"][$vuniqueid] AND $typ == 1){
		$editmode = 1;
	}

    $formparams = cftyp_OpenFormParams($vgtabid,$gformid,$formid,$vuniqueid,$filter);

	if($vgresult[$vgtabid]["id"]){
	foreach($vgresult[$vgtabid]["id"] as $key => $VID) {

		# Data ID
		#$VID = $vgresult[$vgtabid]["id"][$key];

		$BGCOLOR = "";
		# row-color from user
		if($vgresult[$vgtabid]["color"][$key]){
			$BGCOLOR = $vgresult[$vgtabid]["color"][$key];
		}

		if($filter["ext_RelationFields"]["indicator"][$vuniqueid]) {

            # row-color from indicator
            if (is_array($vgresult[$vgtabid]["indicator"]["color"][$key])) {
                $BGCOLOR = average_color($vgresult[$vgtabid]["indicator"]["color"][$key]);
            }

            # row-title from indicator
            $title = "";
            if ($vgresult[$vgtabid]["indicator"]["title"][$key]) {
                $title = implode(", ", $vgresult[$vgtabid]["indicator"]["title"][$key]);
            }

            # class from indicator
            $indicatorClass = '';
            if ($vgresult[$vgtabid]['indicator']['class'][$key]) {
                $indicatorClass = $vgresult[$vgtabid]['indicator']['class'][$key];
            }

            # attribute from indicator
            $indicatorAttribute = '';
            if ($vgresult[$vgtabid]['indicator']['attribute'][$key]) {
                $indicatorAttribute = $vgresult[$vgtabid]['indicator']['attribute'][$key];
            }

            # form_id from indicator
            if ($vgresult[$vgtabid]['indicator']['form_id'][$key]) {
                $formparams['formid'] = $vgresult[$vgtabid]['indicator']['form_id'][$key];
            }
        }

        if($BGCLASS == 'gtabBodyTRColorB'){$BGCLASS = 'gtabBodyTRColorA';}else{$BGCLASS = 'gtabBodyTRColorB';}
		echo "<tr id=\"elrow_".$VID."_".$vgtabid."_".$bzm."_".$vgresult[$vgtabid]["verkn_keyid"][$key]."\" data-keyid=\"".$vgresult[$vgtabid]["verkn_keyid"][$key]."\" data-id=\"$VID\" title=\"".$title."\"  class=\"gtabBodyTR $BGCLASS $indicatorClass\" $indicatorAttribute style=\"background-color:$BGCOLOR;\" lmbbgcolor=\"$BGCOLOR\" onclick=\"lmbTableClickEvent(event,this)\" ";

        # Contextmenu
        if($GLOBALS['gcustmenu'][$vgtabid][20]['id'][0]) {
            echo "oncontextmenu=\"lmbRelationContextMenu(event,this,$VID,$vgtabid)\" ";
        }

        # Explorer Zusatz
		if($gtab["typ"][$gfield[$gtabid]["verkntabid"][$bzm]] == 3){
			echo "ondblclick=\"open('main.php?action=explorer_detail&ID=".$VID."','filedetails','toolbar=0,location=0,status=0,menubar=0,scrollbars=1,resizable=1,width=700,height=650')\"";
		# Messages
        // todo
		# Default
		}else{
		    if($filter["ext_RelationFields"]["ondblclick"][$vuniqueid]) {
                echo "ondblclick=\"".$filter["ext_RelationFields"]["ondblclick"][$vuniqueid]."\"";
            }elseif($vgtabid != $gfield[$gtabid]["verkntabid"][$bzm]){
                echo "ondblclick=\"lmbOpenForm(event,'$vgtabid','$VID',{action:document.form1.action.value,formid:'{$formparams['formid']}',formdimension:'{$formparams['dimension']}',formopenas:'{$formparams['openas']}',v_formid:'$gformid'});\"";
            }else{
                echo "ondblclick=\"lmbOpenForm(event,'{$gfield[$gtabid]["verkntabid"][$bzm]}','$VID',{action:document.form1.action.value,formid:'{$formparams['formid']}',formopenas:'{$formparams['openas']}',formdimension:'{$formparams['dimension']}',v_tabid:'$gtabid',v_fieldid:'$bzm',v_id:'$ID',v_formid:'$gformid'});\"";
			}
		}

        if($BGCOLOR) {
            echo " onmouseover=\"this.style.backgroundColor='" . $farbschema["WEB7"] . "'\" onmouseout=\"this.style.backgroundColor='$BGCOLOR'\" ";
        }

		echo ">";

		if($typ == 1){
            if(!$filter["ext_RelationFields"]["no_sort"][$vuniqueid] AND $gfield[$gtabid]["data_type"][$bzm]){
                echo "<td class=\"element-cell gtabBodyTD\" data-fieldid=\"0\"  valign=\"bottom\" align=\"center\" style=\"width:50px;\" nowrap>";
                    if($isrelation AND $gfield[$gtabid]['data_type'][$bzm] != 25){
                        echo "&nbsp;&nbsp;<i class=\"lmb-icon lmb-caret-down-alt2\" style=\"cursor:pointer;\" TITLE=\"".$lang[862]."\" OnClick=\"LmExt_RelationFields(this,'$gtabid','$bzm','','$typ','$ID','','$VID','sortdown','','$gformid','$formid')\"></i>
                    <i class=\"lmb-icon lmb-caret-up-alt\" style=\"cursor:pointer;\" TITLE=\"".$lang[861]."\" OnClick=\"LmExt_RelationFields(this,'$gtabid','$bzm','','$typ','$ID','','$VID','sortup','','$gformid','$formid')\"></i>&nbsp;";
                    }
                echo "</td>";
            }
		}

		/*----------------- show indicator object in first cell -------------------*/
		if($filter["ext_RelationFields"]["indicator"][$vuniqueid] AND $vgresult[$vgtabid]["indicator"]["object"][$key]){
		    echo "<td class=\"element-cell gtabBodyTD\" data-fieldid=\"0\"  valign=\"bottom\" align=\"center\" nowrap>";
			foreach ($vgresult[$vgtabid]["indicator"]["object"][$key] as $ikey => $ival){
				echo "<span style=\"padding-left:2px;padding-right:2px;\">$ival</span>\n";
			}
			echo "</td>";
		}

		if($filter["ext_RelationFields"][$vuniqueid]){
			foreach ($filter["ext_RelationFields"][$vuniqueid] as $key1 => $value1){

			    if($gfield[$vgtabid_]['field_type'][$value1] >= 100){continue;}
                if($gfield[$vgtabid_]["col_hide"][$value1]){continue;}

				########## use params ##########
				$vgtabid_ = $linklevel["tabid"];
				if($gfield[$gtabid]["verknparams"][$bzm] AND $value1 > 1000){
					$vgtabid_ = $gfield[$gtabid]["verknparams"][$bzm];
				}
				#####################

			    // default readonly
				$edittyp = 2;

				# editmode
				if($editmode){

				    // writable
				    $edittyp = 1;

				    // no writable for n:m realtions exept relation params
                    if($gfield[$gtabid]["data_type"][$bzm] == 24 AND $value1 < 1000 AND !$filter['ext_RelationFields']['editnm'][$vuniqueid]){
                        $edittyp = 2;
                    }

					# specific field setting from extension (ext_RelationFields)
					if($filter['ext_RelationFields']['readonly'][$vuniqueid] AND in_array($value1,$filter['ext_RelationFields']['readonly'][$vuniqueid])){
                        $edittyp = 2;
					}

					# editmode
					if($edittyp == 1){
						# ----------- Edit field permission -----------
						if(!$gfield[$vgtabid_]["perm_edit"][$value1]){$edittyp = 2;}
						# ----------- Editrule -----------
						if($gfield[$vgtabid_]["editrule"][$value1]){
							if(check_GtabRules($ID,$vgtabid_,$value1,$gfield[$vgtabid_]["editrule"][$value1])){$edittyp = 2;}
						}
						if($gfield[$vgtabid_]["argument_typ"][$value1] == 47){$edittyp = 2;}
					}
				}

				# text align
				if($gfield[$vgtabid_]["field_type"][$value1] == 5){$align = "right";}else{$align = "left";}

				# width
				if($filter["ext_RelationFields"]["width"][$vuniqueid] AND !$resizable){
					if($filter["ext_RelationFields"]["width"][$vuniqueid][$value1]){
						$width = $filter["ext_RelationFields"]["width"][$vuniqueid][$value1];
					}else{
						$width = $gfield[$vgtabid_]["rowsize"][$value1];
					}
				}

                // custmenu
                $custmenu = '';
                if($GLOBALS['gcustmenu'][$vgtabid_][20][$value1]){          # filedbased
                    $custmenu = $GLOBALS['gcustmenu'][$vgtabid_][20][$value1];
                }elseif($GLOBALS['gcustmenu'][$vgtabid_][20][0]){          # tablebased
                    $custmenu = $GLOBALS['gcustmenu'][$vgtabid_][20][0];
                }

				# ------------------ Default ---------------------
				$fname = "cftyp_".$gfield[$vgtabid_]["funcid"][$value1];
				/* ------------------ Extension --------------------- */
				if($gfield[$vgtabid_]["ext_type"][$value1]){
					if(function_exists("lmbc_".$gfield[$vgtabid_]["ext_type"][$value1])){
						$fname = "lmbc_".$gfield[$vgtabid_]["ext_type"][$value1];
					}
				}

				#if(!$val){$val == "--";}
				echo "<td class=\"element-cell gtabBodyTD\" data-fieldid=\"$value1\" data-custmenu=\"$custmenu\"  align=\"$align\" style=\"width:{$width}px\">";
				/* ------------------ Typefunction --------------------- */
				$retrn = $fname($key,$value1,$vgtabid_,$edittyp,$vgresult);
				/* ------------------ /Typefunction -------------------- */
				echo "</td>";
				#echo "<DIV STYLE=\"width:100%;height:15;scrollbar:no;border:none;cursor:pointer;overflow:hidden\">".$val."</DIV></TD>\n";
			}
		}
		echo "</tr>";
		#$key++;
	}
	}

	if(!$VID){
		echo "<tr class=\"gtabBodyTR\"><td colspan=\"".$bzmrk."\" class=\"gtabBodyTD\" style=\"height:30px;\"><i>&nbsp;".$lang[122]."</i></td></tr>";
	}

	echo "</tbody><tfoot>";

	if($filter["ext_RelationFields"]["edit"][$vuniqueid] AND !$filter["ext_RelationFields"]["no_new"][$vuniqueid] AND $typ == 1){
		echo "<tr class=\"gtabBodyTR\">
		<td style=\"height:100%\" colspan=\"".$bzmrk."\" valign=\"top\">&nbsp;<i class=\"lmb-icon lmb-page-new\" title=\"$lang[1299]\" style=\"cursor:pointer\" height=\"12\" width=\"12\" onclick=\"LmExt_RelationFields(this,'$gtabid','$bzm','','$typ','$ID','reset','$VID','create','','$gformid','$formid',1)\"></i></td>
		</tr>";
	}else{
		echo "<tr class=\"gtabBodyTR\"><td style=\"height:100%\" colspan=\"".$bzmrk."\"></td></tr>";
	}

	echo "</tfoot></table>";


	if($filter["ext_RelationFields"]["pagination"][$vuniqueid] OR $vgresult[$vgtabid]["res_count"] > $vgresult[$vgtabid]['res_viewcount']) {
        echo "<div id=\"extRelationFooterSource_".$gtabid."_".$bzm."\" >";
        dftyp_14_footer($vgresult[$vgtabid], $gtabid, $bzm, $ID, $gformid, $formid, $vuniqueid);
        echo "</div>";
        echo "<Script language=\"JavaScript\">
        $(function() {
            $(\"#extRelationFooter_".$gtabid."_".$bzm."\").attr(\"id\",\"extRelationFooter_".$gtabid."_".$bzm."\").replaceWith($(\"#extRelationFooterSource_".$gtabid."_".$bzm."\"));
            $(\"#extRelationFooterSource_".$gtabid."_".$bzm."\").attr(\"id\",\"extRelationFooter_".$gtabid."_".$bzm."\");
        });
        </Script>
        ";
	}

	/*
	#if($filter["ext_RelationFields"]["pagination"][$vuniqueid] AND $vgresult[$vgtabid]["res_count"] > $filter["ext_RelationFields"]['maxresult'][$vuniqueid]) {
	if($filter["ext_RelationFields"]["pagination"][$vuniqueid]) {
        echo "<div id=\"GtabTableFooter\"><br>";
        dftyp_14_footer($vgresult[$vgtabid],$gtabid,$bzm,$ID,$gformid,$formid,$vuniqueid);
        echo "</div>";
	}
	*/

	if($VID AND $resizable){echo "<Script language='JavaScript'>$(function(){lmb_initTable('".$gtabid."_".$bzm."')});</Script>";}else{
	echo "<Script language='JavaScript'>
	var id = 'extRelationTab_".$gtabid."_".$bzm."';
	$('#'+id+'head').remove();
	</Script>";
	}

}


/* -------------------------- File-Manager Relation --------------------------------- */
function dftyp_14_FileManager($ID,$gresult,$fieldid,$gtabid,$class,$style,$pos,$edittype,$z_index=null,$event=null,$gformid=null,$formid=null) {
	global $gtab;
	global $gfield;
	global $farbschema;
	global $lang;
	global $action;
	global $session;
	global $ufile;
	global $gfile;
	global $filestruct;
	global $LINK;
	global $ffilter;
	global $filter;
    global $fileupdate;
    global $files_order;

	if(!$ID){return;}

	$vuniqueid = $gfield[$gtabid]["form_name"][$fieldid]."_".$gformid;

	require_once(COREPATH . 'extra/explorer/explorer_main.lib');
	require_once(COREPATH . 'extra/explorer/filestructure.lib');
    #require_once(COREPATH . 'extra/explorer/explorer_main.dao');

	if($style){$style_abs = "STYLE=\"".$pos.$style."\"";}else{$style_abs = "STYLE=\"margin-top:5px;margin-bottom:5px;\"";}

	# VerknÃ¼pfungswerte
	$verkn = set_verknpf($gfield[$gtabid]["verkntabid"][$fieldid],$gfield[$gtabid]["verknfieldid"][$fieldid],0,0,0,0,0);
	$verkn["md5tab"] = $gfield[$gtabid]["md5tab"][$fieldid];
	$verkn["uniqueid"] = $gfield[$gtabid]["form_name"][$fieldid];


	if($verkn){

		# specific formular styles
		if($gformid AND $formid){
			$st = explode(";",$GLOBALS["gform"][$gformid]["style"][$formid]);
			if($st[24]){ #overflow
				$bt = "height:".$GLOBALS["gform"][$gformid]["height"][$formid]."px;overflow:".$st[24];
			}else{
				$bt = "";
			}
			$style_abs = str_replace(";height:",";height_:",$style_abs); # workaround to disable height
			# specific rules
			if($GLOBALS["gform"][$gformid]["parameters"][$formid]){
				$filter_ = eval($GLOBALS["gform"][$gformid]["parameters"][$formid]);
				if(is_array($filter_)){
					foreach ($filter_ as $fkey => $fval){
						$filter["ext_RelationFields"][$fkey][$vuniqueid] = $fval;
					}
				}
			}
		}

        // minimized Upload view
        if($filter["ext_RelationFields"]["viewmode"][$vuniqueid] == 'minimized'){
            form_minimizedDMS($ID,$gresult,$fieldid,$gtabid,$class,$style,$pos,$edittype,$z_index,$event,$gformid,$formid);
            return;
        }


		$linklevel = $GLOBALS["temp"];

        # Unter-Ordner Ebene hÃ¤ndisch ausgewÃ¤hlt (wird Ã¼ber ext_ajax.inc dyns_extRelationFileManager() gesetzt)
        if ($session["ExtFileManager"]["LID"][$verkn["uniqueid"]]) {
            $LID = $session["ExtFileManager"]["LID"][$verkn["uniqueid"]];
        # Root-Ordner aus Formular / VerknÃ¼pfungsparameter
        }elseif($filter["ext_RelationFields"]['formid'][$vuniqueid]){
            $LID = $filter["ext_RelationFields"]['formid'][$vuniqueid];
        # Root-Ordner default
        }else{
			$LID = $gfield[$gtabid]["file_level"][$fieldid];
		}

        // order
        foreach ($fileupdate[$LID] as $key => $value) {
            if($value == 'sort'){
                sort_file($key, $files_order[$key]);
            }
        }

		# get global ffilter
		get_userShow($LID,1);

		# viewmode
		$show_details = $ffilter['viewmode'][$LID];

		# show files recursiv
		$show_sub = $session["ExtFileManager"]["viewsub"][$verkn["uniqueid"]];
		if(!$show_sub){$show_sub = 0;}else{$show_sub = 1;}

		# default height
		if(!$filter["ext_RelationFields"]["showall"][$vuniqueid]){
			if($vgresult[$vgtabid]["res_viewcount"] > 6){$bt = "height:110px;overflow:auto;";}
		}

		# order by
		$filter["order"][$LID] = $ffilter["order"][$LID];

		# search
		foreach ($gfile['show'][$LID] as $key1 => $val1){
			if($ffilter[$key1][$LID]){
				$searchfield = explode('_',$key1);
				$filter["gsr"][$searchfield[0]][$searchfield[1]] = $ffilter[$key1][$LID];
			}
		}

		/* --- Header ------*/
		echo "<div $style_abs class=\"gtabFringeRelationBody form-legacy\">\n";
		echo "<table border=\"0\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" class=\"gtabHeaderRelationTAB\">\n";
		echo "<tr class=\"gtabHeaderSymbolTR\">";

		if($action == "gtab_change" AND $edittype == 1){
			#$funcpara = rawurlencode("$gtabid,$fieldid,$ID");
			if($LINK[249]){
                echo "<TD STYLE=\"width:20px;\" ALIGN=\"CENTER\" NOWRAP>
				<i class=\"lmb-icon ".$LINK["icon_url"][249]."\" STYLE=\"cursor:pointer;\" TITLE=\"".$lang[$LINK["desc"][249]]."\" OnClick=\"LmEx_open_miniexplorer($('#LID_{$gtabid}_{$fieldid}').val(),{gtabid:$gtabid,fieldid:$fieldid,ID:$ID},LmExt_Ex_LinkMiniEx);\">
				</i></TD>";
			}
			if($ffilter['search'][$LID] != 1){$st = "opacity:0.3;filter:Alpha(opacity=30)";}else{$st = null;}
			if($LINK[14]){echo "<td style=\"width:20px;\" align=\"center\" nowrap><i class=\"lmb-icon lmb-page-find\" id=\"LmEx_Ex_symbol_".$verkn["uniqueid"]."6\" TITLE=\"".$lang[$LINK["desc"][14]]."\" style=\"cursor:pointer;$st\" OnClick=\"LmExt_Ex_RelationFields($gtabid,$fieldid,'','','$ID','','','','','','','','','1');LmExt_Ex_DisplaySymbols(6,'','".$verkn["uniqueid"]."')\"></i></td><td style=\"width:5px;color:green;\" align=\"center\">|</td>";
			echo "<td STYLE=\"width:15px;\">&nbsp;</td>";}
			if($LINK[119] AND $LID){echo "<TD STYLE=\"width:20px;\" ALIGN=\"CENTER\" NOWRAP><i class=\"lmb-icon-cus lmb-folder-add\" style=\"cursor:pointer;\" onclick=\"document.getElementById('LmEx_Ex_uploadfile_".$gtabid."_".$fieldid."').style.display='none';document.getElementById('LmEx_Ex_createfolder_".$gtabid."_".$fieldid."').style.display='';\" TITLE=\"".$lang[$LINK["desc"][119]]."\"></i></td><TD STYLE=\"width:5px;color:green;\" ALIGN=\"CENTER\">|</TD>";}
			if($LINK[128] AND $LID){echo "<TD STYLE=\"width:20px;\" ALIGN=\"CENTER\" NOWRAP><i class=\"lmb-icon lmb-file-upload\" style=\"cursor:pointer;\" onclick=\"document.getElementById('LmEx_Ex_createfolder_".$gtabid."_".$fieldid."').style.display='none';document.getElementById('LmEx_Ex_uploadfile_".$gtabid."_".$fieldid."').style.display='';LmEx_showUploadField('lmbUploadLayer', document.getElementById('LID_{$gtabid}_{$fieldid}').value, '{$gtabid}_{$fieldid}', '$gtabid', '$fieldid', '$ID');\" TITLE=\"".$lang[$LINK["desc"][128]]."\"></i></td><TD STYLE=\"width:5px;color:green;\" ALIGN=\"CENTER\">|</TD>";}
			if($LINK[171] AND $LID){echo "<TD STYLE=\"width:20px;\" ALIGN=\"CENTER\" NOWRAP><i class=\"lmb-icon-cus lmb-page-delete-fancy\" style=\"cursor:pointer;\" OnClick=\"LmExt_Ex_UnLinkFiles($gtabid,$fieldid,$ID,document.getElementById('LID_".$gtabid."_".$fieldid."').value,'$formid',1)\" TITLE=\"".$lang[$LINK["desc"][171]]."\"></i></td><TD STYLE=\"width:5px;color:green;\" ALIGN=\"CENTER\">|</TD>";}
			if($LINK[158] AND $LID){echo "<TD STYLE=\"width:20px;\" ALIGN=\"CENTER\" NOWRAP><i class=\"lmb-icon-cus lmb-rel-del\" STYLE=\"cursor:pointer;\" TITLE=\"".$lang[$LINK["desc"][158]]."\" BORDER=\"0\" OnClick=\"LmExt_Ex_UnLinkFiles($gtabid,$fieldid,$ID,document.getElementById('LID_".$gtabid."_".$fieldid."').value,'$formid',0)\"></i></TD>";}

        }else{
			echo "<TD STYLE=\"width:30px;\"></TD>";
		}

		echo "<TD STYLE=\"width:15px;\" ALIGN=\"CENTER\" >&nbsp;&nbsp;&nbsp;</TD>";

		if($LINK[286]){
			echo "<TD STYLE=\"width:20px;\" ALIGN=\"CENTER\" NOWRAP><i class=\"lmb-icon-cus lmb-txt-ol-active\" STYLE=\"cursor:pointer;\" TITLE=\"".$lang[$LINK["desc"][286]]."\" onclick=\"lmb_relShowField(event,this,'extRelationFieldsDIV_".$gtabid."_".$fieldid."');\"></i>";

			/* --- Fieldlist ------*/
			echo "<div ID=\"extRelationFieldsDIV_".$gtabid."_".$fieldid."\" class=\"lmbContextMenu\" style=\"position:absolute;display:none;z-index:9999\" OnClick=\"activ_menu = 1\">\n";
			pop_top('fieldlist');
            pop_header(null, $lang[1634]);
			foreach ($gfile["id"] as $key => $value){
				# Felder ohne Rechte
				if(!$gfile["id"][$key] OR $gtab["argresult_id"]["LDMS_FILES"]."_11" == $key){continue;}
				if($gfile['field_type'][$key] == 100){
                    pop_header(null, $gfile['title'][$key]);
				}else{
					pop_left();

					if($gfile['show'][$LID][$key]){
						$color = "green";$class = "Icon";$icdis = "";
					}else{
						$color = "black";$class = "";$icdis = "none";
					}
					echo "<i id=\"extRelationFieldsPIC_".$gtabid."_".$fieldid."_".$key."\" class=\"lmbContextLeft lmb-icon lmb-check\" border=\"0\" style=display:$icdis></i>";
					echo "<span id=\"extRelationFields_".$gtabid."_".$fieldid."_".$gfile["tabid"][$key]."_".$gfile["fid"][$key]."\" class=\"lmbContextItem$class\" style=\"color:$color;cursor:pointer\" OnClick=\"LmExt_Ex_RelationFields($gtabid,$fieldid,'".$gfile["tabid"][$key]."_".$gfile["fid"][$key]."','$edittype',$ID,'','','','','','$formid','','','');\">&nbsp;".$gfile['title'][$key]."</span>";
					pop_right();
				}
			}
			pop_bottom();
			echo "</DIV>\n";

			echo "</TD>";
			echo "<TD STYLE=\"width:5px;color:green;\" ALIGN=\"CENTER\" >|</TD>";
		}

		if($session["ExtFileManager"]["viewsub"][$verkn["uniqueid"]] != 1){$st = "opacity:0.3;filter:Alpha(opacity=30)";}else{$st = null;}
		echo "<TD STYLE=\"width:20px;\" ALIGN=\"CENTER\" NOWRAP><i ID=\"LmEx_Ex_symbol_".$verkn["uniqueid"]."5\" class=\"lmb-icon-cus lmb-txt-linespace\" STYLE=\"cursor:pointer;$st\" TITLE=\"".$lang[2330]."\" BORDER=\"0\" OnClick=\"LmExt_Ex_RelationFields($gtabid,$fieldid,'','$edittype',$ID,'','','','',1,'$formid','',1,'');LmExt_Ex_DisplaySymbols(5,0,'".$verkn["uniqueid"]."')\"></i></TD>";

		echo "<TD STYLE=\"width:5px;color:green;\" ALIGN=\"CENTER\" >&nbsp;&nbsp;&nbsp;</TD>";



		if($show_details != 1){$st = "opacity:0.3;filter:Alpha(opacity=30)";}else{$st = null;}
		echo "<TD STYLE=\"width:20px;\" ALIGN=\"CENTER\" NOWRAP><i ID=\"LmEx_Ex_symbol_".$verkn["uniqueid"]."1\" class=\"lmb-icon lmb-align-justify\" STYLE=\"cursor:pointer;$st\" TITLE=\"$lang[2233]\" BORDER=\"0\" OnClick=\"LmExt_Ex_RelationFields($gtabid,$fieldid,'1','$edittype',$ID,'','','','','','$formid','','','');LmExt_Ex_DisplaySymbols(1,'1,3,4','".$verkn["uniqueid"]."')\"></i></TD>";
		echo "<TD STYLE=\"width:5px;color:green;\" ALIGN=\"CENTER\">|</TD>";

		if($show_details != 4){$st = "opacity:0.3;filter:Alpha(opacity=30)";}else{$st = null;}
		if($LINK[257]){echo "<TD STYLE=\"width:20px;\" ALIGN=\"CENTER\" NOWRAP><i ID=\"LmEx_Ex_symbol_".$verkn["uniqueid"]."4\" class=\"lmb-icon-cus lmb-pics\" STYLE=\"cursor:pointer;$st\" TITLE=\"$lang[2261]\" BORDER=\"0\" OnClick=\"LmExt_Ex_RelationFields($gtabid,$fieldid,'4','$edittype',$ID,'','','','',1,'$formid','','','');LmExt_Ex_DisplaySymbols(4,'1,3,4','".$verkn["uniqueid"]."')\"></i></TD>";
		echo "<TD STYLE=\"width:5px;color:green;\" ALIGN=\"CENTER\" >|</TD>";}

		if($show_details != 3){$st = "opacity:0.3;filter:Alpha(opacity=30)";}else{$st = null;}
		if($LINK[256]){echo "<TD STYLE=\"width:20px;\" ALIGN=\"CENTER\" NOWRAP><i ID=\"LmEx_Ex_symbol_".$verkn["uniqueid"]."3\" class=\"lmb-icon lmb-picture-icon\" STYLE=\"cursor:pointer;$st\" TITLE=\"$lang[2259]\" BORDER=\"0\" OnClick=\"LmExt_Ex_RelationFields($gtabid,$fieldid,'3','$edittype',$ID,'','','','',1,'$formid','','','');LmExt_Ex_DisplaySymbols(3,'1,3,4','".$verkn["uniqueid"]."')\"></i></TD>";
		echo "<TD STYLE=\"width:5px;color:green;\" ALIGN=\"CENTER\" >|</TD>";}

		# --- Ajax Search ----
		if($gfield[$gtabid]["dynsearch"][$fieldid] AND $action == "gtab_change"){
			echo "<TD nowrap align=\"right\">
				<INPUT TYPE=\"TEXT\" STYLE=\"width:80px;\" NAME=\"".$gfield[$gtabid]["form_name"][$fieldid]."_ds\" OnDblClick=\"LmEx_open_miniexplorer($('#LID_{$gtabid}_{$fieldid}').val(),{gtabid:$gtabid,fieldid:$fieldid,ID:$ID},LmExt_Ex_LinkMiniEx);\" OnKeyup=\"lmbAjax_dynsearch(event,this,'14_b','".$gfield[$gtabid]["form_name"][$fieldid]."','".$verkn['tabid']."','".$verkn["fieldid"]."','$gtabid','$fieldid','$ID','$edittype')\">&nbsp;
				<DIV></DIV><DIV ID=\"".$gfield[$gtabid]["form_name"][$fieldid]."_dsl\" STYLE=\"position:absolute;z-index:999;\"></DIV>
				<INPUT TYPE=\"HIDDEN\" NAME=\"".$gfield[$gtabid]["form_name"][$fieldid]."\"></TD>";
		}else{
			echo "<TD><INPUT TYPE=\"HIDDEN\" NAME=\"".$gfield[$gtabid]["form_name"][$fieldid]."\">&nbsp;</TD>";
		}
		echo "</TR></TABLE>
		<table width=\"100%\">
		<tr id=\"LmEx_Ex_createfolder_".$gtabid."_".$fieldid."\" style=\"display:none;\"><td nowrap>$lang[2231]:</td><td colspan=\"13\"><input type=\"text\" id=\"LmEx_Ex_addfolder_".$gtabid."_".$fieldid."\" style=\"width:200px;\">&nbsp;<input type=\"button\" value=\"$lang[571]\" style=\"cursor:pointer;\" OnClick=\"LmExt_Ex_RelationFields($gtabid,$fieldid,'','$edittype','$ID','','','','','','$formid',document.getElementById('LmEx_Ex_addfolder_".$gtabid."_".$fieldid."').value,'','');\"></td></tr>
		<tr id=\"LmEx_Ex_uploadfile_".$gtabid."_".$fieldid."\" style=\"display:none;\"><td id=\"LmEx_Ex_uploadfiles_".$gtabid."_".$fieldid."\"><td></tr>
		</table>\n";

		echo "<div style=\"height:1px;overflow:hidden\"></div>";
		if($gformid){$height = "height:".($GLOBALS["gform"][$gformid]["height"][$formid]+40);}
		echo "<div style=\"width:100%;$bt\" id=\"extRelationFieldsTab_".$gtabid."_".$fieldid."\">";

		echo "<table id=\"filetab\" class=\"table table-sm table-bordered w-100 p-0 table-striped-columns table-hover\">";
		echo "<input type=\"hidden\" id=\"LID_".$gtabid."_".$fieldid."\" value=\"$LID\">";

		# ----- Ordnerstruktur ------
		get_filestructure();
		$rootlevel = $filestruct["level"][$gfield[$gtabid]["file_level"][$fieldid]];
		$level = $filestruct["level"][$LID];
		$typ = 7;
		$file_path = lmb_getPathFromLevel($level,$LID);
		array_splice($file_path,-4);
		$filter["nolimit"][$LID] = 1;
		$filter["page"][$LID] = 1;
		$filter["viewmode"][$LID] = 5;
		$filter["sub"] = $show_sub;
		$verkn["parent_table"] = $gtab["table"][$gtabid];
		$verkn["parent_datid"] = $ID;

		# Metadaten filter
		if($style_array[22] != 'true' AND $gformid){
			$filter[$gtab["argresult_id"]["FILES"]."_13"][$LID] = array("image");
		}else{
			$filter[$gtab["argresult_id"]["FILES"]."_13"][$LID] = null;
		}

		# --- Abfrage starten ---
		if($query = get_fwhere($LID,$filter,$typ,$verkn)){
			if(!$ffile = get_ffile($query,$filter,$LID,$typ)){echo "no result for image!";return false;}
		}

		if($file_path){echo "<TR><TD colspan=\"10\"><DIV style=\"background-color:".$farbschema["WEB12"]."\">&nbsp;<i class=\"lmb-icon lmb-folder\"></i>&nbsp;<INPUT TYPE=\"TEXT\" STYLE=\"border:none;width:94%;height:17px;background-color:".$farbschema["WEB12"].";\" VALUE=\"/".implode("/",$file_path)."\" READONLY></DIV></TD></TR>";}

		if($show_details == 3){
			explPicShow($ffile,$gtabid,$fieldid,$ID,$gformid,$formid,1,$edittype);
		}elseif($show_details == 4){
			echo "<tr><td>";
			explPicSummery($ffile,$gtabid,$fieldid,$ID,$gformid,$formid);
			echo "</td></tr>";
		}else{
			if($ffilter['search'][$LID]){
				explSearch($LID,$LID,$ffilter,$gtabid,$fieldid,$ID);
			}
			explHeader($LID,$LID,$ffilter,$gtabid,$fieldid,$ID);
			if($show_sub != 1){explFolders($LID,$LID,0,$level,$filter,"$gtabid,$fieldid,$ID",$rootlevel);}
			explFiles($LID,$LID,$level,$ffile,$filter);
		}

		echo "</table></div></div>";

        /* todo
		echo "
		<script language=\"JavaScript\">
		    LmEx_createDropArea($('#extRelationFieldsTab_{$gtabid}_{$fieldid}'), function(files) {
                LmEx_showUploadField('lmbUploadLayer', $LID, '{$gtabid}_{$fieldid}', '{$gtabid}', '{$fieldid}', '{$ID}');
		        LmEx_uploadFilesPrecheck(files, '{$LID}', '{$gtabid}_{$fieldid}', '{$gtabid}', '{$fieldid}', '{$ID}');
		    });
		</script>
		";
        */
	}
}


# -------------------------- Calender Relation ---------------------------------
function dftyp_14_Celandar($ID,&$gresult,$fieldid,$gtabid,$class,$style,$pos,$typ,$z_index=null,$event=null,$gformid=null,$formid=null) {
	global $db;
	global $gtab;
	global $gfield;
	global $farbschema;
	global $lang;
	global $userdat;
	global $view_all_verkn;
	global $LINK;
	global $action;
	global $session;
	global $filter;
	global $umgvar;

	if(!$ID){return;}

	require_once COREPATH . 'gtab/gtab_type_erg.lib';

	if($style){$style_abs = "STYLE=\"".$pos.$style."\"";}else{$style_abs = "STYLE=\"margin-top:5px;margin-bottom:5px;\"";}

	$vgtabid = $gfield[$gtabid]["verkntabid"][$fieldid];
	$vuniqueid = $gfield[$gtabid]["form_name"][$fieldid]."_".$gformid;
	$verkn = set_verknpf($gtabid,$fieldid,$ID,0,0,1,1);
	$linklevel["tabid"] = $gfield[$gtabid]["verkntabid"][$fieldid];
	$linklevel["fieldid"] = $gfield[$gtabid]["verknfieldid"][$fieldid];
	$vgresult = sql_14_c($vgtabid,$verkn,$linklevel,$gformid);
	$rscount = $vgresult[$vgtabid]["res_count"];

	# ------- 1:n / n:m VerknÃ¼pfung Detail-Darstellung -----
	# list of shown fields
	if(!$filter["ext_RelationFields"][$vuniqueid]){
		if($gfield[$gtabid]["verknview"][$fieldid]){
			$filter["ext_RelationFields"][$vuniqueid] = $gfield[$gtabid]["verknview"][$fieldid];
		}else{
			$filter["ext_RelationFields"][$vuniqueid] = array($linklevel["fieldid"]);
		}
	}

	if(!$filter["ext_RelationFields"]["showall"][$vuniqueid]){
		if($vgresult[$vgtabid]["res_viewcount"] > 6){$bt = "height:110px;overflow:auto;";}
	}

	# specific formular styles
	if($gformid AND $formid){
		$st = explode(";",$GLOBALS["gform"][$gformid]["style"][$formid]);
		if($st[24]){ #overflow
			$bt = "height:".$GLOBALS["gform"][$gformid]["height"][$formid]."px;overflow:".$st[24];
		}else{
			$bt = "";
		}
		$style_abs = str_replace(";height:",";height_:",$style_abs); # workaround to disable height
		# specific rules
		if($GLOBALS["gform"][$gformid]["parameters"][$formid]){
			$filter_ = eval($GLOBALS["gform"][$gformid]["parameters"][$formid]);
			if(is_array($filter_)){
				foreach ($filter_ as $fkey => $fval){
					$filter["ext_RelationFields"][$fkey][$vuniqueid] = $fval;
				}
			}
		}
	}

    // form parameter
    $formparams = cftyp_OpenFormParams($vgtabid,$gformid,$formid,$vuniqueid,$filter);

	/* --- Header ------*/
	echo "<div $style_abs class=\"gtabFringeRelationBody form-legacy\">\n";
	echo "<TABLE BORDER=\"0\" WIDTH=\"100%\" CELLSPACING=\"0\" CELLPADDING=\"0\" class=\"gtabHeaderRelationTAB\">\n";
	echo "<TR class=\"gtabHeaderSymbolTR\">";

	if($typ == 1){
		if(!$filter["ext_RelationFields"]["no_add"][$vuniqueid] AND $LINK[1]){echo "<TD STYLE=\"width:20px;\" ALIGN=\"CENTER\" NOWRAP><i class=\"lmb-icon-cus lmb-page-new\" BORDER=\"0\" title=\"".$lang[$LINK["desc"][1]]."\" STYLE=\"cursor:pointer\" OnClick=\"create_new_verkn(event,'".$verkn["vtabid"]."','$fieldid','$gtabid','$ID')\"></i></TD><TD STYLE=\"width:5px;color:green;\" ALIGN=\"CENTER\">|</TD>";}
		if(!$filter["ext_RelationFields"]["no_edit"][$vuniqueid] AND $gfield[$gtabid]["data_type"][$fieldid] == 27 AND $LINK[3]){
			if($filter["ext_RelationFields"]["edit"][$vuniqueid]){$st = "opacity:0.3;filter:Alpha(opacity=30);";}
			echo "<TD STYLE=\"width:20px;\" ALIGN=\"CENTER\" NOWRAP><i class=\"lmb-icon-cus lmb-page-edit\" title=\"".$lang[$LINK["desc"][3]]."\" STYLE=\"cursor:pointer;$st\" OnClick=\"LmExt_RelationFields(this,'$gtabid','$fieldid','','$typ','$ID','','$vid','edit','','$gformid','$formid');limbasSetOpacity(this)\"></i></TD><TD STYLE=\"width:5px;color:green;\" ALIGN=\"CENTER\">|</TD>";
		}
	}
	#if(!$filter["ext_RelationFields"]["no_openlist"][$vuniqueid] AND $LINK[10]){echo "<TD STYLE=\"width:20px;\" ALIGN=\"CENTER\" NOWRAP><i class=\"lmb-icon lmb-list-ul-alt\" STYLE=\"cursor:pointer;\" title=\"".$lang[$LINK["desc"][10]]."\" BORDER=\"0\" OnClick=\"newwin5('".$verkn["vtabid"]."','".$gtabid."','".$fieldid."','".$ID."')\"></i></TD><TD STYLE=\"width:5px;color:green;\" ALIGN=\"CENTER\">|</TD>";}
	if(!$filter["ext_RelationFields"]["no_openlist"][$vuniqueid] AND $LINK[10]){echo "<TD STYLE=\"width:20px;\" ALIGN=\"CENTER\" NOWRAP><i class=\"lmb-icon lmb-list-ul-alt\" STYLE=\"cursor:pointer;\" title=\"".$lang[$LINK["desc"][10]]."\" BORDER=\"0\" onclick=\"lmbOpenForm(event,'{$verkn["vtabid"]}','',{action:'gtab_erg', formid:'{$formparams['formid']}',formdimension:'{$formparams['dimension']}',formopenas:'{$formparams['openas']}' v_tabid:'$gtabid',v_fieldid:'$fieldid',v_id:'$ID',v_formid:'$gformid');\"></i></TD><TD STYLE=\"width:5px;color:green;\" ALIGN=\"CENTER\">|</TD>";}
    if(!$filter["ext_RelationFields"]["no_fieldselect"][$vuniqueid] AND $LINK[286]){echo "<TD STYLE=\"width:20px;\" ALIGN=\"CENTER\" NOWRAP><i class=\"lmb-icon-cus lmb-select-list\" STYLE=\"cursor:pointer;\" title=\"".$lang[$LINK["desc"][286]]."\" onclick=\"lmb_relShowField(event,this,'extRelationFieldsDIV_".$gtabid."_".$fieldid."');\"></i>";
	/* --- Fieldlist ------*/
	echo "<DIV ID=\"extRelationFieldsDIV_".$gtabid."_".$fieldid."\" class=\"lmbContextMenu\" style=\"position:absolute;display:none;z-index:9999\" OnClick=\"activ_menu = 1\">\n";
	pop_top("extRelationFieldsDIV_".$gtabid."_".$fieldid);
	foreach ($gfield[$linklevel["tabid"]]["sort"] as $key => $value){
		pop_left();
		if(in_array($key,$filter["ext_RelationFields"][$vuniqueid])){
			$color = "green";$class = "Icon";$icdis = "";
		}else{
			$color = "black";$class = "";$icdis = "none";
		}
		echo "<i id=\"extRelationFieldsPIC_".$gtabid."_".$fieldid."_".$key."\" class=\"lmbContextLeft lmb-icon lmb-check\" border=\"0\" style=display:$icdis></i>";
		echo "<span id=\"extRelationFields_".$gtabid."_".$fieldid."_".$key."\" class=\"lmbContextItem$class\" style=\"color:$color;cursor:pointer\" OnClick=\"LmExt_RelationFields(this,'$gtabid','$fieldid','$key','$typ','$ID','','','','','$gformid','$formid');\">".$gfield[$linklevel["tabid"]]["spelling"][$key]."</span>";
		pop_right();
	}
	pop_bottom();
	echo "</DIV>\n";
	if(!$filter["ext_RelationFields"]["no_calendar"][$vuniqueid]){
	   echo "</TD><TD STYLE=\"width:15px;color:green;\" ALIGN=\"LEFT\">&nbsp;</TD>";}
	   echo "<TD STYLE=\"width:20px;\" ALIGN=\"CENTER\" NOWRAP><i class=\"lmb-icon-cus lmb-cal-day\" STYLE=\"cursor:pointer;\" TITLE=\"$lang[1929]\" BORDER=\"0\" OnClick=\"newwin14('".$verkn["vtabid"]."','".$gtabid."','".$fieldid."','".$ID."')\"></i></TD>";
	}

	if($gformid){
		echo "<TD></TD>";
	}else{
		echo "<TD cursor:s-resize\" OnClick=\"LmExt_RelationFields(this,'$gtabid','$fieldid','','$typ','$ID','','extRelationFieldsTab_".$gtabid."_".$fieldid."','showall','','$gformid','$formid');\"></TD>";
	}

	# --- Ajax Search ----
	if($gfield[$gtabid]["dynsearch"][$fieldid] AND $typ == 1 AND !$filter["ext_RelationFields"]["no_link"][$vuniqueid]){
		echo "<TD nowrap>
					".$lang[30].": <INPUT TYPE=\"TEXT\" NAME=\"".$gfield[$gtabid]["form_name"][$fieldid]."_ds\" OnKeyup=\"lmbAjax_dynsearch(event,this,'14_b','".$gfield[$gtabid]["form_name"][$fieldid]."','".$verkn["vtabid"]."','".$verkn["vfieldid"]."','$gtabid','$fieldid','$ID','$typ')\">
					<DIV></DIV><DIV ID=\"".$gfield[$gtabid]["form_name"][$fieldid]."_dsl\" STYLE=\"visibility:visible;position:absolute;z-index:999;\" OnClick=\"activ_menu=1;\"></DIV>
					<INPUT TYPE=\"HIDDEN\" NAME=\"".$gfield[$gtabid]["form_name"][$fieldid]."\"></TD>
					<TD>&nbsp;</TD>
					";
	}else{
		echo "<INPUT TYPE=\"HIDDEN\" NAME=\"".$gfield[$gtabid]["form_name"][$fieldid]."\">";
	}

	echo "</TR></TABLE>\n";

	#echo "<DIV STYLE=\"width:100%;overflow:auto;\" ID=\"extRelationFieldsTab_".$gtabid."_".$fieldid."\">";
	echo "<div style=\"width:100%;$bt\" ID=\"extRelationFieldsTab_".$gtabid."_".$fieldid."\">";
	# table list
	cftyp_14_d($vgresult,$rscount,$typ,$verkn,$gtabid,$vgtabid,$fieldid,$ID,$VID,$linklevel,$vuniqueid,$gformid,$formid,$filter);
	echo "</div>";
	echo "</div>";
}




# specific relation params & filter
function cftyp_ext_RelationFields($ID,$gtab_id,$field_id,$vuniqueid,$formid,$gformid,$verkn,&$gresult,&$filter,&$gsr,&$extension,$applyfilter=null){

    $gtabid = $GLOBALS['gfield'][$gtab_id]['verkntabid'][$field_id];

    // table params
    if (!$filter['ext_RelationFields']['params'][$vuniqueid] AND $GLOBALS['gfield'][$gtab_id]['relparams'][$field_id]) {
        $params[0] = $GLOBALS['gfield'][$gtab_id]['relparams'][$field_id];
    }
    // form params
    if (!$filter['ext_RelationFields']['params'][$vuniqueid] AND $GLOBALS['gform'][$gformid]['parameters'][$formid]) {
        $params[0] = $GLOBALS['gform'][$gformid]['parameters'][$formid];
    }

    // table relation extensions
    if ($GLOBALS['gfield'][$gtab_id]['relext'][$field_id]) {
        $params[1] = $GLOBALS['gfield'][$gtab_id]['relext'][$field_id];
    }
    // form relation extensions
    if ($GLOBALS['gform'][$gformid]['extension'][$formid]) {
        $params[1] = $GLOBALS['gform'][$gformid]['extension'][$formid];
    }

    if(!$params){return;}

    if($params[0]){
       $filter_ = eval($params[0]);

        if (!$filter['ext_RelationFields']['params'][$vuniqueid] AND is_array($filter_)) {
            foreach ($filter_ as $fkey => $fval) {
                if ($fkey == 'showfields' AND !$filter['ext_RelationFields'][$vuniqueid]) {
                    $filter['ext_RelationFields'][$vuniqueid] = $fval;
                } elseif ($fkey == 'order') {
                    if (!$filter['ext_RelationFields']['order'][$vuniqueid]) {
                        $filter['ext_RelationFields']['order'][$vuniqueid] = $fval;
                    }
                } else {
                    $filter['ext_RelationFields'][$fkey][$vuniqueid] = $fval;
                }
            }
        }
    }

    if($params[1] AND ($filter['ext_RelationFields']['applyfilter'][$vuniqueid] OR $applyfilter)){
        eval($params[1]);

        // deprecated downward compatible
        if($where){
            foreach($where as $v=>$k) {
                $extension['where'][] = $k;
            }
        }
        if($from){
            foreach($from as $v=>$k) {
                $extension['from'][] = $k;
            }
        }
        if($order){
            foreach($order as $v=>$k) {
                $extension['order'][] = $k;
            }
        }
        if($ojoin){$extension['ojoin'] = $ojoin;}
    }

    $filter['ext_RelationFields']['params'][$vuniqueid] = 1;

    // filter & extension for gresult
    /*
    if($gsr) {
        $filter['ext_RelationFields']['gsr'][$vuniqueid] = $gsr;
    }
    if($extension) {
        $filter['ext_RelationFields']['extension'][$vuniqueid] = $extension;
    }
    */

}
