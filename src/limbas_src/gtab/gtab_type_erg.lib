<?php

/**
 * @copyright Limbas GmbH <https://limbas.com>
 * @license https://opensource.org/licenses/GPL-2.0 GPL-2.0
 *
 * This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 */



/*
typ 1 = echo for edit formular
typ 2 = echo for view formular
typ 3 = return for html export					(with htmlentities, returns only simple text)
typ 4 = return for soap export with arrays		(with htmlentities, returns many details as associated array)
typ 5 = return for raw export with arrays		(returns multiple results as simple array)
typ 6 = return for rest api
typ 7 = xlsx export
typ 8 = csv export
*/


# include extensions
global $gLmbExt;
if($gLmbExt["ext_type.inc"]){
	foreach ($gLmbExt["ext_type.inc"] as $key => $value){
		require_once($value);
	}
}

/* -------------------------- Events --------------------------------- */
/**
 * Enter description here...
 *
 * @param unknown_type $typ
 * @param unknown_type $event1 array(click=>$click,dblclick=>$dblclick,over=>$over,out=>$out,change=>$change)
 * @param unknown_type $event2 array(click=>$click,dblclick=>$dblclick,over=>$over,out=>$out,change=>$change)
 * @param unknown_type $gresult 
 * @param unknown_type $gtabid
 * @param unknown_type $fieldid
 * @param unknown_type $datid
 * @return unknown
 */
function cftyp_events($typ,$event1,$event2,&$gresult,$gtabid,$fieldid,$datid=0){
	global $gfield;
	
	if($typ == 1 AND !$event2["change"]){
		$change = "checktyp('".$gfield[$gtabid]["data_type"][$fieldid]."','".$gfield[$gtabid]["form_name"][$fieldid]."_".$gresult[$gtabid]["id"][$datid]."','".$gfield[$gtabid]["spelling"][$fieldid]."','".$gfield[$gtabid]["field_id"][$fieldid]."','".$gtabid."',this.value,'".$gresult[$gtabid]["id"][$datid]."','".$gfield[$gtabid]["ajaxpost"][$fieldid]."','".$gfield[$gtabid]["size"][$fieldid]."',this,'".$gresult[$gtabid]['parentage']."')";
		if(!$event1 AND !$event2){return "OnChange=\"".$change."\"";}
		$event2["change"] = $change;
	}
	$ID = $gresult[$gtabid]["id"][$datid];
	
	if($event1["click"] OR $event2["click"]){$events = "OnClick=\"".eval("return \"".$event1["click"]."\";")."; ".$event2["click"]."\" ";}
	if($event1["dblclick"] OR $event2["dblclick"]){$events .= "OnDblClick=\"".eval("return \"".$event1["dblclick"]."\";")."; ".$event2["dblclick"]."\" ";}
	if($event1["over"] OR $event2["over"]){$events .= "OnMouseOver=\"".eval("return \"".$event1["over"]."\";")."; ".$event2["over"]."\" ";}
	if($event1["out"] OR $event2["out"]){$events .= "OnMouseOut=\"".eval("return \"".$event1["out"]."\";")."; ".$event2["out"]."\" ";}
	if($event1["change"] OR $event2["change"]){$events .= "OnChange=\"".eval("return \"".$event1["change"]."\";")."; ".$event2["change"]."\" ";}
	if($event1["keyup"] OR $event2["keyup"]){$events .= "OnKeyUp=\"".eval("return \"".$event1["keyup"]."\";")."; ".$event2["keyup"]."\" ";}
	
	return $events;
}

/* -------------------------- PHP Argument --------------------------------- */
function cftyp_13($ID,&$gresult,$fieldid,$gtabid,$class,$style,$pos,$typ,$bzm=0){
	return ftyp_13($ID,$gresult,$fieldid,$gtabid,$class,$style,$pos,$typ,$bzm);
}

# -------------------------- Text -- field_type 1 ---------------------------------
function cftyp_2($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
        global $gtab;
        global $gfield;
        global $umgvar;

		if($gfield[$gtabid]["inherit_tab"][$field_id] AND $gfield[$gtabid]["inherit_search"][$field_id]){
			$event2["keyup"] = "limbasSearchInherit($gtabid,$field_id," . $gfield[$gtabid]["inherit_tab"][$field_id] . "," . $gfield[$gtabid]["inherit_field"][$field_id] . ",this,'".$gresult[$gtabid]["id"][$bzm]."')";
		}
        $events = cftyp_events($typ,$event,$event2,$gresult,$gtabid,$field_id,$bzm);

        if($typ == 1){
        	echo "<INPUT TYPE=\"TEXT\" CLASS=\"gtabBodyINP\" NAME=\"".$gfield[$gtabid]["form_name"][$field_id]."_".$gresult[$gtabid]["id"][$bzm]."\" STYLE=\"width:100%;height:100%;\" MAXLENGTH=\"".$gfield[$gtabid]["size"][$field_id]."\" data-regex=\"".htmlentities($gfield[$gtabid]['regex'][$field_id],ENT_QUOTES)."\" VALUE=\"".htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES)."\" $events>";
        }elseif($typ == 2){
        	echo ($events ? "<span $events>":"").htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES)."&nbsp;".($events ? "</span>":"");
        }elseif($typ == 3 OR $typ == 4){
        	return htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES);
        }else{
        	return $gresult[$gtabid][$field_id][$bzm];
        }
}

/**
 Textblock -- field_type 3
 * @param unknown_type $bzm
 * @param unknown_type $field_id
 * @param unknown_type $gtabid
 * @param unknown_type $typ
 * @param unknown_type $gresult
 * @param unknown_type $event
 * @return unknown
 * 
 * select_pool used as relation cut
 */
function cftyp_3($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null,$gformid=null,$formid=null) {
	global $gtab;
	global $gfield;
	global $umgvar;

	$event2["click"] = "lmbAjax_resultPreView(event,'$gtabid','$field_id','".$gresult[$gtabid]["id"][$bzm]."')";
	$events = cftyp_events($typ,$event,$event2,$gresult,$gtabid,$field_id,$bzm);

	$cut = $umgvar["memolength"];
	if($gfield[$gtabid]["select_pool"][$field_id]){
		$cut = $gfield[$gtabid]["select_pool"][$field_id];
	}

	if($typ == 1 AND $gformid){
        echo "<TEXTAREA CLASS=\"gtabBodyINP\" NAME=\"".$gfield[$gtabid]["form_name"][$field_id]."_".$gresult[$gtabid]["id"][$bzm]."\" STYLE=\"width:100%;height:100%;\" MAXLENGTH=\"".$gfield[$gtabid]["size"][$field_id]."\" data-regex=\"".htmlentities($gfield[$gtabid]['regex'][$field_id],ENT_QUOTES)."\" $events>".htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES)."</TEXTAREA>";
    }elseif($typ == 2 OR $typ == 1){
		echo ($events ? "<div style=\"cursor:help;width:100%;height:100%;\" $events>":"").htmlentities(lmb_substr($gresult[$gtabid][$field_id][$bzm],0,$cut),ENT_QUOTES)."... ".($events ? "</div>":"");
	}elseif($typ == 3){
		return nl2br(htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES));
	}elseif($typ == 4){
		return htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES);
	}else{
		return $gresult[$gtabid][$field_id][$bzm];
	}
}

/**
 Long -- field_type 3
 * @param unknown_type $bzm
 * @param unknown_type $field_id
 * @param unknown_type $gtabid
 * @param unknown_type $typ
 * @param unknown_type $gresult
 * @param unknown_type $event
 * @return unknown
 * 
 */
function cftyp_22($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null,$gformid=null,$formid=null) {
	global $gtab;
	global $gfield;
	global $umgvar;
	global $db;

	$event2["click"] = "lmbAjax_resultPreView(event,'$gtabid','$field_id','".$gresult[$gtabid]["id"][$bzm]."')";
	$events = cftyp_events($typ,$event,$event2,$gresult,$gtabid,$field_id,$bzm);
	
	$cut = $umgvar["memolength"];
	if($gfield[$gtabid]["select_pool"][$field_id]){ // used for memolength
		$cut = $gfield[$gtabid]["select_pool"][$field_id];
	}

    if($typ == 1 AND ($gformid OR $gfield[$gtabid]['argument_edit'][$field_id])){
        echo "<TEXTAREA CLASS=\"gtabBodyINP\" NAME=\"".$gfield[$gtabid]["form_name"][$field_id]."_".$gresult[$gtabid]["id"][$bzm]."\" STYLE=\"width:100%;height:100%;resize: both;\" $events>".htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES)."</TEXTAREA>";
    }elseif($typ == 2){
        if($gfield[$gtabid]["wysiwyg"][$field_id]){
            echo ($events ? "<span style=\"cursor:help;\" $events>" : "") . "<I>" . strip_tags(lmb_substr($gresult[$gtabid][$field_id][$bzm], 0, $cut)) . "... " . "</I>" . ($events ? "</span>" : "");
        }else {
            echo ($events ? "<span style=\"cursor:help;\" $events>" : "") . "<I>" . htmlentities(lmb_substr($gresult[$gtabid][$field_id][$bzm], 0, $cut), ENT_QUOTES) . "... " . "</I>" . ($events ? "</span>" : "");
        }
	}elseif($gfield[$gtabid]["wysiwyg"][$field_id] OR $typ == 5 OR $typ == 6){
		return $gresult[$gtabid][$field_id][$bzm];
	}elseif($typ == 3){
		return nl2br(htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES));
    }elseif($typ == 4){
        if($gfield[$gtabid]["wysiwyg"][$field_id]){
            return $gresult[$gtabid][$field_id][$bzm];
        }else {
            return htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES);
        }
	}
}

# -------------------------- Zahl -- field_type 5 ---------------------------------
function cftyp_1($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
	global $gtab;
	global $gfield;

	$events = cftyp_events($typ,$event,null,$gresult,$gtabid,$field_id,$bzm);

	$result = preg_replace("/^[\.]/","0.",$gresult[$gtabid][$field_id][$bzm]);
	if($typ == 1){
		# Potenz-Dartsellung
		if($gfield[$gtabid]["potency"][$field_id]){
			$result = convert_FloatToScientific($result,$gfield[$gtabid]["potency"][$field_id], $gfield[$gtabid]["nformat"][$field_id]);
		} else {
            $result = convert_NumberFormat($gresult[$gtabid][$field_id][$bzm], $gfield[$gtabid]["nformat"][$field_id]);
        }
		echo "<INPUT TYPE=\"TEXT\" CLASS=\"gtabBodyINP\" NAME=\"".$gfield[$gtabid]["form_name"][$field_id]."_".$gresult[$gtabid]["id"][$bzm]."\" STYLE=\"width:100%;text-align:right;\" MAXLENGTH=\"".($gfield[$gtabid]["size"][$field_id]+6)."\" data-regex=\"".htmlentities($gfield[$gtabid]['regex'][$field_id],ENT_QUOTES)."\" VALUE=\"".$result."\" $events>";
	}elseif($typ == 2) {
        # Potenz-Dartsellung
        if ($gfield[$gtabid]["potency"][$field_id]) {
            $value = convert_FloatToScientific($result, $gfield[$gtabid]["potency"][$field_id], $gfield[$gtabid]["nformat"][$field_id]);
            if (lmb_strpos($value, "E")) {
                $value = explode("E", $value);
                $result = $value[0] . "e" . "<sup>" . $value[1] . "</sup>";
            } else {
                $result = $value;
            }
            # Format-Darstellung
        } elseif ($gfield[$gtabid]["nformat"][$field_id]) {
            $result = convert_NumberFormat($gresult[$gtabid][$field_id][$bzm], $gfield[$gtabid]["nformat"][$field_id]);
        }

        # Prozentzahl
        if ($gfield[$gtabid]["data_type"][$field_id] == 21) {
            $pr = "%&nbsp;";
        }
        echo ($events ? "<span $events>" : "") . $result . "&nbsp;" . $pr . ($events ? "</span>" : "");
    } elseif ($typ == 6) {
        return floatval(str_replace(',', '.', $result));
	}else{
		return $result;
	}
}

# -------------------------- Phone ---------------------------------
function cftyp_28($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
        global $gtab;
        global $gfield;
        global $umgvar;
        global $session;

        if($typ == 1){
        	$events = cftyp_events($typ,$event,null,$gresult,$gtabid,$field_id,$bzm);
        	echo "<INPUT TYPE=\"TEXT\" CLASS=\"gtabBodyINP\" NAME=\"".$gfield[$gtabid]["form_name"][$field_id]."_".$gresult[$gtabid]["id"][$bzm]."\" STYLE=\"width:100%;\" MAXLENGTH=\"".$gfield[$gtabid]["size"][$field_id]."\" VALUE=\"".htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES)."\" data-regex=\"".htmlentities($gfield[$gtabid]['regex'][$field_id],ENT_QUOTES)."\" $events>";
        }elseif($typ == 2){
        	$event2["click"] = "openPhone_".$session["t_setting"][0]."('".str_replace(" ","",$gresult[$gtabid][$field_id][$bzm])."')";
        	$events = cftyp_events($typ,$event,$event2,$gresult,$gtabid,$field_id,$bzm);
        	echo "<a href=\"#\" $events>".htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES)."</a>&nbsp;";
        }elseif($typ == 3 OR $typ == 4){
        	return htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES);
        }else{
        	return $gresult[$gtabid][$field_id][$bzm];
        }
}


# -------------------------- Währung -- field_type 5 ---------------------------------
function cftyp_7($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
        global $gtab;
        global $gfield;
        global $umgvar;
        global $lmcurrency;

        $events = cftyp_events($typ,$event,null,$gresult,$gtabid,$field_id,$bzm);

        $result = $gresult[$gtabid][$field_id][$bzm]['V'];

        if($typ == 1 OR $typ == 2){
	        if($gfield[$gtabid]["nformat"][$field_id]){
	        	$result = convert_NumberFormat($result,$gfield[$gtabid]["nformat"][$field_id]);
	        }
        }
        if($typ == 1){
        	echo "<INPUT TYPE=\"TEXT\" CLASS=\"gtabBodyINP\" NAME=\"".$gfield[$gtabid]["form_name"][$field_id]."_".$gresult[$gtabid]["id"][$bzm]."\" STYLE=\"width:100%;text-align:right;\" TITLE=\"".$gresult[$gtabid][$field_id][$bzm]['C']."\" VALUE=\"".trim($gresult[$gtabid][$field_id][$bzm]['V']." ".$gresult[$gtabid][$field_id][$bzm]['C'])."\" MAXLENGTH=\"".($gfield[$gtabid]["size"][$field_id]+6)."\" data-regex=\"".htmlentities($gfield[$gtabid]['regex'][$field_id],ENT_QUOTES)."\" $events>";
        }elseif($typ == 2){
        	echo ($events ? "<span $events>":"").$result."&nbsp;".$lmcurrency["symbol"][$gresult[$gtabid][$field_id][$bzm]['C']] .($events ? "</span>":"");
        }elseif($typ == 3) {
            $csvexp_zeile = str_replace(",", ".", $result) . " " . $gresult[$gtabid][$field_id][$bzm]['C'];
            #$csvexp_zeile['v'] = str_replace(",", ".", $result);
            #$csvexp_zeile['c'] = $gresult[$gtabid][$field_id][$bzm]['C'];
            return $csvexp_zeile;
        }elseif($typ == 6 OR $typ == 4) {
            return array(
                'currency' => $gresult[$gtabid][$field_id][$bzm]['C'],
                'value' => floatval(str_replace(',', '.', $result))
            );
        }else{
        	return $result;
        }
}

# -------------------------- Datum -- field_type 2 ---------------------------------
function cftyp_4($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
        global $gtab;
        global $gfield;

        $events = cftyp_events($typ,$event,null,$gresult,$gtabid,$field_id,$bzm);
		$dateformat = $gfield[$gtabid]['datetime'][$field_id]; // 1 = DATE or 2 = DATETIME
        if($gfield[$gtabid]['data_type'][$field_id] == 40 OR $gfield[$gtabid]['field_type'][$field_id] == 24){$dateformat = 1;}  // DATE , Validity

        if($typ == 1) {
            $fieldname = $gfield[$gtabid]["form_name"][$field_id]."_".$gresult[$gtabid]["id"][$bzm];

            // validity
            if($gfield[$gtabid]['field_type'][$field_id] == 24){
                $fieldname = $fieldname.'[0]';
                if ($gfield[$gtabid]['field_name'][$field_id] == 'LMB_VALIDTO') {
                    // for table list update always/only LMB_VALIDFROM
                    $valid_from_fieldID = $gfield[$gtabid]["argresult_name"]['LMB_VALIDFROM'];
                    $fieldname = $gfield[$gtabid]["form_name"][$valid_from_fieldID]."_".$gresult[$gtabid]["id"][$bzm].'[1]';
                    $events = cftyp_events($typ,$event,null,$gresult,$gtabid,$valid_from_fieldID,$bzm);
                }
            }
            // browser datepicker needs US format
            if($gfield[$gtabid]['select_pool'][$field_id] == 2){
                $dp = 'date';
                $value = get_date($gresult[$gtabid][$field_id][$bzm],1,2);
            }else{
                $dp = 'text';
                $value = get_date($gresult[$gtabid][$field_id][$bzm],$dateformat);
            }
        }else{
			if($gfield[$gtabid]['nformat'][$field_id]){
				$value = get_format_date($gresult[$gtabid][$field_id][$bzm],$gfield[$gtabid]['nformat'][$field_id]);
			}else{
				$value = get_date($gresult[$gtabid][$field_id][$bzm],$dateformat);
			}
        }

        if($typ == 1){
        	echo "<INPUT TYPE=\"$dp\" CLASS=\"gtabBodyINP\" NAME=\"".$fieldname."\" STYLE=\"width:100%\" MAXLENGTH=\"".$gfield[$gtabid]["size"][$field_id]."\" VALUE=\"".$value."\" data-regex=\"".htmlentities($gfield[$gtabid]['regex'][$field_id],ENT_QUOTES)."\" $events>";
        }elseif($typ == 2) {
            echo ($events ? "<span $events>" : "") . $value . "&nbsp;" . ($events ? "</span>" : "");
        }elseif($typ == 6) {
            return $gresult[$gtabid][$field_id][$bzm];
        }elseif($typ == 7) {
            return get_stamp($gresult[$gtabid][$field_id][$bzm]);
        } else{
        	return $value;
        }
}

# -------------------------- Zeit -- field_type 7 ---------------------------------
function cftyp_25($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
        global $gtab;
        global $gfield;

        $events = cftyp_events($typ,$event,null,$gresult,$gtabid,$field_id,$bzm);

        $value = $gresult[$gtabid][$field_id][$bzm];
        if(!LMB_DBFUNC_TIMEHANDLE){
        	$value = lmb_substr($value,11,8);
        }

        if($typ == 1){
        	echo "<INPUT TYPE=\"TEXT\" CLASS=\"gtabBodyINP\" NAME=\"".$gfield[$gtabid]["form_name"][$field_id]."_".$gresult[$gtabid]["id"][$bzm]."\" STYLE=\"width:100%\" MAXLENGTH=\"".$gfield[$gtabid]["size"][$field_id]."\" VALUE=\"".$value."\" data-regex=\"".htmlentities($gfield[$gtabid]['regex'][$field_id],ENT_QUOTES)."\" $events>";
        }elseif($typ == 2){
        	echo ($events ? "<span $events>":"").$value."&nbsp;".($events ? "</span>":"");
        } elseif($typ == 7) {
            return $value;
        }else{
        	return $value;
        }
}

# -------------------------- BOOLEAN -- field_type 10 ---------------------------------
function cftyp_5($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
        global $gtab;
        global $gfield;

        $events = cftyp_events($typ,$event,null,$gresult,$gtabid,$field_id,$bzm);

        if($typ == 1){
			if($gresult[$gtabid][$field_id][$bzm] == 1){$check = "CHECKED"; $value = "0";} else {$check = ""; $value = "1";}
			echo "<input type=\"checkbox\" class=\"gtabBodyINP\" name=\"".$gfield[$gtabid]["form_name"][$field_id]."_".$gresult[$gtabid]["id"][$bzm]."\" value=\"".$value."\" $check $events>";
        }elseif($typ == 2){
        	echo ($events ? "<span $events>":"")."&nbsp;";
   			if($gresult[$gtabid][$field_id][$bzm] == 1){
   				echo "&nbsp;&nbsp;&nbsp;<i class=\"lmb-icon lmb-check-alt2\" BORDER=\"0\"></i>";
   			}
   			echo ($events ? "</span>":"");
        }elseif($typ == 3 OR $typ == 5){
			if($gresult[$gtabid][$field_id][$bzm] == 1){
				return "1";
			}else{
				return "0";
			}
        }elseif($typ == 4 OR $typ == 6){
			if($gresult[$gtabid][$field_id][$bzm] == 1){
				return true;
			}else{
				return false;
			}
        }
}

# -------------------------- DB-ID -- field_type 5 ---------------------------------
function cftyp_6($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
        global $gtab;
        global $gfield;

		$events = cftyp_events(0,$event,null,$gresult,$gtabid,$field_id,$bzm);

        if($typ == 1 OR $typ == 2){
        	if($gresult[$gtabid]["id"][$bzm] == -1){$result = "*";}else{$result = $gresult[$gtabid]["id"][$bzm];}
        	echo ($events ? "<span $events>":"").$result."&nbsp;".($events ? "</span>":"");
        }else{
			return $gresult[$gtabid]["id"][$bzm];
        }
}

# -------------------------- SYSTEMUSER -- field_type 14 ---------------------------------
function cftyp_19($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
        global $gtab;
        global $gfield;
        global $userdat;

		$events = cftyp_events(0,$event,null,$gresult,$gtabid,$field_id,$bzm);
		$systemfield = strtoupper($gfield[$gtabid]["field_name"][$field_id]);

        if($typ == 1 OR $typ == 2){
        	echo ($events ? "<span $events>":"").htmlentities($userdat["bezeichnung"][$gresult[$gtabid][$systemfield][$bzm]],ENT_QUOTES).($events ? "</span>":"");
        }elseif($typ == 3 OR $typ == 4){
			return htmlentities($userdat["bezeichnung"][$gresult[$gtabid][$systemfield][$bzm]],ENT_QUOTES);
        }else{
        	return $userdat["bezeichnung"][$gresult[$gtabid][$systemfield][$bzm]];
        }
}

# -------------------------- SYSTEMDATE -- field_type 15 ---------------------------------
function cftyp_20($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
        global $gtab;
        global $gfield;

        $dateformat = $gfield[$gtabid]['datetime'][$field_id]; // 1 = DATE or 2 = DATETIME
		$events = cftyp_events(0,$event,null,$gresult,$gtabid,$field_id,$bzm);
        $systemfield = strtoupper($gfield[$gtabid]["field_name"][$field_id]);

        // REST
        if($typ == 6) {
            return convert_date($gresult[$gtabid][$systemfield][$bzm]);
        } if($typ == 7) {
            return get_stamp($gresult[$gtabid][$systemfield][$bzm]);
        } else{
            if($gfield[$gtabid]['nformat'][$field_id]){
                $value = get_format_date($gresult[$gtabid][$systemfield][$bzm],$gfield[$gtabid]['nformat'][$field_id]);
            }else{
                $value = get_date($gresult[$gtabid][$systemfield][$bzm],$dateformat);
            }
            if($typ == 1 OR $typ == 2) {
                echo ($events ? "<span $events>" : "") . $value . ($events ? "</span>" : "");
            }else{
                return $value;
            }
        }
}

# -------------------------- User-Group-Liste -- field_type 16 ---------------------------------
function cftyp_21($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
        global $gtab;
        global $gfield;
        global $userdat;
        global $groupdat;
        global $lang;
        global $db;
        global $action;

		$events = cftyp_events(0,$event,null,$gresult,$gtabid,$field_id,$bzm);
	
		$rscount = $gresult[$gtabid][$field_id][$bzm];
		
		if($typ >= 3 OR $rscount == 1){
			$sqlquery = "SELECT UGID,TYP FROM LMB_UGLST WHERE TABID = $gtabid AND FIELDID = $field_id AND DATID = ".$gresult[$gtabid]["id"][$bzm];
			$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
			while(lmbdb_fetch_row($rs)){
				$gutyp = lmbdb_result($rs, "TYP");
				$guid = lmbdb_result($rs, "UGID");
				
				if($gutyp == 'u'){
					$gres["typ"][] = "user";
					$gres["id"][] = $guid;
					$gres["name"][] = $userdat["bezeichnung"][$guid];
					$gres["email"][] = $userdat["email"][$guid];
					$gres["picdesc"][] = "<i class=\"lmb-icon lmb-icon-8 lmb-user\"></i> ".$userdat["bezeichnung"][$guid];
				}elseif($gutyp == 'g'){
					$gres["typ"][] = "group";
					$gres["id"][] = $guid;
					$gres["name"][] = $groupdat["name"][$guid];
					$gres["email"][] = $userdat["email"][$guid];
					$gres["picdesc"][] = "<i class=\"lmb-icon lmb-icon-8 lmb-group\"></i> ".$groupdat["name"][$guid];
				}
			}
			$rscount = lmb_count($gres["picdesc"]);
		}

		if($gfield[$gtabid]["select_cut"][$bzm]){$br = $gfield[$gtabid]["select_cut"][$bzm];}else{$br = "<br>";}
		
		if($rscount){
	        if($typ == 1 OR $typ == 2){
	        	if($rscount > 1){
	        		echo "&nbsp;".$rscount."&nbsp;$lang[86]";
	        	}else{
	        		echo ($events ? "<span $events>":"").$gres["picdesc"][0]."&nbsp;".($events ? "</span>":"");
	        	}
	        }elseif($typ == 3){
				return htmlentities(implode($br,$gres["name"]),ENT_QUOTES);
	        }elseif($typ == 4){
	        	return $gres;
	        }elseif($typ == 5){
	        	return $gres["name"];
	        }elseif($typ == 6) {
                $result = array();
                foreach ($gres['id'] as $key => $id) {
                    $result[] = array(
                        'id' => "$id",
                        'typ' => $gres['typ'][$key],
                        'name' => $gres['name'][$key],
                        'email' => $gres['email'][$key]
                    );
                }
                return $result;
            }
		}
}

# -------------------------- Filezize ---------------------------------
function cftyp_29($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
        global $gtab;
        global $gfield;

		$events = cftyp_events($typ,$event,null,$gresult,$gtabid,$field_id,$bzm);

        if($typ == 1){
        	echo "<INPUT TYPE=\"TEXT\" CLASS=\"gtabBodyINP\" NAME=\"".$gfield[$gtabid]["form_name"][$field_id]."_".$gresult[$gtabid]["id"][$bzm]."\" STYLE=\"width:100%\" MAXLENGTH=\"".$gfield[$gtabid]["size"][$field_id]."\" VALUE=\"".$gresult[$gtabid][$field_id][$bzm]."\" $events>";
        }elseif($typ == 2) {
            echo ($events ? "<span $events>" : "") . file_size($gresult[$gtabid][$field_id][$bzm]) . ($events ? "</span>" : "");
        }elseif($typ == 6) {
            return floatval($gresult[$gtabid][$field_id][$bzm]);
        }else{
        	return $gresult[$gtabid][$field_id][$bzm];
        }
}

# -------------------------- Mimetype ---------------------------------
function cftyp_30($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
        global $gtab;
        global $gfield;
        global $gmimetypes;

		$events = cftyp_events(0,$event,null,$gresult,$gtabid,$field_id,$bzm);

		if($typ == 1 OR $typ == 2){
			echo ($events ? "<span $events>":"").$gmimetypes["mimetype"][$gresult[$gtabid][$field_id][$bzm]].($events ? "</span>":"");
        }else{
        	return $gmimetypes["mimetype"][$gresult[$gtabid][$field_id][$bzm]];
        }
}

# -------------------------- FILE Content ---------------------------------
function cftyp_32($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null,$gformid=null,$formid=null){
    global $db;
    global $gform;
    global $umgvar;
    global $action;

    require_once(COREPATH . 'extra/explorer/filestructure.lib');

	# if multitenant
	$filequery = set_mttfilter();

    $sqlquery = "SELECT LDMS_FILES.ID,LDMS_FILES.NAME,LDMS_FILES.SECNAME,LDMS_FILES.MIMETYPE,LDMS_FILES.THUMB_OK,LDMS_FILES.LEVEL ".$filequery['select']."
    FROM LDMS_FILES 
	WHERE LDMS_FILES.ID = ".$gresult[$gtabid]["id"][$bzm].' '.$filequery['where'];
    $rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
    if(!$rs) {$commit = 1;}
    if(lmbdb_fetch_row($rs)) {
        $filename = htmlentities(lmbdb_result($rs, "NAME"), ENT_QUOTES);
        $fileid = lmbdb_result($rs, "ID");
        $size = explode('x',$umgvar['thumbsize1']);

        // preview for tile/list formular
        if (!$gform[$gformid]["tab_el"][$formid] AND $width = $gform[$gformid]["width"][$formid] AND $height = $gform[$gformid]["height"][$formid]) {

        }else{
            $width = $size[0];
            $height = $size[1];
            $style = "border:1px solid black;";
        }

        if ($preview_path = lmb_getThumbnail(array(lmbdb_result($rs, "ID"), lmbdb_result($rs, "SECNAME"), lmbdb_result($rs, "MIMETYPE"), lmbdb_result($rs, "THUMB_OK"), lmbdb_result($rs, "LEVEL"), lmbdb_result($rs, "LMB_MID")), ($width - 2), $height, 1)) {
            #$style_array = explode(";", $gform[$gformid]["style"][$formid]);
            #$style = set_style($style_array);
            return "<a href=\"main.php?action=download&ID=$fileid\" target=\"new\" title=\"$filename\"><img src=\"$preview_path\" STYLE=\"" . $style . "\"></a>";
        }

    }
}

# -------------------------- URL -- field_type 1 ---------------------------------
function cftyp_18($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
        global $gtab;
        global $gfield;
        global $umgvar;

		$events = cftyp_events($typ,$event,null,$gresult,$gtabid,$field_id,$bzm);

        if($typ == 1){
        	echo "<INPUT TYPE=\"TEXT\" CLASS=\"gtabBodyINP\" NAME=\"".$gfield[$gtabid]["form_name"][$field_id]."_".$gresult[$gtabid]["id"][$bzm]."\" STYLE=\"width:100%\" MAXLENGTH=\"".$gfield[$gtabid]["size"][$field_id]."\" VALUE=\"".htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES)."\" data-regex=\"".htmlentities($gfield[$gtabid]['regex'][$field_id],ENT_QUOTES)."\" $events>";
        }elseif($typ == 2){
			echo ($events ? "<span $events>":"")."<A HREF=\"".$gresult[$gtabid][$field_id][$bzm]."\" TARGET=\"new\">".htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES)."</A>&nbsp;".($events ? "</span>":"");
        }elseif($typ == 3 OR $typ == 4){
        	return htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES);
        }else{
        	return $gresult[$gtabid][$field_id][$bzm];
        }
}

# -------------------------- email -- field_type 1 ---------------------------------
function cftyp_17($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
        global $gtab;
        global $gfield;

        if($typ == 1){
        	$events = cftyp_events($typ,$event,null,$gresult,$gtabid,$field_id,$bzm);
        	echo "<INPUT TYPE=\"TEXT\" CLASS=\"gtabBodyINP\" NAME=\"".$gfield[$gtabid]["form_name"][$field_id]."_".$gresult[$gtabid]["id"][$bzm]."\" STYLE=\"width:100%\" MAXLENGTH=\"".$gfield[$gtabid]["size"][$field_id]."\" VALUE=\"".htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES)."\" data-regex=\"".htmlentities($gfield[$gtabid]['regex'][$field_id],ENT_QUOTES)."\" $events>";
        }elseif($typ == 2){
        	$event2["click"] = "window.location.href = 'mailto:".$gresult[$gtabid][$field_id][$bzm] . "'";
        	$events = cftyp_events($typ,$event,$event2,$gresult,$gtabid,$field_id,$bzm);
        	echo "<a $events>".htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES)."</a>";
        }elseif($typ == 3 OR $typ == 4){
        	return htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES);
        }else{
        	return $gresult[$gtabid][$field_id][$bzm];
        }
}


/* -------------------------- Picture URL --------------------------------- */
function cftyp_24($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
	global $gtab;
	global $gfield;
	global $umgvar;
	
    $events = cftyp_events($typ, $event, null, $gresult, $gtabid, $field_id, $bzm);
    
    if ($typ == 1) {
        echo "<INPUT TYPE=\"TEXT\" CLASS=\"gtabBodyINP\" NAME=\"" . $gfield[$gtabid]["form_name"][$field_id] . "_" . $gresult[$gtabid]["id"][$bzm] . "\" STYLE=\"width:100%\" MAXLENGTH=\"" . $gfield[$gtabid]["size"][$field_id] . "\" VALUE=\"" . htmlentities($gresult[$gtabid][$field_id][$bzm], ENT_QUOTES) . "\" $events>";
    } elseif ($typ == 2) {
        echo ($events ? "<span $events>" : "") . "<img style=\"max-height:20px;\" src=\"" . htmlentities($gresult[$gtabid][$field_id][$bzm], ENT_QUOTES) . "\">" . ($events ? "</span>" : "");
    } elseif ($typ == 3 or $typ == 4) {
        return htmlentities($gresult[$gtabid][$field_id][$bzm], ENT_QUOTES);
    } else {
        return $gresult[$gtabid][$field_id][$bzm];
    }

}

# -------------------------- Farbauswahl -- field_type 1 ---------------------------------
function cftyp_16($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
        global $gtab;
        global $gfield;
        global $umgvar;
        
        $events = cftyp_events($typ,$event,null,$gresult,$gtabid,$field_id,$bzm);
		$style = "background-color:".$gresult[$gtabid][$field_id][$bzm].";color:".lmbSuggestColor($gresult[$gtabid][$field_id][$bzm]);
		
        if($typ == 1){
        	echo "<INPUT TYPE=\"TEXT\" CLASS=\"gtabBodyINP\" NAME=\"".$gfield[$gtabid]["form_name"][$field_id]."_".$gresult[$gtabid]["id"][$bzm]."\" STYLE=\"width:100%;$style\" MAXLENGTH=\"".$gfield[$gtabid]["size"][$field_id]."\" VALUE=\"".htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES)."\" $events>";
        }elseif($typ == 2){
        	echo "<span $events style=\"$style\">".htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES)."&nbsp;</span>";
        }elseif($typ == 3 OR $typ == 4){
        	return htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES);
        }else{
        	return $gresult[$gtabid][$field_id][$bzm];
        }
}

# -------------------------- Sync-Slave ---------------------------------
function cftyp_35($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
        global $db;
        global $gtab;
        global $gfield;
        static $lmb_sync_clients;
        global $action;
        
        if(!$lmb_sync_clients){
            $sqlquery = "SELECT ID,NAME,SLAVE_URL FROM LMB_SYNC_CLIENTS ORDER BY NAME";
            $rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
            while(lmbdb_fetch_row($rs)){
                $lmb_sync_clients[lmbdb_result($rs, 'ID')] = lmbdb_result($rs, 'NAME');
            }
        }
        
        $events = cftyp_events($typ, $event, null, $gresult, $gtabid, $field_id, $bzm);
        if($typ == 1){
    		echo "<SELECT CLASS=\"gtabBodyINP\" ID=\"".$gfield[$gtabid]["form_name"][$bzm]."\" NAME=\"".$gfield[$gtabid]["form_name"][$field_id]."_".$gresult[$gtabid]["id"][$bzm]."\" STYLE=\"width:100%;\" $events><OPTION></OPTION>";
            foreach ($lmb_sync_clients as $key => $value){
                echo "<OPTION value=\"$key\" ";
                if($key == $gresult[$gtabid][$field_id][$bzm]){echo "selected";}
                echo ">$value</OPTION>";
            }
            echo "</SELECT>";

        }elseif($typ == 2){
        	echo "<span $events>".htmlentities($lmb_sync_clients[$gresult[$gtabid][$field_id][$bzm]],ENT_QUOTES)."&nbsp;</span>";
        }elseif($typ == 3 OR $typ == 4){
        	return htmlentities($lmb_sync_clients[$gresult[$gtabid][$field_id][$bzm]],ENT_QUOTES);
        }else{
        	return $gresult[$gtabid][$field_id][$bzm];
        }
}


/* -------------------------- multitenants --------------------------------- */
function cftyp_36($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
	global $db;
    global $gtab;
    global $session;
    global $lmmultitenants;

	if($pos){$pos = "STYLE=\"".$pos."\"";}
	if($style){$style = "STYLE=\"".$style."\"";}

	if($typ == 1){
        echo "<DIV $pos>";
        $event_change = "checktyp('".$gfield[$gtabid]["data_type"][$field_id]."','".$gfield[$gtabid]["form_name"][$field_id]."','".$gfield[$gtabid]["spelling"][$field_id]."','".$field_id."','".$gtabid."',this.value,'".$ID."','".$gfield[$gtabid]["ajaxpost"][$field_id]."',null,null,'".$gresult[$gtabid]['parentage']."')";
		$events = dftyp_events($typ,$event,null,$event_dblclick,null,null,$event_change,$gresult,$gtabid,$field_id);

		echo "<SELECT ID=\"".$gfield[$gtabid]["form_name"][$field_id]."\" $class $style NAME=\"".$gfield[$gtabid]["form_name"][$field_id]."\" TITLE=\"".$gfield[$gtabid]["need"][$field_id].$gfield[$gtabid]["beschreibung"][$field_id]."\" TABINDEX=\"$z_index\" $events><OPTION></OPTION>";
        foreach ($lmmultitenants['mid'] as $mid => $value){
            echo "<OPTION value=\"$key\" ";
            if($value == $gresult[$gtabid]['MID'][$bzm]){echo "selected";}
            echo ">".$lmmultitenants['name'][$mid]."</OPTION>";
        }
        echo "</SELECT>";
        echo "</DIV>";

    }elseif($typ == 2){
        echo "<DIV $pos>";
        echo "<span $events style=\"$style\" title=\"".$gresult[$gtabid]['MID'][$bzm]."\">".htmlentities($lmmultitenants['name'][$lmmultitenants['translate'][$gresult[$gtabid]['MID'][$bzm]]],ENT_QUOTES)."&nbsp;</span>";
        echo "</DIV>";
    }elseif($typ == 3 OR $typ == 4){
        return htmlentities($lmmultitenants['name'][$lmmultitenants['translate'][$gresult[$gtabid]['MID'][$bzm]]],ENT_QUOTES);
    }else{
        return $gresult[$gtabid]['MID'][$bzm];
    }
}


# -------------------------- Validity -- field_type 24 ---------------------------------
function cftyp_37($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
    if($GLOBALS['action' == 'gtab_erg']){$typ = 2;} // readonly in table
    return cftyp_4($bzm,$field_id,$gtabid,$typ,$gresult,$event);
}

# -------------------------- Encrypted ---------------------------------
function cftyp_38($bzm,$fieldid,$gtabid,$typ,&$gresult,$event=null) {
    global $gfield;


    $encryptionMode = $gfield[$gtabid]['encryption_mode'][$fieldid];

    if ($encryptionMode == 1) {
        echo '<a data-decrypt="' . $gresult[$gtabid]['id'][$bzm] . '" data-gtabid="' . $gtabid . '" data-fieldid="' . $fieldid . '" data-mode="list" data-dparams="">Decrypt</a>';
        return '';
    }

    // at rest encryption => decrypt access
    $fname = 'cftyp_'.$gfield[$gtabid]['argument'][$fieldid];
    return $fname($bzm,$fieldid,$gtabid,$typ,$gresult,$event);
}

# -------------------------- Select -- data_type 12 ---------------------------------
function cftyp_9($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
        global $gtab;
        global $gfield;
        global $db;
        global $farbschema;
        global $umgvar;

        if($typ == 1){
        	
        	$ID = $gresult[$gtabid]['id'][$bzm];
        	$gresult_[$gtabid]['id'][0] = $ID;
        	$gresult_[$gtabid][$field_id][0] = $gresult[$gtabid][$field_id][$bzm];
        	
        	dftyp_9($ID,$gresult_,$field_id,$gtabid,'gtabBodyINP','width:85%',null,$typ,'listmode',$event);

        }elseif($typ == 2){
        	$events = cftyp_events($typ,$event,null,$gresult,$gtabid,$field_id,$bzm);
        	echo ($events ? "<span style=\"cursor:help\" $events>":"").htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES)."&nbsp;".($events ? "</span>":"");
        }elseif($typ == 3 OR $typ == 4){
        	return htmlentities($gresult[$gtabid][$field_id][$bzm],ENT_QUOTES);
        }else{
        	return $gresult[$gtabid][$field_id][$bzm];
        }
}

# -------------------------- Multi-Select -- data_type 18, 31, 32 ---------------------------------
function cftyp_10($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null,$gformid=null,$formid=null) {
	global $gtab;
	global $gfield;
	global $db;
	global $farbschema;
	global $umgvar;
	global $lang;
	global $session;
	global $action;
    global $lmfieldtype;

	if(!$gfield[$gtabid]["select_pool"][$field_id]){return false;}

	# SELECT / ATTRIBUTE
	if($gfield[$gtabid]["field_type"][$field_id] == 19){$tabtyp = "LMB_ATTRIBUTE";$attribute = 1;}else{$tabtyp = "LMB_SELECT";}

	// Poolsettings
    $pool_tagmode = $GLOBALS['gselectpool'][$tabtyp]['tagmode'][$gfield[$gtabid]["select_pool"][$field_id]];
    $pool_multimode = $GLOBALS['gselectpool'][$tabtyp]['multimode'][$gfield[$gtabid]["select_pool"][$field_id]];
    #$sqlquery = "SELECT {$tabtyp}_P.TAGMODE,{$tabtyp}_P.MULTIMODE FROM {$tabtyp}_P WHERE ID = ".$gfield[$gtabid]["select_pool"][$field_id];
    #$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
    #$pool_tagmode = lmbdb_result($rs, 'TAGMODE');
    #$pool_multimode = lmbdb_result($rs, "MULTIMODE");

	# new dataset
	if(!$gresult[$gtabid]['id'][0]){return;}
	
	# Wertliste
	$numr = $gresult[$gtabid][$field_id][$bzm];
	$ID = $gresult[$gtabid]['id'][$bzm];
	
	if($gfield[$gtabid]["unique"][$field_id]){
		$msingle = 1;
	}
	
	// multilang
	$field_name = 'WERT';
	if($gfield[$gtabid]['multilang'][$field_id] == 2){
	    $field_name = 'LANG'.$session['dlanguage'].'_WERT';
	}

	if($numr >= 1 AND (!$msingle OR $typ >= 3)){
        if($pool_tagmode) {$hidetag = $tabtyp."_W.HIDETAG,".$tabtyp."_W.COLOR,";}
        if($attribute) {$attribute = $tabtyp."_D.VALUE_STRING,".$tabtyp."_D.VALUE_NUM,".$tabtyp."_D.VALUE_DATE,".$tabtyp."_W.TYPE,";}
        if ($gfield[$gtabid]["select_sort"][$field_id]) {$sort = " ORDER BY ".$tabtyp."_W." . $gfield[$gtabid]["select_sort"][$field_id].", ".$tabtyp."_D.ID";} else {$sort = " ORDER BY ".$tabtyp."_D.ID";}

		$sqlquery = "SELECT " . $hidetag . $attribute . $field_name . "," . $tabtyp . "_W.KEYWORDS,".$tabtyp."_W.ID FROM ".$tabtyp."_D,".$tabtyp."_W WHERE ".$tabtyp."_D.W_ID = ".$tabtyp."_W.ID AND ".$tabtyp."_D.TAB_ID = ".$gtabid." AND ".$tabtyp."_D.FIELD_ID = ".$field_id." AND ".$tabtyp."_D.DAT_ID = ".$gresult[$gtabid]["id"][$bzm] . $sort;
		$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
		while(lmbdb_fetch_row($rs)) {
			$skey = lmbdb_result($rs, "ID");
			if($typ == 5){
				$row[$skey] = lmbdb_result($rs, $field_name);
				$row['keyword'][$skey] = lmbdb_result($rs, "KEYWORDS");
                if($attribute) {
                    $row['attrvalue'][$skey] = lmbdb_result($rs, "VALUE_STRING");
                }
			}elseif ($typ == 6) {
                $keyword = lmbdb_result($rs, "KEYWORDS");
                $entry = array(
                    'id' => "$skey",
                    'value' => lmbdb_result($rs, $field_name),
                    'desc' => $keyword ? $keyword : null
                );
                // attribute -> get value
                if($attribute) {
                    $entry['attrvalue'] = lmbdb_result($rs, 'VALUE_STRING');
                }
                $row[] = $entry;
            }else{
				$row[$skey] = htmlentities(lmbdb_result($rs, $field_name),ENT_QUOTES);
				$row['keyword'][$skey] = htmlentities(lmbdb_result($rs, "KEYWORDS"),ENT_QUOTES);
                if($pool_tagmode) {
                    $row['color'][$skey] = lmbdb_result($rs, "COLOR");
                    $row['hidetag'][$skey] = lmbdb_result($rs, "HIDETAG");
                }
                if($attribute) {
                    $row['data_type'][$skey] = lmbdb_result($rs, "TYPE");
                    $row['value_string'][$skey] = lmbdb_result($rs, "VALUE_STRING");
                    $row['value_num'][$skey] = lmbdb_result($rs, "VALUE_NUM");
                    $row['value_date'][$skey] = lmbdb_result($rs, "VALUE_DATE");

                    ################ get atrribute values###################
                    # date
                    if ($lmfieldtype['parse_type'][$row['data_type'][$skey]] == 4) {
                        $attvalue = stampToDate($row['value_num'][$skey], 1);
                        # bool
                    } else if ($lmfieldtype['parse_type'][$row['data_type'][$skey]]== 3) {
                        $attvalue = $row['value_num'][$skey];
                        # text / number / pool
                    } else if($row['parse_type'][$skey]){
                        if ($row['value_num'][$skey]) {
                            $value_num = convert_FloatRound($row['value_num'][$skey]);
                        } else {
                            $value_num = '';
                        }
                        $attvalue = htmlentities(trim($value_num . ' ' . $row['value_string'][$skey]), ENT_QUOTES);
                    }
                    $row['attrvalue'][$skey] = $attvalue;
                }
				$row_[] = lmbdb_result($rs, $field_name);
			}
		}
	}


	if($typ == 1 OR $typ == 2){

		# single
		if($msingle){
		    // Ajax
			if($gfield[$gtabid]["data_type"][$field_id] == 32){
				dftyp_11($ID,$gresult,$field_id,$gtabid,'gtabBodyINP',null,null,$typ,'listmode',$event,$gformid,$formid);
			}else{
				dftyp_10($ID,$gresult,$field_id,$gtabid,'gtabBodyINP','width:85%',null,$typ,'listmode',$event,$gformid,$formid);
			}

		# multiple
		}else{
		    # show tags
		    if($formid) {
		        dftyp_11($ID,$gresult,$field_id,$gtabid,'gtabBodyINP',1,null,$typ,'listmode',$event,$gformid,$formid);

		    # show details
            }elseif($row_ AND $gfield[$gtabid]["listing_viewmode"][$field_id] == 2){
				echo implode($row_, $gfield[$gtabid]["listing_cut"][$field_id]);
				$row_ = null;
			# show count
			}else{
				if($numr > 1){
					echo $numr.'&nbsp;'.$lang[86]."&nbsp;";
				}else{
					echo "<A HREF=\"#\" OnClick=\"newwin10('".$gfield[$gtabid]["field_id"][$field_id]."','".$gtabid."','".$gtab["tab_group"][$gtabid]."','".$gresult[$gtabid]["id"][$bzm]."');\">".$row[$skey]."</A>&nbsp;";
				}
			}
		}
		
		# show symbol
		if(!$msingle and (!$pool_tagmode OR !$formid)){
			if($typ == 1){
				echo "<span OnClick=\"lmbAjax_multibleSelect(this,'$gtabid','$field_id','".$gresult[$gtabid]["id"][$bzm]."');\">&nbsp;<i class=\"lmb-icon lmb-edit-caret\" BORDER=\"0\" style=\"cursor:help;\"></i>&nbsp;";
			}elseif($row_){
				echo "<span OnClick=\"activ_menu=1;ajaxGet(event,'main_dyns.php','getSelectValues&gtabid=".$gtabid."&fieldid=".$field_id."&id=".$gresult[$gtabid]["id"][$bzm]."',0,'ajaxContainerPost');\">&nbsp;<i class=\"lmb-icon lmb-caret-down-alt\" BORDER=\"0\" style=\"cursor:help;\"></i>&nbsp;";
			}
		}

	}elseif($typ == 3){
		if($numr == 1){
			return $row_[0];
		}else{
			return $numr."&nbsp;".$lang[86];
		}
	}else{
		return $row;
	}

}

# -------------------------- Multible Select -- data_type 32 ---------------------------------
function cftyp_11($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null,$gformid=null,$formid=null) {
	return cftyp_10($bzm,$field_id,$gtabid,$typ,$gresult,$event,$gformid,$formid);
}

# -------------------------- Select -- data_type 14 ---------------------------------
function cftyp_15($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
	return cftyp_9($bzm,$field_id,$gtabid,$typ,$gresult,$event);
}

# -------------------------- Multible Select -- data_type 18 ---------------------------------
function cftyp_23($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null) {
	return cftyp_10($bzm,$field_id,$gtabid,$typ,$gresult,$event);
}

# -------------------------- UPLOAD -- field_type 6 ---------------------------------
function cftyp_12($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null,$gformid=null,$formid=null) {
	global $gtab;
	global $gfield;
	global $lang;
	global $session;
	global $umgvar;
	global $db;
	global $HTTP_REFERER;
	global $gform;
	global $action;

	require_once(COREPATH . 'extra/explorer/filestructure.lib');

	$events = cftyp_events(0,$event,null,$gresult,$gtabid,$field_id,$bzm);

	if($typ == 1 OR $typ == 2){
		echo ($events ? "<span $events>":"");
		if($gresult[$gtabid][$field_id][$bzm]){

            // preview
            if ($gfield[$gtabid]["quicksearch"][$field_id]) {  # quicksearch == preview

                # if multitenant
                $filequery = set_mttfilter();

                $sqlquery = "SELECT LDMS_FILES.ID,LDMS_FILES.NAME,LDMS_FILES.SECNAME,LDMS_FILES.MIMETYPE,LDMS_FILES.THUMB_OK,LDMS_FILES.LEVEL ".$filequery['select']."
                FROM LDMS_FILES
				WHERE LDMS_FILES.TABID = $gtabid AND LDMS_FILES.FIELDID = $field_id AND LDMS_FILES.DATID = ".$gresult[$gtabid]["id"][$bzm].' '.$filequery['where'];
                $rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);

                // show first thumbnail
                if(lmbdb_fetch_row($rs)) {
                    $filename = htmlentities(lmbdb_result($rs, "NAME"), ENT_QUOTES);
                    $fileid = lmbdb_result($rs, "ID");
                    $width = $gform[$gformid]["width"][$formid];
                    $height = $gform[$gformid]["height"][$formid];
                    if(!$width){
                        $size = explode("x",$umgvar["thumbsize1"]);
                        $width = $size[0];
                        $height = $size[1];
                    }

                    if($preview_path = lmb_getThumbnail(array(lmbdb_result($rs, "ID"), lmbdb_result($rs, "SECNAME"), lmbdb_result($rs, "MIMETYPE"), lmbdb_result($rs, "THUMB_OK"), lmbdb_result($rs, "LEVEL"),lmbdb_result($rs1, "LMB_MID")), ($width - 2), $height, 1)) {

                        echo "<a href=\"main.php?action=download&ID=$fileid\" target=\"new\" title=\"$filename\">";
                        // preview for tile/list formular
                        if (!$gform[$gformid]["tab_el"][$formid]) {
                            $style_array = explode(";", $gform[$gformid]["style"][$formid]);
                            $style = set_style($style_array);
                            echo "<img src=\"$preview_path\" STYLE=\"" . $style . "\">";

                            // preview for tablelist
                        } else {
                            echo "<img src=\"$preview_path\" BORDER=\"1\">";
                        }

                        echo "</a>";

                    }else{
                        echo "<b>".$filename."</b>&nbsp;";
                    }
                }

            }else{
                if(!$gresult[$gtabid][$field_id][$bzm]){return;}
                if(is_numeric($gresult[$gtabid][$field_id][$bzm])) {
                    echo "<b>" . $gresult[$gtabid][$field_id][$bzm] . '</b> ' . $lang[1705] . "&nbsp;";
                }else{
                    echo $gresult[$gtabid][$field_id][$bzm];
                }
            }

		}
		echo ($events ? "</span>":"");
	}else{
		global $gmimetypes;

		$url = explode("&",$HTTP_REFERER);
		$url = explode("/",$url[0]);
		array_pop($url);
		$url = implode("/",$url);

		/* --- Dateien lesen ---------------------------------------- */
		$sqlquery = "SELECT LDMS_FILES.ID,LDMS_FILES.LEVEL,LDMS_FILES.SECNAME,LDMS_FILES.NAME,LDMS_FILES.SIZE,LDMS_FILES.SORT,LDMS_FILES.PERM,LDMS_FILES.MIMETYPE,LDMS_FILES.THUMB_OK
		FROM LDMS_FILES
		WHERE LDMS_FILES.TABID = $gtabid AND LDMS_FILES.FIELDID = $field_id AND LDMS_FILES.DATID = ".$gresult[$gtabid]["id"][$bzm]." ORDER BY LDMS_FILES.SORT";
		$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
		if(!$rs) {$commit = 1;}
		$bzm2 = 1;
		while(lmbdb_fetch_row($rs)) {
			$csvexp_zeile[] = htmlentities(lmbdb_result($rs, "NAME"),ENT_QUOTES);
			$soap_zeile["id"][] = lmbdb_result($rs, "ID");
			$soap_zeile["name"][] = lmbdb_result($rs, "NAME");
			$soap_zeile["secname"][] = lmbdb_result($rs, "SECNAME");
			$soap_zeile["mimetype"][] = $gmimetypes["mimetype"][lmbdb_result($rs, "MIMETYPE")];
			$soap_zeile["mimeid"][] = lmbdb_result($rs, "MIMETYPE");
			$soap_zeile["perm"][] = lmbdb_result($rs, "PERM");
			$soap_zeile["thumb_ok"][] = lmbdb_result($rs, "THUMB_OK");
			$soap_zeile["level"][] = lmbdb_result($rs, "LEVEL");
			$soap_zeile[] = lmbdb_result($rs, "NAME");
			$bzm2++;
		}
		if($csvexp_zeile){
			if($typ == 3){
				if($bzm2 == 2){
					return htmlentities($csvexp_zeile[0],ENT_QUOTES);
				}else{
					return ($bzm2-1)."&nbsp;".$lang[86];
				}
			}elseif($typ == 4){
				return $soap_zeile;
			}else{
				return $soap_zeile["name"];
			}
		}
	}
}


/**
 * relation - field type 11 - Details / Single relation view
 * 
 * @param unknown $bzm
 * @param unknown $field_id
 * @param unknown $gtabid
 * @param unknown $typ
 * @param unknown $gresult
 * @param string $event
 * @param int $viewmode 1=short,2=long,3=first,4=last
 * @return string
 */

function cftyp_14_gresult($bzm, $field_id, $gtabid, $typ, &$gresult, $event = null, $viewmode = null, $gformid=null, $formid=null){
    global $gtab;
    global $gfield;
    global $filter;

    $ID = $gresult[$gtabid]["id"][$bzm];
    $verkn = set_verknpf($gtabid, $field_id, $ID, 0, 0, 1, 1);
    $linklevel["tabid"] = $gfield[$gtabid]["verkntabid"][$field_id];
    $linklevel["fieldid"] = $gfield[$gtabid]["verknfieldid"][$field_id];
    $vgtabid = $gfield[$gtabid]["verkntabid"][$field_id];
    // list of shown fields
    if ($gfield[$gtabid]["verknview"][$field_id]) {
        $showfields = $gfield[$gtabid]["verknview"][$field_id];
        $afieldlist[$linklevel["tabid"]] = $showfields;
    }
    $gsr = null;

    // viewmode
    if($gfield[$gtabid]["data_type"][$field_id] != 25) {
        if ($viewmode == 3) {
            $extension["order"][0] = $gfield[$gtabid]["md5tab"][$field_id] . ".ERSTDATUM ASC";
            $extension['limit'][$vgtabid] = 1;
        } elseif ($viewmode == 4) {
            $extension["order"][0] = $gfield[$gtabid]["md5tab"][$field_id] . ".ERSTDATUM DESC";
            $extension['limit'][$vgtabid] = 1;
        }
    }

	# specific relation params
    $vuniqueid = $gfield[$gtabid]["form_name"][$field_id].'_';

	// specific relation params & filter
    cftyp_ext_RelationFields($ID,$gtabid,$field_id,$vuniqueid,$formid,$gformid,$verkn,$gresult,$filter,$gsr,$extension);

    # check for destination formular
    if($filter["ext_RelationFields"]["formid"][$vuniqueid]){
        $dest_formid = $filter["ext_RelationFields"]["formid"][$vuniqueid];
    }elseif($gform[$gformid]['pic_size'][$formid]){
        $dest_formid = $gform[$gformid]['pic_size'][$formid];
    }else{
        $dest_formid = $gtab["tab_view_form"][$vgtabid];
    }

    # check for form dimension
    if($filter['ext_RelationFields']['formsize'][$vuniqueid]){
        $dimsn = $filter['ext_RelationFields']['formsize'][$vuniqueid];
    }elseif($dest_formid){
        $dimsn = $gformlist[$vgtabid]["dimension"][$dest_formid];
    }

    // default show_inframe in tablelist
    $show_inframe = $filter["ext_RelationFields"]["show_inframe"][$vuniqueid];
    #if(!$show_inframe AND !$gformid){
    #    $show_inframe = 'iframe';
    #}

    // REST/ RAW workarount for returning cftyp_ (type 3) value not echo value (type 1/2)
    // for typ 1 - 4 use typ 3
    $typ_ = $typ;
    if($typ <= 4){$typ_ = 3;}

    // relation gresult
    $vgresult = sql_14_c($vgtabid, $verkn, $linklevel, null, null, $gsr, $afieldlist, $extension);

    // view all relations
    if ($vgresult[$vgtabid]['id']) {
        foreach ($vgresult[$vgtabid]['id'] as $vkey => $vval) {
            // ClickEvents
            if ($gtab["typ"][$gfield[$gtabid]["verkntabid"][$field_id]] == 3) {
                $event2["click"] = "open('main.php?&action=download&ID=" . $vval . "','download','')"; // Explorer
            } else {
                #$event2["click"] = "newwin7('gtab_change','$vgtabid','$gtabid','$field_id','$ID','$vval','$dest_formid','$dimsn','','$show_inframe','')";
                $event2["click"] = "lmbOpenForm(event,'$vgtabid','$vval',{formid:'$dest_formid',action:'gtab_change', v_tabid:'$gtabid',v_fieldid:'$field_id',v_id:'$ID',formdimension:'$dimsn',inframe:'$show_inframe'});";
            } // Dataset
            $events = cftyp_events(0, $event, $event2, $gresult, $gtabid, $field_id, $bzm);

            // list of shown fields
            $retrn = array();
            foreach ($showfields as $fkey => $ffieldid) {
                if (! function_exists("cftyp_" .$gfield[$linklevel["tabid"]]["funcid"][$ffieldid])) {
                    continue;
                }
                $fname = "cftyp_" . $gfield[$linklevel["tabid"]]["funcid"][$ffieldid];
                $subrtn = $fname($vkey, $ffieldid, $linklevel["tabid"], $typ_, $vgresult, 0, $gformid, $formid);
                if($typ > 3 && is_array($subrtn)){
                    $subrtn = implode($gfield[$gtabid]['verknviewcut'][$field_id],$subrtn);
                }
                $retrn[] = $subrtn;
            }
            if (! $retrn) {
                $retrn[0] = $vval;
            }
            // GUI
            if ($typ <= 2) {
                $vvalue[] = "<a $events>" . implode($gfield[$gtabid]["verknviewcut"][$field_id], $retrn) . "</a>";
                // sop / export
            } else {
                $vvalue_ = implode($gfield[$gtabid]["verknviewcut"][$field_id], $retrn);
                $vvalue[] = $vvalue_;
                // $result["id"][] = $vgresult[$vgtabid]["id"][$key];
                // $result["name"][] = $gfield[$linklevel["tabid"]]["spelling"][$linklevel["fieldid"]];
                // $result["value"][] = $vvalue_;
                $result[$vval] = $vvalue_;
            }
            // view only one relation or count of relations
            if ($gfield[$gtabid]["listing_viewmode"][$field_id] != 2 and $typ <= 3) {
                break;
            }
        }
    }

    // sop / export
    if ($typ > 3) {
        return $result;
    }

    // editmode
    if ($typ == 1 and ! $gfield[$gtabid]["artleiste"][$field_id]) {
        $vvalue[] = "&nbsp;<i border=\"0\" onclick=\"LmExt_RelationList(this,'$gtabid','$field_id','$ID')\" style=\"cursor:pointer;vertical-align:top;\" class=\"lmb-icon lmb-edit-caret\" title=\"" . $gfield[$gtabid]['spelling'][$field_id] . ' -> ' . $gresult[$gtabid][$gfield[$gtabid]["mainfield"]][$bzm] . "\"></i>";
    }

    // string of shown relation fields
    if ($vvalue) {
        $vvalue = implode($gfield[$gtabid]["listing_cut"][$field_id],$vvalue);
    }

    return $vvalue;
}

/**
 * relation - field type 11
 *
 * @param unknown_type $bzm
 * @param unknown_type $field_id
 * @param unknown_type $gtabid
 * @param unknown_type $typ
 * @param unknown_type $gresult
 * @param unknown_type $event
 * @param unknown_type $dest_formid
 * @return unknown
 *
 */
function cftyp_14($bzm,$field_id,$gtabid,$typ,&$gresult,$event=null,$gformid=null,$formid=null) {
	global $gtab;
	global $gfield;
	global $gform;
	global $lang;
	global $umgvar;
	global $db;
    global $filter;

	$ID = $gresult[$gtabid]['id'][$bzm];
	$rscount = $gresult[$gtabid][$field_id][$bzm];
    $dest_formid = $gform[$gformid]['pic_size'][$formid]; # pic_size = dest_formid

    // Anzahl verknüpfter Datensätze explizit abfragen  todo
    /*
    $linklevel['tabid'] = $gfield[$gtabid]['verkntabid'][$field_id];
    $linklevel['fieldid'] = $gfield[$gtabid]['verknfieldid'][$field_id];
    $verkn = set_verknpf($gtabid, $field_id, $ID, 0, 0, 1, 1);
    $vgresult = sql_14_c($gfield[$gtabid]['verkntabid'][$field_id], $verkn, $linklevel);
    $rscount = $vgresult[$gfield[$gtabid]['verkntabid'][$field_id]]['res_count'];
    */

#http://10.100.44.12/main.php?action=gtab_erg&verkn_showonly=1&ID=&verkn_ID=697&gtabid=1&verkn_tabid=248&verkn_fieldid=16&form_id=&verknpf=1&verkn_formid=null&verkn_addfrom=&readonly=
#http://10.100.44.12/main.php?action=gtab_erg&verkn_showonly=1&ID=&verkn_ID=699&gtabid=247&verkn_tabid=248&verkn_fieldid=6&form_id=&verkn_formid=null&verkn_addfrom=

	if(!$ID){return;}

	# editmode / viewmode
	if($typ <= 2){
	    # editmode as select or ajax select
	    if($typ == 1 AND $gfield[$gtabid]["unique"][$field_id] AND $gfield[$gtabid]["artleiste"][$field_id]){
		    dftyp_14($ID,$gresult,$field_id,$gtabid,null,null,null,$typ,null,$event,null,-1,$dest_formid);
	    // show rowcount
	    }elseif($rscount > 1 AND ($gfield[$gtabid]["listing_viewmode"][$field_id] == 1 OR !$gfield[$gtabid]["listing_viewmode"][$field_id]) AND !($gfield[$gtabid]["data_type"][$field_id] == 25 AND $gfield[$gtabid]['verkntabletype'][$field_id] == 2)){
            #$event2["click"] = "newwin5(event,'".$gfield[$gtabid]["verkntabid"][$field_id]."','".$gtabid."','".$gfield[$gtabid]["field_id"][$field_id]."','".$gresult[$gtabid]["id"][$bzm]."')";
            # specific relation params

            // specific relation params & filter // generate only once
            static $ext_RelationFields;
            $vuniqueid = $gfield[$gtabid]["form_name"][$field_id].'_';
            if(!$ext_RelationFields) {
                cftyp_ext_RelationFields($ID, $gtabid, $field_id, $vuniqueid, $formid, $gformid, null, $gresult, $filter, $gsr, $extension);
            }
            $ext_RelationFields = 1;

            $show_inframe = $filter["ext_RelationFields"]["show_inframe"][$vuniqueid];
			$event2["click"] = "lmbOpenForm(event,'{$gfield[$gtabid]["verkntabid"][$field_id]}','',{action:'gtab_erg', v_tabid:'$gtabid',v_fieldid:'{$gfield[$gtabid]["field_id"][$field_id]}',v_id:'{$gresult[$gtabid]["id"][$bzm]}',inframe:'$show_inframe'});";
            $events = cftyp_events(0,$event,$event2,$gresult,$gtabid,$field_id,$bzm);
			echo "<a href=\"#\" $events>".$rscount."&nbsp;$lang[86]</a>";
			// show details in dialog in editmode
			if($typ == 1){
				echo "&nbsp;<i border=\"0\" onclick=\"LmExt_RelationList(this,'$gtabid','$field_id','$ID')\" style=\"cursor:pointer;vertical-align:top;\" class=\"lmb-icon lmb-edit-caret\" title=\"".$gfield[$gtabid]['spelling'][$field_id].' -> '.$gresult[$gtabid][$gfield[$gtabid]["mainfield"]][$bzm]."\"></i>";
			}
	    // show details in cell (single or listing_viewmode == 2)
            ## if($rscount AND $vvalue... // todo
		}elseif($vvalue = cftyp_14_gresult($bzm,$field_id,$gtabid,$typ,$gresult,$event,$gfield[$gtabid]["listing_viewmode"][$field_id],$gformid,$formid)){
			echo $vvalue;
		}
	# html exportmode
	}elseif($typ == 3){
	    // return rowcount
		if($rscount > 1 AND $gfield[$gtabid]["listing_viewmode"][$field_id] != 2){
			return $rscount." ".$lang[86];
		// return details (single or listing_viewmode == 2)
		}elseif($vvalue = cftyp_14_gresult($bzm,$field_id,$gtabid,$typ,$gresult,$event)){
			return $vvalue;
		}
	# rawmode
	}elseif($result = cftyp_14_gresult($bzm,$field_id,$gtabid,$typ,$gresult,$event)){
	    // return array
		return $result;
	}
	
}

function cftyp_14_d(&$vgresult,$rscount,$typ,$verkn,$gtabid,$vgtabid,$bzm,$ID,$VID,$linklevel,$vuniqueid,$gformid,$formid,&$filter,$dest_formid=null){
	global $gfield;
	global $gtab;
	global $farbschema;
	global $lang;
	global $umgvar;
	global $gformlist;

	# use style for header resizing in limbasSubheaderSelection()
	if($gformid AND $formid){
		$st = explode(";",$GLOBALS["gform"][$gformid]["style"][$formid]);
		if($st[24] == 'auto'){
			$resizable = 'resizable';
		}
	}
	
	echo "<table id=\"extRelationTab_".$gtabid."_".$bzm."\" data-el=\"".$gtabid."_".$bzm."\" datid=\"$ID\" class=\"legacy-table lmbfringeGtabBody $resizable\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\" style=\"border:none;width:100%;table-layout:fixed\">
	<thead>";
	
	# extended relation table
	if($gfield[$gtabid]["verkntabid"][$bzm]){
		#$sgtabid = $gfield[$gtabid]["verkntabid"][$bzm];
		$isrelation = 1;
	# independent table
	}else{
		#$sgtabid = $vgtabid;
		$isrelation = 0;
	}

	# default list of shown fields
	if(!$filter["ext_RelationFields"][$vuniqueid]){
		if($gfield[$gtabid]["verknview"][$bzm]){
			$filter["ext_RelationFields"][$vuniqueid] = $gfield[$gtabid]["verknview"][$bzm];
		}else{
			$filter["ext_RelationFields"][$vuniqueid] = array($linklevel["fieldid"]);
		}
	}

	# field order
	if($filter["ext_RelationOrder"][$vuniqueid]){
		$params["orderfield"] = $filter["ext_RelationOrder"][$vuniqueid];
	}

	// show indicator always in default formular
    // for custom formulars use $filter["ext_RelationFields"]["indicator"][$vuniqueid] = 1; # $vuniqueid = 'g_[gtabid]_[fieldid]_[formid]'
    if(!$gformid){
        $filter["ext_RelationFields"]["indicator"][$vuniqueid] = 1;
    }
    if(!$vgresult[$vgtabid]["indicator"]["width"]){
        $vgresult[$vgtabid]["indicator"]["width"] = 50;
    }
    if(is_numeric($filter["ext_RelationFields"]["show_inframe"][$vuniqueid])){
        $filter["ext_RelationFields"]["show_inframe"][$vuniqueid] = 'element'.$filter["ext_RelationFields"]["show_inframe"][$vuniqueid];
    }

	#----------------------- Field search -----------------------
	if($filter["ext_RelationFields"]["search"][$vuniqueid] AND !$filter["ext_RelationFields"]["no_search"][$vuniqueid]){
		echo "<TR>";
		if(!$filter["ext_RelationFields"]["no_sort"][$vuniqueid] AND $typ == 1 AND $gfield[$gtabid]["data_type"][$bzm]){echo "<th class=\"gtabHeaderInputTD\" style=\"width:50px;\">&nbsp;</th>";}

        // add indicator object before
        if($filter["ext_RelationFields"]["indicator"][$vuniqueid] AND $vgresult[$vgtabid]["indicator"]["object"]){
            echo "<th nowrap class=\"gtabHeaderInputTD\" style=\"cursor:pointer;width:".$vgresult[$vgtabid]["indicator"]["width"].";\"></th>";
        }

		foreach ($filter["ext_RelationFields"][$vuniqueid] as $key1 => $value1){

            if($gfield[$vgtabid_]["col_hide"][$value1]){continue;}

			####################
			$vgtabid_ = $linklevel["tabid"];
			if($gfield[$gtabid]["verknparams"][$bzm] AND $value1 > 1000){
				$vgtabid_ = $gfield[$gtabid]["verknparams"][$bzm];
			}
			#####################
			
			if($gfield[$vgtabid_]["field_type"][$value1] == 5){$align = "right";}else{$align = "left";}
			# width
			if($filter["ext_RelationFields"]["width"][$vuniqueid] AND !$resizable){
				if($filter["ext_RelationFields"]["width"][$vuniqueid][$value1]){
					$width = $filter["ext_RelationFields"]["width"][$vuniqueid][$value1];
				}else{
					$width = $gfield[$vgtabid_]["rowsize"][$value1];
				}
			}
			echo "<th class=\"gtabHeaderInputTD\" $align style=\"width:".$width."\">";
			echo "<INPUT class=\"gtabHeaderInputINP\" TYPE=\"TEXT\" VALUE=\"".$filter["ext_RelationFields"]["searchval"][$vuniqueid][$vgtabid_][$value1][0]."\" STYLE=\"width:100%;\" OnChange=\"LmExt_RelationFields(this,'$gtabid','$bzm','','$typ','$ID','','$value1','searchval',this.value,'$gformid','$formid');\">";
			echo "</th>";
		}
		echo "</TR>";
	}
	
	#----------------------- Field description ------------------------
	echo "<TR class=\"gtabHeaderTitleTR\">";
	// default order
	$bzmrk = 0;
	if(!$filter["ext_RelationFields"]["no_sort"][$vuniqueid] AND $typ == 1 AND $gfield[$gtabid]["data_type"][$bzm]){
		echo "<th nowrap class=\"gtabHeaderTitleTD\" style=\"cursor:pointer;width:50px;\" align=\"center\" OnClick=\"LmExt_RelationFields(this,'$gtabid','$bzm','','$typ','$ID','reset','','','','$gformid','$formid');\">
			<i class=\"lmb-icon lmb-caret-down-alt2\" valign=\"top\"></i>
			</th>";
		$bzmrk = 1;
	}

    // add indicator object before
    if($filter["ext_RelationFields"]["indicator"][$vuniqueid] AND $vgresult[$vgtabid]["indicator"]["object"]){
        echo "<th nowrap class=\"gtabHeaderTitleTD\" style=\"cursor:pointer;width:".$vgresult[$vgtabid]["indicator"]["width"].";\" align=\"center\">".$vgresult[$vgtabid]["indicator"]["header"]."</th>";
    }

	foreach ($filter["ext_RelationFields"][$vuniqueid] as $key1 => $value1){
		
	    if($gfield[$vgtabid_]['field_type'][$value1] >= 100){continue;}
        if($gfield[$vgtabid_]["col_hide"][$value1]){continue;}
		
		/* noch nicht für Liste
		# no view permission
		if($gfield[$vgtabid]["viewrule"][$value1]){
		if(check_GtabRules($ID,$vgtabid,$value1,$gfield[$vgtabid]["viewrule"][$value1])){
		continue;
		}
		}
		*/

		####################
		$vgtabid_ = $linklevel["tabid"];
		if($gfield[$gtabid]["verknparams"][$bzm] AND $value1 > 1000){
			$vgtabid_ = $gfield[$gtabid]["verknparams"][$bzm];
		}
		#####################
		
		# no field permission
		if(!$gfield[$vgtabid_]["sort"][$value1]){
			unset($filter["ext_RelationFields"][$vuniqueid][$key1]);
			save_viewSettings($vuniqueid);
			continue;
		}

		if($gfield[$vgtabid_]["field_type"][$value1] == 5){
            $align = "text-align:right;padding-right:30px";
        }else{
            $align = "text-align:left";
        }

		# width
		if($filter["ext_RelationFields"]["width"][$vuniqueid] AND !$resizable){
			if($filter["ext_RelationFields"]["width"][$vuniqueid][$value1]){
				$width = $filter["ext_RelationFields"]["width"][$vuniqueid][$value1];
			}else{
				$width = $gfield[$vgtabid_]["rowsize"][$value1];
			}
		}
				
		$onclick = "style=\"cursor:auto;\"";
		if(!$filter["ext_RelationFields"]["no_sort"][$vuniqueid] AND $gfield[$vgtabid_]["field_type"][$value1] != 3 AND $gfield[$vgtabid_]["data_type"][$value1] != 31 AND $gfield[$vgtabid_]["data_type"][$value1] != 32 AND $gfield[$vgtabid_]["field_type"][$value1] != 6 AND $gfield[$vgtabid_]["field_type"][$value1] != 11){
			$onclick = "OnClick=\"LmExt_RelationFields(this,'$gtabid','$bzm','','$typ','$ID',$value1,'','','','$gformid','$formid');\"";
		}

        $sorticon = 'lmb-caret-down';
		if($filter["ext_RelationFields"]["order"][$vuniqueid][0][1] == $value1 && "ASC" == $filter["ext_RelationFields"]["order"][$vuniqueid][0][2]){
            $sorticon = 'lmb-textsort-down';
		}else if($filter["ext_RelationFields"]["order"][$vuniqueid][0][1] == $value1 && "DESC" == $filter["ext_RelationFields"]["order"][$vuniqueid][0][2]){
            $sorticon = 'lmb-textsort-up';
		}
		
		echo "
			<th nowrap align=\"$align\" class=\"gtabHeaderTitleTD\" valign=\"top\" style=\"cursor:auto;width:".$width."\">
			<div style=\"position:relative;\">
			<div class=\"gtabHeaderTitleTDItem\" style=\"width:100%;$align;$cursor\">".$gfield[$vgtabid_]["spelling"][$value1]."</div>
            <span style=\"position:absolute; padding:0px; margin:0px; right:0px; top:0px; border-left: 1px solid {$farbschema['WEB1']};\">
                <i class=\"lmb-icon $sorticon\" STYLE=\"cursor:pointer;\" onclick=\"lmbSetColSetting(this,'$gtabid','$bzm','$ID','$value1','$gformid','$formid')\"></i>
            </span>
			</div>
			
			</th>";
		$bzmrk++;
	}
	echo "</TR>";
	
	echo "</thead><tbody>";

    if($filter["ext_RelationFields"]["edit"][$vuniqueid] AND $typ == 1){
		$editmode = 1;
	}

	#----------------------- Field resultlist -----------------------
	#$key = 0;
	#while($key < $vgresult[$vgtabid]["res_viewcount"]) {

    // destination formid
    if($filter["ext_RelationFields"]["formid"][$vuniqueid]){
        $dest_formid = $filter["ext_RelationFields"]["formid"][$vuniqueid];
    }elseif(!$dest_formid){
        $dest_formid = $gtab["tab_view_form"][$vgtabid];
    }

    # check for form dimension
    if($filter['ext_RelationFields']['formsize'][$vuniqueid]){
        $dimsn = $filter['ext_RelationFields']['formsize'][$vuniqueid];
    }elseif($dest_formid){
        $dimsn = $gformlist[$vgtabid]["dimension"][$dest_formid];
    }else{
        $dimsn = $gformlist[$vgtabid]["dimension"][$gtab["tab_view_form"][$vgtabid]];
    }

	if($vgresult[$vgtabid]["id"]){
	foreach($vgresult[$vgtabid]["id"] as $key => $VID) {

		# Data ID
		#$VID = $vgresult[$vgtabid]["id"][$key];

		$BGCOLOR = "";
		# row-color from user
		if($vgresult[$vgtabid]["color"][$key]){
			$BGCOLOR = $vgresult[$vgtabid]["color"][$key];
		}

		if($filter["ext_RelationFields"]["indicator"][$vuniqueid]) {

            # row-color from indicator
            if (is_array($vgresult[$vgtabid]["indicator"]["color"][$key])) {
                $BGCOLOR = average_color($vgresult[$vgtabid]["indicator"]["color"][$key]);
            }

            # row-title from indicator
            $title = "";
            if ($vgresult[$vgtabid]["indicator"]["title"][$key]) {
                $title = implode(", ", $vgresult[$vgtabid]["indicator"]["title"][$key]);
            }

            # class from indicator
            $indicatorClass = '';
            if ($vgresult[$vgtabid]['indicator']['class'][$key]) {
                $indicatorClass = $vgresult[$vgtabid]['indicator']['class'][$key];
            }

            # attribute from indicator
            $indicatorAttribute = '';
            if ($vgresult[$vgtabid]['indicator']['attribute'][$key]) {
                $indicatorAttribute = $vgresult[$vgtabid]['indicator']['attribute'][$key];
            }

            # form_id from indicator
            if ($vgresult[$vgtabid]['indicator']['form_id'][$key]) {
                $dest_formid = $vgresult[$vgtabid]['indicator']['form_id'][$key];
            }
        }

        if($BGCLASS == 'gtabBodyTRColorB'){$BGCLASS = 'gtabBodyTRColorA';}else{$BGCLASS = 'gtabBodyTRColorB';}
		echo "<tr id=\"elrow_".$VID."_".$vgtabid."_".$bzm."_".$vgresult[$vgtabid]["verkn_keyid"][$key]."\" data-keyid=\"".$vgresult[$vgtabid]["verkn_keyid"][$key]."\" data-id=\"$VID\" title=\"".$title."\"  class=\"gtabBodyTR $BGCLASS $indicatorClass\" $indicatorAttribute style=\"background-color:$BGCOLOR;\" lmbbgcolor=\"$BGCOLOR\" onclick=\"lmbTableClickEvent(event,this)\" ";

        # Contextmenu
        if($GLOBALS['gcustmenu'][$vgtabid][20]['id'][0]) {
            echo "oncontextmenu=\"lmbRelationContextMenu(event,this,$VID,$vgtabid)\" ";
        }

        # Explorer Zusatz
		if($gtab["typ"][$gfield[$gtabid]["verkntabid"][$bzm]] == 3){
			echo "ondblclick=\"open('main.php?action=explorer_detail&ID=".$VID."','filedetails','toolbar=0,location=0,status=0,menubar=0,scrollbars=1,resizable=1,width=700,height=650')\"";
		# Messages
        // todo
		# Default
		}else{
		    if($filter["ext_RelationFields"]["ondblclick"][$vuniqueid]) {
                echo "ondblclick=\"".$filter["ext_RelationFields"]["ondblclick"][$vuniqueid]."\"";
            }elseif($vgtabid != $gfield[$gtabid]["verkntabid"][$bzm]){
				#echo "ondblclick=\"newwin7(document.form1.action.value,'".$vgtabid."','','','','".$VID."','$dest_formid','$dimsn','$formid','".$filter["ext_RelationFields"]["show_inframe"][$vuniqueid]."','".$filter["ext_RelationFields"]["show_relationpath"][$vuniqueid]."')\"";
			    echo "ondblclick=\"lmbOpenForm(event,'$vgtabid','$VID',{formid:'$dest_formid',action:document.form1.action.value,formdimension:'$dimsn',inframe:'{$filter["ext_RelationFields"]["show_inframe"][$vuniqueid]}',v_formid:'$formid',show_relationpath:'{$filter["ext_RelationFields"]["show_relationpath"][$vuniqueid]}'});\"";
            }else{
				#echo "ondblclick=\"newwin7(document.form1.action.value,'".$gfield[$gtabid]["verkntabid"][$bzm]."','".$gtabid."','".$bzm."','".$ID."','".$VID."','$dest_formid','$dimsn','$formid','".$filter["ext_RelationFields"]["show_inframe"][$vuniqueid]."','".$filter["ext_RelationFields"]["show_relationpath"][$vuniqueid]."')\"";
                echo "ondblclick=\"lmbOpenForm(event,'{$gfield[$gtabid]["verkntabid"][$bzm]}','$VID',{v_tabid:'$gtabid',v_fieldid:'$bzm',v_id:'$ID',formid:'$dest_formid',action:document.form1.action.value,formdimension:'$dimsn',inframe:'{$filter["ext_RelationFields"]["show_inframe"][$vuniqueid]}',v_formid:'$formid',show_relationpath:'{$filter["ext_RelationFields"]["show_relationpath"][$vuniqueid]}'});\"";
			}
		}

        if($BGCOLOR) {
            echo " onmouseover=\"this.style.backgroundColor='" . $farbschema["WEB7"] . "'\" onmouseout=\"this.style.backgroundColor='$BGCOLOR'\" ";
        }

		echo ">";

		if($typ == 1){
            if(!$filter["ext_RelationFields"]["no_sort"][$vuniqueid] AND $gfield[$gtabid]["data_type"][$bzm]){
                echo "<td class=\"element-cell gtabBodyTD\" data-fieldid=\"0\"  valign=\"bottom\" align=\"center\" style=\"width:50px;\" nowrap>";
                    if($isrelation AND $gfield[$gtabid]['data_type'][$bzm] != 25){
                        echo "&nbsp;&nbsp;<i class=\"lmb-icon lmb-caret-down-alt2\" style=\"cursor:pointer;\" TITLE=\"".$lang[862]."\" OnClick=\"LmExt_RelationFields(this,'$gtabid','$bzm','','$typ','$ID','','$VID','sortdown','','$gformid','$formid')\"></i>
                    <i class=\"lmb-icon lmb-caret-up-alt\" style=\"cursor:pointer;\" TITLE=\"".$lang[861]."\" OnClick=\"LmExt_RelationFields(this,'$gtabid','$bzm','','$typ','$ID','','$VID','sortup','','$gformid','$formid')\"></i>&nbsp;";
                    }
                echo "</td>";
            }
		}

		/*----------------- show indicator object in first cell -------------------*/
		if($filter["ext_RelationFields"]["indicator"][$vuniqueid] AND $vgresult[$vgtabid]["indicator"]["object"][$key]){
		    echo "<td class=\"element-cell gtabBodyTD\" data-fieldid=\"0\"  valign=\"bottom\" align=\"center\" nowrap>";
			foreach ($vgresult[$vgtabid]["indicator"]["object"][$key] as $ikey => $ival){
				echo "<span style=\"padding-left:2px;padding-right:2px;\">$ival</span>\n";
			}
			echo "</td>";
		}

		if($filter["ext_RelationFields"][$vuniqueid]){
			foreach ($filter["ext_RelationFields"][$vuniqueid] as $key1 => $value1){

			    if($gfield[$vgtabid_]['field_type'][$value1] >= 100){continue;}
                if($gfield[$vgtabid_]["col_hide"][$value1]){continue;}

				########## use params ##########
				$vgtabid_ = $linklevel["tabid"];
				if($gfield[$gtabid]["verknparams"][$bzm] AND $value1 > 1000){
					$vgtabid_ = $gfield[$gtabid]["verknparams"][$bzm];
				}
				#####################

			    // default readonly
				$edittyp = 2;

				# editmode
				if($editmode){

				    // writable
				    $edittyp = 1;

				    // no writable for n:m realtions exept relation params
                    if($gfield[$gtabid]["data_type"][$bzm] == 24 AND $value1 < 1000 AND !$filter['ext_RelationFields']['editnm'][$vuniqueid]){
                        $edittyp = 2;
                    }

					# specific field setting from extension (ext_RelationFields)
					if($filter['ext_RelationFields']['readonly'][$vuniqueid] AND in_array($value1,$filter['ext_RelationFields']['readonly'][$vuniqueid])){
                        $edittyp = 2;
					}

					# editmode
					if($edittyp == 1){
						# ----------- Edit field permission -----------
						if(!$gfield[$vgtabid_]["perm_edit"][$value1]){$edittyp = 2;}
						# ----------- Editrule -----------
						if($gfield[$vgtabid_]["editrule"][$value1]){
							if(check_GtabRules($ID,$vgtabid_,$value1,$gfield[$vgtabid_]["editrule"][$value1])){$edittyp = 2;}
						}
						if($gfield[$vgtabid_]["argument_typ"][$value1] == 47){$edittyp = 2;}
					}
				}

				# text align
				if($gfield[$vgtabid_]["field_type"][$value1] == 5){$align = "right";}else{$align = "left";}

				# width
				if($filter["ext_RelationFields"]["width"][$vuniqueid] AND !$resizable){
					if($filter["ext_RelationFields"]["width"][$vuniqueid][$value1]){
						$width = $filter["ext_RelationFields"]["width"][$vuniqueid][$value1];
					}else{
						$width = $gfield[$vgtabid_]["rowsize"][$value1];
					}
				}

                // custmenu
                $custmenu = '';
                if($GLOBALS['gcustmenu'][$vgtabid_][20][$value1]){          # filedbased
                    $custmenu = $GLOBALS['gcustmenu'][$vgtabid_][20][$value1];
                }elseif($GLOBALS['gcustmenu'][$vgtabid_][20][0]){          # tablebased
                    $custmenu = $GLOBALS['gcustmenu'][$vgtabid_][20][0];
                }
				
				# ------------------ Default ---------------------
				$fname = "cftyp_".$gfield[$vgtabid_]["funcid"][$value1];
				/* ------------------ Extension --------------------- */
				if($gfield[$vgtabid_]["ext_type"][$value1]){
					if(function_exists("lmbc_".$gfield[$vgtabid_]["ext_type"][$value1])){
						$fname = "lmbc_".$gfield[$vgtabid_]["ext_type"][$value1];
					}
				}

				#if(!$val){$val == "--";}
				echo "<td class=\"element-cell gtabBodyTD\" data-fieldid=\"$value1\" data-custmenu=\"$custmenu\"  align=\"$align\" style=\"width:$width\">";
				/* ------------------ Typefunction --------------------- */
				$retrn = $fname($key,$value1,$vgtabid_,$edittyp,$vgresult);
				/* ------------------ /Typefunction -------------------- */
				echo "</td>";
				#echo "<DIV STYLE=\"width:100%;height:15;scrollbar:no;border:none;cursor:pointer;overflow:hidden\">".$val."</DIV></TD>\n";
			}
		}
		echo "</tr>";
		#$key++;
	}
	}
	
	if(!$VID){
		echo "<tr class=\"gtabBodyTR\"><td colspan=\"".$bzmrk."\" class=\"gtabBodyTD\" style=\"height:30px;\"><i>&nbsp;".$lang[122]."</i></td></tr>";
	}
	
	echo "</tbody><tfoot>";
	
	if($filter["ext_RelationFields"]["edit"][$vuniqueid] AND !$filter["ext_RelationFields"]["no_new"][$vuniqueid] AND $typ == 1){
		echo "<tr class=\"gtabBodyTR\">
		<td style=\"height:100%\" colspan=\"".$bzmrk."\" valign=\"top\">&nbsp;<i class=\"lmb-icon lmb-page-new\" title=\"$lang[1299]\" style=\"cursor:pointer\" height=\"12\" width=\"12\" onclick=\"LmExt_RelationFields(this,'$gtabid','$bzm','','$typ','$ID','reset','$VID','create','','$gformid','$formid',1)\"></i></td>
		</tr>";
	}else{
		echo "<tr class=\"gtabBodyTR\"><td style=\"height:100%\" colspan=\"".$bzmrk."\"></td></tr>";
	}
	
	echo "</tfoot></table>";


	if($filter["ext_RelationFields"]["pagination"][$vuniqueid]) {
        echo "<div id=\"extRelationFooterSource_".$gtabid."_".$bzm."\" >";
        if(!$filter["ext_RelationFields"]["showall"][$vuniqueid]) {
            dftyp_14_footer($vgresult[$vgtabid], $gtabid, $bzm, $ID, $gformid, $formid, $vuniqueid);
        }
        echo "</div>";
        echo "<Script language=\"JavaScript\">
        $(function() {
            $(\"#extRelationFooter_".$gtabid."_".$bzm."\").attr(\"id\",\"extRelationFooter_".$gtabid."_".$bzm."\").replaceWith($(\"#extRelationFooterSource_".$gtabid."_".$bzm."\"));
            $(\"#extRelationFooterSource_".$gtabid."_".$bzm."\").attr(\"id\",\"extRelationFooter_".$gtabid."_".$bzm."\");
        });
        </Script>
        ";
	}

	/*
	#if($filter["ext_RelationFields"]["pagination"][$vuniqueid] AND $vgresult[$vgtabid]["res_count"] > $filter["ext_RelationFields"]['maxresult'][$vuniqueid]) {
	if($filter["ext_RelationFields"]["pagination"][$vuniqueid]) {

        echo "<div id=\"GtabTableFooter\"><br>";
        dftyp_14_footer($vgresult[$vgtabid],$gtabid,$bzm,$ID,$gformid,$formid,$vuniqueid);
        echo "</div>";
	}
	*/

	if($VID AND $resizable){echo "<Script language='JavaScript'>$(function(){lmb_initTable('".$gtabid."_".$bzm."')});</Script>";}else{
	echo "<Script language='JavaScript'>
	var id = 'extRelationTab_".$gtabid."_".$bzm."';
	$('#'+id+'head').remove();
	</Script>";
	}

}



