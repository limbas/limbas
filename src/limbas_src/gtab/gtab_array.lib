<?php
/**
 * @copyright Limbas GmbH <https://limbas.com>
 * @license https://opensource.org/licenses/GPL-2.0 GPL-2.0
 *
 * This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 */

use Limbas\lib\auth\Session;

#if(!$job){require_once("extra/snapshot/snapshot.lib");}
require_once(COREPATH . 'extra/snapshot/snapshot.lib');

unset($gtab);
unset($gfield);
unset($gverkn);
unset($gsnap);
unset($tabgroup);

foreach (Session::$globvars as $globvar) {
    global $$globvar;
}

//global $gfields;
$GLOBALS["gtab"] = $gtab;

/* --- Tabellengruppen ----------------------------------------------- */
$sqlquery = "SELECT DISTINCT LMB_CONF_GROUPS.ID,LMB_CONF_GROUPS.ICON,LMB_CONF_GROUPS.LEVEL,LMB_CONF_GROUPS.NAME,LMB_CONF_GROUPS.BESCHREIBUNG,LMB_CONF_GROUPS.SORT FROM LMB_CONF_GROUPS,LMB_RULES_TABLES WHERE LMB_CONF_GROUPS.ID = LMB_RULES_TABLES.TAB_GROUP AND LMB_RULES_TABLES.LMVIEW = ".LMB_DBDEF_TRUE." AND (LMB_RULES_TABLES.GROUP_ID = ".implode(" OR LMB_RULES_TABLES.GROUP_ID = ",$session['subgroup']).") ORDER BY LMB_CONF_GROUPS.SORT";
$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
#$bzm = 0;
while(lmbdb_fetch_row($rs)) {
	$i = lmbdb_result($rs, "ID");
	$tabgroup["id"][$i] = lmbdb_result($rs, "ID");
	$tabgroup["name"][$i] = $lang[lmbdb_result($rs,"NAME")];
	$tabgroup["beschreibung"][$i] = $lang[lmbdb_result($rs,"BESCHREIBUNG")];
	$tabgroup["level"][$i] = lmbdb_result($rs,"LEVEL");
	$tabgroup["icon"][$i] = lmbdb_result($rs,"ICON");
	$tabgroup["name_lid"][$i] = lmbdb_result($rs,"NAME");
	$tabgroup["beschreibung_lid"][$i] = lmbdb_result($rs,"BESCHREIBUNG");
	#$tabgroup["argid"][lmbdb_result($rs, "ID")] = $i;
	#$bzm++;
}




/* --- Table-Conf ------------------------------- */
$sqlquery = "SELECT DISTINCT
LMB_RULES_TABLES.ORDERBY AS GROUP_ORDERBY,LMB_RULES_TABLES.COPY,LMB_RULES_TABLES.INDICATOR,LMB_RULES_TABLES.SPECIFICPRIVILEGE,LMB_RULES_TABLES.HIRAPRIVILEGE,LMB_RULES_TABLES.USERRULES AS EDIT_USERRULES,LMB_RULES_TABLES.USERPRIVILEGE AS EDIT_OWNUSERRULES,LMB_RULES_TABLES.VER,LMB_RULES_TABLES.LMLOCK,LMB_RULES_TABLES.LMTRIGGER AS RULE_TRIGGER, LMB_RULES_TABLES.GLOBALFILTER AS RULE_GLOBALFILTER,LMB_RULES_TABLES.VER,LMB_RULES_TABLES.VIEWVER,LMB_RULES_TABLES.EDITVER,LMB_RULES_TABLES.DELVER,
LMB_RULES_TABLES.GROUP_ID,LMB_RULES_TABLES.LMADD,LMB_RULES_TABLES.HIDE,LMB_RULES_TABLES.TRASH,LMB_RULES_TABLES.NEED,LMB_RULES_TABLES.EDIT,LMB_RULES_TABLES.DEL,LMB_RULES_TABLES.VIEW_PERIOD,LMB_RULES_TABLES.VIEW_FORM,LMB_RULES_TABLES.VIEW_TFORM,LMB_RULES_TABLES.VIEW_LFORM,LMB_RULES_TABLES.EDITRULE,LMB_RULES_TABLES.HIDEMENU,
LMB_CONF_TABLES.CHECKBOXSELECT,LMB_CONF_TABLES.CHECKSUM,LMB_CONF_TABLES.CUSTMENU,LMB_CONF_TABLES.RECURSIV_DELETE,LMB_CONF_TABLES.RECURSIV_ARCHIVE,LMB_CONF_TABLES.VALIDATE,LMB_CONF_TABLES.ORDERBY,LMB_CONF_TABLES.VALIDITY,LMB_CONF_TABLES.THEME,LMB_CONF_TABLES.MULTITENANT,LMB_CONF_TABLES.DATASYNC,LMB_CONF_TABLES.PARAMS2,LMB_CONF_TABLES.PARAMS1,LMB_CONF_TABLES.USEVIEWPARAMS,LMB_CONF_TABLES.KEYFIELD,LMB_CONF_TABLES.EVENT,LMB_CONF_TABLES.RESERVEID,LMB_CONF_TABLES.NUMROWCALC,LMB_CONF_TABLES.AJAXPOST,LMB_CONF_TABLES.INDICATOR AS GROUPINDICATOR,LMB_CONF_TABLES.LMTRIGGER, LMB_CONF_TABLES.GLOBALFILTER ,LMB_CONF_TABLES.USERRULES AS HAS_USERRULES,LMB_CONF_TABLES.VERSIONING,LMB_CONF_TABLES.TYP,LMB_CONF_TABLES.LOGGING,LMB_CONF_TABLES.LINECOLOR,LMB_CONF_TABLES.MARKCOLOR,LMB_CONF_TABLES.VERKN,LMB_CONF_TABLES.TABELLE,LMB_CONF_TABLES.GROUPABLE,LMB_CONF_TABLES.LOCKABLE,LMB_CONF_TABLES.TAB_ID,LMB_CONF_TABLES.TAB_GROUP,LMB_CONF_TABLES.BESCHREIBUNG,LMB_CONF_TABLES.SORT,LMB_CONF_TABLES.LEVEL,LMB_CONF_TABLES.DETAILFORM_OPENER,LMB_CONF_TABLES.DETAILFORM,DETAILFORM_VIEWMODE,
CASE LMB_RULES_TABLES.GROUP_ID WHEN ".$session["group_id"]." THEN 2 ELSE 1 END AS GROUP_SORT,
REPORT_RESOLVE_CACHE
FROM LMB_CONF_TABLES,LMB_RULES_TABLES
WHERE LMB_RULES_TABLES.TAB_ID = LMB_CONF_TABLES.TAB_ID
AND LMB_RULES_TABLES.LMVIEW = ".LMB_DBDEF_TRUE."
AND (LMB_RULES_TABLES.GROUP_ID = ".implode(" OR LMB_RULES_TABLES.GROUP_ID = ",$session["subgroup"]).")
ORDER BY GROUP_SORT,LMB_CONF_TABLES.TAB_GROUP,LMB_CONF_TABLES.SORT";
$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);

$bzm1 = 1;
$bzm2 = 0;
while(lmbdb_fetch_row($rs)) {
	$i = lmbdb_result($rs,"TAB_ID");
	$gtab["tab_id"][$i] = $i;
	$gtab["table"][$i] = lmb_strtoupper(lmbdb_result($rs,"TABELLE"));
	if($lang[lmbdb_result($rs,"BESCHREIBUNG")]){$gtab["desc"][$i] = $lang[lmbdb_result($rs,"BESCHREIBUNG")];}else{$gtab["desc"][$i] = $gtab["table"][$i];}
	if(defined('IS_SOAP')){$gtab["desc_lid"][$i] = lmbdb_result($rs,"BESCHREIBUNG");}
	$gtab["tab_group"][$i] = lmbdb_result($rs,"TAB_GROUP");
	$gtab["tab_view_form"][$i] = lmbdb_result($rs,"VIEW_FORM");
	$gtab["tab_view_tform"][$i] = lmbdb_result($rs,"VIEW_TFORM");
	$gtab["tab_view_lform"][$i] = lmbdb_result($rs,"VIEW_LFORM");
	$gtab["lockable"][$i] = lmbdb_result($rs,"LOCKABLE");
	$gtab["groupable"][$i] = lmbdb_result($rs,"GROUPABLE");
	$gtab["markcolor"][$i] = lmbdb_result($rs, "MARKCOLOR");
	$gtab["linecolor"][$i] = lmbdb_result($rs, "LINECOLOR");
	$gtab["logging"][$i] = lmbdb_result($rs, "LOGGING");
	$gtab["verkn"][$i] = lmbdb_result($rs, "VERKN");
	$gtab["typ"][$i] = lmbdb_result($rs, "TYP");
	$gtab["ajaxpost"][$i] = lmbdb_result($rs, "AJAXPOST");
	$gtab["versioning"][$i] = lmbdb_result($rs, "VERSIONING");
	$gtab["numrowcalc"][$i] = lmbdb_result($rs, "NUMROWCALC");
	$gtab["reserveid"][$i] = lmbdb_result($rs, "RESERVEID");
	$gtab["keyfield"][$i] = lmbdb_result($rs, "KEYFIELD");
	$gtab["datasync"][$i] = lmbdb_result($rs, "DATASYNC");
	$gtab["validity"][$i] = lmbdb_result($rs, "VALIDITY");
    $gtab['theme'][$i] = true;
	if(!$gtab["verkn"][$i]){$gtab["verkn"][$i] = $i;}
	if(lmbdb_result($rs, "GROUP_ORDERBY")){$orderby = lmbdb_result($rs, "GROUP_ORDERBY");}
	elseif(lmbdb_result($rs, "ORDERBY")){$orderby = lmbdb_result($rs, "ORDERBY");}
	if(lmbdb_result($rs, "MULTITENANT")){$gtab["multitenant"][$i] = lmbdb_result($rs, "multitenant");}
	if(lmbdb_result($rs, "PARAMS1")){$gtab["params1"][$i] = lmbdb_result($rs, "PARAMS1");}
	if($params2 = lmbdb_result($rs, "PARAMS2")){$gtab["params2"][$i] = unserialize($params2);}
	if(lmbdb_result($rs, "GROUP_SORT") == 2){$maingroup = 1;}else{$maingroup = 0;}
	if($event = lmbdb_result($rs, "EVENT")){$gtab["event"][$i] = $event;}
    if(lmbdb_result($rs, "USEVIEWPARAMS")){$gtab["useviewparams"][$i] = lmbdb_result($rs, "USEVIEWPARAMS");}
	if(lmbdb_result($rs, "EDITRULE")){$gtab["editrule"][$i] = lmbdb_result($rs, "EDITRULE");}
	if(lmbdb_result($rs, "HAS_USERRULES")){$gtab["has_userrules"][$i] = lmbdb_result($rs, "HAS_USERRULES");}
	if(lmbdb_result($rs, "EDIT_USERRULES")){$gtab["edit_userrules"][$i] = lmbdb_result($rs, "EDIT_USERRULES");}
	if(lmbdb_result($rs, "EDIT_OWNUSERRULES")){$gtab["edit_ownuserrules"][$i] = lmbdb_result($rs, "EDIT_OWNUSERRULES");}
	if(lmbdb_result($rs, "HIRAPRIVILEGE")){$gtab["subedit_userrules"][$i] = lmbdb_result($rs, "HIRAPRIVILEGE");}
	if(lmbdb_result($rs, "VALIDATE")){$gtab["validate"][$i] = lmbdb_result($rs, "VALIDATE");}
    if(lmbdb_result($rs, "RECURSIV_DELETE")){$gtab["recursiv_delete"][$i] = lmbdb_result($rs, "RECURSIV_DELETE");}
    if(lmbdb_result($rs, "RECURSIV_ARCHIVE")){$gtab["recursiv_archive"][$i] = lmbdb_result($rs, "RECURSIV_ARCHIVE");}
    if(lmbdb_result($rs, "CUSTMENU")){$gtab["custmenu"][$i] = lmbdb_result($rs, "CUSTMENU");}
    if(lmbdb_result($rs, "LEVEL")){$gtab["level"][$i] = lmbdb_result($rs, "LEVEL");}
    if(lmbdb_result($rs, "CHECKSUM")){$gtab["checksum"][$i] = lmbdb_result($rs, "CHECKSUM");}
    if(lmbdb_result($rs, "CHECKBOXSELECT")){$gtab["checkboxselect"][$i] = lmbdb_result($rs, "CHECKBOXSELECT");}
    if(lmbdb_result($rs, "DETAILFORM")){$gtab["detailform"][$i] = lmbdb_result($rs, "DETAILFORM");}

    $gtab["detailform_opener"][$i] = $umgvar['detail_openas'];
    if(lmbdb_result($rs, "DETAILFORM_OPENER")){
        $formopenas[1] = 'same'; $formopenas[2] = 'modal';  $formopenas[3] = 'tab'; $formopenas[4] = 'window';
        $gtab["detailform_opener"][$i] = $formopenas[lmbdb_result($rs, "DETAILFORM_OPENER")];
    }

    if(lmbdb_result($rs, "DETAILFORM_VIEWMODE") != 2 && ($umgvar['detail_viewmode'] == 'viewmode' OR lmbdb_result($rs, "DETAILFORM_VIEWMODE") == 1)){
        $gtab["detailform_viewmode"][$i] = 1;
    }

	if(lmbdb_result($rs, "SPECIFICPRIVILEGE")){
		if($gtab["specific_userrules"][$i]){
			$gtab["specific_userrules"][$i] = array_unique(array_merge($gtab["specific_userrules"][$i],explode(",",lmbdb_result($rs, "SPECIFICPRIVILEGE"))));
		}else{
			$gtab["specific_userrules"][$i] = explode(",",lmbdb_result($rs, "SPECIFICPRIVILEGE"));
		}
	}

    // trigger
	if($gtab["trigger"][$i]){$trgger = $gtab["trigger"][$i];}else{$trgger = array();}
	if(lmbdb_result($rs, "LMTRIGGER") OR lmbdb_result($rs, "RULE_TRIGGER")){
        $gtab["trigger"][$i] = array_filter(array_unique(array_merge(explode(",",lmbdb_result($rs, "LMTRIGGER")),explode(",",lmbdb_result($rs, "RULE_TRIGGER")),$trgger)));
    }

    // global filter
	if($gtab["globalfilter"][$i]){$glfilter = $gtab["globalfilter"][$i];}else{$glfilter = array();}
	if(lmbdb_result($rs, "GLOBALFILTER") OR lmbdb_result($rs, "RULE_GLOBALFILTER")){
        $gtab["globalfilter"][$i] = array_filter(array_unique(array_merge(explode(",",lmbdb_result($rs, "GLOBALFILTER")),explode(",",lmbdb_result($rs, "RULE_GLOBALFILTER")),$trgger)));
    }


    // order by
    if($orderby){
        $orderby = explode(',',$orderby);
        foreach($orderby as $okey => $orderval){
            $orderval = trim($orderval);
            if($p = stripos($orderval,' ASC')) {
                $order_d = 'ASC';
                $order_f = strtoupper(substr($orderval,0,$p));
            }elseif($p = stripos($orderval,' DESC')){
                $order_d = 'DESC';
                $order_f = strtoupper(substr($orderval,0,$p));
            }else{
                $order_d = 'ASC';
                $order_f = strtoupper($orderval);
            }
            $gtab['orderby'][$i][] = array(trim($order_f),$order_d);
        }
        $orderby = null;
    }

    ##### 1:1 Verknüpfungen #####
	# alle 1:1 Verknüpfungen mit Rechten ohne Sortierung
	$gtab["rverkn"][$gtab["verkn"][$i]][$i] = $i;

	if(!$alrdone[$i]){
		# alle 1:1 Verknüpfungen ohne Rechte mit Haupttabelle als erstes Element
		$sqlquery1 = "SELECT TAB_ID,TABELLE,VERSIONING FROM LMB_CONF_TABLES WHERE VERKN = ".$i." ORDER BY TAB_ID";
		$rs1 = lmbdb_exec($db,$sqlquery1) or errorhandle(lmbdb_errormsg($db),$sqlquery1,$action,__FILE__,__LINE__);
		while(lmbdb_fetch_row($rs1)) {
		    $_tabid = lmbdb_result($rs1, "TAB_ID");
		    // main table
		    if($i == $_tabid) {
                $main_tab = $_tabid;
            // child tables
		    }else{
		        $gtab["raverkn"][$gtab["verkn"][$i]][$_tabid] = $_tabid;
            }
            // Zusatzeinträge falls keine Rechte
			$gtab["table"][$_tabid] = lmb_strtoupper(lmbdb_result($rs1,"TABELLE"));
			$gtab["versioning"][$_tabid] = lmbdb_result($rs1, "VERSIONING");

            // set versioning always recursiv if validity is versioned FIX
            if($gtab['versioning'][$_tabid] AND $gtab["validity"][$_tabid] == 2) {
                $gtab['versioning'][$_tabid] = 1;
            }

			$alrdone[$_tabid] = 1;
		}
        // add main table
		$gtab["raverkn"][$gtab["verkn"][$i]][$main_tab] = $main_tab;
		// main table as first array element
		$gtab["raverkn"][$gtab["verkn"][$i]] = array_reverse($gtab["raverkn"][$gtab["verkn"][$i]],TRUE);
	}

	$gtab["argresult_id"][lmb_strtoupper(lmbdb_result($rs,"TABELLE"))] = lmbdb_result($rs,"TAB_ID");
	if(lmbdb_result($rs,"DEL") == 1){$gtab["delete"][$i] = 1;}
	if(lmbdb_result($rs,"EDIT") == 1){$gtab["edit"][$i] = 1;}
	if(lmbdb_result($rs,"HIDE") == 1){$gtab["hide"][$i] = 1;}
    if(lmbdb_result($rs,"TRASH") == 1){$gtab["trash"][$i] = 1;}
	if(lmbdb_result($rs,"COPY") == 1){$gtab["copy"][$i] = 1;}
	if(lmbdb_result($rs,"LMADD") == 1){$gtab["add"][$i] = 1;}
	$gtab["need"][$i] = lmbdb_result($rs,"NEED");
	if(lmbdb_result($rs,"VER") AND $gtab["versioning"][$i]){$gtab["ver"][$i] = lmbdb_result($rs,"VER");}
	if(lmbdb_result($rs,"VIEWVER") AND $gtab["versioning"][$i]){$gtab["viewver"][$i] = lmbdb_result($rs,"VIEWVER");}
	if(lmbdb_result($rs,"EDITVER") AND $gtab["versioning"][$i]){$gtab["editver"][$i] = lmbdb_result($rs,"EDITVER");}
	if(lmbdb_result($rs,"DELVER") AND $gtab["versioning"][$i]){$gtab["delver"][$i] = lmbdb_result($rs,"DELVER");}
	if(lmbdb_result($rs,"LMLOCK")){$gtab["lock"][$i] = lmbdb_result($rs,"LMLOCK");}
	$gtab["hidemenu"][$i] = lmbdb_result($rs,"HIDEMENU");

	#----------------- indicator -------------------
	if(lmbdb_result($rs, "GROUPINDICATOR")){$gtab["indicator"][$i] = lmbdb_result($rs, "GROUPINDICATOR");}
	elseif(lmbdb_result($rs, "INDICATOR")){$gtab["indicator"][$i] = lmbdb_result($rs, "INDICATOR");}
	
	# table is view
	if($gtab["typ"][$i] == 5){
		$gtab["lockable"][$i] = null;
		$gtab["linecolor"][$i] = null;
		$gtab["logging"][$i] = null;
		$gtab["versioning"][$i] = null;
		$gtab["delete"][$i] = null;
		$gtab["edit"][$i] = null;
		$gtab["hide"][$i] = null;
        $gtab["trash"][$i] = null;
		$gtab["add"][$i] = null;
		$gtab["lock"][$i] = null;
	}

	# table is param relation // todo - set extra flag in lmb_conf_tables
	if(strtoupper(substr($gtab["table"][$i],0,5)) == 'VERK_'){
		$gtab["versioning"][$i] = null;
		$gtab["delete"][$i] = null;
		$gtab["add"][$i] = null;
		$gtab["lock"][$i] = null;
	}

	#----- File-Level ----------------------------------
	#$sqlquery1 = "SELECT ID FROM LDMS_STRUCTURE WHERE TABGROUP_ID = ".lmbdb_result($rs,"TAB_GROUP")." AND TAB_ID = $i AND FIELD_ID = 0 AND FIX = TRUE";
	#$rs1 = lmbdb_exec($db,$sqlquery1) or errorhandle(lmbdb_errormsg($db),$sqlquery1,$action,__FILE__,__LINE__);
	#if(!$rs1) {$commit = 1;}
	#$gtab['file_level'][$i] = lmbdb_result($rs1,"ID");

	if(!$alrdone[$i]){
		#----------------- Berichts LEVEL -------------------
		$sqlquery1 = "SELECT LEVEL FROM LDMS_STRUCTURE WHERE LDMS_STRUCTURE.TYP = 5 AND LDMS_STRUCTURE.FIX = ".LMB_DBDEF_TRUE." AND TAB_ID = $i";
		$rs1 = lmbdb_exec($db,$sqlquery1) or errorhandle(lmbdb_errormsg($db),$sqlquery1,$action,__FILE__,__LINE__);
		if(!$rs1) {$commit = 1;}
		$gtab["reportlevel"][$i] = lmbdb_result($rs1, "LEVEL");
	}

	$alrdone[$i] = 1;
}


# ------- gfield Funktion aufrufen ------
if($gtab["table"]){
 	# ------- gfield Funktion ------
    $gfield = array();
	foreach($gtab["table"] as $key => $value){
		gfield_array($gtab,$gfield,$key);
		if($gfield[$key]["field_id"]) {
            $gtab["fieldcount"][$key] = lmb_count($gfield[$key]["field_id"]);
        }
	}
}

$_SESSION["gtab"]=$gtab;
$_SESSION["gfield"]=$gfield;
$_SESSION["gverkn"]=$gverkn;
$_SESSION["gsnap"]=$gsnap;
$_SESSION["tabgroup"]=$tabgroup;
$_SESSION["gtabletree"]=$gtabletree;

$GLOBALS["gtab"]=$gtab;
$GLOBALS["gfield"]=$gfield;
$GLOBALS["gverkn"]=$gverkn;
$GLOBALS["gsnap"]=$gsnap;
$GLOBALS["tabgroup"]=$tabgroup;
$GLOBALS["gtabletree"]=$gtabletree;

# ------- gfield Funktion ------
function gfield_array(&$gtab,&$gfield,$gtabid){
	global $umgvar;
	global $session;
	global $db;
	global $gverkn;
	global $lang;
	#global $gtab;
	global $DBA;
    global $lmfieldtype;

	$gfield[$gtabid]["argument"] = array();
	$gfield[$gtabid]["argument_edit"] = array();
	$gfield[$gtabid]["genlink"] = array();
	$gfield[$gtabid]["verkntabid"] = array();
	$gfield[$gtabid]["verknfieldid"] = array();
	$gfield[$gtabid]["dynsearch"] = array();
	$gfield[$gtabid]["artleiste"] = array();
	$gfield[$gtabid]["md5tab"] = array();
	$gfield[$gtabid]["filter"] = array();
	$gfield[$gtabid]["filtertyp"] = array();
	$gfield[$gtabid]["unique"] = array();
	$gfield[$gtabid]["select_sort"] = array();
    $gfield[$gtabid]["select_defaulttype"] = array();
	$gfield[$gtabid]["groupable"] = array();
	$gfield[$gtabid]["indize"] = array();
	$gfield[$gtabid]["indexed"] = array();
	$gfield[$gtabid]["deflt"] = array();
	$gfield[$gtabid]["datetime"] = array();
	$gfield[$gtabid]["wysiwyg"] = array();
	$gfield[$gtabid]['encryption_mode'] = array();
	#$fieldName = array(); ?????
    $tabrse = [];

    // systemfields
	$systemFields = array('ID','ERSTDATUM','EDITDATUM','EDITUSER','ERSTUSER','ERSTGROUP','INUSE_TIME','INUSE_USER','DEL',
        'VID','VACT','VDESC','VPID','LMB_MID','LMB_VALIDFROM','LMB_VALIDTO','LMB_CHECKSUM',
        'LID','IND','INDD','INDT','INDM','INDC','OCR','OCRD','OCRT','OCRS');
    
    # ------- Spaltenbreiten ------
	$sqlquery = "SELECT ROW_SIZE FROM LMB_GTAB_ROWSIZE WHERE TAB_ID = $gtabid AND USER_ID = ".$session["user_id"];
	$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
	if(lmbdb_fetch_row($rs)){
		$trse = explode(";",lmbdb_result($rs,"ROW_SIZE"));
		foreach($trse as $key => $value){
			$rse = explode(",",$trse[$key]);
            if(is_numeric($rse[1]) AND $rse[1] > 0) {
                $tabrse[$gtabid][$rse[0]] = $rse[1];
            }
		}
		$gfield[$gtabid]["rowsize"][0] = $tabrse[$gtabid][0];
	}
	# tool column at first
	if(!$gfield[$gtabid]["rowsize"][0]){
		$gfield[$gtabid]["rowsize"][0] = 30;
	}

	# ------- Spalten-Array ------
	$sqlquery = "SELECT 
                        LMB_CONF_FIELDS.LEVEL,LMB_CONF_FIELDS.CHECKSUM,LMB_CONF_FIELDS.MULTIRELATION,LMB_CONF_FIELDS.FULLSEARCH,LMB_CONF_FIELDS.SEARCHVERSION,LMB_CONF_FIELDS.POPUPDEFAULT,LMB_CONF_FIELDS.INACTIVELINK,LMB_CONF_FIELDS.VERKNTREE,LMB_CONF_FIELDS.LISTING_VIEWMODE,LMB_CONF_FIELDS.LISTING_CUT,LMB_CONF_FIELDS.RELPARAMS,LMB_CONF_FIELDS.VERKNPARAMS,LMB_CONF_FIELDS.SCALE,LMB_CONF_FIELDS.AGGREGATE,LMB_CONF_FIELDS.COLLREPLACE,LMB_CONF_FIELDS.FIELD_SIZE,LMB_CONF_FIELDS.ROW_SIZE,LMB_CONF_FIELDS.COL_HIDE,LMB_CONF_FIELDS.DETAILSEARCH,LMB_CONF_FIELDS.AJAXPOST,LMB_CONF_FIELDS.POTENCY, LMB_CONF_FIELDS.EDITRULE AS GEDITRULE,LMB_CONF_FIELDS.VIEWRULE,LMB_CONF_FIELDS.QUICKSEARCH,LMB_CONF_FIELDS.HASRECVERKN,LMB_CONF_FIELDS.DEFAULTVALUE,LMB_CONF_FIELDS.LMTRIGGER,LMB_CONF_FIELDS.RELEXT,LMB_CONF_FIELDS.MAINFIELD,LMB_CONF_FIELDS.VERKNTABLETYPE,LMB_CONF_FIELDS.EXT_TYPE,LMB_CONF_FIELDS.INHERIT_TAB,LMB_CONF_FIELDS.INHERIT_FIELD,LMB_CONF_FIELDS.INHERIT_SEARCH,LMB_CONF_FIELDS.INHERIT_GROUP,LMB_CONF_FIELDS.INHERIT_EVAL,LMB_CONF_FIELDS.INHERIT_FILTER,LMB_CONF_FIELDS.SELECT_CUT,LMB_CONF_FIELDS.ID,LMB_CONF_FIELDS.SELECT_POOL,LMB_CONF_FIELDS.DATETIME,LMB_CONF_FIELDS.WYSIWYG,LMB_CONF_FIELDS.GROUPABLE,LMB_CONF_FIELDS.CURRENCY,LMB_CONF_FIELDS.NFORMAT,LMB_CONF_FIELDS.INDIZE,LMB_CONF_FIELDS.INDEXED,LMB_CONF_FIELDS.SELECT_SORT,LMB_CONF_FIELDS.SELECT_DEFAULTTYPE,LMB_CONF_FIELDS.MD5TAB,LMB_CONF_FIELDS.FIELD_ID,LMB_CONF_FIELDS.TAB_ID,LMB_CONF_FIELDS.TAB_GROUP,LMB_CONF_FIELDS.SORT,LMB_CONF_FIELDS.DATA_TYPE,LMB_CONF_FIELDS.FIELD_TYPE,LMB_CONF_FIELDS.FIELD_NAME,LMB_CONF_FIELDS.BESCHREIBUNG,LMB_CONF_FIELDS.SPELLING,LMB_CONF_FIELDS.FIELDKEY,LMB_CONF_FIELDS.ISUNIQUE,LMB_CONF_FIELDS.VERKNFIELDID,LMB_CONF_FIELDS.DYNSEARCH,LMB_CONF_FIELDS.VERKNSEARCH,LMB_CONF_FIELDS.VERKNVIEW,LMB_CONF_FIELDS.VERKNFIND,LMB_CONF_FIELDS.ARTLEISTE,LMB_CONF_FIELDS.VERKNTABID,LMB_CONF_FIELDS.GENLINK,LMB_CONF_FIELDS.ARGUMENT,LMB_CONF_FIELDS.ARGUMENT_EDIT,LMB_CONF_FIELDS.ARGUMENT_TYP,LMB_CONF_FIELDS.MULTILANG,LMB_CONF_FIELDS.VERKNGROUP, LMB_CONF_FIELDS.ENCRYPTION_MODE,LMB_CONF_FIELDS.REGEX,
                        LMB_RULES_FIELDS.LMVIEW,LMB_RULES_FIELDS.EXT_TYPE AS GROUPEXT_TYPE,LMB_RULES_FIELDS.VER,LMB_RULES_FIELDS.LMTRIGGER AS RULE_TRIGGER,LMB_RULES_FIELDS.EDITRULE,LMB_RULES_FIELDS.COPY,LMB_RULES_FIELDS.FIELDOPTION,LMB_RULES_FIELDS.DEFLT,LMB_RULES_FIELDS.NEED,LMB_RULES_FIELDS.CURRENCY AS GROUPCURRENCY,LMB_RULES_FIELDS.NFORMAT AS GROUPNFORMAT,LMB_RULES_FIELDS.COLOR AS GROUPCOLOR,LMB_RULES_FIELDS.FILTER AS GROUPFILTER,LMB_RULES_FIELDS.FILTERTYP AS GROUPFILTERTYP,LMB_RULES_FIELDS.EDIT AS GROUPEDIT,LMB_RULES_FIELDS.LISTEDIT,LMB_RULES_FIELDS.SPEECHREC,
                        CASE LMB_RULES_FIELDS.GROUP_ID WHEN ".$session["group_id"]." THEN 2 ELSE 1 END AS GROUP_SORT
                        FROM LMB_CONF_FIELDS,LMB_RULES_FIELDS
                        WHERE LMB_CONF_FIELDS.FIELD_ID = LMB_RULES_FIELDS.FIELD_ID
                        AND LMB_CONF_FIELDS.TAB_ID = ".$gtabid."
                        AND LMB_RULES_FIELDS.TAB_ID = ".$gtabid."
                        AND ((LMB_RULES_FIELDS.GROUP_ID = ".implode(" OR LMB_RULES_FIELDS.GROUP_ID = ",$session["subgroup"]).") AND (LMB_RULES_FIELDS.LMVIEW = ".LMB_DBDEF_TRUE." OR LMB_RULES_FIELDS.EDIT = ".LMB_DBDEF_TRUE." OR LMB_RULES_FIELDS.COPY = ".LMB_DBDEF_TRUE." OR LMB_RULES_FIELDS.FILTER != ''))
                		ORDER BY GROUP_SORT,LMB_CONF_FIELDS.SORT";
	$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
	while(lmbdb_fetch_row($rs)) {
		
		$bzm0 = lmbdb_result($rs,"FIELD_ID");
		$field_ok = 1;
		$field_name = lmbdb_result($rs,"FIELD_NAME");
		$data_type = lmbdb_result($rs,"DATA_TYPE");
		$field_type = lmbdb_result($rs,"FIELD_TYPE");
        $parse_type = $lmfieldtype["parse_type"][lmbdb_result($rs,"DATA_TYPE")];
        #$field_type_name = $lmfieldtype["name"][lmbdb_result($rs,"DATA_TYPE")];
        #$field_type_desc = $lmfieldtype["description"][lmbdb_result($rs,"DATA_TYPE")];
        $field_type_size = $lmfieldtype["size"][lmbdb_result($rs,"DATA_TYPE")];
        $field_type_regex = $lmfieldtype["regex"][lmbdb_result($rs,"DATA_TYPE")];
        $field_type_funcid = $lmfieldtype["funcid"][lmbdb_result($rs,"DATA_TYPE")];

        $gfield[$gtabid]['data_type'][$bzm0] = $data_type;

		#$fieldName[$field_name]=$bzm0; ??????

		// multilang
		$rawfield_name = '';
		if(lmbdb_result($rs,"MULTILANG")){
            $rawfield_name = $field_name;
            if($session['dlanguage'] != $umgvar['default_language'] AND ($data_type != 32 AND $data_type != 31 AND $data_type != 18)){
                $field_name = 'LANG'.$session['dlanguage'].'_'.$field_name;
            }
		}
		
		# predefine long fields
		$lmb_argument = trim(lmbdb_result($rs,"ARGUMENT")); # longtext handle
		$lmb_relext = trim(lmbdb_result($rs,"RELEXT")); # longtext handle
		$lmb_genlink = trim(lmbdb_result($rs,"GENLINK")); # longtext handle

		# Virtuelle Felder :: Sparten-Beschriftung / Gruppierung
		if($parse_type == 100){
			if(lmbdb_result($rs,"LMVIEW")){
				$gfield[$gtabid]["field_id"][$bzm0] = $bzm0;
				$gfield[$gtabid]["key"][$bzm0] = $bzm0;
				$gfield[$gtabid]["field_name"][$bzm0] = lmb_strtoupper($field_name);
				if($lang[lmbdb_result($rs,"SPELLING")]){$gfield[$gtabid]["spelling"][$bzm0] = $lang[lmbdb_result($rs,"SPELLING")];}else{$gfield[$gtabid]["spelling"][$bzm0] = $gfield[$gtabid]["field_name"][$bzm0];}
				if($lang[lmbdb_result($rs,"BESCHREIBUNG")]){$gfield[$gtabid]["beschreibung"][$bzm0] = $lang[lmbdb_result($rs,"BESCHREIBUNG")];}else{$gfield[$gtabid]["beschreibung"][$bzm0] = $gfield[$gtabid]["field_name"][$bzm0];}
				$gfield[$gtabid]["field_type"][$bzm0] = lmbdb_result($rs,"FIELD_TYPE");
				$gfield[$gtabid]["funcid"][$bzm0] = $field_type_funcid ;
				if($lmb_argument){$gfield[$gtabid]["argument"][$bzm0] = $lmb_argument;}
				if($lmb_relext){$gfield[$gtabid]["relext"][$bzm0] = $lmb_relext;}
				if(lmbdb_result($rs,"VIEWRULE")){$gfield[$gtabid]["viewrule"][$bzm0] = lmbdb_result($rs,"VIEWRULE");}
				if(lmbdb_result($rs,"AJAXPOST")){$gfield[$gtabid]["ajaxpost"][$bzm0] = lmbdb_result($rs,"AJAXPOST");}
                $gfield[$gtabid]["sort"][$bzm0] = lmbdb_result($rs,"SORT");
                $gfield[$gtabid]["sys"][$bzm0] = 1;

                /* validity sort
				$sort = lmbdb_result($rs,"SORT");
				if($validity_key){$sort++;} // reserve for lmb_valid_to
				$gfield[$gtabid]["sort"][$bzm0] = $sort;
                */

				# is grouping field
				if($gfield[$gtabid]["field_type"][$bzm0] == 101 AND $gfield[$gtabid]["argument"][$bzm0]){
					$grpel = explode(";",$gfield[$gtabid]["argument"][$bzm0]);
					foreach ($grpel as $ky => $va){
						$gfield[$gtabid]["grouping"][$va] = 1;
					}
				}
			}
			continue;
		}

		#----- LMB_SYNC_SLAVE published field hidden if is Slave ----------------------------------
	    if($field_type == 22 AND $umgvar['sync_mode'] == 1){
		    continue;
        }

		# ------- Verknüpfungsrechte auf Tabellen prüfen  ------
		if(lmbdb_result($rs,"VERKNTABID")){
			if($gtab["tab_id"][lmbdb_result($rs,"VERKNTABID")]){
				$field_ok = 1;
			}else{
				$field_ok = 0;
			}
		}

		if($field_ok){

            // check if is systemfield
            if(in_array($field_name,$systemFields)){
                $gfield[$gtabid]["sys"][$bzm0] = 1;
            }
		
			# handle long fields
			if($data_type == 39 AND LMB_DBFUNC_LONGHANDLE AND !lmbdb_result($rs,"INDIZE")){
				$gfield[$gtabid]["longhandle"][$bzm0] = 1;
			}
			
			$gfield[$gtabid]["form_name"][$bzm0] = "g_".$gtabid."_".lmbdb_result($rs,"FIELD_ID");

			#$gfield[$gtabid]['tab'][$bzm0] = $gtab['table'][$gtabid];
			#$gfield[$gtabid]['tab_id'][$bzm0] = $gtabid;
			#$gfield[$gtabid]['tab_group'][$bzm0] = lmbdb_result($rs,"TAB_GROUP");

			# Sichtrechte
			if(lmbdb_result($rs,"LMVIEW")){
				$gfield[$gtabid]["sort"][$bzm0] = lmbdb_result($rs,"SORT");
				$gfield[$gtabid]["key"][$bzm0] = $bzm0;
			}

			$gfield[$gtabid]["id"][$bzm0] = $bzm0;
			$gfield[$gtabid]["field_id"][$bzm0] = $bzm0;
			$gfield[$gtabid]["field_name"][$bzm0] = lmb_strtoupper($field_name);
			$gfield[$gtabid]["field_type"][$bzm0] = $field_type;
			$gfield[$gtabid]["data_type"][$bzm0] = $data_type;
			$gfield[$gtabid]["funcid"][$bzm0] = $field_type_funcid ;
			$gfield[$gtabid]["parse_type"][$bzm0] = $parse_type;
			#$gfield[$gtabid]["data_type_exp"][$bzm0] = $field_type_name;
			#$gfield[$gtabid]["format"][$bzm0] = $field_type_desc;
			$gfield[$gtabid]["argresult_name"][lmb_strtoupper($field_name)] = $bzm0;

			if(lmbdb_result($rs,"FIELD_SIZE")){
				$gfield[$gtabid]["size"][$bzm0] = lmbdb_result($rs,"FIELD_SIZE");
				if(lmbdb_result($rs,"SCALE")){$gfield[$gtabid]["scale"][$bzm0] = lmbdb_result($rs,"SCALE");}
				$gfield[$gtabid]["regel"][$bzm0] = str_replace("xxx",(lmbdb_result($rs,"FIELD_SIZE")+1),$field_type_regex);
				$gfield[$gtabid]["regel"][$bzm0] = str_replace("xx",lmbdb_result($rs,"FIELD_SIZE"),$gfield[$gtabid]["regel"][$bzm0]);
			}else{
				$gfield[$gtabid]["size"][$bzm0] = $field_type_size;
				$gfield[$gtabid]["regel"][$bzm0] = str_replace("xx","",$field_type_regex);
			}
            if($field_type == 11){
                $gfield[$gtabid]["size"][$bzm0] = 50;
            }

            if(lmbdb_result($rs,"REGEX")){
                $gfield[$gtabid]["regel"][$bzm0] = lmbdb_result($rs,"REGEX");
                $gfield[$gtabid]["regex"][$bzm0] = lmbdb_result($rs,"REGEX");
            }
			
			if($rawfield_name){$gfield[$gtabid]["rawfield_name"][$bzm0] = $rawfield_name;}
			if($lang[lmbdb_result($rs,"SPELLING")]){$gfield[$gtabid]["spelling"][$bzm0] = $lang[lmbdb_result($rs,"SPELLING")];}else{$gfield[$gtabid]["spelling"][$bzm0] = lmbdb_result($rs,"FIELD_NAME");}
			if($lang[lmbdb_result($rs,"BESCHREIBUNG")]){$gfield[$gtabid]["beschreibung"][$bzm0] = $lang[lmbdb_result($rs,"BESCHREIBUNG")];}else{$gfield[$gtabid]["beschreibung"][$bzm0] = lmbdb_result($rs,"FIELD_NAME");}
			
			if(lmbdb_result($rs,"INHERIT_TAB")){$gfield[$gtabid]["inherit_tab"][$bzm0] = lmbdb_result($rs,"INHERIT_TAB");}
			if(lmbdb_result($rs,"INHERIT_FIELD")){$gfield[$gtabid]["inherit_field"][$bzm0] = lmbdb_result($rs,"INHERIT_FIELD");}
			if(lmbdb_result($rs,"INHERIT_SEARCH")){$gfield[$gtabid]["inherit_search"][$bzm0] = lmbdb_result($rs,"INHERIT_SEARCH");}
			if(lmbdb_result($rs,"INHERIT_EVAL")){$gfield[$gtabid]["inherit_eval"][$bzm0] = lmbdb_result($rs,"INHERIT_EVAL");}
			if(lmbdb_result($rs,"INHERIT_GROUP")){$gfield[$gtabid]["inherit_group"][$bzm0] = lmbdb_result($rs,"INHERIT_GROUP");}
			if(lmbdb_result($rs,"INHERIT_FILTER")){$gfield[$gtabid]["inherit_filter"][$bzm0] = lmbdb_result($rs,"INHERIT_FILTER");}
			if($lmb_argument){$gfield[$gtabid]["argument"][$bzm0] = $lmb_argument;}
			if(lmbdb_result($rs,"ARGUMENT_TYP")){$gfield[$gtabid]["argument_typ"][$bzm0] = lmbdb_result($rs,"ARGUMENT_TYP");}
			if(lmbdb_result($rs,"ARGUMENT_EDIT")){$gfield[$gtabid]["argument_edit"][$bzm0] = lmbdb_result($rs,"ARGUMENT_EDIT");}
			if(lmbdb_result($rs,"AJAXPOST")){$gfield[$gtabid]["ajaxpost"][$bzm0] = lmbdb_result($rs,"AJAXPOST");}
			if($lmb_genlink){$gfield[$gtabid]["genlink"][$bzm0] = $lmb_genlink;}
			if(lmbdb_result($rs,"VERKNTABID")){$gfield[$gtabid]["verkntabid"][$bzm0] = lmbdb_result($rs,"VERKNTABID");}
			if(lmbdb_result($rs,"VERKNFIELDID")){$gfield[$gtabid]["verknfieldid"][$bzm0] = lmbdb_result($rs,"VERKNFIELDID");}
			if(lmbdb_result($rs,"HASRECVERKN")){$gfield[$gtabid]["hasrecverkn"][$bzm0] = lmbdb_result($rs,"HASRECVERKN");}
			if(lmbdb_result($rs,"VERKNTABLETYPE")){$gfield[$gtabid]["verkntabletype"][$bzm0] = lmbdb_result($rs,"VERKNTABLETYPE");}
			if(lmbdb_result($rs,"VERKNTREE")){$gfield[$gtabid]["verkntree"][$bzm0] = lmbdb_result($rs,"VERKNTREE");}
			if(lmbdb_result($rs,"MD5TAB")){$gfield[$gtabid]["md5tab"][$bzm0] = lmb_strtoupper(lmbdb_result($rs,"MD5TAB"));}
			if($lmb_relext){$gfield[$gtabid]["relext"][$bzm0] = $lmb_relext;}
			if(lmbdb_result($rs,"DYNSEARCH")){$gfield[$gtabid]["dynsearch"][$bzm0] = lmbdb_result($rs,"DYNSEARCH");}
			if(lmbdb_result($rs,"ARTLEISTE")){$gfield[$gtabid]["artleiste"][$bzm0] = lmbdb_result($rs,"ARTLEISTE");}
			if(lmbdb_result($rs,"QUICKSEARCH")){$gfield[$gtabid]["quicksearch"][$bzm0] = lmbdb_result($rs,"QUICKSEARCH");}
            if(lmbdb_result($rs,"FULLSEARCH")){$gfield[$gtabid]["fullsearch"][$bzm0] = lmbdb_result($rs,"FULLSEARCH");}
			if(lmbdb_result($rs,"ISUNIQUE")){$gfield[$gtabid]["unique"][$bzm0] = lmbdb_result($rs,"ISUNIQUE");}
			if(lmbdb_result($rs,"SELECT_SORT")){$gfield[$gtabid]["select_sort"][$bzm0] = lmbdb_result($rs,"SELECT_SORT");}elseif(lmbdb_result($rs,"FIELD_TYPE") == 4){$gfield[$gtabid]["select_sort"][$bzm0] = 'SORT';}
			if(lmbdb_result($rs,"SELECT_POOL")){$gfield[$gtabid]["select_pool"][$bzm0] = lmbdb_result($rs,"SELECT_POOL");}elseif(lmbdb_result($rs,"FIELD_TYPE") == 4){$gfield[$gtabid]["select_pool"][$bzm0] = 0;}
			if(lmbdb_result($rs,"SELECT_DEFAULTTYPE")){$gfield[$gtabid]["select_defaulttype"][$bzm0] = lmbdb_result($rs,"SELECT_DEFAULTTYPE");}
            if(lmbdb_result($rs,"FIELD_TYPE") == 4 OR lmbdb_result($rs,"FIELD_TYPE") == 11){if(lmbdb_result($rs,"SELECT_CUT")){$gfield[$gtabid]["select_cut"][$bzm0] = lmbdb_result($rs,"SELECT_CUT");}else{$gfield[$gtabid]["select_cut"][$bzm0] = '<BR>';}}
			if(lmbdb_result($rs,"GROUPABLE")){$gfield[$gtabid]["groupable"][$bzm0] = lmbdb_result($rs,"GROUPABLE");}
			if(lmbdb_result($rs,"INDIZE")){$gfield[$gtabid]["indize"][$bzm0] = lmbdb_result($rs,"INDIZE");}
			if(lmbdb_result($rs,"INDEXED")){$gfield[$gtabid]["indexed"][$bzm0] = lmbdb_result($rs,"INDEXED");}
			if(lmbdb_result($rs,"DATETIME") OR lmbdb_result($rs,"DATETIME") == 0){$gfield[$gtabid]["datetime"][$bzm0] = parse_db_int(lmbdb_result($rs,"DATETIME"));}
			if(lmbdb_result($rs,"WYSIWYG")){$gfield[$gtabid]["wysiwyg"][$bzm0] = lmbdb_result($rs,"WYSIWYG");}
			if(lmbdb_result($rs,"SEARCHVERSION")){$gfield[$gtabid]["searchversion"][$bzm0] = lmbdb_result($rs,"SEARCHVERSION");}
			if(lmbdb_result($rs,"DEFAULTVALUE")){$gfield[$gtabid]["table_deflt"][$bzm0] = lmbdb_result($rs,"DEFAULTVALUE");}
			if(lmbdb_result($rs,"DEFLT")){$gfield[$gtabid]["deflt"][$bzm0] = lmbdb_result($rs,"DEFLT");}
			if(lmbdb_result($rs,"VIEWRULE")){$gfield[$gtabid]["viewrule"][$bzm0] = lmbdb_result($rs,"VIEWRULE");}
			if(lmbdb_result($rs,"POTENCY")){$gfield[$gtabid]["potency"][$bzm0] = lmbdb_result($rs,"POTENCY");}
			if(lmbdb_result($rs,"COLLREPLACE")){$gfield[$gtabid]["collreplace"][$bzm0] = lmbdb_result($rs,"COLLREPLACE");}
			if(lmbdb_result($rs,"AGGREGATE")){$gfield[$gtabid]["aggregate"][$bzm0] = lmbdb_result($rs,"AGGREGATE");}
		    if(lmbdb_result($rs,"MULTILANG") AND $session['dlanguage'] != $umgvar['default_language']){$gfield[$gtabid]["multilang"][$bzm0] = 2;}
		    elseif(lmbdb_result($rs,"MULTILANG")){$gfield[$gtabid]["multilang"][$bzm0] = 1;}
			if(lmbdb_result($rs,"LISTING_CUT")){$gfield[$gtabid]["listing_cut"][$bzm0] = lmbdb_result($rs,"LISTING_CUT");}
			if(lmbdb_result($rs,"LISTING_VIEWMODE")){$gfield[$gtabid]["listing_viewmode"][$bzm0] = lmbdb_result($rs,"LISTING_VIEWMODE");}
            if(lmbdb_result($rs,"VERKNGROUP")){$gfield[$gtabid]["verkngroup"][$bzm0] = lmbdb_result($rs,"VERKNGROUP");}
			if(lmbdb_result($rs,"VERKNPARAMS")){$gfield[$gtabid]["verknparams"][$bzm0] = lmbdb_result($rs,"VERKNPARAMS");}
			if(lmbdb_result($rs,"RELPARAMS")){$gfield[$gtabid]["relparams"][$bzm0] = lmbdb_result($rs,"RELPARAMS");}
			if(lmbdb_result($rs,"ENCRYPTION_MODE")){$gfield[$gtabid]["encryption_mode"][$bzm0] = lmbdb_result($rs,"ENCRYPTION_MODE");}
			if(lmbdb_result($rs,"VERKNSEARCH")){$gfield[$gtabid]["verknsearch"][$bzm0] = explode(",",lmbdb_result($rs,"VERKNSEARCH"));}else{$gfield[$gtabid]["verknsearch"][$bzm0][0] = lmbdb_result($rs,"VERKNFIELDID");}
			if(lmbdb_result($rs,"COL_HIDE")){$gfield[$gtabid]["col_hide"][$bzm0] = 1;}
            if(lmbdb_result($rs,"DETAILSEARCH")){$gfield[$gtabid]["detailsearch"][$bzm0] = 1;} // negate
            if(lmbdb_result($rs,"MULTIRELATION")){$gfield[$gtabid]["multirelation"][$bzm0] = 1;}
            if(lmbdb_result($rs,"LEVEL")){$gfield[$gtabid]["level"][$bzm0] = lmbdb_result($rs,"LEVEL");}
            if(lmbdb_result($rs,"CHECKSUM")){$gfield[$gtabid]["checksum"][$bzm0] = lmbdb_result($rs,"CHECKSUM");}
            if(lmbdb_result($rs,"INACTIVELINK")){$gfield[$gtabid]["inactivelink"][$bzm0] = lmbdb_result($rs,"INACTIVELINK");}

            if(lmbdb_result($rs,"VERKNVIEW")){
				$verknview = explode("?",lmbdb_result($rs,"VERKNVIEW"));
				if(isset($verknview[1])){
					$gfield[$gtabid]["verknviewcut"][$bzm0] = $verknview[1];
				}else{
					$gfield[$gtabid]["verknviewcut"][$bzm0] = ' ';
				}
				$gfield[$gtabid]["verknview"][$bzm0] = explode(",",$verknview[0]);
			}else{$gfield[$gtabid]["verknview"][$bzm0][0] = lmbdb_result($rs,"VERKNFIELDID");}
			if(lmbdb_result($rs,"VERKNFIND")){
				$verknfind = explode("?",lmbdb_result($rs,"VERKNFIND"));
				if($verknfind[1]){$gfield[$gtabid]["verknfindcut"][$bzm0] = $verknfind[1];}else{$gfield[$gtabid]["verknfindcut"][$bzm0] = ' ';}
				$gfield[$gtabid]["verknfind"][$bzm0] = explode(",",$verknfind[0]);
			}else{$gfield[$gtabid]["verknfind"][$bzm0][0] = lmbdb_result($rs,"VERKNFIELDID");}
			
			$ftp = $gfield[$gtabid]["field_type"][$bzm0];
			$dtp = $gfield[$gtabid]["data_type"][$bzm0];

			if($ftp == 2 OR $ftp == 16 OR $ftp == 14 OR $ftp == 21
			OR $dtp == 29 OR $dtp == 28 OR $dtp == 12 OR $dtp == 31 OR $dtp == 32 OR $dtp == 21 OR ($dtp == 39 AND $gfield[$gtabid]["wysiwyg"][$bzm0])){
				$gfield[$gtabid]["hasfunction"][$bzm0] = -15;
			}

			# ----- GROUP PARAMETER --------

			# ######## Summierende Rechte #########
			# ----- Schreibrechte -----------
			if(lmbdb_result($rs,"GROUPEDIT")){$gfield[$gtabid]["perm_edit"][$bzm0] = 1;}
			# ----- kopierrechte -----------
			if(lmbdb_result($rs,"COPY")){$gfield[$gtabid]["copy"][$bzm0] = 1;}
			# ----- Optionen -----------
			if(lmbdb_result($rs,"FIELDOPTION")){$gfield[$gtabid]["option"][$bzm0] = 1;}
			# ----- Pflichtfeld -----------
			if(lmbdb_result($rs,"NEED")){$gfield[$gtabid]["need"][$bzm0] = "*".$gfield[$gtabid]["spelling"][$bzm0].": ";}
			# ----- Versionierung -----------
			if(lmbdb_result($rs,"VER")){$gfield[$gtabid]["ver"][$bzm0] = 1;}

			# ######## Hauptgruppen Rechte #########
			if($gfield[$gtabid]["trigger"][$bzm0]){$trgger = $gfield[$gtabid]["trigger"][$bzm0];}else{$trgger = array();}
			if(lmbdb_result($rs, "LMTRIGGER") OR lmbdb_result($rs, "RULE_TRIGGER")){
                $gfield[$gtabid]["trigger"][$bzm0] = array_filter(array_unique(array_merge(explode(",",lmbdb_result($rs, "LMTRIGGER")),explode(",",lmbdb_result($rs, "RULE_TRIGGER")),$trgger)));
            }
			if(lmbdb_result($rs,"GEDITRULE")){
				$gfield[$gtabid]["editrule"][$bzm0] = lmbdb_result($rs,"GEDITRULE");
			}elseif(lmbdb_result($rs,"EDITRULE")){
				$gfield[$gtabid]["editrule"][$bzm0] = lmbdb_result($rs,"EDITRULE");
			}
			$gfield[$gtabid]["color"][$bzm0] = lmbdb_result($rs,"GROUPCOLOR");
			
			$groupfilter = lmbdb_result($rs,"GROUPFILTER");
			# gilt nur wenn keine anderen Einschränkungen aktiv
			if($groupfilter == '#INACTIVE#'){

			}elseif($groupfilter){
				$gfield[$gtabid]["filter"][$bzm0][] = $groupfilter;
				$gfield[$gtabid]["filtertyp"][$bzm0][] = lmbdb_result($rs,"GROUPFILTERTYP");
			# setzt Rechte auf NULL (alle Rechte) wenn kein Filter gesetzt
			}else{
				$reset_groupfilter[$bzm0] = $bzm0;
			}

			#----- Numberformat / Potenzen ----------------------------------
			if(lmbdb_result($rs,"GROUPNFORMAT")){$gfield[$gtabid]["nformat"][$bzm0] = lmbdb_result($rs,"GROUPNFORMAT");}
			elseif(lmbdb_result($rs,"NFORMAT")){$gfield[$gtabid]["nformat"][$bzm0] = lmbdb_result($rs,"NFORMAT");}
			else{$gfield[$gtabid]["nformat"][$bzm0] = NULL;}

			#----- extension ----------------------------------
			if(lmbdb_result($rs,"GROUPEXT_TYPE")){$gfield[$gtabid]["ext_type"][$bzm0] = lmbdb_result($rs,"GROUPEXT_TYPE");}
			elseif(lmbdb_result($rs,"EXT_TYPE")){$gfield[$gtabid]["ext_type"][$bzm0] = lmbdb_result($rs,"EXT_TYPE");}
			else{$gfield[$gtabid]["ext_type"][$bzm0] = NULL;}

			#----- currency ----------------------------------
			if(lmbdb_result($rs,"GROUPCURRENCY")){$gfield[$gtabid]["currency"][$bzm0] = lmbdb_result($rs,"GROUPCURRENCY");}
			elseif(lmbdb_result($rs,"CURRENCY")){$gfield[$gtabid]["currency"][$bzm0] = lmbdb_result($rs,"CURRENCY");}
			
			#----- LMB_SYNC_SLAVE published field ----------------------------------
		    if($gfield[$gtabid]["field_name"][$bzm0] == 'LMB_SYNC_SLAVE'){$gfield[$gtabid]['sync'][$bzm0] = 1;}

            // ######## field select array ############
            # argument
			if($gfield[$gtabid]["argument_typ"][$bzm0] == 47 AND !$gfield[$gtabid]["argument_edit"][$bzm0]) {
                if(!$lmb_argument){$lmb_argument = "''";}
                $gfield[$gtabid]["select"][$bzm0] = $lmb_argument . " AS " . $gfield[$gtabid]["form_name"][$bzm0];
            # currency
            }elseif($gfield[$gtabid]["data_type"][$bzm0] == 30) {
                $gfield[$gtabid]["select"][$bzm0] = $gtab["table"][$gtabid].".".$field_name." AS ".$gfield[$gtabid]["form_name"][$bzm0] . ',' . $gtab['table'][$gtabid] . "." . $gfield[$gtabid]['field_name'][$bzm0] . "_C AS " . $gfield[$gtabid]["form_name"][$bzm0] . "_C";
            # backward relation 1:n direkt
            }elseif($gfield[$gtabid]['data_type'][$bzm0] == 25 AND $gfield[$gtabid]['verkntabletype'][$bzm0] == 2){
				$sqlquery1 = "SELECT MD5TAB FROM LMB_CONF_FIELDS WHERE TAB_ID = ".$gfield[$gtabid]['verkntabid'][$bzm0]." AND FIELD_ID = ".$gfield[$gtabid]['hasrecverkn'][$bzm0];
				$rs1 = lmbdb_exec($db,$sqlquery1) or errorhandle(lmbdb_errormsg($db),$sqlquery1,$action,__FILE__,__LINE__);
				if(!$rs1) {$commit = 1;}
				if(lmbdb_result($rs1,"MD5TAB")){
                    // workaround for missing md5tab
                    $gfield[$gtabid]["md5tabBD"][$bzm0] = lmb_strtoupper(lmbdb_result($rs1,"MD5TAB"));
                    // select query
                        $gfield[$gtabid]["select"][$bzm0] = $gtab["table"][$gtabid] . "." . lmb_strtoupper(lmbdb_result($rs1, "MD5TAB"))." AS ".$gfield[$gtabid]["form_name"][$bzm0];
                    }
                #$gfield[$gtabid]["select"][$bzm0] = $gtab["table"][$gtabid] . "." . $gfield[ $gfield[$gtabid]['verkntabid'][$bzm0] ]['md5tab'][ $gfield[$gtabid]['hasrecverkn'][$bzm0] ] . " AS " . $gfield[$gtabid]["form_name"][$bzm0];
            # default
            }elseif($gfield[$gtabid]['field_type'][$bzm0] != 14 AND $gfield[$gtabid]['field_type'][$bzm0] != 15 AND $gfield[$gtabid]['field_type'][$bzm0] != 100 AND ($data_type != 39 OR $gfield[$gtabid]["longhandle"][$bzm0])){
				$gfield[$gtabid]["select"][$bzm0] = $gtab["table"][$gtabid].".".$field_name." AS ".$gfield[$gtabid]["form_name"][$bzm0];
			}



			# ---- Verknüpfung --------------------
			if($gfield[$gtabid]["field_type"][$bzm0] == 11 AND $gfield[$gtabid]["verknfieldid"][$bzm0] AND $gfield[$gtabid]["verkntabid"][$bzm0]){

				# ----- gfield Rückwertige Verknüpfung -----------
				$gfield[ $gfield[$gtabid]["verkntabid"][$bzm0] ]["r_verkntabid"][$bzm0] = $gtabid;
				$gfield[ $gfield[$gtabid]["verkntabid"][$bzm0] ]["r_verknfieldid"][$bzm0] = $bzm0;
				#if($gfield[$gtabid]["sort"][$bzm0] AND $gfield[$gtabid]["verkntabletype"][$bzm0] == 1){
				if($gfield[$gtabid]["sort"][$bzm0]){
					#  fieldlist of relations for fast foreach
					$gfield[$gtabid]["verknfields"][$bzm0] = $bzm0;
				}
			
				# ---- gverkn alle Verknüpfungen
				$gverkn[$gtabid]["id"][$bzm0] = $gfield[$gtabid]["verkntabid"][$bzm0];

				// replaced by relation parameters
				/*
                # Zusatzfelder Verknüpfungstabelle
				$rs1 = lmbdb_columns($db,null,$DBA["DBSCHEMA"],lmb_strtoupper($gfield[$gtabid]["md5tab"][$bzm0]));
				$deffields = array("ID","KEYID","VERKN_ID","ERSTDATUM","ERSTUSER","SORT");
				$gfield[$gtabid]["md5tab_fields"][$bzm0] = null;
				$gfield[$gtabid]["md5tab_types"][$bzm0] = null;
				while(lmbdb_fetch_row($rs1)) {
					if(!in_array(lmb_strtoupper(lmbdb_result($rs1, "COLUMN_NAME")),$deffields)){
			  			$gfield[$gtabid]["md5tab_fields"][$bzm0][] = lmbdb_result($rs1, "COLUMN_NAME");
			  			$gfield[$gtabid]["md5tab_types"][$bzm0][] = lmbdb_result($rs1, "TYPE_NAME");
					}
				}
				*/
				#$gfield[$gtabid]["md5tab_fields"][$bzm0] = array("ID","KEYID","VERKN_ID","ERSTDATUM","ERSTUSER","SORT");
			}

			#----- File-Level ----------------------------------
			if($data_type == 25 OR $data_type == 13 OR ($gtab["typ"][lmbdb_result($rs,"VERKNTABID")] == 3 AND lmbdb_result($rs,"FIELD_TYPE") == 11)){
				$sqlquery1 = "SELECT ID FROM LDMS_STRUCTURE WHERE TAB_ID = $gtabid AND FIELD_ID = $bzm0 AND FIX = ".LMB_DBDEF_TRUE; // and typ = 7
				$rs1 = lmbdb_exec($db,$sqlquery1) or errorhandle(lmbdb_errormsg($db),$sqlquery1,$action,__FILE__,__LINE__);
				if(!$rs1) {$commit = 1;}
				if(lmbdb_result($rs1,"ID")){
					$gfield[$gtabid]["file_level"][$bzm0] = lmbdb_result($rs1,"ID");
				}
			}

			#----- Selbstverknüpfung ----------------------------------
			if(isset($gfield[$gtabid]["verkntabid"][$bzm0]) && $gfield[$gtabid]["verkntabid"][$bzm0] == $gtabid && ($gfield[$gtabid]["data_type"][$bzm0] == 27 || $gfield[$gtabid]["data_type"][$bzm0] == 25)){
				$gfield[$gtabid]["sverkn"][$bzm0] = $bzm0;
				$GLOBALS['gtab']["sverkn"][$gtabid] = $bzm0;
				// if a self relation has forward and backward relation, prevent overwrite by backward relation
                if ($gfield[$gtabid]['verkntabletype'][$bzm0] != 2 OR !$GLOBALS['gtab']["smd5tab"][$gtabid]) {
                    $GLOBALS['gtab']["smd5tab"][$gtabid] = $gfield[$gtabid]["md5tab"][$bzm0];
                }
			}

			# ----------------- Field Key -------------------
			if(lmbdb_result($rs,"FIELDKEY") == TRUE){
				$gfield[$gtabid]["fieldkey"] = lmbdb_result($rs,"FIELD_NAME");
				$gfield[$gtabid]["fieldkey_id"] = $bzm0;
			}

			# ----------------- Main Field / Bezeichner -------------------
			if(lmbdb_result($rs,"MAINFIELD") == TRUE){
				$gfield[$gtabid]["mainfield"] = $bzm0;
			}

			# ------- Spaltenbreiten eintragen ------
            // userdefined
			if($tabrse[$gtabid][$bzm0]){
				$gfield[$gtabid]["rowsize"][$bzm0] = $tabrse[$gtabid][$bzm0];
            // default fieldsetting
			}elseif(lmbdb_result($rs,"ROW_SIZE")) {
                $gfield[$gtabid]["rowsize"][$bzm0] = lmbdb_result($rs,"ROW_SIZE");
            // default umgvar
            }else{
				$gfield[$gtabid]["rowsize"][$bzm0] = $umgvar["default_fieldwidth"];
			}

            if (lmbdb_result($rs,"LISTEDIT")) {$gfield[$gtabid]["listedit"][$bzm0] = 1;}
            if (lmbdb_result($rs,"SPEECHREC")) {$gfield[$gtabid]["speechrec"][$bzm0] = 1;}
            if (lmbdb_result($rs,"POPUPDEFAULT")) {
                $GLOBALS['popg'][$gtabid][0]['null'][$bzm0] = 1;
                $GLOBALS['popc'][$gtabid][$gfield[$gtabid]["verkntabid"][$bzm0]] = 1;
            }
        }
		
		# is view
		if($gtab["typ"][$gtabid] == 5){
			$gfield[$gtabid]["copy"][$bzm0]  = null;
			$gfield[$gtabid]["perm_edit"][$bzm0]  = null;
			$gfield[$gtabid]["need"][$bzm0]  = null;
			$gfield[$gtabid]["editrule"][$bzm0]  = null;
		}
		
		$bzm++;
	}


	#----- validity add valid_to ----------------------------------
    /*
	if($validity_key){

	    $new_fieldid = (max($gfield[$gtabid]['id'])+1);
	    // copy all validity_from settings in validity_to
	    foreach($gfield[$gtabid] as $vkey => $vvalue){
	        if($gfield[$gtabid][$vkey][$validity_key] AND $vkey != 'r_verkntabid' AND $vkey != 'r_verknfieldid') {
                $gfield[$gtabid][$vkey][$new_fieldid] = $gfield[$gtabid][$vkey][$validity_key];
            }
        }

        // set special settings in validity_to
        $gfield[$gtabid]["id"][$new_fieldid] = $new_fieldid;
		$gfield[$gtabid]["key"][$new_fieldid] = $new_fieldid;
		$gfield[$gtabid]["sort"][$new_fieldid] = ($gfield[$gtabid]["sort"][$new_fieldid]+1);
        $gfield[$gtabid]["field_id"][$new_fieldid] = $new_fieldid;
        $gfield[$gtabid]["field_name"][$new_fieldid] = lmb_strtoupper('LMB_VALIDTO');
        $gfield[$gtabid]["spelling"][$new_fieldid] = $gfield[$gtabid]["spelling"][$validity_key].' '.$lang[1446]; // adding "to" to spelling
        $gfield[$gtabid]["form_name"][$new_fieldid] = "g_".$gtabid."_".$new_fieldid;
        $gfield[$gtabid]["select"][$new_fieldid] = $gtab["table"][$gtabid].".".$gfield[$gtabid]["field_name"][$new_fieldid]." AS ".$gfield[$gtabid]["form_name"][$new_fieldid];

		$gfield[$gtabid]["spelling"][$validity_key] .= ' '.$lang[1445]; // adding "from" to spelling
    }
    */

	# reset groufilter / Filter auf null setzen wenn eine andere Gruppe keinen Filter besitzt und somit doch Rechte besitzt
	foreach($gfield[$gtabid]["filter"] as $gkey => $gval){
		$gfield[$gtabid]["filter"][$gkey] = array_unique($gfield[$gtabid]["filter"][$gkey]);
		if (is_array($reset_groupfilter) AND in_array($gkey,$reset_groupfilter)) {
			unset($gfield[$gtabid]["filter"][$gkey]);
		}
	}

	# default sort and key values
	if($gfield[$gtabid]["sort"]){

	    asort($gfield[$gtabid]["sort"]);

        if($gfield[$gtabid]["argresult_name"]['ID']){ // has ID
            $first_gfield = $gfield[$gtabid]["argresult_name"]['ID'];
        }elseif($gtab["typ"][$gtabid] == 5) { //IS VIEW - order first second or third field of view for pagination
            $first_gfield_ = array_keys($gfield[$gtabid]["sort"]);
            $first_gfield = $first_gfield_[0];
            if ($gfield[$gtabid]["field_type"][$first_gfield] == 100) {
                $first_gfield = $first_gfield_[1];
                if ($gfield[$gtabid]["field_type"][$first_gfield] == 100) {
                    $first_gfield = $first_gfield = $first_gfield_[2];
                    if ($gfield[$gtabid]["field_type"][$first_gfield] == 100) {
                        $first_gfield = 0;
                    }
                }
            }
        }else{
            $first_gfield = 0;
        }


		#----- Sortierung eintragen --------
		if(!$gtab['orderby'][$gtabid] AND $first_gfield){
		    $gtab['orderby'][$gtabid][0] = array($gtab['table'][$gtabid].'.'.$gfield[$gtabid]["field_name"][$first_gfield],'ASC');
		}

		#----- Feld-Key eintragen --------
		if(!$gfield[$gtabid]["fieldkey"] AND $first_gfield){
			$gfield[$gtabid]["fieldkey"] = $gfield[$gtabid]["field_name"][$first_gfield];
			$gfield[$gtabid]["fieldkey_id"] = $first_gfield;
		}


	}

	return $gfield;
}

#----------------- Berichte -------------------
function resultreportlist(){
	global $db;
	global $session;
    global $umgvar;
/*
	$sqlquery = "SELECT DISTINCT LMB_REPORT_LIST.ID,LMB_REPORT_LIST.GROUPLIST,LMB_REPORT_LIST.NAME,LMB_REPORT_LIST.REFERENZ_TAB,LDMS_STRUCTURE.ID AS FID,LDMS_STRUCTURE.LEVEL
	FROM LMB_REPORT_LIST,LDMS_STRUCTURE,LMB_RULES_REPFORM
	WHERE LMB_REPORT_LIST.TARGET = LDMS_STRUCTURE.FIELD_ID
	AND LMB_RULES_REPFORM.REPFORM_ID = LMB_REPORT_LIST.ID
	AND LMB_RULES_REPFORM.TYP = 1
	AND LDMS_STRUCTURE.TYP = 5
	AND LDMS_STRUCTURE.FIX = TRUE
	AND (LMB_RULES_REPFORM.GROUP_ID = ".implode(" OR LMB_RULES_REPFORM.GROUP_ID = ",$session["subgroup"]).")
	UNION
	SELECT DISTINCT LMB_REPORT_LIST.ID,LMB_REPORT_LIST.GROUPLIST,LMB_REPORT_LIST.NAME,LMB_REPORT_LIST.REFERENZ_TAB,0 AS FID,0 AS LEVEL
	FROM LMB_REPORT_LIST,LMB_RULES_REPFORM
	WHERE LMB_RULES_REPFORM.REPFORM_ID = LMB_REPORT_LIST.ID
	AND LMB_RULES_REPFORM.TYP = 1
	AND LMB_REPORT_LIST.REFERENZ_TAB = -1
	AND (LMB_RULES_REPFORM.GROUP_ID = ".implode(" OR LMB_RULES_REPFORM.GROUP_ID = ",$session["subgroup"])."
	";
*/
    $greportlist = [];
    
	$sqlquery = "
	SELECT DISTINCT LMB_REPORT_LIST.PRINTER,LMB_REPORT_LIST.LISTMODE,LMB_REPORT_LIST.EXTENSION,LMB_REPORT_LIST.DEFFORMAT,LMB_REPORT_LIST.CSS,LMB_REPORT_LIST.SAVENAME,LMB_REPORT_LIST.ODT_TEMPLATE,LMB_REPORT_LIST.ODS_TEMPLATE,LMB_REPORT_LIST.ID,LMB_REPORT_LIST.TARGET,LMB_REPORT_LIST.NAME,LMB_REPORT_LIST.REFERENZ_TAB,LMB_RULES_REPFORM.HIDDEN,LMB_RULES_REPFORM.EDITABLE, LMB_REPORT_LIST.PARENT_ID, LMB_REPORT_LIST.SAVED_TEMPLATE
	FROM LMB_REPORT_LIST,LMB_RULES_REPFORM
	WHERE LMB_RULES_REPFORM.REPFORM_ID = LMB_REPORT_LIST.ID
	AND LMB_RULES_REPFORM.TYP = 1
	AND (LMB_RULES_REPFORM.GROUP_ID = ".implode(" OR LMB_RULES_REPFORM.GROUP_ID = ",$session["subgroup"]).")
	";
	#ORDER BY LMB_REPORT_LIST.NAME (only maxdb76)
	$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
	if(!$rs) {$commit = 1;}
	while(lmbdb_fetch_row($rs)) {
		$key = lmbdb_result($rs, "ID");
		$gtabid = lmbdb_result($rs, "REFERENZ_TAB");
		$greportlist[$gtabid]["id"][$key] = $key;
		$greportlist[$gtabid]["name"][$key] = lmbdb_result($rs, "NAME");
        if(lmbdb_result($rs, "DEFFORMAT")){$greportlist[$gtabid]["defformat"][$key] = lmbdb_result($rs, "DEFFORMAT");}
        if(lmbdb_result($rs, "CSS")){$greportlist[$gtabid]["css"][$key] = lmbdb_result($rs, "CSS");}
		if(lmbdb_result($rs, "ODT_TEMPLATE")){$greportlist[$gtabid]["odt_template"][$key] = lmbdb_result($rs, "ODT_TEMPLATE");}
		if(lmbdb_result($rs, "ODS_TEMPLATE")){$greportlist[$gtabid]["ods_template"][$key] = lmbdb_result($rs, "ODS_TEMPLATE");}
		if(lmbdb_result($rs, "SAVENAME")){$greportlist[$gtabid]["savename"][$key] = lmbdb_result($rs, "SAVENAME");}
		if(lmbdb_result($rs, "LISTMODE")){$greportlist[$gtabid]["listmode"][$key] = lmbdb_result($rs, "LISTMODE");}
		if(lmbdb_result($rs, "EXTENSION")){$greportlist[$gtabid]["extension"][$key] = lmbdb_result($rs, "EXTENSION");}
        if(lmbdb_result($rs, "PRINTER")){$greportlist[$gtabid]["printer"][$key] = lmbdb_result($rs, "PRINTER");}
        $greportlist[$gtabid]["target"][$key] = lmbdb_result($rs, "TARGET");
        $greportlist[$gtabid]["parent_id"][$key] = lmbdb_result($rs, "PARENT_ID");
        $greportlist[$gtabid]["saved_template"][$key] = lmbdb_result($rs, "SAVED_TEMPLATE");
        $greportlist[$gtabid]["is_template"][$key] = !empty($greportlist[$gtabid]["parent_id"][$key]);
    /*
     * 0 = no preview, visible
     * 1 = preview, visible
     * 2 = no preview, not visible
     * 3 = preview, not visible
     *
     */
        $greportlist[$gtabid]["preview"][$key] = 3; //TODO: REPORT PREVIEW
		
		$greportlist["argresult_tabid"][$key] = $gtabid;
		if(lmbdb_result($rs, "HIDDEN") AND $greportlist[$gtabid]["hidden"][$key] !== 0){$greportlist[$gtabid]["hidden"][$key] = 1;}
		else{$greportlist[$gtabid]["hidden"][$key] = 0;}
        if(lmbdb_result($rs, "EDITABLE") AND $greportlist[$gtabid]["editable"][$key] !== 0){$greportlist[$gtabid]["editable"][$key] = 1;}
        else{$greportlist[$gtabid]["editable"][$key] = 0;}
	}




    $sqlquery = 'SELECT TAB_ID, REPORT_RESOLVE_CACHE FROM LMB_CONF_TABLES';
    $rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
    if(!$rs) {$commit = 1;}
    while(lmbdb_fetch_row($rs)) {
        $gtabid = lmbdb_result($rs, 'TAB_ID');
        $cachedConfig = lmbdb_result($rs, 'REPORT_RESOLVE_CACHE');
        if(array_key_exists($gtabid, $greportlist)) {
            $greportlist[$gtabid]['resolved'] = [];
            if(!empty($cachedConfig) && $umgvar['report_resolve_cache']) {
                $greportlist[$gtabid]['resolved'] = json_decode($cachedConfig, true) ?? [];
            }
        }
    }
    
	return $greportlist;
}

#----------------- Diagramme -------------------
function resultdiaglist(){
	global $db;
	global $session;

	$sqlquery = "SELECT DISTINCT LMB_CHART_LIST.ID,LMB_CHART_LIST.TAB_ID,LMB_CHART_LIST.DIAG_NAME,LMB_CHART_LIST.DIAG_DESC,LMB_CHART_LIST.TEMPLATE,LMB_CHART_LIST.NOHEADER,LMB_RULES_REPFORM.HIDDEN
	FROM LMB_CHART_LIST,LMB_RULES_REPFORM
	WHERE LMB_RULES_REPFORM.REPFORM_ID = LMB_CHART_LIST.ID
	AND LMB_RULES_REPFORM.TYP = 3
	AND (LMB_RULES_REPFORM.GROUP_ID IN (".implode(",",$session["subgroup"])."))";
	$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
	if(!$rs) {$commit = 1;}
	while(lmbdb_fetch_row($rs)) {
		$key = lmbdb_result($rs, "ID");
		$gtabid = lmbdb_result($rs, "TAB_ID");
		$gdiaglist[$gtabid]["id"][$key] = $key;
		$gdiaglist[$gtabid]["name"][$key] = lmbdb_result($rs, "DIAG_NAME");
		$gdiaglist[$gtabid]["desc"][$key] = lmbdb_result($rs, "DIAG_DESC");
		$gdiaglist[$gtabid]["template"][$key] = lmbdb_result($rs, "TEMPLATE");
		$gdiaglist[$gtabid]["noheader"][$key] = lmbdb_result($rs, "NOHEADER");
		$gdiaglist['gtabid'][$key] = $gtabid;
		if(lmbdb_result($rs, "HIDDEN") AND $gdiaglist[$gtabid]["hidden"][$key] !== 0){$gdiaglist[$gtabid]["hidden"][$key] = 1;}
		else{$gdiaglist[$gtabid]["hidden"][$key] = 0;}
	}
	return $gdiaglist;
}

#----------------- Reminder -------------------
function resultreminder(){
	global $db;
	global $session;
	global $lang;

	$sqlquery = "SELECT DISTINCT LMB_REMINDER_LIST.ID,LMB_REMINDER_LIST.NOTIFICATION,LMB_REMINDER_LIST.REFRESHTIME,LMB_REMINDER_LIST.DEFAULTSELECTION,LMB_REMINDER_LIST.SORT,LMB_REMINDER_LIST.TAB_ID,LMB_REMINDER_LIST.NAME,LMB_REMINDER_LIST.GROUPBASED,LMB_REMINDER_LIST.FORML_ID,LMB_REMINDER_LIST.FORMD_ID,LMB_RULES_REPFORM.HIDDEN
	FROM LMB_REMINDER_LIST,LMB_RULES_REPFORM
	WHERE LMB_RULES_REPFORM.REPFORM_ID = LMB_REMINDER_LIST.ID
	AND LMB_RULES_REPFORM.TYP = 4
	AND (LMB_RULES_REPFORM.GROUP_ID IN (".implode(",",$session["subgroup"])."))
	ORDER BY LMB_REMINDER_LIST.TAB_ID,LMB_REMINDER_LIST.SORT";

	$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
	if(!$rs) {$commit = 1;}
	$bzm = 1;
	$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
	if(!$rs) {$commit = 1;}
	while(lmbdb_fetch_row($rs)) {
		$key = parse_db_int(lmbdb_result($rs, "ID"));
		$gtabid = parse_db_int(lmbdb_result($rs, "TAB_ID"));
		$greminder[$gtabid]["name"][$key] = $lang[lmbdb_result($rs, "NAME")];
		$greminder[$gtabid]["forml_id"][$key] = lmbdb_result($rs, "FORML_ID");
		$greminder[$gtabid]["formd_id"][$key] = lmbdb_result($rs, "FORMD_ID");
		$greminder[$gtabid]["groupbased"][$key] = lmbdb_result($rs, "GROUPBASED");
        $greminder[$gtabid]["default"][$key] = lmbdb_result($rs, "DEFAULTSELECTION");
        $greminder[$gtabid]["notification"][$key] = lmbdb_result($rs, "NOTIFICATION");
        $greminder[$gtabid]["refreshtime"][$key] = lmbdb_result($rs, "REFRESHTIME");
		$greminder["argresult_id"][$key] = $gtabid;
		if(lmbdb_result($rs, "HIDDEN") AND $greminder[$gtabid]["hidden"][$key] !== 0){$greminder[$gtabid]["hidden"][$key] = 1;}
		else{$greminder[$gtabid]["hidden"][$key] = 0;}
	}
	return $greminder;
	
}


#----------------- Form list -------------------
function resultformlist(){
	global $db;
	global $session;

	$sqlquery = "SELECT DISTINCT LMB_FORM_LIST.CUSTMENU,LMB_FORM_LIST.DIMENSION,LMB_FORM_LIST.EXTENSION,LMB_FORM_LIST.NAME,LMB_FORM_LIST.CSS,LMB_FORM_LIST.HEADER,LMB_FORM_LIST.ID,LMB_FORM_LIST.REDIRECT,LMB_FORM_LIST.FORM_TYP,LMB_FORM_LIST.REFERENZ_TAB,LMB_FORM_LIST.ERSTUSER,LMB_RULES_REPFORM.HIDDEN
	FROM LMB_FORM_LIST,LMB_RULES_REPFORM
	WHERE LMB_RULES_REPFORM.REPFORM_ID = LMB_FORM_LIST.ID
	AND LMB_RULES_REPFORM.TYP = 2
	AND (LMB_RULES_REPFORM.GROUP_ID IN (".implode(",",$session["subgroup"])."))
	ORDER BY REFERENZ_TAB,NAME";
	$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
	if(!$rs) {$commit = 1;}
	while(lmbdb_fetch_row($rs)) {
        $key = lmbdb_result($rs, "ID");
        $gtabid = lmbdb_result($rs, "REFERENZ_TAB");
        $css = lmbdb_result($rs, "CSS");
        $extension = lmbdb_result($rs, "EXTENSION");

        if (!$gtabid) {
            $gtabid = 0;
        }
        $gformlist["argresult_id"][$key] = $gtabid;
        $gformlist[$gtabid]["id"][$key] = $key;
        $gformlist[$gtabid]["name"][$key] = lmbdb_result($rs, "NAME");
        $gformlist[$gtabid]["typ"][$key] = lmbdb_result($rs, "FORM_TYP");
        $gformlist[$gtabid]["redirect"][$key] = lmbdb_result($rs, "REDIRECT");
        $gformlist[$gtabid]["ref_tab"][$key] = $gtabid;
        $gformlist[$gtabid]["erstuser"][$key] = lmbdb_result($rs, "ERSTUSER");
        $gformlist[$gtabid]["custmenu"][$key] = lmbdb_result($rs, "CUSTMENU");
        $gformlist[$gtabid]["header"][$key] = lmbdb_result($rs, "HEADER");
        if ($css and $css != 'layout.css') {
            $gformlist[$gtabid]["css"][$key] = str_replace('/EXTENSIONS', "localassets", $css);  // todo - remove EXTENSIONS via updatescript
        }
        if ($extension) {
            $gformlist[$gtabid]["extension"][$key] = trim(str_replace('EXTENSIONS/', '', $extension), "/"); // todo - remove EXTENSIONS via updatescript
        }

        $gformlist[$gtabid]["dimension"][$key] = lmbdb_result($rs, "DIMENSION");
        if(trim($gformlist[$gtabid]["dimension"][$key]) == 'x'){$gformlist[$gtabid]["dimension"][$key] = null;}

		if(lmbdb_result($rs, "HIDDEN") AND $gformlist[$gtabid]["hidden"][$key] !== 0){$gformlist[$gtabid]["hidden"][$key] = 1;}
		else{$gformlist[$gtabid]["hidden"][$key] = 0;}
	}
	
	return $gformlist;
}

#----------------- Form details -------------------
function resultform($tableid,$formid,$fbzm,$gform){
	global $db;
	global $gfield;
	global $gformlist;

	if($tableid){$where = "TAB_EL = $tableid AND FORM_ID = $formid AND TAB_EL_ROW > 0 AND TAB_EL_COL > 0 ORDER BY KEYID";}
	else{$where = "TAB_EL_ROW = 0 AND TAB_EL_COL = 0 ORDER BY CATEGORIE,Z_INDEX";}
	$sqlquery = "SELECT * FROM LMB_FORMS WHERE $where";
	$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
	if(!$rs) {$commit = 1;}
	while(lmbdb_fetch_row($rs)) {
		$key = lmbdb_result($rs, "FORM_ID");
		$id = lmbdb_result($rs, "KEYID");
		$fbzm = $id;
		if(!isset($gformlist["argresult_id"][$key])){continue;} // todo description ??

		$gform[$key]["id"][$fbzm] = $key;
		$gform[$key]["fid"][$fbzm] = $id;
		$gform[$key]["typ"][$fbzm] = lmbdb_result($rs, "TYP");
		$gform[$key]["posx"][$fbzm] = lmbdb_result($rs, "POSX");
		$gform[$key]["posy"][$fbzm] = lmbdb_result($rs, "POSY");
		$gform[$key]["height"][$fbzm] = lmbdb_result($rs, "HEIGHT");
		$gform[$key]["width"][$fbzm] = lmbdb_result($rs, "WIDTH");
		$gform[$key]["style"][$fbzm] = lmbdb_result($rs, "STYLE");
		$gform[$key]["z_index"][$fbzm] = lmbdb_result($rs, "Z_INDEX");
		if($inhalt = lmbdb_result($rs, "INHALT")){$gform[$key]["inhalt"][$fbzm] = trim($inhalt);} # longtext handle
		if($title = lmbdb_result($rs, "TITLE")){$gform[$key]["title"][$fbzm] = $title;}
		if(lmbdb_result($rs, "TAB_GROUP")){$gform[$key]["tab_group"][$fbzm] = lmbdb_result($rs, "TAB_GROUP");}
		if(lmbdb_result($rs, "TAB_ID")){$gform[$key]["tab_id"][$fbzm] = lmbdb_result($rs, "TAB_ID");}
		if(lmbdb_result($rs, "FIELD_ID")){$gform[$key]["field_id"][$fbzm] = lmbdb_result($rs, "FIELD_ID");}
		if(lmbdb_result($rs, "UFORM_TYP")){$gform[$key]["uform_typ"][$fbzm] = lmbdb_result($rs, "UFORM_TYP");}
		if(lmbdb_result($rs, "UFORM_VTYP")){$gform[$key]["uform_vtyp"][$fbzm] = lmbdb_result($rs, "UFORM_VTYP");}
		if(lmbdb_result($rs, "PIC_TYP")){$gform[$key]["pic_typ"][$fbzm] = lmbdb_result($rs, "PIC_TYP");}
		if($pic_style = lmbdb_result($rs, "PIC_STYLE")){$gform[$key]["pic_style"][$fbzm] = $pic_style;}
		if($pic_size = lmbdb_result($rs, "PIC_SIZE")){$gform[$key]["pic_size"][$fbzm] = $pic_size;}
		if(lmbdb_result($rs, "TAB")){$gform[$key]["tab"][$fbzm] = lmbdb_result($rs, "TAB");}
		if(lmbdb_result($rs, "TAB_SIZE")){$gform[$key]["tab_size"][$fbzm] = lmbdb_result($rs, "TAB_SIZE");}
		if(lmbdb_result($rs, "TAB_EL")){$gform[$key]["tab_el"][$fbzm] = lmbdb_result($rs, "TAB_EL");}
		if(lmbdb_result($rs, "TAB_EL_COL")){$gform[$key]["tab_el_col"][$fbzm] = lmbdb_result($rs, "TAB_EL_COL");}
		if(lmbdb_result($rs, "TAB_EL_ROW")){$gform[$key]["tab_el_row"][$fbzm] = lmbdb_result($rs, "TAB_EL_ROW");}
		if(lmbdb_result($rs, "PARENTREL")){$gform[$key]["parentage"][$fbzm] = lmbdb_result($rs, "PARENTREL");}
		# if(lmbdb_result($rs, "PARENTRELPATH")){$gform[$key]["parentrelpath"][$fbzm] = lmbdb_result($rs, "PARENTRELPATH");} # TODO
		#if(lmbdb_result($rs, "TAB_EL_COL_SIZE")){$gform[$key]["tab_el_col_size"][$fbzm] = lmbdb_result($rs, "TAB_EL_COL_SIZE");} # ????? TODO

		if($parameters = lmbdb_result($rs, "PARAMETERS")){$gform[$key]["parameters"][$fbzm] = trim($parameters);}  # longtext handle
        if($extension = lmbdb_result($rs, "EXTENSION")){$gform[$key]["extension"][$fbzm] = trim($extension);}  # longtext handle
		#$gform[$key]["categorie"][$fbzm] = lmbdb_result($rs, "CATEGORIE");
		
		# is subelement
		if(lmbdb_result($rs, "SUBELEMENT") AND !$tableid AND $gform[$key]["typ"][$fbzm] != "tabuItem"){
			$gform[$key]["subelement"][$fbzm] = lmbdb_result($rs, "SUBELEMENT");
			$gform[$key]["subellist"][$gform[$key]["subelement"][$fbzm]][parse_db_int(lmbdb_result($rs, "CATEGORIE"))][$fbzm] = $fbzm;
		}else{
			$gform[$key]["mainellist"][$fbzm] = $fbzm;
		}
		
		# is parent relationelement
		if($parentrel = lmb_strtoupper(lmbdb_result($rs, "PARENTREL"))){
		    // relation parameters fields
			if($gform[$key]["field_id"][$fbzm] > 1000){
                $gform[$key]["paramrel"][$parentrel][] = $gform[$key]["field_id"][$fbzm];
			// parent relation fields
			}else{
                $gform[$key]["parentrel"][$parentrel][] = $gform[$key]["field_id"][$fbzm];
			}
		}
		
		# is table-cell
		if($gform[$key]["typ"][$fbzm] == 'tabcell'){
			$gform[$key]["tab_cell"][$gform[$key]["tab_el"][$fbzm]][$gform[$key]["tab_el_col"][$fbzm]][$gform[$key]["tab_el_row"][$fbzm]] = $fbzm;
		}
		
		if($gform[$key]["tab_el"][$fbzm] AND $gform[$key]["tab_el_col"][$fbzm] AND $gform[$key]["tab_el_row"][$fbzm] AND $gform[$key]["typ"][$fbzm] != 'tabcell'){	
			$gform[$key]["tab_el_key"][$gform[$key]["tab_el"][$fbzm]][$gform[$key]["tab_el_col"][$fbzm]][$gform[$key]["tab_el_row"][$fbzm]] = $fbzm; # ??????
			$gform[$key]["tab_cellel"][$gform[$key]["tab_el"][$fbzm]][$gform[$key]["tab_el_col"][$fbzm]][$gform[$key]["tab_el_row"][$fbzm]][] = $fbzm;
			# ------- hat Tabellenreihe einen Datensatz ----------
			if($gform[$key]["typ"][$fbzm] == "dbdat"){
				$gform[$key]["tab_el_rowdat"][$gform[$key]["tab_el"][$fbzm]][$gform[$key]["tab_el_row"][$fbzm]] = 1;
			}
		}
		
		# overwrite class
		if($class = lmbdb_result($rs, "CLASS")){
			$pcl = explode(".",$class);
			$gform[$key]["class"][$fbzm] = trim($pcl[lmb_count($pcl)-1]);
		}

		# ------- Events -----------
		if(lmbdb_result($rs, "EVENT_CLICK")){$gform[$key]["event"][$fbzm]["click"] = lmbdb_result($rs, "EVENT_CLICK");}
		if(lmbdb_result($rs, "EVENT_DBLCLICK")){$gform[$key]["event"][$fbzm]["dblclick"] = lmbdb_result($rs, "EVENT_DBLCLICK");}
		if(lmbdb_result($rs, "EVENT_OVER")){$gform[$key]["event"][$fbzm]["over"] = lmbdb_result($rs, "EVENT_OVER");}
		if(lmbdb_result($rs, "EVENT_OUT")){$gform[$key]["event"][$fbzm]["out"] = lmbdb_result($rs, "EVENT_OUT");}
		if(lmbdb_result($rs, "EVENT_CHANGE")){$gform[$key]["event"][$fbzm]["change"] = lmbdb_result($rs, "EVENT_CHANGE");}

		# benötigte Tabellen und Felder für Query
		if($gfield[$gform[$key]["tab_id"][$fbzm]]["sort"][$gform[$key]["field_id"][$fbzm]]){
			$gform[$key]["used_fields"][lmbdb_result($rs, "TAB_ID")][$gform[$key]["field_id"][$fbzm]] = $gform[$key]["field_id"][$fbzm];
		}


        // adding used_fields for tile subform
        if(isset($gform[$key]["typ"][$fbzm]) && $gform[$key]["typ"][$fbzm] == "tile"){
            $tile[$key] = $gform[$key]["tab_group"][$fbzm]; # tab_group == tile subform id
        }

        if(isset($gform[$key]["typ"][$fbzm]) && $gform[$key]["typ"][$fbzm] == "tab"){
            $gform_ = resultform(lmbdb_result($rs, "TAB"),lmbdb_result($rs, "FORM_ID"),$fbzm,$gform);
            $gform = $gform_[0];
            $fbzm = $gform_[1];
        }
		$fbzm++;

	}

    // adding used_fields for tile subform
	if($tile){
	foreach($tile as $fkey => $tileform){
	    if($fkey AND $gform[$tileform]) {
	        if ($gform[$tileform]['used_fields']) {
                foreach ($gform[$tileform]['used_fields'] as $tab_key => $tab_val) {
                    foreach ($tab_val as $field_key => $field_val) {
                        $gform[$fkey]['used_fields'][$tab_key][$field_val] = $field_val;
                    }
                }
            }
        }
    }}


	return array($gform,$fbzm);
}


#----------------- FILES -------------------
function resultfiles(){
	global $gtab;
	global $gfield;
	global $lang;

	if($gtab["argresult_id"]["LDMS_FILES"]){
		
		# Mußfelder LDMS_FILES Tabelle
		$bzm = 1;
		$fields = array("NAME","SIZE","MIMETYPE","ERSTDATUM","ERSTUSER","THUMB_OK","INFO","SORT","CHECKED","PERM","LMLOCK");
		$gtabid = $gtab["argresult_id"]["LDMS_FILES"];
		$tab = "LDMS_FILES";
		foreach($gfield[$gtabid]["field_id"] as $key => $value){
			if(in_array($gfield[$gtabid]["field_name"][$key],$fields)){
				$fkey = $gtab["argresult_id"]["LDMS_FILES"]."_".$key;
				$gfile["form_name"][$fkey] = "g_".$gtab["argresult_id"]["LDMS_FILES"]."_".$key;
				$gfile["id"][$fkey] = $fkey;
                $gfile["fid"][$fkey] = $key;
                $gfile["name"][$fkey] = $gfield[$gtabid]["field_name"][$key];
                $gfile["title"][$fkey] = $gfield[$gtabid]["spelling"][$key];
                $gfile["desc"][$fkey] = $gfield[$gtabid]["beschreibung"][$key];
                $gfile["tabid"][$fkey] = $gtab["argresult_id"]["LDMS_FILES"];
                $gfile["tab"][$fkey] = $tab;
                $gfile["typ"][$fkey] = $gfield[$gtabid]["parse_type"][$key];
                $gfile["size"][$fkey] = $gfield[$gtabid]["size"][$key];
                $gfile["field_type"][$fkey] = $gfield[$gtabid]["field_type"][$key];
                $gfile["data_type"][$fkey] = $gfield[$gtabid]["data_type"][$key];
			}
			$bzm++;
		}

		# Metadaten
		if($allmeta = array_keys($gtab["verkn"],$gtabid)){
			foreach ($allmeta as $key0 => $metatabid){
				if($metatabid != $gtabid){
					# Metadaten
					if($gfield[$metatabid]["field_id"]){
					foreach($gfield[$metatabid]["sort"] as $key => $val){
						$fkey = $metatabid."_".$key;
						$gfile["form_name"][$fkey] = "g_".$metatabid."_".$key;
						$gfile["id"][$fkey] = $fkey;
                        $gfile["fid"][$fkey] = $key;
                        $gfile["name"][$fkey] = $gfield[$metatabid]["field_name"][$key];
                        $gfile["title"][$fkey] = $gfield[$metatabid]["spelling"][$key];
                        $gfile["desc"][$fkey] = $gfield[$metatabid]["beschreibung"][$key];
                        $gfile["tabid"][$fkey] = $metatabid;
                        $gfile["tab"][$fkey] = $gtab["table"][$metatabid];
                        $gfile["typ"][$fkey] = $gfield[$metatabid]["parse_type"][$key];
                        $gfile["size"][$fkey] = $gfield[$metatabid]["size"][$key];
                        $gfile["field_type"][$fkey] = $gfield[$metatabid]["field_type"][$key];
                        $gfile["data_type"][$fkey] = $gfield[$metatabid]["data_type"][$key];
						$bzm++;
					}}
				}
			}
		}
	}
	return $gfile;
}


#----------------- Pool -------------------
function resultmselectpool(){
    global $db;

    $sqlquery = "SELECT * FROM LMB_SELECT_P";
    $rs = lmbdb_exec($db, $sqlquery) or errorhandle(lmbdb_errormsg($db), $sqlquery, $action, __FILE__, __LINE__);
    while (lmbdb_fetch_row($rs)) {
        $id = lmbdb_result($rs, 'ID');
        $gselectpool['LMB_SELECT']['tagmode'][$id] = lmbdb_result($rs, 'TAGMODE');
        $gselectpool['LMB_SELECT']['multimode'][$id] = lmbdb_result($rs, 'MULTIMODE');
        $gselectpool['LMB_SELECT']['recursivemode'][$id] = lmbdb_result($rs, 'RECURSIVEMODE');
    }

    $sqlquery = "SELECT * FROM LMB_ATTRIBUTE_P";
    $rs = lmbdb_exec($db, $sqlquery) or errorhandle(lmbdb_errormsg($db), $sqlquery, $action, __FILE__, __LINE__);
    while (lmbdb_fetch_row($rs)) {
        $id = lmbdb_result($rs, 'ID');
        $gselectpool['LMB_ATTRIBUTE']['tagmode'][$id] = lmbdb_result($rs, 'TAGMODE');
        $gselectpool['LMB_ATTRIBUTE']['multimode'][$id] = lmbdb_result($rs, 'MULTIMODE');
        $gselectpool['LMB_ATTRIBUTE']['recursivemode'][$id] = lmbdb_result($rs, 'RECURSIVEMODE');
    }

    return $gselectpool;
}

#----------------- Table Tree -------------------
function resulttabletree(){
	global $db;

	$sqlquery = "SELECT * FROM LMB_TABLETREE";
	$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
	while(lmbdb_fetch_row($rs)) {
		$tid = lmbdb_result($rs, "ID");
		$tabid = lmbdb_result($rs, "TABID");
		$treeid = lmbdb_result($rs, "TREEID");
		
		$gtabletree[$tabid][$treeid]["id"] = $tid;
		$gtabletree[$tabid][$treeid]["tabid"] = $tabid;
		if(lmbdb_result($rs, "POOLNAME")){$gtabletree[$tabid][$treeid]["poolname"] = lmbdb_result($rs, "POOLNAME");}
	}
	
	return $gtabletree;
}

#----------------- Trigger -------------------
function resulttriggerlist(){
	global $db;
	global $gtab;
	global $session;

	$sqlquery = "SELECT ID,TABLE_NAME,TYPE,TRIGGER_VALUE,DESCRIPTION,POSITION FROM LMB_TRIGGER WHERE ACTIVE = ".LMB_DBDEF_TRUE." AND INTERN = ".LMB_DBDEF_TRUE;
	$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
	if(!$rs) {$commit = 1;}
	while(lmbdb_fetch_row($rs)) {
		$key = lmbdb_result($rs, "ID");
		$gtabid = $gtab["argresult_id"][lmb_strtoupper(lmbdb_result($rs, "TABLE_NAME"))];
		$gtrigger[$gtabid]["id"][$key] = $key;
		$gtrigger[$gtabid]["table_name"][$key] = lmbdb_result($rs, "TABLE_NAME");
		$gtrigger[$gtabid]["type"][$key] = lmbdb_result($rs, "TYPE");
		$gtrigger[$gtabid]["value"][$key] = lmbdb_result($rs, "TRIGGER_VALUE");
		$gtrigger[$gtabid]["trigger_name"][$key] = lmbdb_result($rs, "DESCRIPTION");
		$gtrigger[$gtabid]["position"][$key] = lmbdb_result($rs, "POSITION");
	}
	return $gtrigger;
}

#----------------- Custmenu -------------------
function resultcustmenu(){
    global $db;

    $sqlquery = "SELECT * FROM LMB_CUSTMENU_LIST ORDER BY TABID,TYPE DESC,FIELDID,NAME";
    $rs = lmbdb_exec($db, $sqlquery) or errorhandle(lmbdb_errormsg($db), $sqlquery, $action, __FILE__, __LINE__);

    while (lmbdb_fetch_row($rs)) {

        $key = lmbdb_result($rs, 'ID');
        $tabid = lmbdb_result($rs, 'TABID');
        $type = lmbdb_result($rs, 'TYPE');
        $fieldid = lmbdb_result($rs, 'FIELDID');
        $name = lmbdb_result($rs, 'NAME');

        if(!$fieldid){
            $fieldid = 0;
        }
        $directlink = 0;
        if($type == 17){
            $type = 2;
            $directlink = 1;
        }
        if($type == 18){
            $directlink = 1;
        }
        if($type == 14){
            $type = 12;
            $directlink = 1;
        }

        if(!$type){$type = -1;}

        if($tabid) {
            $gcustmenu[$tabid][$type]['id'][] = $key;
            $gcustmenu[$tabid][$type]['name'][] = $name;
            $gcustmenu[$tabid][$type]['directlink'][] = $directlink;
            $gcustmenu[$tabid][$type][$fieldid] = $key;
        }

        $gcustmenu['argresult_name'][$key] = $name;

    }

    return $gcustmenu;
}


#----------------- Data Sync -------------------
function resultsync(&$gfield){
	global $db;
	global $gtab;
	global $session;
	global $umgvar;

	// Field syncmodus
	if($umgvar['sync_mode'] == 1){$mode='LMB_SYNC_CONF.SLAVE';}else{$mode='LMB_SYNC_CONF.MASTER';}
	$sqlquery = "SELECT DISTINCT LMB_SYNC_CONF.TABID,LMB_SYNC_CONF.FIELDID 
	FROM LMB_SYNC_CONF,LMB_CONF_TABLES 
	WHERE LMB_SYNC_CONF.TABID = LMB_CONF_TABLES.TAB_ID AND LMB_CONF_TABLES.DATASYNC > 0 AND $mode = ".LMB_DBDEF_TRUE ;
	$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
	if(!$rs) {$commit = 1;}
	while(lmbdb_fetch_row($rs)) {
	    $gfield[lmbdb_result($rs, 'TABID')]['sync'][lmbdb_result($rs, 'FIELDID')] = 1;
	}

    // Data Sync Parameter
    $sqlquery = "SELECT TABID,PARAMS FROM LMB_SYNC_PARAMS";
    $rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
    while(lmbdb_fetch_row($rs)) {
        $gtab["syncparams"][lmbdb_result($rs, 'TABID')][] = lmbdb_result($rs, "PARAMS");
    }
}



#----------------- Workflow -------------------
function result_wfl(){
	global $db;
	global $session;

	$sqlquery = "SELECT DISTINCT LMB_WFL.ID,LMB_WFL.NAME,LMB_WFL.DESCR FROM LMB_WFL,LMB_RULES_REPFORM WHERE LMB_WFL.ID = LMB_RULES_REPFORM.REPFORM_ID AND LMB_RULES_REPFORM.GROUP_ID IN(".implode(",",$session["subgroup"]).") AND LMB_RULES_REPFORM.TYP = 5 ORDER BY ID";
	$rs = lmbdb_exec($db,$sqlquery);
	if($rs){
		while(lmbdb_fetch_row($rs)) {
			$key = lmbdb_result($rs, "ID");
			$wfl[$key]["name"] = lmbdb_result($rs, "NAME");
			$wfl[$key]["desc"] = lmbdb_result($rs, "DESCR");
			
			#$params =  lmbdb_result($rs, "PARAMS");
			#if($params){$wfl[$key]["params"] = $params;}
			
			$sqlquery1 = "SELECT * FROM LMB_WFL_TASK WHERE WFL_ID = $key ORDER BY SORT";
			$rs1 = lmbdb_exec($db,$sqlquery1);
			if($rs1){
				while(lmbdb_fetch_row($rs1)) {
					$tid = lmbdb_result($rs1, "ID");
					$wfl[$key]["task"]["name"][$tid] = lmbdb_result($rs1, "NAME");
					$params =  lmbdb_result($rs1, "PARAMS");
					if($params){$wfl[$key]["task"]["params"][$tid] = $params;}
				}
			}
	
		}
	}
	return $wfl;
}

#----------------- Printer -------------------
function resultPrinter() {
    global $db;
    global $umgvar;
    global $lmmultitenants;
    global $session;


    // multitenant
    $mut = 0;

    if($umgvar['multitenant'] AND is_array($lmmultitenants['mid'])) {
        #$where = 'WHERE LMB_MID IN ('.implode(',',$lmmultitenants['mid']) .',0,NULL)'; // todo
        $where = 'WHERE LMB_MID IN ('.$lmmultitenants['mid'][$session['mid']].',0,NULL)';
    }

    $sqlquery = "SELECT ID, NAME, SYSNAME, CONFIG, DEF FROM LMB_PRINTERS $where ORDER BY ID";
    $rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$GLOBALS['action'],__FILE__,__LINE__);

    $printers = array();
    while (lmbdb_fetch_row($rs)) {
        $printer = array(
            'name' => lmbdb_result($rs, 'NAME'),
            'sysName' => lmbdb_result($rs, 'SYSNAME'),
            'config' => lmbdb_result($rs, 'CONFIG')
        );
        if (lmbdb_result($rs, 'DEF')) {
            $printer['default'] = 1;
        }
        $printers[lmbdb_result($rs, 'ID')] = $printer;
    }

    return $printers;
}

function mergeArray($a,$b)
{
	$args=func_get_args();
	$res=array_shift($args);
	while(!empty($args))
	{
		$next=array_shift($args);
		foreach($next as $k => $v)
		{
			if(is_integer($k))
			isset($res[$k]) ? $res[]=$v : $res[$k]=$v;
			elseif(is_array($v) && isset($res[$k]) && is_array($res[$k]))
			$res[$k]=mergeArray($res[$k],$v);
			else
			$res[$k]=$v;
		}
	}
	return $res;
}















$gfile = resultfiles();
# Formulare
#if($LINK[132]){
    $gformlist = resultformlist();
	$gform_ = resultform(0,0,0,array());
	$gform = $gform_[0];
#}
# Berichte
#if($LINK[131]){
	$greportlist = resultreportlist();
#}
# Diagramme
if($LINK[232]){
	$gdiaglist = resultdiaglist();
}

# multiselect Pool
$gselectpool = resultmselectpool();

# tabletree
$gtabletree = resulttabletree();

# Trigger
$gtrigger = resulttriggerlist();

# Custmenu
$gcustmenu = resultcustmenu();

# Data Sync
resultsync($gfield);

# Reminder
$greminder = resultreminder();

# Workflow
$gwfl = result_wfl();

# Snapshot
$gsnapgroup = SNAP_get_group();
$gsnap = SNAP_loadInSession();

# Printer
if ($LINK[304]) {
    $gprinter = resultPrinter();
}
