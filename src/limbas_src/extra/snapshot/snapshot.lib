<?php
/**
 * @copyright Limbas GmbH <https://limbas.com>
 * @license https://opensource.org/licenses/GPL-2.0 GPL-2.0
 *
 * This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 */

use Limbas\gtab\lib\tables\TableFilter;
use Limbas\gtab\lib\tables\TableFilterContent;
use Limbas\lib\general\Log\Log;


/**
 * Invalidate the snapshot in the session in order to be reloaded
 *
 */
function SNAP_invalidate(){
	global $db;
	global $action;

	$sqlquery = "UPDATE LMB_SESSION SET SNAP_CHANGED = ".LMB_DBDEF_TRUE;
	$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
}


function filter_reset($gtabid=null){
	if($gtabid){
    	$GLOBALS['popc'][$gtabid] = null;
    	$GLOBALS['popg'][$gtabid] = null;
    	$GLOBALS['gs'][$gtabid] = null;
    	$GLOBALS['gsr'][$gtabid] = null;
    	$GLOBALS["filter"]["hidecols"][$gtabid] = null;
    	$GLOBALS["filter"]["order"][$gtabid] = null;
        $GLOBALS['filter']["page"][$gtabid] = 1;
	}else{
    	$GLOBALS['popc'] = null;
    	$GLOBALS['popg'] = null;
    	$GLOBALS['gs']= null;
    	$GLOBALS['gsr'] = null;
    	$GLOBALS["filter"]["hidecols"] = null;
    	$GLOBALS["filter"]["order"] = null;
	}
	$GLOBALS['filter']['reminder_from'] = null;
	$GLOBALS['filter']['reminder_to'] = null;
	$GLOBALS['filter']['reminder_create'] = null;
	$GLOBALS['view_version_status'] = null;

}


# already done in gtab_array.lib (SNAP_loadInSession)

/**
 * validate snapshot fields against existing fields
 *
 * @return snapshot
 */
/*
function SNAP_revalidate($snapshot,$gtabid,$snapid){
	global $db;
	global $gfield;
	global $session;
	global $gsnap;
	
	
	if(!$owner = $gsnap[$gtabid]["owner"][$snapid] AND $session["user_group"] != 1){return false;}

	$snap = unserialize($snapshot);

	# filter order (delete not existing order field)
	if($snap["order"]){
		$order = explode("&",$snap["order"]);
		if(!$gfield[$order[0]]["sort"][$order[1]]){
			#unset($snap["hidecols"]);
			$update = 1;
		}
	}

	# filter sort (add new field if not exist)

	if($snap["sort"]){
		$maxval = max($snap["sort"]);
		foreach ($gfield[$gtabid]["sort"] as $key => $value){
			$maxval++;
			if(!$snap["sort"][$key]){
				$snap["sort"][$key] = $maxval;
				$snap["hidecols"][$key] = 1;
				$update = 1;
			}
		}

	# other filter must come!!
	
	$snapshot = serialize($snap);

	if($update){
		$prepare_string = "UPDATE LMB_SNAP SET FILTER = ? WHERE ID = ".$snapid." AND USER_ID = " . $session["user_id"];
		if(!lmb_PrepareSQL($prepare_string,array($snapshot),__FILE__,__LINE__)){$commit = 1;}
	}

	return $snapshot;
}
*/

/**
 * validate snapshot fields against existing fields
 *
 * @return snapshot
 */
/*
function SNAP_validate($gtabid,&$snapfilter){
	global $db;
	global $gfield;
	global $session;
	global $gsnap;

	#$GLOBALS["gfield"][$gtabid]["sort"] = $snapfilter["sort"];
	# filter order (delete not existing order field)
	if($snapfilter["sort"]){
		foreach ($snapfilter["sort"] as $key => $value){
			if(!$gfield[$gtabid]["sort"][$key]){
				unset($snapfilter["sort"][$key]);
			}
		}
	}
	
	#lmbGetGtabWidth($gtabid,$snapfilter["hidecols"]);
}
*/


/**
 * Load the snapshot in session in order to accelarate
 *
 * @deprecated Use an TableFilter::loadInSession instead.
 * @return array the gsnap array that contains the description of the snapshots
 */
function SNAP_loadInSession($snap_changed=null,$admin=null){
    Log::deprecated('Method ' . __METHOD__ . ' is deprecated. Use an TableFilter::loadInSession instead.');

    return TableFilter::loadInSession($snap_changed,$admin);
}

/**
 * Share a snapshot with a user or group
 * @param unknown_type $destUser the user whom the snapshot will shared to
 * @param unknown_type $snapshotId the snapshot id
 * 
 * @deprecated Use share on instance of TableFilter instead.
 */
function SNAP_share($destUser,$snapshotId,$del,$edit,$drop){

    Log::deprecated('Method ' . __METHOD__ . ' is deprecated. Use TableFilter::create instead.');
    
    $tableFilter = TableFilter::get(intval($snapshotId));
    if(!$tableFilter) {
        return false;
    }
    return $tableFilter->share($destUser,$del,$edit,$drop);
}

/**
 * @deprecated Use an instance of TableFilter instead.
 * @param $id
 * @return array
 */
function SNAP_getParam($id)
{
    Log::deprecated('Method ' . __METHOD__ . ' is deprecated. Use an instance of TableFilter instead.');

    $tableFilter = TableFilter::get(intval($id));
    
    return [
        'name' => $tableFilter->name,
        'id' => $tableFilter->name,
        'tabid' => $tableFilter->tabId,
        'global' => $tableFilter->global,
        'filter' => $tableFilter->content->toArray(),
        'owner' => $tableFilter->userId,
        'type' => $tableFilter->type,
        
    ];
}

/**
 * delete a snapshot
 *
 * @deprecated Use delete on instance of TableFilter instead.
 * 
 * @param int $id if of the snapshot
 * @param int $gtabid
 * @return bool
 */
function SNAP_delete($id, $gtabid): bool
{
	Log::deprecated('Method ' . __METHOD__ . ' is deprecated. Use TableFilter::create instead.');
	
	$tableFilter = TableFilter::get($id);
	
	if($tableFilter !== null) {
		return $tableFilter->delete();
	}
	return false;
}


//from gtab_erg.dao
/**
 * SchnapschuÃŸ eintragen
 * 
 * @deprecated Use TableFilter::create instead.
 * 
 * @param int $tabId
 * @param string $name
 * @param int $id
 * @param TableFilterContent|null $useContent
 * @param int $type
 * @param int $filterGroupId
 * @return bool|int|null
 */
function SNAP_save(int $tabId, string $name, int $id, TableFilterContent $useContent = null, int $type=1, int $filterGroupId = 0): bool|int|null
{
    Log::deprecated('Method ' . __METHOD__ . ' is deprecated. Use TableFilter::create instead.');
	return TableFilter::create($tabId,  $name,  $id,  $useContent, $type, $filterGroupId);
}


# get_snapshot_filter
function SNAP_get_filter($snap_id,$gtabid){

	global $gsnap;
	#global $filter;
    #global $gsr;

	//get filter from snapshot
    $snapfilter = $gsnap[$gtabid]["filter"][$snap_id];
    if(!$snapfilter){return;}

    // searchselect
    if($gsnap[$gtabid]["type"][$snap_id] == 2){
        $GLOBALS["gsr"][$gtabid] = $snapfilter["gsr"];
        $GLOBALS["filter"]["snapid"][$gtabid] = $snap_id;
    // filter
    }else {
        $GLOBALS["filter"]["snapisset"][$snap_id] = $snap_id;
        $GLOBALS["filter"]["snapid"][$gtabid] = $snap_id;
        $GLOBALS["filter"]["order"][$gtabid] = $snapfilter["order"];
        $GLOBALS["filter"]["popups"][$gtabid] = $snapfilter["popups"];
        $GLOBALS["filter"]["status"][$gtabid] = $snapfilter["status"];
        $GLOBALS["filter"]["hidecols"][$gtabid] = $snapfilter["hidecols"];
        $GLOBALS["filter"]["form"][$gtabid] = $snapfilter["form"];
        $GLOBALS["gfield"][$gtabid]["sort"] = $snapfilter["sort"];
        if ($snapfilter["rowsize"]) {
            $GLOBALS["gfield"][$gtabid]["rowsize"] = $snapfilter["rowsize"];
        }
        $GLOBALS["gsr"][$gtabid] = $snapfilter["gsr"];
        if($gsnap[$gtabid]["ext"][$snap_id]){
            eval($gsnap[$gtabid]["ext"][$snap_id]);
            $GLOBALS["filter"]["extension"][$gtabid] = $extension;
            $GLOBALS["gsr"][$gtabid] = $gsr[$gtabid];
        }else{
            $GLOBALS["filter"]["extension"][$gtabid] = '';
        }
    }

    $gsnap[$gtabid]["gsr_md5"][$snap_id] = md5(serialize($snapfilter["gsr"]));

	//speichern der filter und gsr in session
}

function SNAP_get_filtergroup($gtabid=null,$groupid=null,int $type=1, $showall=false ){
    global $gsnap;
    global $gsnapgroup;

    // group based filter without table
    if($groupid) {
        foreach ($gsnap[-1][$groupid] as $snapid => $value) {
            $snaptabid = $gsnap["argresult_id"][$snapid];

            // skip if intern snapshot
            if($gsnapgroup['intern'][ $gsnap[$snaptabid]['group'][$snapid] ] && !$showall){
                continue;
            }

            if($type !== intval($gsnap[$snaptabid]["type"][$snapid])){
                continue;
            }

            $filterlist[$snapid] = $gsnap[$snaptabid]["name"][$snapid];
        }
    // table based filter
    }elseif($gtabid){

        foreach ($gsnap[$gtabid]['name'] as $snapid => $value) {

            // skip if intern snapshot
            if($gsnapgroup['intern'][ $gsnap[$gtabid]['group'][$snapid] ] && !$showall){
                continue;
            }

            if($type !== intval($gsnap[$gtabid]["type"][$snapid])){
                continue;
            }
            $filterlist[$snapid] = $gsnap[$gtabid]["name"][$snapid];
        }
    }

    return $filterlist;
}

# remember original table filter
function SNAP_set_reminder($gtabid){

	$filter["order"] = $GLOBALS["filter"]["order"][$gtabid];
	$filter["popups"] = $GLOBALS["filter"]["popups"][$gtabid];
	$filter["status"] = $GLOBALS["filter"]["status"][$gtabid];
	$filter["hidecols"] = $GLOBALS["filter"]["hidecols"][$gtabid];
	$filter["form"] = $GLOBALS["filter"]["form"][$gtabid];
	$filter["sort"] = $GLOBALS["gfield"][$gtabid]["sort"];
    $filter["rowsize"] = $GLOBALS["gfield"][$gtabid]["rowsize"];
	$filter["gsr"] = $GLOBALS["gsr"][$gtabid];
	
	$GLOBALS["session"]["snapreminder"][$gtabid] = $filter;
}

# restore original table filter
function SNAP_get_reminder($gtabid){

	if($GLOBALS["session"]["snapreminder"][$gtabid]){
		$GLOBALS["filter"]["order"][$gtabid] = $GLOBALS["session"]["snapreminder"][$gtabid]["order"];
		$GLOBALS["filter"]["popups"][$gtabid] = $GLOBALS["session"]["snapreminder"][$gtabid]["popups"];
		$GLOBALS["filter"]["status"][$gtabid] = $GLOBALS["session"]["snapreminder"][$gtabid]["status"];
		$GLOBALS["filter"]["hidecols"][$gtabid] = $GLOBALS["session"]["snapreminder"][$gtabid]["hidecols"];
		$GLOBALS["filter"]["form"][$gtabid] = $GLOBALS["session"]["snapreminder"][$gtabid]["form"];
		$GLOBALS["gfield"][$gtabid]["sort"] = $GLOBALS["session"]["snapreminder"][$gtabid]["sort"];
        $GLOBALS["gfield"][$gtabid]["rowsize"] = $GLOBALS["session"]["snapreminder"][$gtabid]["rowsize"];
		$GLOBALS["gsr"][$gtabid] = $GLOBALS["session"]["snapreminder"][$gtabid]["gsr"];
		$GLOBALS["filter"]["extension"][$gtabid] = null;
	}
	
	$GLOBALS["session"]["snapreminder"][$gtabid] = null;
}

function SNAP_td_size_global($rowsize,$gtabid){
    global $db;
    global $umgvar;

	$rsize = explode(";",$rowsize);

	foreach ($rsize as $bzm => $value){
		$element = explode(",",$rsize[$bzm]);

        $field_id = $element[0];
        $width = parse_db_int($element[1]);
        if(!$width OR $width < 10){$width = $umgvar["default_fieldwidth"];}

		$sqlquery = "UPDATE LMB_CONF_FIELDS SET ROW_SIZE = $width WHERE FIELD_ID = $field_id AND TAB_ID = $gtabid";
		$rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);

	}
}

function lmb_register_snapshot($gtabid,&$snap_id,$filter_reset=null){
    global $gsnap;
    global $filter;

    if($snap_id AND $gsnap[$gtabid]["id"][$snap_id]){
        if(!$filter_reset AND (!$filter["snapisset"][$snap_id] OR $filter["snapid"][$gtabid] != $snap_id)){
            if(!$filter["snapid"][$gtabid]){
                SNAP_set_reminder($gtabid);
            }
            SNAP_get_filter($snap_id,$gtabid);
        }elseif($filter_reset){
            filter_reset($gtabid);
            SNAP_get_filter($snap_id,$gtabid);
        }
    }else{
        if($filter["snapid"][$gtabid]){
            filter_reset($gtabid);
            SNAP_get_reminder($gtabid);
        }
        $filter["snapid"][$gtabid] = 0;
        $snap_id = null;
    }

}

function SNAP_get_group(){
    global $gsnap;
    global $db;

    $sqlquery = "SELECT ID,NAME,INTERN FROM LMB_SNAP_GROUP ORDER BY NAME";
    $rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$action,__FILE__,__LINE__);
    if(!$rs) {return false;}

    $snapgroup = array();
	while(lmbdb_fetch_row($rs)) {
        $snapgroup['name'][lmbdb_result($rs, 'ID')] = lmbdb_result($rs, "NAME");
        $snapgroup['intern'][lmbdb_result($rs, 'ID')] = lmbdb_result($rs, "INTERN");
    }

    return $snapgroup;
}

function SNAP_print_select($gtabid,$snap_id,$filterlist=null){
    global $gsnap;
    global $gsnapgroup;

    if(!$filterlist) {
        $filterlist = SNAP_get_filtergroup($gtabid);
    }
    foreach($filterlist as $key => $value){
        $sg = $gsnap[$gtabid]['group'][$key];
        $sgname = $gsnapgroup['name'][$sg];
        if($sgp != $sg){
            echo '<optgroup label="'.$sgname.'">';
        }
        $sgp = $sg;
        echo "<option value=\"$key\" ".($key == $snap_id ? 'selected' : '').">".$value;
    }
}

function SNAP_clean_up($snap_id){
    global $db;
    global $gsnap;

    if(!is_numeric($snap_id)){return;}

    $sqlquery = "SELECT ID,FILTER,TABID FROM LMB_SNAP WHERE ID = $snap_id";
    $rs = lmbdb_exec($db,$sqlquery) or errorhandle(lmbdb_errormsg($db),$sqlquery,$GLOBALS['action'],__FILE__,__LINE__);
    if(lmbdb_fetch_row($rs)) {
        $tab_id = lmbdb_result($rs,'TABID');
        $snap_filter = json_decode(lmbdb_result($rs,'FILTER'),true);

        $sqlquery1 = "SELECT ID,FIELD_ID FROM LMB_CONF_FIELDS WHERE TAB_ID = $tab_id";
        $rs1 = lmbdb_exec($db,$sqlquery1) or errorhandle(lmbdb_errormsg($db),$sqlquery1,$GLOBALS['action'],__FILE__,__LINE__);
        while(lmbdb_fetch_row($rs1)) {
            $fieldexists[lmbdb_result($rs1,'FIELD_ID')] = 1;
        }

        // sort
        foreach($snap_filter['sort'] as $fieldid => $key){
            if(!$fieldexists[$fieldid]){
                unset($snap_filter['sort'][$fieldid]);
            }
        }
        // hidecols
        foreach($snap_filter['hidecols'] as $fieldid => $key){
            if($fieldid != 0 && !$fieldexists[$fieldid]){
                unset($snap_filter['hidecols'][$fieldid]);
            }
        }
        // rowsize
        foreach($snap_filter['rowsize'] as $fieldid => $key){
            if($fieldid != 0 && !$fieldexists[$fieldid]){
                unset($snap_filter['rowsize'][$fieldid]);
            }
        }
        
    }

}